========================================
　　　PC-6001F　　Ver.0235-0053 　　　　
　　　　　　　　　　　　　　　　　　　　
　　　Copyright and Designed by えすび　
　　　　　　　　　　　　　　　　　　　　
　　　　　　　　　　　　　2013-Feb-19 　
========================================

１．はじめに
￣￣￣￣￣￣

　PC-6001F とは、往年のパソコンPC-6001を
FPGAで実現してしまおうというものです。


２．著作権、使用上の注意
￣￣￣￣￣￣￣￣￣￣￣￣
　本回路、ソフトは、フリーウエアです。

　T80 のVHDL記述の著作権は、作者であるDaniel Wallnerさんにあります。
　T80コアの一部を修正して使用しました。
　VDGの内部キャラクタデータの著作権は、作者である Bernieさんにあります。

　その他のVHDL記述、プログラムの著作権は、作者であるえすびにあります。


　使用する際は、使用者個人責任で行ってください。実行した結果によって、
いかなる結果になっても、作者は一切責任を負いませんので、ご了承下さい。


「ボードが壊れた」「SDカードの内容が消えた」
「ボードをわざわざ買ったのに、期待したものと違った」

　などに関して、当然責任は負いませんので。


３．改定箇所
￣￣￣￣￣￣
　Ver.0234-0052 から、以下の箇所を変更しています。

・拡張漢字ROMの実装


　！！注意！！

　ファイルをsave する際など、プログラムの不具合などでSDカードの内容が
破壊される可能性がありますので、必ずバックアップを取っておいて下さい。

　また、SDカードにアクセス中(LED0が点灯中)は、SDカードを抜き挿ししないで下さい。


４．使用環境
￣￣￣￣￣￣
　実現のためには以下のものが必要になります。

・FPGAボード DE0（Terasic製　http://www.terasic.com.tw/en/）
・VGAが表示できるモニタ
・PS/2キーボード
・SDカード（条件あり、後述）
・PC-6001のROMデータ（BASICROM.60、CGROM60.60）
・PC-6001mk2のROMデータ（BASICROM.62、CGROM60.62、CGROM60M.62、VOICEROM.62、KANJIROM.62）
・PC-6601のROMデータ（BASICROM.66、CGROM60.66、CGROM66.66、VOICEROM.66、KANJIROM.66）
・拡張漢字ROMデータ（EXKANJI.ROM）

（ROMデータは全部必要はありませんが、あるものしか実行できません）

　以下はあるといいものです。
・音声出力回路
・ジョイスティックポート
・液晶基板
・RS-232Cポート


５．準備
￣￣￣￣
・SDカード

　SDカードは、FAT16 でフォーマットされた物のみ対応しています。
　最近の1GB〜2GBぐらいのものなら、多分大丈夫だと思います。
　また、SDHC は対応していません。

　SDカードに、ROM というディレクトリを作成して、その中にROMデータを
　格納して下さい。その、SDカードスロットに挿します。

　CMTファイル、拡張ROMファイル、FDDファイルは、SDカードに格納されていれば、
　ディレクトリ内であっても特に問題ありません。名前の制約もありません。


・音声出力回路

　音声出力回路は、GPIO0_D23（32ピン） と GND に挿します。

　同梱の回路図のＬＰＦの部分だけでも動作します。しかしスピーカーを
　直接駆動は出来ないので、イヤホンで聞いて下さい。


・ジョイスティックポート

　同梱のジョイスティック回路（というかD-SUBのコネクタ）をつなげば、
　ジョイスティックが使えます。

　ただし、FPGAの入出力が3.3Vでしか対応できないため、3.3V用では、
　5V動作のものは使えません（例えば、74LS系のICを使っているなど）。

　ボタンを押すだけのものは、3.3V用で使用できます。

　5V動作のもの（一部の連射パッド、マウスなど）を使う場合は、5V用を
　使ってください。


・液晶基板

　同梱の回路図を参考にして下さい。


・RS-232Cポート

　同梱の回路図を参考にして下さい。

　基板右上から接続しますが、スクリーン印刷が一部間違えているので気を付けて下さい。


・その他

　PS/2キーボード、VGAモニタは、それぞれのコネクタに挿します。

　最後に、PC6001.sof または、PC6001.pof をDE0 ボードにインストールして下さい。

　PC6001.pof をインストールした場合は、電源を切っても回路情報は消えません。


６．使い方
￣￣￣￣￣
　スライドスイッチ（SW0〜SW9）、プッシュスイッチ(BUTTON0〜2）、LED0〜9
　及び７セグLEDに以下のことを割り当てています。

・LED0〜9

　LED9：かなキーのインジケータ
　LED8：CMT のリレーON時に点灯
　LED7：CMT のデータを読み込んでいる際に点滅
　LED2：SDRAMのメモリエラー（通常は点滅しないはずです）
　LED1：SDカードエラー
　LED0：SDカード使用中。

　SDカードは、LED0が点灯している時は、抜き差ししないで下さい。
　消灯中は、SDカードにアクセスしていませんので、抜き差しできますが、
　出来れば電源を切ってから、抜き差しした方が安全です。

　LED1が点滅する場合は、
　・SDカードが入っていない。
　・SDカードが対応していないフォーマットである。
　・必要なROMファイルが入っていない。
　・その他、アクセス時にエラーが検出された。

　のいずれかです。リセットをする（BUTTON2を押す）か、電源を切→入して下さい。

・スライドスイッチ（SW0〜9）
　上がONになります。

　SW9〜SW6：デバッグ用。OFFにして下さい。

　SW5：ON時、液晶に表示。
　SW4：ON時、CMTロードを等速にする。
　SW3：ON時、PC-6601モード。
　SW2：ON時、PC-6001mk2モード。
　SW1：OFFにして下さい。
　SW0：ON時、画面間引きモード。


　P6、mk2、P66を切り換えるには、SW2、SW3 を切り換えてから、BUTTON2（リセット）を押して下さい。
　BUTTON2 を押した時に SW2、SW3 の状態を読み込んで、動作を切り換えます。

　画面間引きモードでは、画面がちらついて見えますが、その分の時間をCPUに割り当てます。
　（結果として、CPUが速く動いているように見えます）


・プッシュスイッチ（BUTTON0〜2）、７セグLED

　BUTTON2：リセット。回路全てをリセットします。
　BUTTON1：CPUアドレスのラッチ。
　BUTTON0：７セグ表示セレクト。


　BUTTON0を押すと、

　CMTカウンタ → FPGA-Ver, → FARM-Ver. → CPUアドレス → CMTカウンタ　･･･
　の順で変わります。


　CPUアドレスは、リセット時には "CAdd" になるようにしています。


・キーボード

　F8  を押すと、メニュー画面に入ります。
　F11 を押すと、PC-6001 をリセットします（メニュー画面の内容はリセットされません）。


　PC-6001 独自のキーに関しては、以下のように割り当てています。

　かな　：半角／全角、Pause、NumLock（テンキー）
　GRAPH ：ALT
　PAGE　：PageUp
　STOP　：End
　MODE　：PageDown

　また、テンキーでもキー入力が可能です。


・メニュー画面

　使用するキーは、画面の下の一覧を参考にして下さい。

　CMT READ FILE 　　　：読み込むテープデバイスを選択します。
　CMT READ FILE REW.　：読み込むテープデバイスを先頭に戻します。
　CMT WRITE FILE　　　：書き込むテープデバイスを選択します。
　RAM SIZE　　　　　　：16KB/32KB （mk2の場合、64KB/128KB）を選択します。選択した際は、PC-6001が
　　　　　　　　　　　　自動的にリセットされます。
　EXTEND ROM　　　　　：拡張ROMを選択します。選択した際は、PC-6001が自動的にリセットされます。
　　　　　　　　　　　　さらに、読み込むテープデバイスが、未選択状態になります。
　SCREEN4 COLOR 　　　：OFFにする、もしくは色の組み合わせを選択します。
　UART SETTING 　 　　：OFFにする、もしくはボーレートを選択します。左が1/64分周時、右が1/16分周時です。


　次ページ（スペースキーで進みます）

　INT FDD#0 SETTING　：内蔵ドライブ#0を使用するかどうかを選択します。使用する時は、1D を選びます。
　INT FDD#0 FILE 　　：内蔵ドライブ#0のファイルを選択します。ドライブが使用状態の時にしか選べません。
　INT FDD#0 SETTING　：内蔵ドライブ#1を使用するかどうかを選択します。使用する時は、1D を選びます。
　INT FDD#0 FILE 　　：内蔵ドライブ#1のファイルを選択します。ドライブが使用状態の時にしか選べません。

　EXT FDD#0 SETTING　：外付けドライブ#0を使用するかどうかを選択します。使用する時は、1D を選びます。
　EXT FDD#0 FILE 　　：外付けドライブ#0のファイルを選択します。ドライブが使用状態の時にしか選べません。
　EXT FDD#0 SETTING　：外付けドライブ#1を使用するかどうかを選択します。使用する時は、1D を選びます。
　EXT FDD#0 FILE 　　：外付けドライブ#1のファイルを選択します。ドライブが使用状態の時にしか選べません。


　内蔵ドライブは、PC-6601の時のみ有効です。外付けドライブは、すべてのモードで使用できます。
　ドライブを変更した時に、F11 でリセットすると、BASIC-ROM が認識します。

　テープのセーブ、ロード中、FDDアクセス中は、メニューの項目の変更などはできません。F8、F11 のみ使用できます。


　注意：BUTTON2 でリセットした場合は、上記設定値は全て初期値に戻ります。



・P6T ファイルのオートスタートコマンドについて

　テープのロードファイルの拡張子が〜.P6T で、オートスタートコマンドを有にしている場合、
　それを実行します（ただし、P6T のフォーマット は Ver.2 のみです）。

　テープを選択後、F11 を押すと、リセット解除後、モード選択、ページ選択を行い、
　記述されているコマンドを実行します。

　コマンドを実行するかどうかは、F11 を押すたびに変わります。

　テープ選択
　↓
　F11 を押す　　→　オートスタートコマンド実行
　↓
　F11 を押す　　→　通常起動
　↓
　F11 を押す　　→　オートスタートコマンド実行
　：

　ROM の種類がPC-6001 の場合は、RAM のサイズも自動的に変更します。
　モード指定が１、３の場合は16KB、モード指定が２、４の場合は32KB になります。


・テープのセーブについての制限

　セーブする時は、新規にファイルを作成することが出来ません。
　既存のファイルの後ろに、セーブデータがくっつきます。

　そのため、セーブする際は、あらかじめファイルを作成しておいて下さい。

　あらかじめ作成するファイルは、０バイトのファイルで構いませんし、どこの
　ディレクトリに格納しても構いません。


　また、ReadOnlyのファイルには書き込みできません（ファイル選択画面に表示されません）。
　SDカードを書き込み禁止にしている場合は、ファイル選択自体ができないようになっています。


　セーブした後に、そのファイルをロードする際は、ロード時にファイルを選び直して下さい。



・フロッピーのファイルについて

　フロッピーは、d88 フォーマットのみ対応しています。

　オート起動の物は、

　「ドライブを使用可能状態にする」
　　↓
　「フロッピーファイルを選択する」
　　↓
　「F11を押す（リセット）」

　で起動します。


　また、フロッピーのファイルとしては、d88 フォーマットのものしか認識しません。
　そのため、普通のファイルをフォーマットして使う、などの事ができませんので、注意して下さい。


　フロッピーファイルのセーブやフォーマットは、

　「SDカードのLOCKが掛かっていない」
　「d88フォーマット内のライトプロテクトが掛かっていない」
　「d88のファイルがリードオンリーでない」

　場合に可能になります。


　フロッピーファイルのフォーマットは、元のファイルと同じ形式にしか出来ません。
　それ以外の場合は、他のトラックをつぶしたり、エラーでフォーマットが中止される可能性があります。



７．判明している問題点、実現していない機能など
￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣
　○mk2 で RAM SIZE を128KB にした場合、内部RAM と外部RAM が存在する事になります。
　　mk2 の機能で、内部RAM と外部RAM に同時に書き込みが出来る仕様になっていますが、
　　同時書き込みは実現していません。


　○加速モードではNGのものがあります。

　・問題が起こる場合は、CMT のロードが殆どです。複数のファイルに分割されている場合は、
　　ファイルの間に適当なバイトを入れるといいかと思います（他のエミュレータなどと同様です）。

　・ドアドアなど、CMTロードの速度を変更するとダメなプログラムがあります。
　　この場合は、CMTロードを等速にして下さい。
　　さらに画面間引きモードにすると、問題が解消される可能性が高くなります。




　「動作しないソフトがある」「動作がおかしい」などがありましたら、知らせて頂けるとありがたいです。
　　その他、不明点などは、ブログまでお願いします（どの発言に対するコメントでも構いませんので）。



８．謝辞
￣￣￣￣
　Z80のVHDLコアに、Daniel Wallnerさん作のT80 を改修して使用させて頂きました。
　VDG内部のキャラクタのデータは、Bernieさん作のPC-6001VW で生成される
　cgrom60s.txt を使用させて頂きました。
　uPD7752の実装に関して、cisc.さんの『μPD7752 風味 音声合成エンジン』を
　大いに参考にさせて頂ました。

　PC-6001のエミュレータを作成したそれぞれの作者の人達、応援してくださった
　みなさん、ありがとうございます。みなさんのおかげで、FPGA化計画自体を
　進める事ができました。



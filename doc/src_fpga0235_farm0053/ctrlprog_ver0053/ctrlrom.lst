 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 1 - 2/18/2013 12:10:16


       1/       0 :                     ;
       2/       0 :                     ;	SD card file control program
       3/       0 :                     ;
       4/       0 :                     	ORG	0000H
       5/       0 :                     ;
       6/       0 :                     
       7/       0 : =53H                FIRMVER:	EQU	0053H
       8/       0 :                     
       9/       0 :                     ;FIRMVER:	EQU	0E006H	; decode address for debug
      10/       0 :                     
      11/       0 : =3FFFH              INITSP:		EQU	3FFFH
      12/       0 :                     ;
      13/       0 :                     ; buffer location
      14/       0 :                     ;
      15/       0 : =8000H              REG_SDBUF:	EQU	8000H
      16/       0 : =81C6H              REG_OFFSET:	EQU	81C6H
      17/       0 :                     
      18/       0 : =800BH              BPB_SECBYTE	EQU	800BH
      19/       0 : =800DH              BPB_CLASTSEC:	EQU	800DH
      20/       0 : =800EH              BPB_FATST:	EQU	800EH
      21/       0 : =8010H              BPB_FATNUM	EQU	8010H
      22/       0 : =8011H              BPB_DIRENTRY	EQU	8011H
      23/       0 : =8016H              BPB_FATSEC:	EQU	8016H
      24/       0 : =8039H              BPB_FATVER:	EQU	8039H
      25/       0 :                     
      26/       0 :                     ;
      27/       0 :                     ; register mapping
      28/       0 :                     ;
      29/       0 : =8200H              REG_SDCMDST:	EQU	8200H
      30/       0 : =8201H              REG_SDCTRL:	EQU	8201H
      31/       0 : =8202H              REG_SDRDDONE:	EQU	8202H
      32/       0 : =8203H              REG_ROMINIT:	EQU	8203H
      33/       0 : =8204H              REG_SDWP:	EQU	8204H
      34/       0 : =8205H              REG_SDCMDNO:	EQU	8205H
      35/       0 : =8206H              REG_SDADD:	EQU	8206H
      36/       0 :                     
      37/       0 : =8210H              REG_BUFAD:	EQU	8210H
      38/       0 : =8211H              REG_BUFSEL:	EQU	8211H
      39/       0 : =8212H              REG_CMTOPEN:	EQU	8212H
      40/       0 : =8213H              REG_SDRD:	EQU	8213H
      41/       0 : =8214H              REG_SDWR:	EQU	8214H
      42/       0 : =8234H              REG_CMTRD:	EQU	8234H
      43/       0 : =8254H              REG_CMTWR:	EQU	8254H
      44/       0 :                     
      45/       0 : =8220H              REG_FIFO_0:	EQU	8220H
      46/       0 : =8240H              REG_FIFO_1:	EQU	8240H
      47/       0 : =8260H              REG_FIFO_2:	EQU	8260H
      48/       0 : =8280H              REG_FIFO_3:	EQU	8280H
      49/       0 : =82A0H              REG_FIFO_4:	EQU	82A0H
      50/       0 : =82C0H              REG_FIFO_5:	EQU	82C0H
      51/       0 :                     
      52/       0 : =0H                 FIFO_CMTLEN:	EQU	00H
      53/       0 : =4H                 FIFO_CMTPTR:	EQU	04H
      54/       0 : =8H                 FIFO_CL:	EQU	08H
      55/       0 : =AH                 FIFO_SEC:	EQU	0AH
      56/       0 : =BH                 FIFO_STCL:	EQU	0BH
      57/       0 : =DH                 FIFO_BEFCL:	EQU	0DH
      58/       0 : =FH                 FIFO_DIRCL:	EQU	0FH
      59/       0 : =11H                FIFO_DIRPOS:	EQU	11H
      60/       0 : =13H                FIFO_FATNEW:	EQU	13H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 2 - 2/18/2013 12:10:16


      61/       0 : =14H                FIFO_STAT:	EQU	14H
      62/       0 : =15H                FIFO_WRADD:	EQU	15H
      63/       0 : =14H                FIFO_FLOPPY:	EQU	14H
      64/       0 : =15H                FIFO_CNUM:	EQU	15H
      65/       0 : =1FH                FIFO_FDD:	EQU	1FH
      66/       0 :                     
      67/       0 : =827FH              REG_FDD0:	EQU	827FH
      68/       0 : =829FH              REG_FDD1:	EQU	829FH
      69/       0 : =82BFH              REG_FDD2:	EQU	82BFH
      70/       0 : =82DFH              REG_FDD3:	EQU	82DFH
      71/       0 :                     
      72/       0 : =8310H              REG_INTFDD:	EQU	8310H
      73/       0 : =8340H              REG_EXTFDD:	EQU	8340H
      74/       0 :                     
      75/       0 : =0H                 FDD_DMACTRL:	EQU	00H
      76/       0 : =1H                 FDD_DMASIZE:	EQU	01H
      77/       0 : =10H                FDD_ST0:	EQU	10H
      78/       0 : =11H                FDD_ST1:	EQU	11H
      79/       0 : =12H                FDD_ST2:	EQU	12H
      80/       0 : =13H                FDD_RST_C:	EQU	13H
      81/       0 : =14H                FDD_RST_H:	EQU	14H
      82/       0 : =15H                FDD_RST_R:	EQU	15H
      83/       0 : =16H                FDD_RST_N:	EQU	16H
      84/       0 : =17H                FDD_ENDTRG:	EQU	17H
      85/       0 : =20H                FDD_COMEND:	EQU	20H
      86/       0 : =21H                FDD_COMMAND:	EQU	21H
      87/       0 : =22H                FDD_MT:		EQU	22H
      88/       0 : =23H                FDD_DNUM:	EQU	23H
      89/       0 : =24H                FDD_HNUM:	EQU	24H
      90/       0 : =25H                FDD_IDRC:	EQU	25H
      91/       0 : =26H                FDD_IDRH:	EQU	26H
      92/       0 : =27H                FDD_IDRR:	EQU	27H
      93/       0 : =28H                FDD_IDRN:	EQU	28H
      94/       0 : =29H                FDD_EOT:	EQU	29H
      95/       0 : =2AH                FDD_GPL:	EQU	2AH
      96/       0 : =2BH                FDD_DTL:	EQU	2BH
      97/       0 :                     
      98/       0 : =8370H              REG_FDINT:	EQU	8370H
      99/       0 :                     
     100/       0 : =8400H              REG_LCDMODE:	EQU	8400H
     101/       0 : =8401H              REG_LCDADD:	EQU	8401H
     102/       0 : =8402H              REG_LCDDAT:	EQU	8402H
     103/       0 : =8403H              REG_LCDST:	EQU	8403H
     104/       0 : =8404H              REG_LCDDONE:	EQU	8404H
     105/       0 : =8410H              REG_CTRLSEL:	EQU	8410H
     106/       0 : =8411H              REG_CTRLRST:	EQU	8411H
     107/       0 : =8412H              REG_MEM16K:	EQU	8412H
     108/       0 : =8413H              REG_SC4MODE:	EQU	8413H
     109/       0 : =8414H              REG_DBGTRG:	EQU	8414H
     110/       0 : =8415H              REG_MK2MODE:	EQU	8415H
     111/       0 : =8416H              REG_KEYDAT:	EQU	8416H
     112/       0 : =8417H              REG_KEYENB:	EQU	8417H
     113/       0 : =8418H              REG_UARTENB:	EQU	8418H
     114/       0 : =8419H              REG_UARTLEN:	EQU	8419H
     115/       0 : =841CH              REG_EXKANJIENB:	EQU	841CH
     116/       0 :                     
     117/       0 : =8420H              REG_FUNCKEY:	EQU	8420H
     118/       0 :                     
     119/       0 : =8440H              REG_FPGAVER:	EQU	8440H
     120/       0 : =8442H              REG_FIRMVER:	EQU	8442H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 3 - 2/18/2013 12:10:16


     121/       0 :                     
     122/       0 : =9000H              DISKBUF:	EQU	9000H
     123/       0 : =90H                DISKBUF_U:	EQU	90H
     124/       0 :                     
     125/       0 : =9FF0H              REG_EXTFDDDI:	EQU	9FF0H
     126/       0 : =9FF1H              REG_EXTFDDDO:	EQU	9FF1H
     127/       0 : =9FF2H              REG_EXTFDDCIO:	EQU	9FF2H
     128/       0 : =9FF3H              REG_EXTFDDCNT:	EQU	9FF3H
     129/       0 : =9FF4H              REG_EXTFDCMAIN:	EQU	9FF4H
     130/       0 : =9FF5H              REG_EXTFDCDATA:	EQU	9FF5H
     131/       0 :                     
     132/       0 : =A000H              EXTWRBUF:	EQU	0A000H
     133/       0 : =A0H                EXTWRBUF_U:	EQU	0A0H
     134/       0 : =B000H              EXTRDBUF:	EQU	0B000H
     135/       0 : =B0H                EXTRDBUF_U:	EQU	0B0H
     136/       0 :                     
     137/       0 : =C000H              CTRLATT:	EQU	0C000H
     138/       0 : =C200H              CTRLVRAM:	EQU	0C200H
     139/       0 :                     
     140/       0 :                     
     141/       0 : =7H                 CMD_RECALB:	EQU	07H
     142/       0 : =FH                 CMD_SEEK:	EQU	0FH
     143/       0 : =8H                 CMD_SENSEINTST:	EQU	08H
     144/       0 : =46H                CMD_MFMRDDATA:	EQU	46H
     145/       0 : =6H                 CMD_RDDATA:	EQU	06H
     146/       0 : =CH                 CMD_RDDELDATA:	EQU	0CH
     147/       0 : =45H                CMD_MFMWRDATA:	EQU	45H
     148/       0 : =5H                 CMD_WRDATA:	EQU	05H
     149/       0 : =9H                 CMD_WRDELDATA:	EQU	09H
     150/       0 : =2H                 CMD_RDDIA:	EQU	02H
     151/       0 : =AH                 CMD_RDID:	EQU	0AH
     152/       0 : =DH                 CMD_WRID:	EQU	0DH
     153/       0 : =4DH                CMD_MFMWRID:	EQU	4DH
     154/       0 : =11H                CMD_SCEQU:	EQU	11H
     155/       0 : =19H                CMD_SCLOW:	EQU	19H
     156/       0 : =1DH                CMD_SCHIG:	EQU	1DH
     157/       0 :                     
     158/       0 :                     
     159/       0 :                     ;
     160/       0 :                     
     161/       0 :                     START:
     162/       0 :                     
     163/       0 : 31 FF 3F            	LD	SP,INITSP
     164/       3 : 3E FF               	LD	A,0FFH
     165/       5 : ED 47               	LD	I,A
     166/       7 : FB                  	EI
     167/       8 : 21 53 00            	LD	HL,FIRMVER
     168/       B : 22 42 84            	LD	(REG_FIRMVER),HL
     169/       E : AF                  	XOR	A
     170/       F : 32 14 84            	LD	(REG_DBGTRG),A
     171/      12 :                     
     172/      12 :                     		;
     173/      12 : CD 2A 14            	CALL	LCD_INIT
     174/      15 : CD 89 0A            	CALL	SCREENINIT
     175/      18 : CD 68 14            	CALL	FDUNITINIT
     176/      1B : CD 82 14            	CALL	UARTINIT
     177/      1E :                     		;
     178/      1E : AF                  	XOR	A
     179/      1F : 32 B4 22            	LD	(SDMODE),A
     180/      22 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 4 - 2/18/2013 12:10:16


     181/      22 :                     		;
     182/      22 : CD 14 11            	CALL	SDCARD_OPEN
     183/      25 : CD 8A 14            	CALL	SDREGINIT
     184/      28 :                     		;
     185/      28 : 11 26 24            	LD	DE,ST_EXROM_VAL
     186/      2B : CD 42 15            	CALL	LD_ST_NOSELECT
     187/      2E :                     
     188/      2E :                     		;
     189/      2E :                     		; ROM read
     190/      2E :                     		;
     191/      2E : 3A 15 84            	LD	A,(REG_MK2MODE)
     192/      31 : B7                  	OR	A
     193/      32 : 20 1D               	JR	NZ,RDM2
     194/      34 :                     		;
     195/      34 :                     		; ROM read (6001)
     196/      34 :                     		;
     197/      34 : DD 21 2C 28         	LD	IX,F_BASICROM60
     198/      38 : 21 00 00            	LD	HL,0000H
     199/      3B : 11 02 00            	LD	DE,0002H
     200/      3E : CD E7 0F            	CALL	ROMFILEREAD
     201/      41 : DD 21 37 28         	LD	IX,F_CGROM60
     202/      45 : 21 00 A0            	LD	HL,0A000H
     203/      48 : 11 02 00            	LD	DE,0002H
     204/      4B : CD E7 0F            	CALL	ROMFILEREAD
     205/      4E : C3 D8 00            	JP	READEND
     206/      51 :                     
     207/      51 : 3D                  RDM2:	DEC	A
     208/      52 : 20 43               	JR	NZ,RDM3
     209/      54 :                     		;
     210/      54 :                     		; ROM read (mk2)
     211/      54 :                     		;
     212/      54 : DD 21 42 28         	LD	IX,F_BASICROM62
     213/      58 : 21 00 00            	LD	HL,0000H
     214/      5B : 11 03 00            	LD	DE,0003H
     215/      5E : CD E7 0F            	CALL	ROMFILEREAD
     216/      61 : DD 21 4D 28         	LD	IX,F_CGROM62
     217/      65 : 21 00 A0            	LD	HL,0A000H
     218/      68 : 11 03 00            	LD	DE,0003H
     219/      6B : CD E7 0F            	CALL	ROMFILEREAD
     220/      6E : DD 21 58 28         	LD	IX,F_CG2ROM62
     221/      72 : 21 00 80            	LD	HL,08000H
     222/      75 : 11 03 00            	LD	DE,0003H
     223/      78 : CD E7 0F            	CALL	ROMFILEREAD
     224/      7B : DD 21 63 28         	LD	IX,F_KANJIROM62
     225/      7F : 21 00 00            	LD	HL,0000H
     226/      82 : 11 04 00            	LD	DE,0004H
     227/      85 : CD E7 0F            	CALL	ROMFILEREAD
     228/      88 : DD 21 6E 28         	LD	IX,F_VOICEROM62
     229/      8C : 21 00 C0            	LD	HL,0C000H
     230/      8F : 11 03 00            	LD	DE,0003H
     231/      92 : CD E7 0F            	CALL	ROMFILEREAD
     232/      95 : 18 41               	JR	READEND
     233/      97 :                     
     234/      97 :                     RDM3:		;
     235/      97 :                     		; ROM read (66)
     236/      97 :                     		;
     237/      97 : DD 21 79 28         	LD	IX,F_BASICROM66
     238/      9B : 21 00 00            	LD	HL,0000H
     239/      9E : 11 03 00            	LD	DE,0003H
     240/      A1 : CD E7 0F            	CALL	ROMFILEREAD
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 5 - 2/18/2013 12:10:16


     241/      A4 : DD 21 84 28         	LD	IX,F_CGROM66
     242/      A8 : 21 00 A0            	LD	HL,0A000H
     243/      AB : 11 03 00            	LD	DE,0003H
     244/      AE : CD E7 0F            	CALL	ROMFILEREAD
     245/      B1 : DD 21 8F 28         	LD	IX,F_CG2ROM66
     246/      B5 : 21 00 80            	LD	HL,08000H
     247/      B8 : 11 03 00            	LD	DE,0003H
     248/      BB : CD E7 0F            	CALL	ROMFILEREAD
     249/      BE : DD 21 9A 28         	LD	IX,F_KANJIROM66
     250/      C2 : 21 00 00            	LD	HL,0000H
     251/      C5 : 11 04 00            	LD	DE,0004H
     252/      C8 : CD E7 0F            	CALL	ROMFILEREAD
     253/      CB : DD 21 A5 28         	LD	IX,F_VOICEROM66
     254/      CF : 21 00 C0            	LD	HL,0C000H
     255/      D2 : 11 03 00            	LD	DE,0003H
     256/      D5 : CD E7 0F            	CALL	ROMFILEREAD
     257/      D8 :                     
     258/      D8 :                     READEND:
     259/      D8 : 3E 01               	LD	A,01H
     260/      DA : 32 59 23            	LD	(EXKANJIEXIST),A
     261/      DD :                     		;
     262/      DD :                     		; EXPAND KANJI ROM
     263/      DD :                     		;
     264/      DD : DD 21 B0 28         	LD	IX,F_EXKANJIROM
     265/      E1 : 21 00 00            	LD	HL,0000H
     266/      E4 : 11 06 00            	LD	DE,0006H
     267/      E7 : CD EE 0F            	CALL	ROMFILEREAD2
     268/      EA : 30 04               	JR	NC,READEND2
     269/      EC : AF                  	XOR	A
     270/      ED : 32 59 23            	LD	(EXKANJIEXIST),A
     271/      F0 :                     
     272/      F0 :                     READEND2:
     273/      F0 : CD 09 11            	CALL	ROMINIT
     274/      F3 :                     
     275/      F3 : 3E 01               	LD	A,01H
     276/      F5 : 32 02 82            	LD	(REG_SDRDDONE),A
     277/      F8 :                     
     278/      F8 : 3E 01               	LD	A,01H
     279/      FA : 32 B4 22            	LD	(SDMODE),A
     280/      FD :                     
     281/      FD :                     
     282/      FD :                     MAINSTART:
     283/      FD : 3E 02               	LD	A,02H
     284/      FF : 32 B4 22            	LD	(SDMODE),A
     285/     102 : CD 14 11            	CALL	SDCARD_OPEN
     286/     105 : CD 8A 14            	CALL	SDREGINIT
     287/     108 :                     MAINST2:
     288/     108 : 3E 01               	LD	A,01H
     289/     10A : 32 B4 22            	LD	(SDMODE),A
     290/     10D : CD 8A 14            	CALL	SDREGINIT
     291/     110 : CD 4B 15            	CALL	SDADDINIT
     292/     113 :                     
     293/     113 : CD 55 15            	CALL	KEYBUFINIT
     294/     116 :                     
     295/     116 : AF                  	XOR	A
     296/     117 : 32 BD 22            	LD	(EXROMFLAG),A
     297/     11A : 32 17 84            	LD	(REG_KEYENB),A
     298/     11D :                     
     299/     11D :                     ;
     300/     11D :                     ; main loop
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 6 - 2/18/2013 12:10:16


     301/     11D :                     ;
     302/     11D :                     MLP10:
     303/     11D : CD 3A 0B            	CALL	KEYDET
     304/     120 : 3A 2B 23            	LD	A,(FUNCPUSH+1)
     305/     123 : E6 08               	AND	08H
     306/     125 : 28 21               	JR	Z,MLP11
     307/     127 :                     
     308/     127 :                     ;
     309/     127 :                     ; F11 (reset)
     310/     127 :                     ;
     311/     127 : 21 10 84            	LD	HL,REG_CTRLSEL
     312/     12A : 36 01               	LD	(HL),01H
     313/     12C : 36 00               	LD	(HL),00H
     314/     12E :                     
     315/     12E : 21 19 23            	LD	HL,P6TCMDENB
     316/     131 : 7E                  	LD	A,(HL)
     317/     132 : EE 01               	XOR	01H
     318/     134 : 77                  	LD	(HL),A
     319/     135 : AF                  	XOR	A
     320/     136 : 32 17 84            	LD	(REG_KEYENB),A
     321/     139 : 32 C1 22            	LD	(EXTFDDST),A
     322/     13C : 3E 0A               	LD	A,0AH
     323/     13E : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset RFD
     324/     141 : 3E 0C               	LD	A,0CH
     325/     143 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset DAC
     326/     146 :                     
     327/     146 : 18 D5               	JR	MLP10
     328/     148 :                     
     329/     148 :                     MLP11:
     330/     148 : CD 60 15            	CALL	DETSDEJECT
     331/     14B : CD 68 0B            	CALL	CMTREADWAIT
     332/     14E : CD B5 0B            	CALL	CMTWRITEWAIT
     333/     151 : CD 90 15            	CALL	P6TKEYWAIT
     334/     154 : CD 0E 17            	CALL	EXTDISKWAIT
     335/     157 :                     
     336/     157 : DD 21 10 83         	LD	IX,REG_INTFDD
     337/     15B : CD 39 1D            	CALL	DISKWAIT
     338/     15E : DD 21 40 83         	LD	IX,REG_EXTFDD
     339/     162 : CD 39 1D            	CALL	DISKWAIT
     340/     165 :                     
     341/     165 : 3A 21 23            	LD	A,(CTRLNOW)
     342/     168 : E6 10               	AND	10H
     343/     16A : 28 B1               	JR	Z,MLP10
     344/     16C : 3A 29 23            	LD	A,(CTRLPUSH)
     345/     16F : E6 10               	AND	10H
     346/     171 :                     
     347/     171 : C4 55 03            	CALL	NZ,PAGE0INIT
     348/     174 :                     
     349/     174 :                     ;
     350/     174 :                     ; control panel display
     351/     174 :                     ;
     352/     174 :                     MLP12:
     353/     174 :                     
     354/     174 : CD DE 07            	CALL	DISPPAGE
     355/     177 : CD 5A 0A            	CALL	DISPCUR
     356/     17A :                     
     357/     17A : CD 7F 01            	CALL	KEYINPAGE
     358/     17D :                     
     359/     17D : 18 9E               	JR	MLP10
     360/     17F :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 7 - 2/18/2013 12:10:16


     361/     17F :                     
     362/     17F :                     
     363/     17F :                     ;
     364/     17F :                     ; page # keyin process
     365/     17F :                     ;
     366/     17F :                     KEYINPAGE:
     367/     17F : 3A B8 22            	LD	A,(PAGENUM)
     368/     182 : B7                  	OR	A
     369/     183 : CA 91 01            	JP	Z,KEYINPAGE0
     370/     186 : FE 01               	CP	01H
     371/     188 : CA 47 03            	JP	Z,KEYINPAGE1
     372/     18B : FE 02               	CP	02H
     373/     18D : CA C0 06            	JP	Z,KEYINPAGE2
     374/     190 :                     
     375/     190 : C9                  	RET
     376/     191 :                     
     377/     191 :                     ;
     378/     191 :                     ; page 0 keyin process
     379/     191 :                     ;
     380/     191 :                     KEYINPAGE0:
     381/     191 :                     
     382/     191 : 21 2A 23            	LD	HL,FUNCPUSH
     383/     194 :                     		; F7 - F0,ESC
     384/     194 :                     
     385/     194 : 23                  	INC	HL
     386/     195 :                     		; TAB,RETURN,SPACE,F12 - F8
     387/     195 :                     
     388/     195 : CB 6E               	BIT	5,(HL)
     389/     197 : 28 18               	JR	Z,KP0LS
     390/     199 :                     
     391/     199 :                     PAGE2INIT:
     392/     199 : 3E 02               	LD	A,02H
     393/     19B : 32 B8 22            	LD	(PAGENUM),A
     394/     19E : 3D                  	DEC	A
     395/     19F : 32 BA 22            	LD	(PAGEREDRAW),A
     396/     1A2 : 32 BB 22            	LD	(CURSORREDRAW),A
     397/     1A5 : 21 03 28            	LD	HL,PAGE2CURDATA
     398/     1A8 : 11 2D 23            	LD	DE,CURSOR_ADD
     399/     1AB : 01 03 00            	LD	BC,0003H
     400/     1AE : ED B0               	LDIR
     401/     1B0 : C9                  	RET
     402/     1B1 :                     
     403/     1B1 : CB 76               KP0LS:	BIT	6,(HL)
     404/     1B3 : CA 91 02            	JP	Z,KP0L0
     405/     1B6 :                     
     406/     1B6 :                     ;
     407/     1B6 :                     ; return
     408/     1B6 :                     ;
     409/     1B6 : 3E 01               	LD	A,01H
     410/     1B8 : 32 BA 22            	LD	(PAGEREDRAW),A
     411/     1BB : 32 BB 22            	LD	(CURSORREDRAW),A
     412/     1BE :                     
     413/     1BE : 2A 2D 23            	LD	HL,(CURSOR_ADD)
     414/     1C1 : 29                  	ADD	HL,HL
     415/     1C2 : 29                  	ADD	HL,HL
     416/     1C3 : 29                  	ADD	HL,HL
     417/     1C4 : 7C                  	LD	A,H
     418/     1C5 : D6 03               KP0L00:	SUB	03H
     419/     1C7 : 20 0D               	JR	NZ,KP0L01
     420/     1C9 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 8 - 2/18/2013 12:10:16


     421/     1C9 : AF                  	XOR	A
     422/     1CA : 32 B9 22            	LD	(BEFPAGENUM),A
     423/     1CD : 3E 04               	LD	A,04H
     424/     1CF : 32 BC 22            	LD	(FILESEL),A
     425/     1D2 : CD D0 02            	CALL	FILESELINIT
     426/     1D5 : C9                  	RET
     427/     1D6 :                     
     428/     1D6 : FE 01               KP0L01:	CP	01H
     429/     1D8 : 20 1B               	JR	NZ,KP0L02
     430/     1DA :                     
     431/     1DA : 21 34 82            	LD	HL,REG_CMTRD
     432/     1DD : 36 02               	LD	(HL),02H
     433/     1DF : 36 00               	LD	(HL),00H
     434/     1E1 : 3A B5 22            	LD	A,(READFLAG)
     435/     1E4 : B7                  	OR	A
     436/     1E5 : C8                  	RET	Z
     437/     1E6 :                     
     438/     1E6 : 2A 2B 82            	LD	HL,(REG_FIFO_0+FIFO_STCL)
     439/     1E9 : 22 28 82            	LD	(REG_FIFO_0+FIFO_CL),HL
     440/     1EC : AF                  	XOR	A
     441/     1ED : 32 2A 82            	LD	(REG_FIFO_0+FIFO_SEC),A
     442/     1F0 : 3C                  	INC	A
     443/     1F1 : 32 B5 22            	LD	(READFLAG),A
     444/     1F4 : C9                  	RET
     445/     1F5 :                     
     446/     1F5 : FE 02               KP0L02:	CP	02H
     447/     1F7 : 20 12               	JR	NZ,KP0L04
     448/     1F9 :                     
     449/     1F9 : 3A 04 82            	LD	A,(REG_SDWP)
     450/     1FC : B7                  	OR	A
     451/     1FD : C0                  	RET	NZ
     452/     1FE : AF                  	XOR	A
     453/     1FF : 32 B9 22            	LD	(BEFPAGENUM),A
     454/     202 : 3E 0C               	LD	A,0CH
     455/     204 : 32 BC 22            	LD	(FILESEL),A
     456/     207 : CD D0 02            	CALL	FILESELINIT
     457/     20A : C9                  	RET
     458/     20B :                     
     459/     20B : FE 04               KP0L04:	CP	04H
     460/     20D : 20 0F               	JR	NZ,KP0L05
     461/     20F :                     
     462/     20F : 21 12 84            	LD	HL,REG_MEM16K
     463/     212 : 7E                  	LD	A,(HL)
     464/     213 : EE 01               	XOR	01H
     465/     215 : 77                  	LD	(HL),A
     466/     216 :                     
     467/     216 : 21 11 84            	LD	HL,REG_CTRLRST
     468/     219 : 36 01               	LD	(HL),01H
     469/     21B : 36 00               	LD	(HL),00H
     470/     21D : C9                  	RET
     471/     21E :                     
     472/     21E : FE 05               KP0L05:	CP	05H
     473/     220 : 20 0D               	JR	NZ,KP0L06
     474/     222 :                     
     475/     222 : AF                  	XOR	A
     476/     223 : 32 B9 22            	LD	(BEFPAGENUM),A
     477/     226 : 3E 05               	LD	A,05H
     478/     228 : 32 BC 22            	LD	(FILESEL),A
     479/     22B : CD D0 02            	CALL	FILESELINIT
     480/     22E : C9                  	RET
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 9 - 2/18/2013 12:10:16


     481/     22F :                     
     482/     22F : FE 06               KP0L06:	CP	06H
     483/     231 : 20 0A               	JR	NZ,KP0L08
     484/     233 :                     
     485/     233 : 21 1C 84            	LD	HL,REG_EXKANJIENB
     486/     236 : 46                  	LD	B,(HL)
     487/     237 : 3A 59 23            	LD	A,(EXKANJIEXIST)
     488/     23A : A8                  	XOR	B
     489/     23B : 77                  	LD	(HL),A
     490/     23C : C9                  	RET
     491/     23D :                     
     492/     23D : FE 08               KP0L08:	CP	08H
     493/     23F : 20 1E               	JR	NZ,KP0L09
     494/     241 :                     
     495/     241 : 21 13 84            	LD	HL,REG_SC4MODE
     496/     244 : 7E                  	LD	A,(HL)
     497/     245 : CB 67               	BIT	4,A
     498/     247 : 20 06               	JR	NZ,KP0L081
     499/     249 : F6 10               	OR	10H
     500/     24B : E6 FC               	AND	0FCH
     501/     24D : 77                  	LD	(HL),A
     502/     24E : C9                  	RET
     503/     24F :                     
     504/     24F :                     KP0L081:
     505/     24F : E6 03               	AND	03H
     506/     251 : 3C                  	INC	A
     507/     252 : E6 03               	AND	03H
     508/     254 : 47                  	LD	B,A
     509/     255 : 7E                  	LD	A,(HL)
     510/     256 : 20 02               	JR	NZ,KP0L082
     511/     258 : E6 EF               	AND	0EFH
     512/     25A :                     KP0L082:
     513/     25A : E6 FC               	AND	0FCH
     514/     25C : B0                  	OR	B
     515/     25D : 77                  	LD	(HL),A
     516/     25E : C9                  	RET
     517/     25F :                     
     518/     25F : FE 09               KP0L09:	CP	09H
     519/     261 : C0                  	RET	NZ
     520/     262 :                     
     521/     262 : 3A 58 23            	LD	A,(UART_BAUD)
     522/     265 : 3C                  	INC	A
     523/     266 : FE 18               	CP	18H
     524/     268 : 20 09               	JR	NZ,KP0L91
     525/     26A : AF                  	XOR	A
     526/     26B : 32 18 84            	LD	(REG_UARTENB),A
     527/     26E : 32 58 23            	LD	(UART_BAUD),A
     528/     271 : 18 08               	JR	KP0L92
     529/     273 :                     KP0L91:
     530/     273 : 32 58 23            	LD	(UART_BAUD),A
     531/     276 : 3E 01               	LD	A,01H
     532/     278 : 32 18 84            	LD	(REG_UARTENB),A
     533/     27B :                     KP0L92:
     534/     27B : 3A 58 23            	LD	A,(UART_BAUD)
     535/     27E : 6F                  	LD	L,A
     536/     27F : 87                  	ADD	A,A
     537/     280 : 85                  	ADD	A,L
     538/     281 : 6F                  	LD	L,A
     539/     282 : 26 00               	LD	H,00H
     540/     284 : 11 9D 27            	LD	DE,TB_UARTBAUD
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 10 - 2/18/2013 12:10:16


     541/     287 : 19                  	ADD	HL,DE
     542/     288 : 11 19 84            	LD	DE,REG_UARTLEN
     543/     28B : 01 03 00            	LD	BC,0003H
     544/     28E : ED B0               	LDIR
     545/     290 :                     
     546/     290 : C9                  	RET
     547/     291 :                     
     548/     291 :                     
     549/     291 : 23                  KP0L0:	INC	HL
     550/     292 :                     		; END,ALT,SHIFT,CTRL,<-,->,v,^
     551/     292 :                     
     552/     292 : CB 46               	BIT	0,(HL)
     553/     294 : 28 04               	JR	Z,KP0L1
     554/     296 :                     
     555/     296 :                     ;
     556/     296 :                     ; cursor up
     557/     296 :                     ;
     558/     296 : 0E FF               	LD	C,0FFH
     559/     298 : 18 07               	JR	PAGE0CURMOV
     560/     29A :                     
     561/     29A :                     KP0L1:
     562/     29A : CB 4E               	BIT	1,(HL)
     563/     29C : C8                  	RET	Z
     564/     29D :                     
     565/     29D :                     ;
     566/     29D :                     ; cursor down
     567/     29D :                     ;
     568/     29D : 0E 01               	LD	C,01H
     569/     29F : 18 00               	JR	PAGE0CURMOV
     570/     2A1 :                     
     571/     2A1 :                     ;
     572/     2A1 :                     ; page 0 keyin sub
     573/     2A1 :                     ;
     574/     2A1 :                     PAGE0CURMOV:
     575/     2A1 : 3E 01               	LD	A,01H
     576/     2A3 : 32 BB 22            	LD	(CURSORREDRAW),A
     577/     2A6 :                     
     578/     2A6 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
     579/     2A9 : 29                  	ADD	HL,HL
     580/     2AA : 29                  	ADD	HL,HL
     581/     2AB : 29                  	ADD	HL,HL
     582/     2AC : 7C                  	LD	A,H
     583/     2AD : D6 03               	SUB	03H
     584/     2AF :                     
     585/     2AF : 81                  	ADD	A,C
     586/     2B0 : FE 0A               	CP	0AH
     587/     2B2 : D0                  	RET	NC
     588/     2B3 :                     
     589/     2B3 : FE 03               	CP	03H
     590/     2B5 : 20 01               	JR	NZ,P0CL0
     591/     2B7 : 81                  	ADD	A,C
     592/     2B8 :                     P0CL0:
     593/     2B8 : FE 07               	CP	07H
     594/     2BA : 20 01               	JR	NZ,P0CL2
     595/     2BC : 81                  	ADD	A,C
     596/     2BD :                     P0CL2:
     597/     2BD : 47                  	LD	B,A
     598/     2BE : 87                  	ADD	A,A
     599/     2BF : 80                  	ADD	A,B
     600/     2C0 : 5F                  	LD	E,A
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 11 - 2/18/2013 12:10:16


     601/     2C1 : 16 00               	LD	D,00H
     602/     2C3 : 21 E5 27            	LD	HL,PAGE0CURDATA
     603/     2C6 : 19                  	ADD	HL,DE
     604/     2C7 : 11 2D 23            	LD	DE,CURSOR_ADD
     605/     2CA : 01 03 00            	LD	BC,0003H
     606/     2CD : ED B0               	LDIR
     607/     2CF :                     
     608/     2CF : C9                  	RET
     609/     2D0 :                     
     610/     2D0 :                     ;
     611/     2D0 :                     ; page 0 keyin sub
     612/     2D0 :                     ; file selector initialize
     613/     2D0 :                     ;
     614/     2D0 :                     FILESELINIT:
     615/     2D0 : 21 00 00            	LD	HL,0000H
     616/     2D3 : 22 A0 22            	LD	(DIRCL),HL
     617/     2D6 : 2B                  	DEC	HL
     618/     2D7 : 22 A2 22            	LD	(DIRPOS),HL
     619/     2DA : 3E 01               	LD	A,01H
     620/     2DC : 32 B8 22            	LD	(PAGENUM),A
     621/     2DF : CD 4B 15            	CALL	SDADDINIT
     622/     2E2 :                     		;
     623/     2E2 : 3A BC 22            	LD	A,(FILESEL)
     624/     2E5 : FE 04               	CP	04H
     625/     2E7 : 20 09               	JR	NZ,FSIL1
     626/     2E9 :                     		;
     627/     2E9 : FD 21 20 82         	LD	IY,REG_FIFO_0
     628/     2ED : AF                  	XOR	A
     629/     2EE : 32 10 82            	LD	(REG_BUFAD),A
     630/     2F1 : C9                  	RET
     631/     2F2 : FE 05               FSIL1:	CP	05H
     632/     2F4 : 20 09               	JR	NZ,FSIL2
     633/     2F6 :                     		;
     634/     2F6 : FD 21 20 82         	LD	IY,REG_FIFO_0
     635/     2FA : AF                  	XOR	A
     636/     2FB : 32 10 82            	LD	(REG_BUFAD),A
     637/     2FE : C9                  	RET
     638/     2FF : FE 06               FSIL2:	CP	06H
     639/     301 : 20 0A               	JR	NZ,FSIL3
     640/     303 :                     		;
     641/     303 : FD 21 60 82         	LD	IY,REG_FIFO_2
     642/     307 : 3E 04               	LD	A,04H
     643/     309 : 32 10 82            	LD	(REG_BUFAD),A
     644/     30C : C9                  	RET
     645/     30D : FE 07               FSIL3:	CP	07H
     646/     30F : 20 0A               	JR	NZ,FSIL4
     647/     311 :                     		;
     648/     311 : FD 21 80 82         	LD	IY,REG_FIFO_3
     649/     315 : 3E 05               	LD	A,05H
     650/     317 : 32 10 82            	LD	(REG_BUFAD),A
     651/     31A : C9                  	RET
     652/     31B : FE 0C               FSIL4:	CP	0CH
     653/     31D : 20 0A               	JR	NZ,FSIL5
     654/     31F :                     		;
     655/     31F : FD 21 40 82         	LD	IY,REG_FIFO_1
     656/     323 : 3E 01               	LD	A,01H
     657/     325 : 32 10 82            	LD	(REG_BUFAD),A
     658/     328 : C9                  	RET
     659/     329 : FE 0E               FSIL5:	CP	0EH
     660/     32B : 20 0A               	JR	NZ,FSIL6
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 12 - 2/18/2013 12:10:16


     661/     32D :                     		;
     662/     32D : FD 21 A0 82         	LD	IY,REG_FIFO_4
     663/     331 : 3E 06               	LD	A,06H
     664/     333 : 32 10 82            	LD	(REG_BUFAD),A
     665/     336 : C9                  	RET
     666/     337 : FE 0F               FSIL6:	CP	0FH
     667/     339 : 20 0A               	JR	NZ,FSIL7
     668/     33B :                     		;
     669/     33B : FD 21 C0 82         	LD	IY,REG_FIFO_5
     670/     33F : 3E 07               	LD	A,07H
     671/     341 : 32 10 82            	LD	(REG_BUFAD),A
     672/     344 : C9                  	RET
     673/     345 : 18 FE               FSIL7:	JR	FSIL7
     674/     347 :                     
     675/     347 :                     ;
     676/     347 :                     ; page 1 keyin process
     677/     347 :                     ;
     678/     347 :                     KEYINPAGE1:
     679/     347 :                     
     680/     347 : 21 2A 23            	LD	HL,FUNCPUSH
     681/     34A :                     		; F7 - F0,ESC
     682/     34A :                     
     683/     34A : CB 46               	BIT	0,(HL)
     684/     34C : 28 1E               	JR	Z,KP1L0
     685/     34E :                     
     686/     34E :                     ;
     687/     34E :                     ; ESC
     688/     34E :                     ;
     689/     34E :                     PAGEINIT:
     690/     34E : 3A B9 22            	LD	A,(BEFPAGENUM)
     691/     351 : B7                  	OR	A
     692/     352 : C2 99 01            	JP	NZ,PAGE2INIT
     693/     355 :                     
     694/     355 :                     PAGE0INIT:
     695/     355 : AF                  	XOR	A
     696/     356 : 32 B8 22            	LD	(PAGENUM),A
     697/     359 : 3C                  	INC	A
     698/     35A : 32 BA 22            	LD	(PAGEREDRAW),A
     699/     35D : 32 BB 22            	LD	(CURSORREDRAW),A
     700/     360 :                     
     701/     360 : 21 E5 27            	LD	HL,PAGE0CURDATA
     702/     363 : 11 2D 23            	LD	DE,CURSOR_ADD
     703/     366 : 01 03 00            	LD	BC,0003H
     704/     369 : ED B0               	LDIR
     705/     36B :                     
     706/     36B : C9                  	RET
     707/     36C :                     
     708/     36C : 23                  KP1L0:	INC	HL
     709/     36D :                     		; TAB,RETURN,SPACE,F12 - F8
     710/     36D :                     
     711/     36D : CB 6E               	BIT	5,(HL)
     712/     36F : 28 0C               	JR	Z,KP1L1
     713/     371 :                     
     714/     371 :                     ;
     715/     371 :                     ; space
     716/     371 :                     ;
     717/     371 :                     PAGE1REDRAW:
     718/     371 : 3E 01               	LD	A,01H
     719/     373 : 32 B8 22            	LD	(PAGENUM),A
     720/     376 : 32 BA 22            	LD	(PAGEREDRAW),A
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 13 - 2/18/2013 12:10:16


     721/     379 : 32 BB 22            	LD	(CURSORREDRAW),A
     722/     37C : C9                  	RET
     723/     37D :                     
     724/     37D : CB 76               KP1L1:	BIT	6,(HL)
     725/     37F : CA D9 05            	JP	Z,KP1L2
     726/     382 :                     
     727/     382 :                     ;
     728/     382 :                     ; return
     729/     382 :                     ;
     730/     382 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
     731/     385 : CD 66 06            	CALL	CUR2BUF
     732/     388 : 23                  	INC	HL
     733/     389 : 7C                  	LD	A,H
     734/     38A : B5                  	OR	L
     735/     38B : 2B                  	DEC	HL
     736/     38C : 20 75               	JR	NZ,KP1L1_SEL1
     737/     38E :                     
     738/     38E :                     		;
     739/     38E :                     		; file "no select"
     740/     38E :                     		;
     741/     38E :                     KP1L1_NOSELECT:
     742/     38E : 3A BC 22            	LD	A,(FILESEL)
     743/     391 : FE 04               	CP	04H
     744/     393 : 20 0D               	JR	NZ,KP1L1_NOSEL1
     745/     395 :                     		;
     746/     395 :                     		; CMT load "no select"
     747/     395 :                     		;
     748/     395 : CD F4 14            	CALL	SDREGINIT_0
     749/     398 :                     
     750/     398 : 11 AC 23            	LD	DE,ST_CMTREAD_VAL
     751/     39B :                     
     752/     39B :                     KP1L1_NOSELEND:
     753/     39B : CD 42 15            	CALL	LD_ST_NOSELECT
     754/     39E : CD 4E 03            	CALL	PAGEINIT
     755/     3A1 : C9                  	RET
     756/     3A2 :                     
     757/     3A2 :                     KP1L1_NOSEL1:
     758/     3A2 : FE 05               	CP	05H
     759/     3A4 : 20 18               	JR	NZ,KP1L1_NOSEL2
     760/     3A6 :                     		;
     761/     3A6 :                     		; EXT.ROM "no select"
     762/     3A6 :                     		;
     763/     3A6 : 3E 01               	LD	A,01H
     764/     3A8 : 32 11 84            	LD	(REG_CTRLRST),A
     765/     3AB : CD 09 11            	CALL	ROMINIT
     766/     3AE : AF                  	XOR	A
     767/     3AF : 32 11 84            	LD	(REG_CTRLRST),A
     768/     3B2 :                     
     769/     3B2 : CD F4 14            	CALL	SDREGINIT_0
     770/     3B5 :                     
     771/     3B5 : AF                  	XOR	A
     772/     3B6 : 32 BD 22            	LD	(EXROMFLAG),A
     773/     3B9 :                     
     774/     3B9 : 11 26 24            	LD	DE,ST_EXROM_VAL
     775/     3BC : 18 DD               	JR	KP1L1_NOSELEND
     776/     3BE :                     
     777/     3BE :                     KP1L1_NOSEL2:
     778/     3BE : FE 0C               	CP	0CH
     779/     3C0 : 20 08               	JR	NZ,KP1L1_NOSEL3
     780/     3C2 :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 14 - 2/18/2013 12:10:16


     781/     3C2 :                     		; CMT save "no select"
     782/     3C2 :                     		;
     783/     3C2 : CD 19 15            	CALL	SDREGINIT_1
     784/     3C5 :                     
     785/     3C5 : 11 E9 23            	LD	DE,ST_CMTWRITE_VAL
     786/     3C8 : 18 D1               	JR	KP1L1_NOSELEND
     787/     3CA :                     
     788/     3CA :                     KP1L1_NOSEL3:
     789/     3CA : FE 06               	CP	06H
     790/     3CC : 20 0C               	JR	NZ,KP1L1_NOSEL4
     791/     3CE :                     		;
     792/     3CE :                     		; INT FDD#0 "no select"
     793/     3CE :                     		;
     794/     3CE : FD 21 60 82         	LD	IY,REG_FIFO_2
     795/     3D2 : 11 C2 24            	LD	DE,ST_FDD0INTFILE_VAL
     796/     3D5 :                     
     797/     3D5 :                     KP1L1_NOSELFDD:
     798/     3D5 : CD 31 15            	CALL	SDREGINIT_2
     799/     3D8 : 18 C1               	JR	KP1L1_NOSELEND
     800/     3DA :                     
     801/     3DA :                     KP1L1_NOSEL4:
     802/     3DA : FE 07               	CP	07H
     803/     3DC : 20 09               	JR	NZ,KP1L1_NOSEL5
     804/     3DE :                     		;
     805/     3DE :                     		; INT FDD#1 "no select"
     806/     3DE :                     		;
     807/     3DE : FD 21 80 82         	LD	IY,REG_FIFO_3
     808/     3E2 : 11 03 25            	LD	DE,ST_FDD1INTFILE_VAL
     809/     3E5 : 18 EE               	JR	KP1L1_NOSELFDD
     810/     3E7 :                     
     811/     3E7 :                     KP1L1_NOSEL5:
     812/     3E7 : FE 0E               	CP	0EH
     813/     3E9 : 20 09               	JR	NZ,KP1L1_NOSEL6
     814/     3EB :                     		;
     815/     3EB :                     		; EXT FDD#0 "no select"
     816/     3EB :                     		;
     817/     3EB : FD 21 A0 82         	LD	IY,REG_FIFO_4
     818/     3EF : 11 44 25            	LD	DE,ST_FDD0EXTFILE_VAL
     819/     3F2 : 18 E1               	JR	KP1L1_NOSELFDD
     820/     3F4 :                     
     821/     3F4 :                     KP1L1_NOSEL6:
     822/     3F4 : FE 0F               	CP	0FH
     823/     3F6 : 20 09               	JR	NZ,KP1L1_NOSEL7
     824/     3F8 :                     		;
     825/     3F8 :                     		; EXT FDD#1 "no select"
     826/     3F8 :                     		;
     827/     3F8 : FD 21 C0 82         	LD	IY,REG_FIFO_5
     828/     3FC : 11 85 25            	LD	DE,ST_FDD1EXTFILE_VAL
     829/     3FF : 18 D4               	JR	KP1L1_NOSELFDD
     830/     401 :                     
     831/     401 :                     KP1L1_NOSEL7:
     832/     401 : 18 FE               	JR	KP1L1_NOSEL7
     833/     403 :                     
     834/     403 :                     		;
     835/     403 :                     		; file / directory judge
     836/     403 :                     		;
     837/     403 :                     KP1L1_SEL1:
     838/     403 : 22 A2 22            	LD	(DIRPOS),HL
     839/     406 :                     		;
     840/     406 : 3E 01               	LD	A,01H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 15 - 2/18/2013 12:10:16


     841/     408 : 32 01 82            	LD	(REG_SDCTRL),A
     842/     40B : CD AC 11            	CALL	READ_DIRFILE
     843/     40E : AF                  	XOR	A
     844/     40F : 32 01 82            	LD	(REG_SDCTRL),A
     845/     412 :                     		;
     846/     412 : 01 0B 00            	LD	BC,000BH
     847/     415 : 09                  	ADD	HL,BC
     848/     416 : 7E                  	LD	A,(HL)
     849/     417 : 01 0F 00            	LD	BC,000FH
     850/     41A : 09                  	ADD	HL,BC
     851/     41B : 5E                  	LD	E,(HL)
     852/     41C : 23                  	INC	HL
     853/     41D : 56                  	LD	D,(HL)
     854/     41E : 2B                  	DEC	HL
     855/     41F : E6 10               	AND	10H
     856/     421 : 28 13               	JR	Z,KP1L11
     857/     423 :                     
     858/     423 :                     		;
     859/     423 :                     		; select directory
     860/     423 :                     		;
     861/     423 : EB                  	EX	DE,HL
     862/     424 : 22 A0 22            	LD	(DIRCL),HL
     863/     427 : 7C                  	LD	A,H
     864/     428 : B5                  	OR	L
     865/     429 : 21 FF FF            	LD	HL,0FFFFH
     866/     42C : 28 01               	JR	Z,KP1L1_ROOT
     867/     42E : 23                  	INC	HL
     868/     42F :                     KP1L1_ROOT:
     869/     42F : 22 A2 22            	LD	(DIRPOS),HL
     870/     432 : CD 71 03            	CALL	PAGE1REDRAW
     871/     435 : C9                  	RET
     872/     436 :                     
     873/     436 :                     KP1L11:
     874/     436 : 3A BC 22            	LD	A,(FILESEL)
     875/     439 : FE 04               	CP	04H
     876/     43B : 20 38               	JR	NZ,KP1L1_FS1
     877/     43D :                     
     878/     43D :                     		;
     879/     43D :                     		; CMT load file name
     880/     43D :                     		;
     881/     43D : CD F4 14            	CALL	SDREGINIT_0
     882/     440 : CD 88 06            	CALL	SETFILEPARA
     883/     443 :                     
     884/     443 : 3E 01               	LD	A,01H
     885/     445 : 32 B5 22            	LD	(READFLAG),A
     886/     448 :                     
     887/     448 : 11 AC 23            	LD	DE,ST_CMTREAD_VAL
     888/     44B : 2A 2D 23            	LD	HL,(CURSOR_ADD)
     889/     44E : 01 00 C2            	LD	BC,CTRLVRAM
     890/     451 : 09                  	ADD	HL,BC
     891/     452 : E5                  	PUSH	HL
     892/     453 : 01 0C 00            	LD	BC,000CH
     893/     456 : ED B0               	LDIR
     894/     458 :                     
     895/     458 : AF                  	XOR	A
     896/     459 : 32 1B 23            	LD	(P6TFILEREAD),A
     897/     45C :                     
     898/     45C : E1                  	POP	HL
     899/     45D : 11 09 00            	LD	DE,0009H
     900/     460 : 19                  	ADD	HL,DE
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 16 - 2/18/2013 12:10:16


     901/     461 : 11 93 25            	LD	DE,ST_P6T
     902/     464 : 06 03               	LD	B,03H
     903/     466 : CD 65 13            	CALL	CP_MHL_MDE
     904/     469 : 20 06               	JR	NZ,KP1L1_NOP6T
     905/     46B :                     
     906/     46B : CD 9A 16            	CALL	READP6T
     907/     46E : 32 1B 23            	LD	(P6TFILEREAD),A
     908/     471 :                     
     909/     471 :                     KP1L1_NOP6T:
     910/     471 : CD 4E 03            	CALL	PAGEINIT
     911/     474 :                     
     912/     474 : C9                  	RET
     913/     475 :                     
     914/     475 :                     KP1L1_FS1:
     915/     475 : FE 05               	CP	05H
     916/     477 : 20 4A               	JR	NZ,KP1L1_FS2
     917/     479 :                     
     918/     479 :                     		;
     919/     479 :                     		; EXT. ROM load file name
     920/     479 :                     		;
     921/     479 : CD F4 14            	CALL	SDREGINIT_0
     922/     47C : CD 88 06            	CALL	SETFILEPARA
     923/     47F :                     
     924/     47F : 11 26 24            	LD	DE,ST_EXROM_VAL
     925/     482 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
     926/     485 : 01 00 C2            	LD	BC,CTRLVRAM
     927/     488 : 09                  	ADD	HL,BC
     928/     489 : 01 0C 00            	LD	BC,000CH
     929/     48C : ED B0               	LDIR
     930/     48E :                     
     931/     48E : 11 AC 23            	LD	DE,ST_CMTREAD_VAL
     932/     491 : CD 42 15            	CALL	LD_ST_NOSELECT
     933/     494 :                     
     934/     494 : CD 4E 03            	CALL	PAGEINIT
     935/     497 :                     
     936/     497 :                     
     937/     497 : 3E 01               	LD	A,01H
     938/     499 : 32 11 84            	LD	(REG_CTRLRST),A
     939/     49C :                     		;
     940/     49C : CD 09 11            	CALL	ROMINIT
     941/     49F :                     		;
     942/     49F : AF                  	XOR	A
     943/     4A0 : 32 10 82            	LD	(REG_BUFAD),A
     944/     4A3 : FD 36 04 00         	LD	(IY+FIFO_CMTPTR+0),00H
     945/     4A7 : FD 36 05 C0         	LD	(IY+FIFO_CMTPTR+1),0C0H
     946/     4AB : FD 36 06 02         	LD	(IY+FIFO_CMTPTR+2),02H
     947/     4AF : FD 36 07 00         	LD	(IY+FIFO_CMTPTR+3),00H
     948/     4B3 :                     		;
     949/     4B3 : CD 3C 10            	CALL	FILEREAD
     950/     4B6 :                     		;
     951/     4B6 : AF                  	XOR	A
     952/     4B7 : 32 11 84            	LD	(REG_CTRLRST),A
     953/     4BA :                     		;
     954/     4BA : CD F4 14            	CALL	SDREGINIT_0
     955/     4BD :                     		;
     956/     4BD : 3E 01               	LD	A,01H
     957/     4BF : 32 BD 22            	LD	(EXROMFLAG),A
     958/     4C2 :                     
     959/     4C2 : C9                  	RET
     960/     4C3 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 17 - 2/18/2013 12:10:16


     961/     4C3 :                     
     962/     4C3 :                     KP1L1_FS2:
     963/     4C3 : FE 0C               	CP	0CH
     964/     4C5 : 20 23               	JR	NZ,KP1L1_FS3
     965/     4C7 :                     
     966/     4C7 :                     		;
     967/     4C7 :                     		; CMT save file name
     968/     4C7 :                     		;
     969/     4C7 : CD 19 15            	CALL	SDREGINIT_1
     970/     4CA : CD 88 06            	CALL	SETFILEPARA
     971/     4CD :                     
     972/     4CD : 11 E9 23            	LD	DE,ST_CMTWRITE_VAL
     973/     4D0 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
     974/     4D3 : 01 00 C2            	LD	BC,CTRLVRAM
     975/     4D6 : 09                  	ADD	HL,BC
     976/     4D7 : 01 0C 00            	LD	BC,000CH
     977/     4DA : ED B0               	LDIR
     978/     4DC :                     
     979/     4DC : CD 4E 03            	CALL	PAGEINIT
     980/     4DF :                     
     981/     4DF : 3E 04               	LD	A,04H
     982/     4E1 : 32 54 82            	LD	(REG_CMTWR),A
     983/     4E4 :                     
     984/     4E4 : 3E 01               	LD	A,01H
     985/     4E6 : 32 B6 22            	LD	(WRITEFLAG),A
     986/     4E9 :                     
     987/     4E9 : C9                  	RET
     988/     4EA :                     
     989/     4EA :                     
     990/     4EA :                     KP1L1_FS3:
     991/     4EA : FE 06               	CP	06H
     992/     4EC : C2 AD 05            	JP	NZ,KP1L1_FS4
     993/     4EF :                     
     994/     4EF :                     		;
     995/     4EF :                     		; INT FDD#0 file name
     996/     4EF :                     		;
     997/     4EF : FD 21 60 82         	LD	IY,REG_FIFO_2
     998/     4F3 : 11 C2 24            	LD	DE,ST_FDD0INTFILE_VAL
     999/     4F6 :                     
    1000/     4F6 :                     KP1L1_FDD:
    1001/     4F6 : D5                  	PUSH	DE
    1002/     4F7 : CD 31 15            	CALL	SDREGINIT_2
    1003/     4FA : CD 88 06            	CALL	SETFILEPARA
    1004/     4FD :                     
    1005/     4FD :                     		;
    1006/     4FD :                     		; read only -> write protect set
    1007/     4FD :                     		;
    1008/     4FD : 01 14 00            	LD	BC,0014H
    1009/     500 : B7                  	OR	A
    1010/     501 : ED 42               	SBC	HL,BC
    1011/     503 : 7E                  	LD	A,(HL)
    1012/     504 : E6 01               	AND	01H
    1013/     506 : 28 05               	JR	Z,KP1L1_FDD_RW
    1014/     508 : 3E 08               	LD	A,08H
    1015/     50A : FD 77 14            	LD	(IY+FIFO_FLOPPY),A
    1016/     50D :                     
    1017/     50D :                     KP1L1_FDD_RW:
    1018/     50D : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1019/     510 : 01 00 C2            	LD	BC,CTRLVRAM
    1020/     513 : 09                  	ADD	HL,BC
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 18 - 2/18/2013 12:10:16


    1021/     514 : 01 0C 00            	LD	BC,000CH
    1022/     517 : ED B0               	LDIR
    1023/     519 :                     
    1024/     519 : D1                  	POP	DE
    1025/     51A :                     
    1026/     51A :                     		;
    1027/     51A :                     		; file length check (>= 0x000002B0)
    1028/     51A :                     		;
    1029/     51A : FD 7E 03            	LD	A,(IY+FIFO_CMTLEN+3)
    1030/     51D : B7                  	OR	A
    1031/     51E : 20 1B               	JR	NZ,KP1L1_LEN_OK
    1032/     520 : FD 7E 02            	LD	A,(IY+FIFO_CMTLEN+2)
    1033/     523 : B7                  	OR	A
    1034/     524 : 20 15               	JR	NZ,KP1L1_LEN_OK
    1035/     526 : FD 7E 01            	LD	A,(IY+FIFO_CMTLEN+1)
    1036/     529 : B7                  	OR	A
    1037/     52A : 28 75               	JR	Z,KP1L1_LEN_0
    1038/     52C : FE 02               	CP	02H
    1039/     52E : DA D5 03            	JP	C,KP1L1_NOSELFDD
    1040/     531 : 20 08               	JR	NZ,KP1L1_LEN_OK
    1041/     533 : FD 7E 00            	LD	A,(IY+FIFO_CMTLEN+0)
    1042/     536 : FE B0               	CP	0B0H
    1043/     538 : DA D5 03            	JP	C,KP1L1_NOSELFDD
    1044/     53B :                     
    1045/     53B :                     KP1L1_LEN_OK:
    1046/     53B : D5                  	PUSH	DE
    1047/     53C : 3E 01               	LD	A,01H
    1048/     53E : 32 01 82            	LD	(REG_SDCTRL),A
    1049/     541 : 32 11 82            	LD	(REG_BUFSEL),A
    1050/     544 :                     
    1051/     544 : 01 00 00            	LD	BC,0000H
    1052/     547 : 11 1A 00            	LD	DE,001AH
    1053/     54A : CD C6 0E            	CALL	JMPREADPTR
    1054/     54D :                     
    1055/     54D : CD F6 0E            	CALL	READ1BYTE
    1056/     550 : 4F                  	LD	C,A		; disk write protect
    1057/     551 : CD F6 0E            	CALL	READ1BYTE
    1058/     554 : 47                  	LD	B,A		; disk type
    1059/     555 : C5                  	PUSH	BC
    1060/     556 :                     
    1061/     556 :                     		;
    1062/     556 :                     		; disk size compare
    1063/     556 :                     		;
    1064/     556 : CD F6 0E            	CALL	READ1BYTE
    1065/     559 : FD 46 00            	LD	B,(IY+FIFO_CMTLEN+0)
    1066/     55C : B8                  	CP	B
    1067/     55D : 20 39               	JR	NZ,KP1L1_LEN_NG
    1068/     55F : CD F6 0E            	CALL	READ1BYTE
    1069/     562 : FD 46 01            	LD	B,(IY+FIFO_CMTLEN+1)
    1070/     565 : B8                  	CP	B
    1071/     566 : 20 30               	JR	NZ,KP1L1_LEN_NG
    1072/     568 : CD F6 0E            	CALL	READ1BYTE
    1073/     56B : FD 46 02            	LD	B,(IY+FIFO_CMTLEN+2)
    1074/     56E : B8                  	CP	B
    1075/     56F : 20 27               	JR	NZ,KP1L1_LEN_NG
    1076/     571 : CD F6 0E            	CALL	READ1BYTE
    1077/     574 : FD 46 03            	LD	B,(IY+FIFO_CMTLEN+3)
    1078/     577 : B8                  	CP	B
    1079/     578 : 20 1E               	JR	NZ,KP1L1_LEN_NG
    1080/     57A :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 19 - 2/18/2013 12:10:16


    1081/     57A : AF                  	XOR	A
    1082/     57B : 32 01 82            	LD	(REG_SDCTRL),A
    1083/     57E : C1                  	POP	BC
    1084/     57F : D1                  	POP	DE
    1085/     580 :                     
    1086/     580 :                     KP1L1_FDD_1:
    1087/     580 : FD CB 14 C6         	SET	0,(IY+FIFO_FLOPPY)
    1088/     584 : 78                  	LD	A,B
    1089/     585 : B7                  	OR	A
    1090/     586 : 28 04               	JR	Z,KP1L1_FDD_2
    1091/     588 : FD CB 14 CE         	SET	1,(IY+FIFO_FLOPPY)
    1092/     58C :                     
    1093/     58C :                     KP1L1_FDD_2:
    1094/     58C : 79                  	LD	A,C
    1095/     58D : B7                  	OR	A
    1096/     58E : 28 04               	JR	Z,KP1L1_FDD_3
    1097/     590 : FD CB 14 DE         	SET	3,(IY+FIFO_FLOPPY)
    1098/     594 :                     
    1099/     594 :                     KP1L1_FDD_3:
    1100/     594 : CD 4E 03            	CALL	PAGEINIT
    1101/     597 : C9                  	RET
    1102/     598 :                     
    1103/     598 :                     
    1104/     598 :                     KP1L1_LEN_NG:
    1105/     598 : AF                  	XOR	A
    1106/     599 : 32 01 82            	LD	(REG_SDCTRL),A
    1107/     59C : C1                  	POP	BC
    1108/     59D : D1                  	POP	DE
    1109/     59E : C3 D5 03            	JP	KP1L1_NOSELFDD
    1110/     5A1 :                     
    1111/     5A1 :                     
    1112/     5A1 :                     KP1L1_LEN_0:
    1113/     5A1 : FD 7E 00            	LD	A,(IY+FIFO_CMTLEN+0)
    1114/     5A4 : B7                  	OR	A
    1115/     5A5 : C2 D5 03            	JP	NZ,KP1L1_NOSELFDD
    1116/     5A8 :                     
    1117/     5A8 : 01 00 00            	LD	BC,0000H
    1118/     5AB : 18 D3               	JR	KP1L1_FDD_1
    1119/     5AD :                     
    1120/     5AD :                     
    1121/     5AD :                     KP1L1_FS4:
    1122/     5AD : FE 07               	CP	07H
    1123/     5AF : 20 0A               	JR	NZ,KP1L1_FS5
    1124/     5B1 :                     
    1125/     5B1 :                     		;
    1126/     5B1 :                     		; INT FDD#1 file name
    1127/     5B1 :                     		;
    1128/     5B1 : FD 21 80 82         	LD	IY,REG_FIFO_3
    1129/     5B5 : 11 03 25            	LD	DE,ST_FDD1INTFILE_VAL
    1130/     5B8 : C3 F6 04            	JP	KP1L1_FDD
    1131/     5BB :                     
    1132/     5BB :                     KP1L1_FS5:
    1133/     5BB : FE 0E               	CP	0EH
    1134/     5BD : 20 0A               	JR	NZ,KP1L1_FS6
    1135/     5BF :                     
    1136/     5BF :                     		;
    1137/     5BF :                     		; EXT FDD#0 file name
    1138/     5BF :                     		;
    1139/     5BF : FD 21 A0 82         	LD	IY,REG_FIFO_4
    1140/     5C3 : 11 44 25            	LD	DE,ST_FDD0EXTFILE_VAL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 20 - 2/18/2013 12:10:16


    1141/     5C6 : C3 F6 04            	JP	KP1L1_FDD
    1142/     5C9 :                     
    1143/     5C9 :                     KP1L1_FS6:
    1144/     5C9 : FE 0F               	CP	0FH
    1145/     5CB : 20 0A               	JR	NZ,KP1L1_FS7
    1146/     5CD :                     
    1147/     5CD :                     		;
    1148/     5CD :                     		; EXT FDD#1 file name
    1149/     5CD :                     		;
    1150/     5CD : FD 21 C0 82         	LD	IY,REG_FIFO_5
    1151/     5D1 : 11 85 25            	LD	DE,ST_FDD1EXTFILE_VAL
    1152/     5D4 : C3 F6 04            	JP	KP1L1_FDD
    1153/     5D7 :                     
    1154/     5D7 :                     
    1155/     5D7 :                     KP1L1_FS7:
    1156/     5D7 : 20 FE               	JR	NZ,KP1L1_FS7
    1157/     5D9 :                     
    1158/     5D9 :                     
    1159/     5D9 : 23                  KP1L2:	INC	HL
    1160/     5DA :                     		; END,ALT,SHIFT,CTRL,<-,->,v,^
    1161/     5DA :                     
    1162/     5DA : CB 46               	BIT	0,(HL)
    1163/     5DC : 28 1B               	JR	Z,KP1L3
    1164/     5DE :                     
    1165/     5DE :                     ;
    1166/     5DE :                     ; cursor up
    1167/     5DE :                     ;
    1168/     5DE : 3E 01               	LD	A,01H
    1169/     5E0 : 32 BB 22            	LD	(CURSORREDRAW),A
    1170/     5E3 :                     
    1171/     5E3 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1172/     5E6 : EB                  	EX	DE,HL
    1173/     5E7 : 21 72 00            	LD	HL,0072H
    1174/     5EA : B7                  	OR	A
    1175/     5EB : ED 52               	SBC	HL,DE
    1176/     5ED : D0                  	RET	NC
    1177/     5EE :                     
    1178/     5EE : 21 20 00            	LD	HL,0020H
    1179/     5F1 : EB                  	EX	DE,HL
    1180/     5F2 : B7                  	OR	A
    1181/     5F3 : ED 52               	SBC	HL,DE
    1182/     5F5 : 22 2D 23            	LD	(CURSOR_ADD),HL
    1183/     5F8 :                     
    1184/     5F8 : C9                  	RET
    1185/     5F9 :                     
    1186/     5F9 :                     KP1L3:
    1187/     5F9 : CB 4E               	BIT	1,(HL)
    1188/     5FB : 28 26               	JR	Z,KP1L4
    1189/     5FD :                     
    1190/     5FD :                     ;
    1191/     5FD :                     ; cursor down
    1192/     5FD :                     ;
    1193/     5FD : 3E 01               	LD	A,01H
    1194/     5FF : 32 BB 22            	LD	(CURSORREDRAW),A
    1195/     602 :                     
    1196/     602 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1197/     605 : EB                  	EX	DE,HL
    1198/     606 : 21 81 01            	LD	HL,0182H-1
    1199/     609 : B7                  	OR	A
    1200/     60A : ED 52               	SBC	HL,DE
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 21 - 2/18/2013 12:10:16


    1201/     60C : D8                  	RET	C
    1202/     60D :                     
    1203/     60D : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1204/     610 : 11 20 00            	LD	DE,0020H
    1205/     613 : 19                  	ADD	HL,DE
    1206/     614 : CD 81 06            	CALL	CUR2CHK
    1207/     617 : C8                  	RET	Z
    1208/     618 :                     
    1209/     618 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1210/     61B : 11 20 00            	LD	DE,0020H
    1211/     61E : 19                  	ADD	HL,DE
    1212/     61F : 22 2D 23            	LD	(CURSOR_ADD),HL
    1213/     622 : C9                  	RET
    1214/     623 :                     
    1215/     623 :                     KP1L4:
    1216/     623 : CB 56               	BIT	2,(HL)
    1217/     625 : 28 24               	JR	Z,KP1L5
    1218/     627 :                     
    1219/     627 :                     ;
    1220/     627 :                     ; cursor right
    1221/     627 :                     ;
    1222/     627 : 3E 01               	LD	A,01H
    1223/     629 : 32 BB 22            	LD	(CURSORREDRAW),A
    1224/     62C :                     
    1225/     62C : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1226/     62F : 7D                  	LD	A,L
    1227/     630 : E6 1F               	AND	1FH
    1228/     632 : FE 12               	CP	12H
    1229/     634 : D0                  	RET	NC
    1230/     635 :                     
    1231/     635 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1232/     638 : 11 10 00            	LD	DE,0010H
    1233/     63B : 19                  	ADD	HL,DE
    1234/     63C : CD 81 06            	CALL	CUR2CHK
    1235/     63F : C8                  	RET	Z
    1236/     640 :                     
    1237/     640 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1238/     643 : 11 10 00            	LD	DE,0010H
    1239/     646 : 19                  	ADD	HL,DE
    1240/     647 : 22 2D 23            	LD	(CURSOR_ADD),HL
    1241/     64A :                     
    1242/     64A : C9                  	RET
    1243/     64B :                     
    1244/     64B :                     KP1L5:
    1245/     64B : CB 5E               	BIT	3,(HL)
    1246/     64D : C8                  	RET	Z
    1247/     64E :                     
    1248/     64E :                     ;
    1249/     64E :                     ; cursor left
    1250/     64E :                     ;
    1251/     64E : 3E 01               	LD	A,01H
    1252/     650 : 32 BB 22            	LD	(CURSORREDRAW),A
    1253/     653 :                     
    1254/     653 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1255/     656 : 7D                  	LD	A,L
    1256/     657 : E6 1F               	AND	1FH
    1257/     659 : FE 03               	CP	02H+1
    1258/     65B : D8                  	RET	C
    1259/     65C :                     
    1260/     65C : 11 10 00            	LD	DE,0010H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 22 - 2/18/2013 12:10:16


    1261/     65F : B7                  	OR	A
    1262/     660 : ED 52               	SBC	HL,DE
    1263/     662 : 22 2D 23            	LD	(CURSOR_ADD),HL
    1264/     665 :                     
    1265/     665 : C9                  	RET
    1266/     666 :                     
    1267/     666 :                     
    1268/     666 :                     
    1269/     666 :                     ;
    1270/     666 :                     ; cursor position -> file buffer positon (keyin 1 sub)
    1271/     666 :                     ;
    1272/     666 :                     ; HL <- cursor position
    1273/     666 :                     ;
    1274/     666 :                     ; RETURN HL:file buffer position
    1275/     666 :                     ;
    1276/     666 :                     CUR2BUF:
    1277/     666 : 11 62 00            	LD	DE,0062H
    1278/     669 : B7                  	OR	A
    1279/     66A : ED 52               	SBC	HL,DE
    1280/     66C : CB 3C               	SRL	H
    1281/     66E : CB 1D               	RR	L
    1282/     670 : CB 3C               	SRL	H
    1283/     672 : CB 1D               	RR	L
    1284/     674 : CB 3C               	SRL	H
    1285/     676 : CB 1D               	RR	L
    1286/     678 : 11 30 23            	LD	DE,FILEPTR_BUF
    1287/     67B : 19                  	ADD	HL,DE
    1288/     67C : 5E                  	LD	E,(HL)
    1289/     67D : 23                  	INC	HL
    1290/     67E : 56                  	LD	D,(HL)
    1291/     67F : EB                  	EX	DE,HL
    1292/     680 : C9                  	RET
    1293/     681 :                     
    1294/     681 :                     ;
    1295/     681 :                     ; cursor position -> file buffer positon (keyin 1 sub)
    1296/     681 :                     ;
    1297/     681 :                     ; HL <- cursor position
    1298/     681 :                     ;
    1299/     681 :                     ; RETURN Zflag set:file NULL
    1300/     681 :                     ;
    1301/     681 :                     CUR2CHK:
    1302/     681 : CD 66 06            	CALL	CUR2BUF
    1303/     684 : 23                  	INC	HL
    1304/     685 : 7D                  	LD	A,L
    1305/     686 : B4                  	OR	H
    1306/     687 : C9                  	RET
    1307/     688 :                     
    1308/     688 :                     ;
    1309/     688 :                     ; set file parameter
    1310/     688 :                     ; IX <= file name address
    1311/     688 :                     ;
    1312/     688 :                     SETFILEPARA:
    1313/     688 : E5                  	PUSH	HL
    1314/     689 : 2A A0 22            	LD	HL,(DIRCL)
    1315/     68C : FD 75 0F            	LD	(IY+FIFO_DIRCL+0),L
    1316/     68F : FD 74 10            	LD	(IY+FIFO_DIRCL+1),H
    1317/     692 : 2A A2 22            	LD	HL,(DIRPOS)
    1318/     695 : FD 75 11            	LD	(IY+FIFO_DIRPOS+0),L
    1319/     698 : FD 74 12            	LD	(IY+FIFO_DIRPOS+1),H
    1320/     69B : E1                  	POP	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 23 - 2/18/2013 12:10:16


    1321/     69C :                     
    1322/     69C :                     SETFILEPARA2:
    1323/     69C : 7E                  	LD	A,(HL)
    1324/     69D : FD 77 08            	LD	(IY+FIFO_CL+0),A
    1325/     6A0 : FD 77 0B            	LD	(IY+FIFO_STCL+0),A
    1326/     6A3 : 23                  	INC	HL
    1327/     6A4 : 7E                  	LD	A,(HL)
    1328/     6A5 : FD 77 09            	LD	(IY+FIFO_CL+1),A
    1329/     6A8 : FD 77 0C            	LD	(IY+FIFO_STCL+1),A
    1330/     6AB : 23                  	INC	HL
    1331/     6AC : 7E                  	LD	A,(HL)
    1332/     6AD : FD 77 00            	LD	(IY+FIFO_CMTLEN+0),A
    1333/     6B0 : 23                  	INC	HL
    1334/     6B1 : 7E                  	LD	A,(HL)
    1335/     6B2 : FD 77 01            	LD	(IY+FIFO_CMTLEN+1),A
    1336/     6B5 : 23                  	INC	HL
    1337/     6B6 : 7E                  	LD	A,(HL)
    1338/     6B7 : FD 77 02            	LD	(IY+FIFO_CMTLEN+2),A
    1339/     6BA : 23                  	INC	HL
    1340/     6BB : 7E                  	LD	A,(HL)
    1341/     6BC : FD 77 03            	LD	(IY+FIFO_CMTLEN+3),A
    1342/     6BF :                     
    1343/     6BF : C9                  	RET
    1344/     6C0 :                     
    1345/     6C0 :                     ;
    1346/     6C0 :                     ; page 2 keyin process
    1347/     6C0 :                     ;
    1348/     6C0 :                     KEYINPAGE2:
    1349/     6C0 :                     
    1350/     6C0 : 21 2A 23            	LD	HL,FUNCPUSH
    1351/     6C3 :                     		; F7 - F0,ESC
    1352/     6C3 :                     
    1353/     6C3 : 23                  	INC	HL
    1354/     6C4 :                     		; TAB,RETURN,SPACE,F12 - F8
    1355/     6C4 :                     
    1356/     6C4 : CB 6E               	BIT	5,(HL)
    1357/     6C6 : C2 55 03            	JP	NZ,PAGE0INIT
    1358/     6C9 :                     
    1359/     6C9 : CB 76               KP2LS:	BIT	6,(HL)
    1360/     6CB : CA A4 07            	JP	Z,KP2L0
    1361/     6CE :                     
    1362/     6CE :                     ;
    1363/     6CE :                     ; return
    1364/     6CE :                     ;
    1365/     6CE : 3E 01               	LD	A,01H
    1366/     6D0 : 32 BA 22            	LD	(PAGEREDRAW),A
    1367/     6D3 : 32 BB 22            	LD	(CURSORREDRAW),A
    1368/     6D6 :                     
    1369/     6D6 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1370/     6D9 : 29                  	ADD	HL,HL
    1371/     6DA : 29                  	ADD	HL,HL
    1372/     6DB : 29                  	ADD	HL,HL
    1373/     6DC : 7C                  	LD	A,H
    1374/     6DD : D6 03               KP2L00:	SUB	03H
    1375/     6DF : 20 1A               	JR	NZ,KP2L01
    1376/     6E1 :                     
    1377/     6E1 : 3A 15 84            	LD	A,(REG_MK2MODE)
    1378/     6E4 : FE 02               	CP	02H
    1379/     6E6 : C0                  	RET	NZ
    1380/     6E7 : 3A 7F 82            	LD	A,(REG_FDD0)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 24 - 2/18/2013 12:10:16


    1381/     6EA : E6 01               	AND	01H
    1382/     6EC : EE 01               	XOR	01H
    1383/     6EE : 32 7F 82            	LD	(REG_FDD0),A
    1384/     6F1 : C0                  	RET	NZ
    1385/     6F2 : 3E 06               	LD	A,06H
    1386/     6F4 : 32 BC 22            	LD	(FILESEL),A
    1387/     6F7 : CD 8E 03            	CALL	KP1L1_NOSELECT
    1388/     6FA : C9                  	RET
    1389/     6FB :                     
    1390/     6FB :                     
    1391/     6FB :                     ;	LD	A,(REG_FDD0)
    1392/     6FB :                     ;	AND	07H
    1393/     6FB :                     ;	ADD	A,02H
    1394/     6FB :                     ;	LD	(REG_FDD0),A
    1395/     6FB :                     ;	BIT	0,A
    1396/     6FB :                     ;	JR	NZ,KP2L00_0
    1397/     6FB :                     ;	LD	A,01H
    1398/     6FB :                     ;	LD	(REG_FDD0),A
    1399/     6FB :                     ;	RET
    1400/     6FB :                     ;KP2L00_0:
    1401/     6FB :                     ;	CP	09H
    1402/     6FB :                     ;	RET	NZ
    1403/     6FB :                     ;	XOR	A
    1404/     6FB :                     ;	LD	(REG_FDD0),A
    1405/     6FB :                     ;	RET
    1406/     6FB :                     
    1407/     6FB :                     
    1408/     6FB : FE 01               KP2L01:	CP	01H
    1409/     6FD : 20 13               	JR	NZ,KP2L02
    1410/     6FF :                     
    1411/     6FF : 3A 7F 82            	LD	A,(REG_FDD0)
    1412/     702 : B7                  	OR	A
    1413/     703 : C8                  	RET	Z
    1414/     704 : 3E 02               	LD	A,02H
    1415/     706 : 32 B9 22            	LD	(BEFPAGENUM),A
    1416/     709 : 3E 06               	LD	A,06H
    1417/     70B : 32 BC 22            	LD	(FILESEL),A
    1418/     70E : CD D0 02            	CALL	FILESELINIT
    1419/     711 : C9                  	RET
    1420/     712 :                     
    1421/     712 :                     
    1422/     712 : FE 02               KP2L02:	CP	02H
    1423/     714 : 20 1A               	JR	NZ,KP2L03
    1424/     716 :                     
    1425/     716 : 3A 15 84            	LD	A,(REG_MK2MODE)
    1426/     719 : FE 02               	CP	02H
    1427/     71B : C0                  	RET	NZ
    1428/     71C : 3A 9F 82            	LD	A,(REG_FDD1)
    1429/     71F : E6 01               	AND	01H
    1430/     721 : EE 01               	XOR	01H
    1431/     723 : 32 9F 82            	LD	(REG_FDD1),A
    1432/     726 : C0                  	RET	NZ
    1433/     727 : 3E 07               	LD	A,07H
    1434/     729 : 32 BC 22            	LD	(FILESEL),A
    1435/     72C : CD 8E 03            	CALL	KP1L1_NOSELECT
    1436/     72F : C9                  	RET
    1437/     730 :                     
    1438/     730 :                     ;	LD	A,(REG_FDD1)
    1439/     730 :                     ;	AND	07H
    1440/     730 :                     ;	ADD	A,02H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 25 - 2/18/2013 12:10:16


    1441/     730 :                     ;	LD	(REG_FDD1),A
    1442/     730 :                     ;	BIT	0,A
    1443/     730 :                     ;	JR	NZ,KP2L02_0
    1444/     730 :                     ;	LD	A,01H
    1445/     730 :                     ;	LD	(REG_FDD1),A
    1446/     730 :                     ;	RET
    1447/     730 :                     ;KP2L02_0:
    1448/     730 :                     ;	CP	09H
    1449/     730 :                     ;	RET	NZ
    1450/     730 :                     ;	XOR	A
    1451/     730 :                     ;	LD	(REG_FDD1),A
    1452/     730 :                     ;	RET
    1453/     730 :                     
    1454/     730 :                     
    1455/     730 : FE 03               KP2L03:	CP	03H
    1456/     732 : 20 13               	JR	NZ,KP2L05
    1457/     734 :                     
    1458/     734 : 3A 9F 82            	LD	A,(REG_FDD1)
    1459/     737 : B7                  	OR	A
    1460/     738 : C8                  	RET	Z
    1461/     739 : 3E 02               	LD	A,02H
    1462/     73B : 32 B9 22            	LD	(BEFPAGENUM),A
    1463/     73E : 3E 07               	LD	A,07H
    1464/     740 : 32 BC 22            	LD	(FILESEL),A
    1465/     743 : CD D0 02            	CALL	FILESELINIT
    1466/     746 : C9                  	RET
    1467/     747 :                     
    1468/     747 :                     
    1469/     747 : FE 05               KP2L05:	CP	05H
    1470/     749 : 20 14               	JR	NZ,KP2L06
    1471/     74B :                     
    1472/     74B : 3A BF 82            	LD	A,(REG_FDD2)
    1473/     74E : E6 01               	AND	01H
    1474/     750 : EE 01               	XOR	01H
    1475/     752 : 32 BF 82            	LD	(REG_FDD2),A
    1476/     755 : C0                  	RET	NZ
    1477/     756 : 3E 0E               	LD	A,0EH
    1478/     758 : 32 BC 22            	LD	(FILESEL),A
    1479/     75B : CD 8E 03            	CALL	KP1L1_NOSELECT
    1480/     75E : C9                  	RET
    1481/     75F :                     
    1482/     75F :                     ;	LD	A,(REG_FDD2)
    1483/     75F :                     ;	AND	07H
    1484/     75F :                     ;	ADD	A,02H
    1485/     75F :                     ;	LD	(REG_FDD2),A
    1486/     75F :                     ;	BIT	0,A
    1487/     75F :                     ;	JR	NZ,KP2L05_0
    1488/     75F :                     ;	LD	A,01H
    1489/     75F :                     ;	LD	(REG_FDD2),A
    1490/     75F :                     ;	RET
    1491/     75F :                     ;KP2L05_0:
    1492/     75F :                     ;	CP	09H
    1493/     75F :                     ;	RET	NZ
    1494/     75F :                     ;	XOR	A
    1495/     75F :                     ;	LD	(REG_FDD2),A
    1496/     75F :                     ;	RET
    1497/     75F :                     
    1498/     75F : FE 06               KP2L06:	CP	06H
    1499/     761 : 20 13               	JR	NZ,KP2L07
    1500/     763 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 26 - 2/18/2013 12:10:16


    1501/     763 : 3A BF 82            	LD	A,(REG_FDD2)
    1502/     766 : B7                  	OR	A
    1503/     767 : C8                  	RET	Z
    1504/     768 : 3E 02               	LD	A,02H
    1505/     76A : 32 B9 22            	LD	(BEFPAGENUM),A
    1506/     76D : 3E 0E               	LD	A,0EH
    1507/     76F : 32 BC 22            	LD	(FILESEL),A
    1508/     772 : CD D0 02            	CALL	FILESELINIT
    1509/     775 : C9                  	RET
    1510/     776 :                     
    1511/     776 :                     
    1512/     776 : FE 07               KP2L07:	CP	07H
    1513/     778 : 20 14               	JR	NZ,KP2L08
    1514/     77A :                     
    1515/     77A : 3A DF 82            	LD	A,(REG_FDD3)
    1516/     77D : E6 01               	AND	01H
    1517/     77F : EE 01               	XOR	01H
    1518/     781 : 32 DF 82            	LD	(REG_FDD3),A
    1519/     784 : C0                  	RET	NZ
    1520/     785 : 3E 0F               	LD	A,0FH
    1521/     787 : 32 BC 22            	LD	(FILESEL),A
    1522/     78A : CD 8E 03            	CALL	KP1L1_NOSELECT
    1523/     78D : C9                  	RET
    1524/     78E :                     
    1525/     78E :                     ;	LD	A,(REG_FDD3)
    1526/     78E :                     ;	AND	07H
    1527/     78E :                     ;	ADD	A,02H
    1528/     78E :                     ;	LD	(REG_FDD3),A
    1529/     78E :                     ;	BIT	0,A
    1530/     78E :                     ;	JR	NZ,KP2L07_0
    1531/     78E :                     ;	LD	A,01H
    1532/     78E :                     ;	LD	(REG_FDD3),A
    1533/     78E :                     ;	RET
    1534/     78E :                     ;KP2L07_0:
    1535/     78E :                     ;	CP	09H
    1536/     78E :                     ;	RET	NZ
    1537/     78E :                     ;	XOR	A
    1538/     78E :                     ;	LD	(REG_FDD3),A
    1539/     78E :                     ;	RET
    1540/     78E :                     
    1541/     78E :                     
    1542/     78E : FE 08               KP2L08:	CP	08H
    1543/     790 : C0                  	RET	NZ
    1544/     791 :                     
    1545/     791 : 3A DF 82            	LD	A,(REG_FDD3)
    1546/     794 : B7                  	OR	A
    1547/     795 : C8                  	RET	Z
    1548/     796 : 3E 02               	LD	A,02H
    1549/     798 : 32 B9 22            	LD	(BEFPAGENUM),A
    1550/     79B : 3E 0F               	LD	A,0FH
    1551/     79D : 32 BC 22            	LD	(FILESEL),A
    1552/     7A0 : CD D0 02            	CALL	FILESELINIT
    1553/     7A3 : C9                  	RET
    1554/     7A4 :                     
    1555/     7A4 :                     
    1556/     7A4 : 23                  KP2L0:	INC	HL
    1557/     7A5 :                     		; END,ALT,SHIFT,CTRL,<-,->,v,^
    1558/     7A5 :                     
    1559/     7A5 : CB 46               	BIT	0,(HL)
    1560/     7A7 : 28 04               	JR	Z,KP2L1
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 27 - 2/18/2013 12:10:16


    1561/     7A9 :                     
    1562/     7A9 :                     ;
    1563/     7A9 :                     ; cursor up
    1564/     7A9 :                     ;
    1565/     7A9 : 0E FF               	LD	C,0FFH
    1566/     7AB : 18 07               	JR	PAGE2CURMOV
    1567/     7AD :                     
    1568/     7AD :                     KP2L1:
    1569/     7AD : CB 4E               	BIT	1,(HL)
    1570/     7AF : C8                  	RET	Z
    1571/     7B0 :                     
    1572/     7B0 :                     ;
    1573/     7B0 :                     ; cursor down
    1574/     7B0 :                     ;
    1575/     7B0 : 0E 01               	LD	C,01H
    1576/     7B2 : 18 00               	JR	PAGE2CURMOV
    1577/     7B4 :                     
    1578/     7B4 :                     ;
    1579/     7B4 :                     ; page 2 keyin sub
    1580/     7B4 :                     ;
    1581/     7B4 :                     PAGE2CURMOV:
    1582/     7B4 : 3E 01               	LD	A,01H
    1583/     7B6 : 32 BB 22            	LD	(CURSORREDRAW),A
    1584/     7B9 :                     
    1585/     7B9 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    1586/     7BC : 29                  	ADD	HL,HL
    1587/     7BD : 29                  	ADD	HL,HL
    1588/     7BE : 29                  	ADD	HL,HL
    1589/     7BF : 7C                  	LD	A,H
    1590/     7C0 : D6 03               	SUB	03H
    1591/     7C2 :                     
    1592/     7C2 : 81                  	ADD	A,C
    1593/     7C3 : FE 09               	CP	09H
    1594/     7C5 : D0                  	RET	NC
    1595/     7C6 :                     
    1596/     7C6 : FE 04               	CP	04H
    1597/     7C8 : 20 01               	JR	NZ,P2CL0
    1598/     7CA : 81                  	ADD	A,C
    1599/     7CB :                     P2CL0:
    1600/     7CB : 47                  	LD	B,A
    1601/     7CC : 87                  	ADD	A,A
    1602/     7CD : 80                  	ADD	A,B
    1603/     7CE : 5F                  	LD	E,A
    1604/     7CF : 16 00               	LD	D,00H
    1605/     7D1 : 21 03 28            	LD	HL,PAGE2CURDATA
    1606/     7D4 : 19                  	ADD	HL,DE
    1607/     7D5 : 11 2D 23            	LD	DE,CURSOR_ADD
    1608/     7D8 : 01 03 00            	LD	BC,0003H
    1609/     7DB : ED B0               	LDIR
    1610/     7DD :                     
    1611/     7DD : C9                  	RET
    1612/     7DE :                     
    1613/     7DE :                     
    1614/     7DE :                     ;
    1615/     7DE :                     ; page # display
    1616/     7DE :                     ;
    1617/     7DE :                     DISPPAGE:
    1618/     7DE : 3A BA 22            	LD	A,(PAGEREDRAW)
    1619/     7E1 : B7                  	OR	A
    1620/     7E2 : C8                  	RET	Z
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 28 - 2/18/2013 12:10:16


    1621/     7E3 :                     
    1622/     7E3 : CD 89 0A            	CALL	SCREENINIT
    1623/     7E6 :                     
    1624/     7E6 : AF                  	XOR	A
    1625/     7E7 : 32 BA 22            	LD	(PAGEREDRAW),A
    1626/     7EA : 3C                  	INC	A
    1627/     7EB : 32 BB 22            	LD	(CURSORREDRAW),A
    1628/     7EE :                     
    1629/     7EE : 3A B8 22            	LD	A,(PAGENUM)
    1630/     7F1 : B7                  	OR	A
    1631/     7F2 : CA 00 08            	JP	Z,DISPPAGE0
    1632/     7F5 : FE 01               	CP	01H
    1633/     7F7 : CA AE 08            	JP	Z,DISPPAGE1
    1634/     7FA : FE 02               	CP	02H
    1635/     7FC : CA 81 09            	JP	Z,DISPPAGE2
    1636/     7FF :                     
    1637/     7FF : C9                  	RET
    1638/     800 :                     
    1639/     800 :                     
    1640/     800 :                     ;
    1641/     800 :                     ; page 0 display
    1642/     800 :                     ;
    1643/     800 :                     DISPPAGE0:
    1644/     800 : 21 16 26            	LD	HL,ST_32
    1645/     803 : 3A 12 84            	LD	A,(REG_MEM16K)
    1646/     806 : B7                  	OR	A
    1647/     807 : 28 03               	JR	Z,DP0L2
    1648/     809 : 21 13 26            	LD	HL,ST_16
    1649/     80C :                     DP0L2:
    1650/     80C : 3A 15 84            	LD	A,(REG_MK2MODE)
    1651/     80F : B7                  	OR	A
    1652/     810 : 28 0C               	JR	Z,DP0L21
    1653/     812 : 21 19 26            	LD	HL,ST_64
    1654/     815 : 3A 12 84            	LD	A,(REG_MEM16K)
    1655/     818 : B7                  	OR	A
    1656/     819 : 28 03               	JR	Z,DP0L21
    1657/     81B : 21 1C 26            	LD	HL,ST_128
    1658/     81E :                     DP0L21:
    1659/     81E : 11 0C 24            	LD	DE,ST_MEMSIZE_VAL
    1660/     821 : 01 03 00            	LD	BC,0003H
    1661/     824 : ED B0               	LDIR
    1662/     826 :                     
    1663/     826 : 21 0B 26            	LD	HL,ST_OFF
    1664/     829 : 3A 1C 84            	LD	A,(REG_EXKANJIENB)
    1665/     82C : B7                  	OR	A
    1666/     82D : 28 03               	JR	Z,DPOL3
    1667/     82F : 21 0F 26            	LD	HL,ST_ON
    1668/     832 :                     DPOL3:
    1669/     832 : 11 4A 24            	LD	DE,ST_EXKANJI_VAL
    1670/     835 : 01 04 00            	LD	BC,0004H
    1671/     838 : ED B0               	LDIR
    1672/     83A :                     
    1673/     83A : 21 3F 26            	LD	HL,ST_SC4COLOFF
    1674/     83D : 3A 13 84            	LD	A,(REG_SC4MODE)
    1675/     840 : CB 67               	BIT	4,A
    1676/     842 : 28 18               	JR	Z,DP0L5
    1677/     844 : 21 1F 26            	LD	HL,ST_SC4COL0
    1678/     847 : E6 03               	AND	03H
    1679/     849 : 28 11               	JR	Z,DP0L5
    1680/     84B : 21 27 26            	LD	HL,ST_SC4COL1
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 29 - 2/18/2013 12:10:16


    1681/     84E : FE 01               	CP	01H
    1682/     850 : 28 0A               	JR	Z,DP0L5
    1683/     852 : 21 2F 26            	LD	HL,ST_SC4COL2
    1684/     855 : FE 02               	CP	02H
    1685/     857 : 28 03               	JR	Z,DP0L5
    1686/     859 : 21 37 26            	LD	HL,ST_SC4COL3
    1687/     85C : 11 65 24            DP0L5:	LD	DE,ST_SC4COL_VAL
    1688/     85F : 01 08 00            	LD	BC,0008H
    1689/     862 : ED B0               	LDIR
    1690/     864 :                     
    1691/     864 : 3A 58 23            	LD	A,(UART_BAUD)
    1692/     867 : 6F                  	LD	L,A
    1693/     868 : 5D                  	LD	E,L
    1694/     869 : 26 00               	LD	H,00H
    1695/     86B : 54                  	LD	D,H
    1696/     86C : 29                  	ADD	HL,HL		; x2
    1697/     86D : 19                  	ADD	HL,DE		; x3
    1698/     86E : 29                  	ADD	HL,HL		; x6
    1699/     86F : 29                  	ADD	HL,HL		; x12
    1700/     870 : 19                  	ADD	HL,DE		; x13
    1701/     871 : 11 47 26            	LD	DE,ST_UARTBAUD
    1702/     874 : 19                  	ADD	HL,DE
    1703/     875 : 11 80 24            	LD	DE,ST_UART_VAL
    1704/     878 : 01 0D 00            	LD	BC,000DH
    1705/     87B : ED B0               	LDIR
    1706/     87D :                     
    1707/     87D : 21 9A 23            	LD	HL,ST_CMTREAD
    1708/     880 : CD 28 0B            	CALL	PRINTSTRING
    1709/     883 : 21 BA 23            	LD	HL,ST_CMTREW
    1710/     886 : CD 28 0B            	CALL	PRINTSTRING
    1711/     889 : 21 D7 23            	LD	HL,ST_CMTWRITE
    1712/     88C : CD 28 0B            	CALL	PRINTSTRING
    1713/     88F : 21 F7 23            	LD	HL,ST_MEMSIZE
    1714/     892 : CD 28 0B            	CALL	PRINTSTRING
    1715/     895 : 21 14 24            	LD	HL,ST_EXROM
    1716/     898 : CD 28 0B            	CALL	PRINTSTRING
    1717/     89B : 21 34 24            	LD	HL,ST_EXKANJI
    1718/     89E : CD 28 0B            	CALL	PRINTSTRING
    1719/     8A1 : 21 51 24            	LD	HL,ST_SC4COL
    1720/     8A4 : CD 28 0B            	CALL	PRINTSTRING
    1721/     8A7 : 21 6F 24            	LD	HL,ST_UART
    1722/     8AA : CD 28 0B            	CALL	PRINTSTRING
    1723/     8AD :                     
    1724/     8AD : C9                  	RET
    1725/     8AE :                     
    1726/     8AE :                     ;
    1727/     8AE :                     ; page 1 display
    1728/     8AE :                     ;
    1729/     8AE :                     DISPPAGE1:
    1730/     8AE : 3E 01               	LD	A,01H
    1731/     8B0 : 32 01 82            	LD	(REG_SDCTRL),A
    1732/     8B3 :                     
    1733/     8B3 : 06 28               	LD	B,28H
    1734/     8B5 : 21 30 23            	LD	HL,FILEPTR_BUF
    1735/     8B8 : 36 FF               P1LP10:	LD	(HL),0FFH
    1736/     8BA : 23                  	INC	HL
    1737/     8BB : 10 FB               	DJNZ	P1LP10
    1738/     8BD :                     		;
    1739/     8BD : 21 62 00            	LD	HL,0062H
    1740/     8C0 : 22 DA 25            	LD	(ST_FNAME),HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 30 - 2/18/2013 12:10:16


    1741/     8C3 :                     		;
    1742/     8C3 : 06 14               P1LP11:	LD	B,14H
    1743/     8C5 : 11 30 23            	LD	DE,FILEPTR_BUF
    1744/     8C8 : C5                  P1LP13:	PUSH	BC
    1745/     8C9 : D5                  	PUSH	DE
    1746/     8CA : 2A A2 22            P1LP15: LD	HL,(DIRPOS)
    1747/     8CD : 23                  	INC	HL
    1748/     8CE : 7C                  	LD	A,H
    1749/     8CF : B5                  	OR	L
    1750/     8D0 : 20 0D               	JR	NZ,P1LP151
    1751/     8D2 :                     		;
    1752/     8D2 :                     		; "NO SELECT"
    1753/     8D2 :                     		;
    1754/     8D2 : 22 A2 22            	LD	(DIRPOS),HL
    1755/     8D5 : 11 DC 25            	LD	DE,ST_FNAME_VAL
    1756/     8D8 : CD 42 15            	CALL	LD_ST_NOSELECT
    1757/     8DB : 18 5C               	JR	P1LP18
    1758/     8DD :                     
    1759/     8DD : 18 E9               P1LP131:JR	P1LP13
    1760/     8DF :                     
    1761/     8DF :                     P1LP151:
    1762/     8DF : CD AC 11            	CALL	READ_DIRFILE
    1763/     8E2 :                     
    1764/     8E2 : E5                  	PUSH	HL
    1765/     8E3 : 2A A2 22            	LD	HL,(DIRPOS)
    1766/     8E6 : 7C                  	LD	A,H
    1767/     8E7 : 23                  	INC	HL
    1768/     8E8 : 22 A2 22            	LD	(DIRPOS),HL
    1769/     8EB : E1                  	POP	HL
    1770/     8EC : FE 02               	CP	02H
    1771/     8EE : 30 79               	JR	NC,P1LP14
    1772/     8F0 :                     
    1773/     8F0 : 7E                  	LD	A,(HL)
    1774/     8F1 : B7                  	OR	A
    1775/     8F2 : 28 75               	JR	Z,P1LP14
    1776/     8F4 : FE 05               	CP	05H
    1777/     8F6 : 28 D2               	JR	Z,P1LP15
    1778/     8F8 : FE E5               	CP	0E5H
    1779/     8FA : 28 CE               	JR	Z,P1LP15
    1780/     8FC : FE 2E               	CP	'.'
    1781/     8FE : 20 07               	JR	NZ,P1LP16
    1782/     900 : 23                  	INC	HL
    1783/     901 : 7E                  	LD	A,(HL)
    1784/     902 : 2B                  	DEC	HL
    1785/     903 : FE 20               	CP	' '
    1786/     905 : 28 C3               	JR	Z,P1LP15
    1787/     907 :                     
    1788/     907 : 11 DC 25            P1LP16: LD	DE,ST_FNAME_VAL
    1789/     90A : 01 08 00            	LD	BC,0008H
    1790/     90D : ED B0               	LDIR
    1791/     90F : 3E 2E               	LD	A,'.'
    1792/     911 : 12                  	LD	(DE),A
    1793/     912 : 13                  	INC	DE
    1794/     913 : 01 03 00            	LD	BC,0003H
    1795/     916 : ED B0               	LDIR
    1796/     918 : 7E                  	LD	A,(HL)
    1797/     919 : 47                  	LD	B,A
    1798/     91A : E6 0E               	AND	0EH
    1799/     91C : 20 AC               	JR	NZ,P1LP15
    1800/     91E : 3A BC 22            	LD	A,(FILESEL)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 31 - 2/18/2013 12:10:16


    1801/     921 : FE 0C               	CP	0CH
    1802/     923 : 20 05               	JR	NZ,P1LP161
    1803/     925 : 78                  	LD	A,B
    1804/     926 : E6 01               	AND	01H
    1805/     928 : 20 A0               	JR	NZ,P1LP15
    1806/     92A :                     P1LP161:
    1807/     92A : 78                  	LD	A,B
    1808/     92B : E6 10               	AND	10H
    1809/     92D : 28 0A               	JR	Z,P1LP18
    1810/     92F : 3E 3D               	LD	A,'='
    1811/     931 : 1B                  	DEC	DE
    1812/     932 : 12                  	LD	(DE),A
    1813/     933 : 1B                  	DEC	DE
    1814/     934 : 12                  	LD	(DE),A
    1815/     935 : 1B                  	DEC	DE
    1816/     936 : 12                  	LD	(DE),A
    1817/     937 : 1B                  	DEC	DE
    1818/     938 : 12                  	LD	(DE),A
    1819/     939 :                     
    1820/     939 : 2A A2 22            P1LP18:	LD	HL,(DIRPOS)
    1821/     93C : 2B                  	DEC	HL
    1822/     93D : EB                  	EX	DE,HL
    1823/     93E : E1                  	POP	HL
    1824/     93F : E5                  	PUSH	HL
    1825/     940 : 73                  	LD	(HL),E
    1826/     941 : 23                  	INC	HL
    1827/     942 : 72                  	LD	(HL),D
    1828/     943 :                     
    1829/     943 : 21 DA 25            	LD	HL,ST_FNAME
    1830/     946 : CD 28 0B            	CALL	PRINTSTRING
    1831/     949 :                     
    1832/     949 : 2A DA 25            	LD	HL,(ST_FNAME)
    1833/     94C : 11 10 00            	LD	DE,0010H
    1834/     94F : 19                  	ADD	HL,DE
    1835/     950 : 22 DA 25            	LD	(ST_FNAME),HL
    1836/     953 : D1                  	POP	DE
    1837/     954 : 13                  	INC	DE
    1838/     955 : 13                  	INC	DE
    1839/     956 : C1                  	POP	BC
    1840/     957 : 10 84               	DJNZ	P1LP131
    1841/     959 :                     
    1842/     959 : 21 62 00            P1LP12:	LD	HL,0062H
    1843/     95C : 22 2D 23            	LD	(CURSOR_ADD),HL
    1844/     95F : 3E 0C               	LD	A,0CH
    1845/     961 : 32 2F 23            	LD	(CURSOR_LEN),A
    1846/     964 : AF                  	XOR	A
    1847/     965 : 32 01 82            	LD	(REG_SDCTRL),A
    1848/     968 : C9                  	RET
    1849/     969 :                     
    1850/     969 :                     		;
    1851/     969 :                     		; directory entry end
    1852/     969 :                     		;
    1853/     969 : D1                  P1LP14:	POP	DE
    1854/     96A : C1                  	POP	BC
    1855/     96B : 2A A0 22            	LD	HL,(DIRCL)
    1856/     96E : 7C                  	LD	A,H
    1857/     96F : B5                  	OR	L
    1858/     970 : 21 FF FF            	LD	HL,0FFFFH
    1859/     973 : 28 01               	JR	Z,P1LP141
    1860/     975 : 23                  	INC	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 32 - 2/18/2013 12:10:16


    1861/     976 :                     P1LP141:
    1862/     976 : 22 A2 22            	LD	(DIRPOS),HL
    1863/     979 : 78                  	LD	A,B
    1864/     97A : FE 14               	CP	14H
    1865/     97C : CA C3 08            	JP	Z,P1LP11
    1866/     97F : 18 D8               	JR	P1LP12
    1867/     981 :                     
    1868/     981 :                     
    1869/     981 :                     ;
    1870/     981 :                     ; page 2 display
    1871/     981 :                     ;
    1872/     981 :                     DISPPAGE2:
    1873/     981 :                     
    1874/     981 : 21 7F 27            	LD	HL,ST_NOUSE
    1875/     984 :                     		;
    1876/     984 : 3A 7F 82            	LD	A,(REG_FDD0)
    1877/     987 : CB 47               	BIT	0,A
    1878/     989 : 28 18               	JR	Z,DP2LF0
    1879/     98B :                     		;
    1880/     98B : E6 06               	AND	A,06H
    1881/     98D : 21 85 27            	LD	HL,ST_1D
    1882/     990 : 28 11               	JR	Z,DP2LF0
    1883/     992 :                     		;
    1884/     992 : 21 8B 27            	LD	HL,ST_1DD
    1885/     995 : FE 02               	CP	02H
    1886/     997 : 28 0A               	JR	Z,DP2LF0
    1887/     999 :                     		;
    1888/     999 : 21 91 27            	LD	HL,ST_2D
    1889/     99C : FE 04               	CP	04H
    1890/     99E : 28 03               	JR	Z,DP2LF0
    1891/     9A0 :                     		;
    1892/     9A0 : 21 97 27            	LD	HL,ST_2DD
    1893/     9A3 :                     		;
    1894/     9A3 : 11 A6 24            DP2LF0:	LD	DE,ST_FDD0INTSET_VAL
    1895/     9A6 : 01 06 00            	LD	BC,0006H
    1896/     9A9 : ED B0               	LDIR
    1897/     9AB :                     
    1898/     9AB : 21 7F 27            	LD	HL,ST_NOUSE
    1899/     9AE :                     		;
    1900/     9AE : 3A 9F 82            	LD	A,(REG_FDD1)
    1901/     9B1 : CB 47               	BIT	0,A
    1902/     9B3 : 28 18               	JR	Z,DP2LF1
    1903/     9B5 :                     		;
    1904/     9B5 : E6 06               	AND	A,06H
    1905/     9B7 : 21 85 27            	LD	HL,ST_1D
    1906/     9BA : 28 11               	JR	Z,DP2LF1
    1907/     9BC :                     		;
    1908/     9BC : 21 8B 27            	LD	HL,ST_1DD
    1909/     9BF : FE 02               	CP	02H
    1910/     9C1 : 28 0A               	JR	Z,DP2LF1
    1911/     9C3 :                     		;
    1912/     9C3 : 21 91 27            	LD	HL,ST_2D
    1913/     9C6 : FE 04               	CP	04H
    1914/     9C8 : 28 03               	JR	Z,DP2LF1
    1915/     9CA :                     		;
    1916/     9CA : 21 97 27            	LD	HL,ST_2DD
    1917/     9CD :                     		;
    1918/     9CD : 11 E7 24            DP2LF1:	LD	DE,ST_FDD1INTSET_VAL
    1919/     9D0 : 01 06 00            	LD	BC,0006H
    1920/     9D3 : ED B0               	LDIR
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 33 - 2/18/2013 12:10:16


    1921/     9D5 :                     
    1922/     9D5 : 21 7F 27            	LD	HL,ST_NOUSE
    1923/     9D8 :                     		;
    1924/     9D8 : 3A BF 82            	LD	A,(REG_FDD2)
    1925/     9DB : CB 47               	BIT	0,A
    1926/     9DD : 28 18               	JR	Z,DP2LF2
    1927/     9DF :                     		;
    1928/     9DF : E6 06               	AND	A,06H
    1929/     9E1 : 21 85 27            	LD	HL,ST_1D
    1930/     9E4 : 28 11               	JR	Z,DP2LF2
    1931/     9E6 :                     		;
    1932/     9E6 : 21 8B 27            	LD	HL,ST_1DD
    1933/     9E9 : FE 02               	CP	02H
    1934/     9EB : 28 0A               	JR	Z,DP2LF2
    1935/     9ED :                     		;
    1936/     9ED : 21 91 27            	LD	HL,ST_2D
    1937/     9F0 : FE 04               	CP	04H
    1938/     9F2 : 28 03               	JR	Z,DP2LF2
    1939/     9F4 :                     		;
    1940/     9F4 : 21 97 27            	LD	HL,ST_2DD
    1941/     9F7 :                     		;
    1942/     9F7 : 11 28 25            DP2LF2:	LD	DE,ST_FDD0EXTSET_VAL
    1943/     9FA : 01 06 00            	LD	BC,0006H
    1944/     9FD : ED B0               	LDIR
    1945/     9FF :                     
    1946/     9FF : 21 7F 27            	LD	HL,ST_NOUSE
    1947/     A02 :                     		;
    1948/     A02 : 3A DF 82            	LD	A,(REG_FDD3)
    1949/     A05 : CB 47               	BIT	0,A
    1950/     A07 : 28 18               	JR	Z,DP2LF3
    1951/     A09 :                     		;
    1952/     A09 : E6 06               	AND	A,06H
    1953/     A0B : 21 85 27            	LD	HL,ST_1D
    1954/     A0E : 28 11               	JR	Z,DP2LF3
    1955/     A10 :                     		;
    1956/     A10 : 21 8B 27            	LD	HL,ST_1DD
    1957/     A13 : FE 02               	CP	02H
    1958/     A15 : 28 0A               	JR	Z,DP2LF3
    1959/     A17 :                     		;
    1960/     A17 : 21 91 27            	LD	HL,ST_2D
    1961/     A1A : FE 04               	CP	04H
    1962/     A1C : 28 03               	JR	Z,DP2LF3
    1963/     A1E :                     		;
    1964/     A1E : 21 97 27            	LD	HL,ST_2DD
    1965/     A21 :                     		;
    1966/     A21 : 11 69 25            DP2LF3:	LD	DE,ST_FDD1EXTSET_VAL
    1967/     A24 : 01 06 00            	LD	BC,0006H
    1968/     A27 : ED B0               	LDIR
    1969/     A29 :                     
    1970/     A29 :                     
    1971/     A29 : 21 8F 24            	LD	HL,ST_FDD0INTSET
    1972/     A2C : CD 28 0B            	CALL	PRINTSTRING
    1973/     A2F : 21 AE 24            	LD	HL,ST_FDD0INTFILE
    1974/     A32 : CD 28 0B            	CALL	PRINTSTRING
    1975/     A35 : 21 D0 24            	LD	HL,ST_FDD1INTSET
    1976/     A38 : CD 28 0B            	CALL	PRINTSTRING
    1977/     A3B : 21 EF 24            	LD	HL,ST_FDD1INTFILE
    1978/     A3E : CD 28 0B            	CALL	PRINTSTRING
    1979/     A41 : 21 11 25            	LD	HL,ST_FDD0EXTSET
    1980/     A44 : CD 28 0B            	CALL	PRINTSTRING
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 34 - 2/18/2013 12:10:16


    1981/     A47 : 21 30 25            	LD	HL,ST_FDD0EXTFILE
    1982/     A4A : CD 28 0B            	CALL	PRINTSTRING
    1983/     A4D : 21 52 25            	LD	HL,ST_FDD1EXTSET
    1984/     A50 : CD 28 0B            	CALL	PRINTSTRING
    1985/     A53 : 21 71 25            	LD	HL,ST_FDD1EXTFILE
    1986/     A56 : CD 28 0B            	CALL	PRINTSTRING
    1987/     A59 :                     
    1988/     A59 : C9                  	RET
    1989/     A5A :                     
    1990/     A5A :                     
    1991/     A5A :                     
    1992/     A5A :                     ;
    1993/     A5A :                     ; cursor display
    1994/     A5A :                     ;
    1995/     A5A :                     DISPCUR:
    1996/     A5A : 3A BB 22            	LD	A,(CURSORREDRAW)
    1997/     A5D : B7                  	OR	A
    1998/     A5E : C8                  	RET	Z
    1999/     A5F :                     
    2000/     A5F : 11 41 C0            	LD	DE,CTRLATT+41H
    2001/     A62 : 21 40 C0            	LD	HL,CTRLATT+40H
    2002/     A65 : 01 7F 01            	LD	BC,017FH
    2003/     A68 :                     
    2004/     A68 : 36 22               	LD	(HL),22H
    2005/     A6A : 3A 15 84            	LD	A,(REG_MK2MODE)
    2006/     A6D : B7                  	OR	A
    2007/     A6E : 28 02               	JR	Z,DCL2
    2008/     A70 : 36 20               	LD	(HL),20H
    2009/     A72 :                     DCL2:
    2010/     A72 : ED B0               	LDIR
    2011/     A74 :                     
    2012/     A74 : 3A 2F 23            	LD	A,(CURSOR_LEN)
    2013/     A77 : 47                  	LD	B,A
    2014/     A78 : 2A 2D 23            	LD	HL,(CURSOR_ADD)
    2015/     A7B : 11 00 C0            	LD	DE,CTRLATT
    2016/     A7E : 19                  	ADD	HL,DE
    2017/     A7F : 36 23               DCL1:	LD	(HL),23H
    2018/     A81 : 23                  	INC	HL
    2019/     A82 : 10 FB               	DJNZ	DCL1
    2020/     A84 :                     
    2021/     A84 : AF                  	XOR	A
    2022/     A85 : 32 BB 22            	LD	(CURSORREDRAW),A
    2023/     A88 : C9                  	RET
    2024/     A89 :                     
    2025/     A89 :                     
    2026/     A89 :                     ;
    2027/     A89 :                     ; screen initialize
    2028/     A89 :                     ;
    2029/     A89 :                     SCREENINIT:
    2030/     A89 : 11 01 C0            	LD	DE,CTRLATT+1
    2031/     A8C : 21 00 C0            	LD	HL,CTRLATT
    2032/     A8F : 01 40 00            	LD	BC,0040H
    2033/     A92 : 36 20               	LD	(HL),20H
    2034/     A94 : 3A 15 84            	LD	A,(REG_MK2MODE)
    2035/     A97 : B7                  	OR	A
    2036/     A98 : 28 02               	JR	Z,SIL_TOP
    2037/     A9A : 36 23               	LD	(HL),23H
    2038/     A9C :                     SIL_TOP:
    2039/     A9C :                     
    2040/     A9C : ED B0               	LDIR
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 35 - 2/18/2013 12:10:16


    2041/     A9E : 01 80 01            	LD	BC,0180H
    2042/     AA1 : 36 22               	LD	(HL),22H
    2043/     AA3 : 3A 15 84            	LD	A,(REG_MK2MODE)
    2044/     AA6 : B7                  	OR	A
    2045/     AA7 : 28 02               	JR	Z,SIL_MID
    2046/     AA9 : 36 20               	LD	(HL),20H
    2047/     AAB :                     SIL_MID:
    2048/     AAB :                     
    2049/     AAB : ED B0               	LDIR
    2050/     AAD : 01 40 00            	LD	BC,0040H
    2051/     AB0 : 36 20               	LD	(HL),20H
    2052/     AB2 : 3A 15 84            	LD	A,(REG_MK2MODE)
    2053/     AB5 : B7                  	OR	A
    2054/     AB6 : 28 02               	JR	Z,SIL_BOT
    2055/     AB8 : 36 23               	LD	(HL),23H
    2056/     ABA :                     SIL_BOT:
    2057/     ABA : ED B0               	LDIR
    2058/     ABC : 01 FF 01            	LD	BC,01FFH
    2059/     ABF : 36 20               	LD	(HL),20H
    2060/     AC1 :                     
    2061/     AC1 :                     
    2062/     AC1 : ED B0               	LDIR
    2063/     AC3 :                     
    2064/     AC3 : 2A 42 84            	LD	HL,(REG_FIRMVER)
    2065/     AC6 : 11 95 23            	LD	DE,ST_FIRMVER_VAL
    2066/     AC9 : CD 04 0B            	CALL	VER_CONV
    2067/     ACC : 2A 40 84            	LD	HL,(REG_FPGAVER)
    2068/     ACF : 11 88 23            	LD	DE,ST_FPGAVER_VAL
    2069/     AD2 : CD 04 0B            	CALL	VER_CONV
    2070/     AD5 :                     
    2071/     AD5 : 21 5A 23            	LD	HL,ST_PC6001F
    2072/     AD8 : 3A 15 84            	LD	A,(REG_MK2MODE)
    2073/     ADB : B7                  	OR	A
    2074/     ADC : 28 0A               	JR	Z,SIL_P6
    2075/     ADE : 21 65 23            	LD	HL,ST_PC6001FMK2
    2076/     AE1 : FE 01               	CP	01H
    2077/     AE3 : 28 03               	JR	Z,SIL_P6
    2078/     AE5 : 21 74 23            	LD	HL,ST_PC6601F
    2079/     AE8 :                     SIL_P6:
    2080/     AE8 : CD 28 0B            	CALL	PRINTSTRING
    2081/     AEB : 21 7F 23            	LD	HL,ST_FPGAVER
    2082/     AEE : CD 28 0B            	CALL	PRINTSTRING
    2083/     AF1 : 21 8D 23            	LD	HL,ST_FIRMVER
    2084/     AF4 : CD 28 0B            	CALL	PRINTSTRING
    2085/     AF7 :                     
    2086/     AF7 : 21 96 25            	LD	HL,ST_KEYFUNC1
    2087/     AFA : CD 28 0B            	CALL	PRINTSTRING
    2088/     AFD : 21 B8 25            	LD	HL,ST_KEYFUNC2
    2089/     B00 : CD 28 0B            	CALL	PRINTSTRING
    2090/     B03 :                     
    2091/     B03 : C9                  	RET
    2092/     B04 :                     
    2093/     B04 :                     ;
    2094/     B04 :                     ; version number convert
    2095/     B04 :                     ;
    2096/     B04 :                     VER_CONV
    2097/     B04 : 06 02               	LD	B,02H
    2098/     B06 :                     
    2099/     B06 :                     VCL1:
    2100/     B06 : 7C                  	LD	A,H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 36 - 2/18/2013 12:10:16


    2101/     B07 : E6 F0               	AND	0F0H
    2102/     B09 : 1F                  	RRA
    2103/     B0A : 1F                  	RRA
    2104/     B0B : 1F                  	RRA
    2105/     B0C : 1F                  	RRA
    2106/     B0D : C6 30               	ADD	A,30H
    2107/     B0F : FE 3A               	CP	3AH
    2108/     B11 : 38 02               	JR	C,VCL2
    2109/     B13 : C6 07               	ADD	A,07H
    2110/     B15 : 12                  VCL2:	LD	(DE),A
    2111/     B16 : 13                  	INC	DE
    2112/     B17 : 7C                  	LD	A,H
    2113/     B18 : E6 0F               	AND	0FH
    2114/     B1A : C6 30               	ADD	A,30H
    2115/     B1C : FE 3A               	CP	3AH
    2116/     B1E : 38 02               	JR	C,VCL3
    2117/     B20 : C6 07               	ADD	A,07H
    2118/     B22 : 12                  VCL3:	LD	(DE),A
    2119/     B23 : 13                  	INC	DE
    2120/     B24 : 65                  	LD	H,L
    2121/     B25 : 10 DF               	DJNZ	VCL1
    2122/     B27 : C9                  	RET
    2123/     B28 :                     
    2124/     B28 :                     
    2125/     B28 :                     ;
    2126/     B28 :                     ; print strings
    2127/     B28 :                     ;
    2128/     B28 :                     ; HL <- pointer of strings with display address
    2129/     B28 :                     ;
    2130/     B28 :                     PRINTSTRING:
    2131/     B28 : 11 00 C2            	LD	DE,CTRLVRAM
    2132/     B2B : 4E                  	LD	C,(HL)
    2133/     B2C : 23                  	INC	HL
    2134/     B2D : 46                  	LD	B,(HL)
    2135/     B2E : 23                  	INC	HL
    2136/     B2F : EB                  	EX	DE,HL
    2137/     B30 : 09                  	ADD	HL,BC
    2138/     B31 : EB                  	EX	DE,HL
    2139/     B32 :                     
    2140/     B32 :                     PSL1:
    2141/     B32 : 7E                  	LD	A,(HL)
    2142/     B33 : B7                  	OR	A
    2143/     B34 : C8                  	RET	Z
    2144/     B35 : 12                  	LD	(DE),A
    2145/     B36 : 23                  	INC	HL
    2146/     B37 : 13                  	INC	DE
    2147/     B38 : 18 F8               	JR	PSL1
    2148/     B3A :                     
    2149/     B3A :                     
    2150/     B3A :                     ;
    2151/     B3A :                     ; debug
    2152/     B3A :                     ;
    2153/     B3A :                     ; HL <- print number
    2154/     B3A :                     ;
    2155/     B3A :                     ;PRINTHL:
    2156/     B3A :                     ;	LD	DE,ST_DEBUG_VAL
    2157/     B3A :                     ;	CALL	VER_CONV
    2158/     B3A :                     ;	LD	HL,ST_DEBUG
    2159/     B3A :                     ;	CALL	PRINTSTRING
    2160/     B3A :                     ;	RET
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 37 - 2/18/2013 12:10:16


    2161/     B3A :                     
    2162/     B3A :                     
    2163/     B3A :                     ;
    2164/     B3A :                     ; key push detect
    2165/     B3A :                     ;
    2166/     B3A :                     KEYDET:
    2167/     B3A : 21 21 23            	LD	HL,CTRLNOW
    2168/     B3D : 11 25 23            	LD	DE,CTRLBEF
    2169/     B40 : DD 21 10 84         	LD	IX,REG_CTRLSEL
    2170/     B44 : FD 21 29 23         	LD	IY,CTRLPUSH
    2171/     B48 : 06 04               	LD	B,04H
    2172/     B4A :                     
    2173/     B4A : 7E                  KDLP1:	LD	A,(HL)
    2174/     B4B : 12                  	LD	(DE),A
    2175/     B4C : DD 7E 00            	LD	A,(IX+00H)
    2176/     B4F : 77                  	LD	(HL),A
    2177/     B50 : 1A                  	LD	A,(DE)
    2178/     B51 : AE                  	XOR	(HL)
    2179/     B52 : A6                  	AND	(HL)
    2180/     B53 : FD 77 00            	LD	(IY+00H),A
    2181/     B56 :                     
    2182/     B56 : 23                  	INC	HL
    2183/     B57 : 13                  	INC	DE
    2184/     B58 : FD 23               	INC	IY
    2185/     B5A : 78                  	LD	A,B
    2186/     B5B : FE 04               	CP	04H
    2187/     B5D : 20 04               	JR	NZ,KDLP2
    2188/     B5F : DD 21 1F 84         	LD	IX,REG_FUNCKEY-1
    2189/     B63 : DD 23               KDLP2:	INC	IX
    2190/     B65 : 10 E3               	DJNZ	KDLP1
    2191/     B67 :                     
    2192/     B67 : C9                  	RET
    2193/     B68 :                     
    2194/     B68 :                     
    2195/     B68 :                     ;
    2196/     B68 :                     ; read file
    2197/     B68 :                     ;
    2198/     B68 :                     CMTREADWAIT:
    2199/     B68 : 3A B5 22            	LD	A,(READFLAG)
    2200/     B6B : B7                  	OR	A
    2201/     B6C : C8                  	RET	Z
    2202/     B6D : 3D                  	DEC	A
    2203/     B6E : 20 25               	JR	NZ,CRWL1
    2204/     B70 :                     
    2205/     B70 :                     		;
    2206/     B70 :                     		; read file (new)
    2207/     B70 :                     		;
    2208/     B70 : 3A 12 82            	LD	A,(REG_CMTOPEN)
    2209/     B73 : E6 01               	AND	01H
    2210/     B75 : C8                  	RET	Z
    2211/     B76 :                     
    2212/     B76 : 3E 01               	LD	A,01H
    2213/     B78 : 32 01 82            	LD	(REG_SDCTRL),A
    2214/     B7B :                     
    2215/     B7B : AF                  	XOR	A
    2216/     B7C : 32 10 82            	LD	(REG_BUFAD),A
    2217/     B7F : 3E 04               	LD	A,04H
    2218/     B81 : 32 BC 22            	LD	(FILESEL),A
    2219/     B84 : FD 21 20 82         	LD	IY,REG_FIFO_0
    2220/     B88 :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 38 - 2/18/2013 12:10:16


    2221/     B88 : CD 3C 10            	CALL	FILEREAD
    2222/     B8B :                     
    2223/     B8B : AF                  	XOR	A
    2224/     B8C : 32 01 82            	LD	(REG_SDCTRL),A
    2225/     B8F : 3E 02               	LD	A,02H
    2226/     B91 : 32 B5 22            	LD	(READFLAG),A
    2227/     B94 : C9                  	RET
    2228/     B95 :                     
    2229/     B95 :                     		;
    2230/     B95 :                     		; read file (continue)
    2231/     B95 :                     		;
    2232/     B95 :                     CRWL1:
    2233/     B95 : 3A 12 82            	LD	A,(REG_CMTOPEN)
    2234/     B98 : E6 01               	AND	01H
    2235/     B9A : C8                  	RET	Z
    2236/     B9B :                     
    2237/     B9B : 3E 01               	LD	A,01H
    2238/     B9D : 32 01 82            	LD	(REG_SDCTRL),A
    2239/     BA0 :                     
    2240/     BA0 : AF                  	XOR	A
    2241/     BA1 : 32 10 82            	LD	(REG_BUFAD),A
    2242/     BA4 : 3E 04               	LD	A,04H
    2243/     BA6 : 32 BC 22            	LD	(FILESEL),A
    2244/     BA9 : FD 21 20 82         	LD	IY,REG_FIFO_0
    2245/     BAD :                     		;
    2246/     BAD : CD 68 10            	CALL	READCONT
    2247/     BB0 :                     
    2248/     BB0 : AF                  	XOR	A
    2249/     BB1 : 32 01 82            	LD	(REG_SDCTRL),A
    2250/     BB4 : C9                  	RET
    2251/     BB5 :                     
    2252/     BB5 :                     
    2253/     BB5 :                     ;
    2254/     BB5 :                     ; write file
    2255/     BB5 :                     ;
    2256/     BB5 :                     CMTWRITEWAIT:
    2257/     BB5 : 3A B6 22            	LD	A,(WRITEFLAG)
    2258/     BB8 : B7                  	OR	A
    2259/     BB9 : C8                  	RET	Z
    2260/     BBA : 3D                  	DEC	A
    2261/     BBB : C2 69 0C            	JP	NZ,CWW_FL2
    2262/     BBE :                     
    2263/     BBE :                     
    2264/     BBE :                     		;
    2265/     BBE :                     		; WRITEFLAG = 1
    2266/     BBE :                     		;
    2267/     BBE : 3A 12 82            	LD	A,(REG_CMTOPEN)
    2268/     BC1 : E6 02               	AND	02H
    2269/     BC3 : C8                  	RET	Z
    2270/     BC4 :                     
    2271/     BC4 :                     		;
    2272/     BC4 : 3E 01               	LD	A,01H
    2273/     BC6 : 32 01 82            	LD	(REG_SDCTRL),A
    2274/     BC9 : 32 10 82            	LD	(REG_BUFAD),A
    2275/     BCC : FD 21 40 82         	LD	IY,REG_FIFO_1
    2276/     BD0 :                     
    2277/     BD0 :                     		;
    2278/     BD0 :                     		; get new file length and new start claster
    2279/     BD0 :                     		;
    2280/     BD0 : FD 6E 0F            	LD	L,(IY+FIFO_DIRCL+0)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 39 - 2/18/2013 12:10:16


    2281/     BD3 : FD 66 10            	LD	H,(IY+FIFO_DIRCL+1)
    2282/     BD6 : 22 A0 22            	LD	(DIRCL),HL
    2283/     BD9 : FD 6E 11            	LD	L,(IY+FIFO_DIRPOS+0)
    2284/     BDC : FD 66 12            	LD	H,(IY+FIFO_DIRPOS+1)
    2285/     BDF : 22 A2 22            	LD	(DIRPOS),HL
    2286/     BE2 :                     		;
    2287/     BE2 :                     
    2288/     BE2 : CD AC 11            	CALL	READ_DIRFILE
    2289/     BE5 :                     
    2290/     BE5 :                     		;
    2291/     BE5 : 01 1A 00            	LD	BC,001AH
    2292/     BE8 : 09                  	ADD	HL,BC
    2293/     BE9 :                     
    2294/     BE9 : CD 9C 06            	CALL	SETFILEPARA2
    2295/     BEC :                     
    2296/     BEC : FD 7E 00            	LD	A,(IY+FIFO_CMTLEN+0)
    2297/     BEF : FD 77 04            	LD	(IY+FIFO_CMTPTR+0),A
    2298/     BF2 : FD 7E 01            	LD	A,(IY+FIFO_CMTLEN+1)
    2299/     BF5 : FD 77 05            	LD	(IY+FIFO_CMTPTR+1),A
    2300/     BF8 : FD 7E 02            	LD	A,(IY+FIFO_CMTLEN+2)
    2301/     BFB : FD 77 06            	LD	(IY+FIFO_CMTPTR+2),A
    2302/     BFE : FD 7E 03            	LD	A,(IY+FIFO_CMTLEN+3)
    2303/     C01 : FD 77 07            	LD	(IY+FIFO_CMTPTR+3),A
    2304/     C04 :                     
    2305/     C04 : CD 33 0E            	CALL	FILETAILREAD
    2306/     C07 :                     
    2307/     C07 : 3E 06               	LD	A,06H
    2308/     C09 : 32 54 82            	LD	(REG_CMTWR),A
    2309/     C0C : 3E 04               	LD	A,04H
    2310/     C0E : 32 54 82            	LD	(REG_CMTWR),A
    2311/     C11 :                     
    2312/     C11 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2313/     C14 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2314/     C17 :                     
    2315/     C17 : 7D                  	LD	A,L
    2316/     C18 : B4                  	OR	H
    2317/     C19 : 20 17               	JR	NZ,CWWL0
    2318/     C1B :                     
    2319/     C1B :                     		;
    2320/     C1B :                     		; file length = 0
    2321/     C1B :                     		;
    2322/     C1B : CD 7C 12            	CALL	GET_NEWCL
    2323/     C1E :                     
    2324/     C1E : FD 75 08            	LD	(IY+FIFO_CL+0),L
    2325/     C21 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    2326/     C24 : FD 75 0B            	LD	(IY+FIFO_STCL+0),L
    2327/     C27 : FD 74 0C            	LD	(IY+FIFO_STCL+1),H
    2328/     C2A :                     
    2329/     C2A : 11 FF FF            	LD	DE,0FFFFH
    2330/     C2D : CD AD 12            	CALL	FATWRITE
    2331/     C30 :                     
    2332/     C30 : 18 23               	JR	CWWL1
    2333/     C32 :                     
    2334/     C32 :                     CWWL0:
    2335/     C32 : 11 F8 FF            	LD	DE,0FFF8H
    2336/     C35 : B7                  	OR	A
    2337/     C36 : ED 52               	SBC	HL,DE
    2338/     C38 : 38 1B               	JR	C,CWWL1
    2339/     C3A :                     
    2340/     C3A :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 40 - 2/18/2013 12:10:16


    2341/     C3A :                     		; file length % (200H x FATSEC) = 0
    2342/     C3A :                     		;
    2343/     C3A : CD 7C 12            	CALL	GET_NEWCL
    2344/     C3D :                     
    2345/     C3D : FD 75 08            	LD	(IY+FIFO_CL+0),L
    2346/     C40 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    2347/     C43 :                     
    2348/     C43 : E5                  	PUSH	HL
    2349/     C44 : 11 FF FF            	LD	DE,0FFFFH
    2350/     C47 : CD AD 12            	CALL	FATWRITE
    2351/     C4A :                     		;
    2352/     C4A : E1                  	POP	HL
    2353/     C4B : EB                  	EX	DE,HL
    2354/     C4C : FD 6E 0D            	LD	L,(IY+FIFO_BEFCL+0)
    2355/     C4F : FD 66 0E            	LD	H,(IY+FIFO_BEFCL+1)
    2356/     C52 : CD AD 12            	CALL	FATWRITE
    2357/     C55 :                     
    2358/     C55 :                     CWWL1:
    2359/     C55 :                     
    2360/     C55 : 3E 0C               	LD	A,0CH
    2361/     C57 : 32 11 82            	LD	(REG_BUFSEL),A
    2362/     C5A :                     
    2363/     C5A : 3E 05               	LD	A,05H
    2364/     C5C : 32 54 82            	LD	(REG_CMTWR),A
    2365/     C5F : 3D                  	DEC	A
    2366/     C60 : 32 54 82            	LD	(REG_CMTWR),A
    2367/     C63 :                     
    2368/     C63 : 3E 02               	LD	A,02H
    2369/     C65 : 32 B6 22            	LD	(WRITEFLAG),A
    2370/     C68 :                     
    2371/     C68 :                     
    2372/     C68 : C9                  	RET
    2373/     C69 :                     
    2374/     C69 :                     
    2375/     C69 :                     		;
    2376/     C69 :                     		; WRITEFLAG = 2
    2377/     C69 :                     		;
    2378/     C69 :                     CWW_FL2:
    2379/     C69 : 3E 01               	LD	A,01H
    2380/     C6B : 32 10 82            	LD	(REG_BUFAD),A
    2381/     C6E : FD 21 40 82         	LD	IY,REG_FIFO_1
    2382/     C72 :                     
    2383/     C72 : 3A 12 82            	LD	A,(REG_CMTOPEN)
    2384/     C75 : E6 02               	AND	02H
    2385/     C77 : 28 65               	JR	Z,CWWL2
    2386/     C79 :                     
    2387/     C79 : 3A 54 82            	LD	A,(REG_CMTWR)
    2388/     C7C : E6 10               	AND	10H
    2389/     C7E :                     
    2390/     C7E :                     		;
    2391/     C7E :                     		; saveopen = 1 and wrfull = 0
    2392/     C7E :                     		; no process
    2393/     C7E :                     		;
    2394/     C7E : C8                  	RET	Z
    2395/     C7F :                     
    2396/     C7F :                     		;
    2397/     C7F :                     		; saveopen = 1 and wrfull = 1
    2398/     C7F :                     		;
    2399/     C7F :                     
    2400/     C7F :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 41 - 2/18/2013 12:10:16


    2401/     C7F :                     		; write 1 sector
    2402/     C7F :                     		;
    2403/     C7F : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2404/     C82 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2405/     C85 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2406/     C88 : CD 03 12            	CALL	CALCSDADD
    2407/     C8B :                     		;
    2408/     C8B : 21 A4 22            	LD	HL,WORK
    2409/     C8E : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    2410/     C91 :                     		;
    2411/     C91 : CD AA 13            	CALL	WRITE1SEC
    2412/     C94 :                     
    2413/     C94 :                     		;
    2414/     C94 :                     		; new sector
    2415/     C94 :                     		;
    2416/     C94 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2417/     C97 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2418/     C9A : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2419/     C9D : E5                  	PUSH	HL
    2420/     C9E : CD 6B 12            	CALL	GET_NEWSEC
    2421/     CA1 : FD 75 08            	LD	(IY+FIFO_CL+0),L
    2422/     CA4 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    2423/     CA7 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    2424/     CAA :                     
    2425/     CAA : E1                  	POP	HL
    2426/     CAB : B7                  	OR	A
    2427/     CAC : 20 21               	JR	NZ,CWWL11
    2428/     CAE :                     		;
    2429/     CAE :                     
    2430/     CAE : FD 75 0D            	LD	(IY+FIFO_BEFCL+0),L
    2431/     CB1 : FD 74 0E            	LD	(IY+FIFO_BEFCL+1),H
    2432/     CB4 :                     		;
    2433/     CB4 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2434/     CB7 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2435/     CBA : 11 FF FF            	LD	DE,0FFFFH
    2436/     CBD : CD AD 12            	CALL	FATWRITE
    2437/     CC0 :                     		;
    2438/     CC0 : FD 5E 08            	LD	E,(IY+FIFO_CL+0)
    2439/     CC3 : FD 56 09            	LD	D,(IY+FIFO_CL+1)
    2440/     CC6 : FD 6E 0D            	LD	L,(IY+FIFO_BEFCL+0)
    2441/     CC9 : FD 66 0E            	LD	H,(IY+FIFO_BEFCL+1)
    2442/     CCC :                     
    2443/     CCC : CD AD 12            	CALL	FATWRITE
    2444/     CCF :                     
    2445/     CCF :                     CWWL11:
    2446/     CCF : 3E 0C               	LD	A,0CH
    2447/     CD1 : 32 11 82            	LD	(REG_BUFSEL),A
    2448/     CD4 :                     
    2449/     CD4 : 3E 05               	LD	A,05H
    2450/     CD6 : 32 54 82            	LD	(REG_CMTWR),A
    2451/     CD9 : 3D                  	DEC	A
    2452/     CDA : 32 54 82            	LD	(REG_CMTWR),A
    2453/     CDD :                     
    2454/     CDD : C9                  	RET
    2455/     CDE :                     
    2456/     CDE :                     CWWL2:
    2457/     CDE : 3A 54 82            	LD	A,(REG_CMTWR)
    2458/     CE1 : E6 10               	AND	10H
    2459/     CE3 : 20 31               	JR	NZ,CWWL3
    2460/     CE5 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 42 - 2/18/2013 12:10:16


    2461/     CE5 :                     		;
    2462/     CE5 :                     		; saveopen = 0 and wrfull = 0
    2463/     CE5 :                     		;
    2464/     CE5 :                     
    2465/     CE5 : FD 7E 16            	LD	A,(IY+FIFO_WRADD+1)
    2466/     CE8 : E6 01               	AND	01H
    2467/     CEA : FD B6 15            	OR	(IY+FIFO_WRADD+0)
    2468/     CED :                     
    2469/     CED :                     		;
    2470/     CED :                     		; cmtwradd(8:0) <> 0
    2471/     CED :                     		;
    2472/     CED : 20 27               	JR	NZ,CWWL3
    2473/     CEF :                     
    2474/     CEF : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2475/     CF2 : B7                  	OR	A
    2476/     CF3 :                     
    2477/     CF3 :                     		;
    2478/     CF3 :                     		; (IY+FIFO_SEC) <> 0
    2479/     CF3 :                     		;
    2480/     CF3 : 20 36               	JR	NZ,CWWL4
    2481/     CF5 :                     
    2482/     CF5 :                     		;
    2483/     CF5 :                     		; (IY+FIFO_SEC) = 0
    2484/     CF5 :                     		;
    2485/     CF5 :                     
    2486/     CF5 :                     		; FAT rewind
    2487/     CF5 :                     
    2488/     CF5 : CD 4B 15            	CALL	SDADDINIT
    2489/     CF8 :                     
    2490/     CF8 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2491/     CFB : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2492/     CFE : 11 00 00            	LD	DE,0000H
    2493/     D01 :                     
    2494/     D01 : CD AD 12            	CALL	FATWRITE
    2495/     D04 :                     
    2496/     D04 : FD 6E 0D            	LD	L,(IY+FIFO_BEFCL+0)
    2497/     D07 : FD 66 0E            	LD	H,(IY+FIFO_BEFCL+1)
    2498/     D0A : 7D                  	LD	A,L
    2499/     D0B : B4                  	OR	H
    2500/     D0C :                     
    2501/     D0C : 28 1D               	JR	Z,CWWL4
    2502/     D0E :                     
    2503/     D0E : 11 FF FF            	LD	DE,0FFFFH
    2504/     D11 : CD AD 12            	CALL	FATWRITE
    2505/     D14 :                     
    2506/     D14 : 18 15               	JR	CWWL4
    2507/     D16 :                     
    2508/     D16 :                     
    2509/     D16 :                     CWWL3:
    2510/     D16 :                     		;
    2511/     D16 :                     		; saveopen = 0 and wrfull = 1
    2512/     D16 :                     		;
    2513/     D16 :                     
    2514/     D16 :                     		;
    2515/     D16 :                     		; write 1 sector
    2516/     D16 :                     		;
    2517/     D16 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2518/     D19 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2519/     D1C : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2520/     D1F : CD 03 12            	CALL	CALCSDADD
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 43 - 2/18/2013 12:10:16


    2521/     D22 :                     		;
    2522/     D22 : 21 A4 22            	LD	HL,WORK
    2523/     D25 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    2524/     D28 :                     		;
    2525/     D28 :                     
    2526/     D28 : CD AA 13            	CALL	WRITE1SEC
    2527/     D2B :                     
    2528/     D2B :                     CWWL4:
    2529/     D2B :                     		;
    2530/     D2B :                     		; file length and claster overwrite
    2531/     D2B :                     		;
    2532/     D2B : AF                  	XOR	A
    2533/     D2C : FD B6 15            	OR	(IY+FIFO_WRADD+0)
    2534/     D2F : FD B6 16            	OR	(IY+FIFO_WRADD+1)
    2535/     D32 : FD B6 17            	OR	(IY+FIFO_WRADD+2)
    2536/     D35 : FD B6 18            	OR	(IY+FIFO_WRADD+3)
    2537/     D38 : 20 07               	JR	NZ,CWWL5
    2538/     D3A :                     
    2539/     D3A :                     		;
    2540/     D3A :                     		; file length = 0 -> claster = 0
    2541/     D3A :                     		;
    2542/     D3A : AF                  	XOR	A
    2543/     D3B : FD 77 0B            	LD	(IY+FIFO_STCL+0),A
    2544/     D3E : FD 77 0C            	LD	(IY+FIFO_STCL+1),A
    2545/     D41 :                     
    2546/     D41 :                     CWWL5:
    2547/     D41 : FD 6E 0F            	LD	L,(IY+FIFO_DIRCL+0)
    2548/     D44 : FD 66 10            	LD	H,(IY+FIFO_DIRCL+1)
    2549/     D47 : 22 A0 22            	LD	(DIRCL),HL
    2550/     D4A : FD 6E 11            	LD	L,(IY+FIFO_DIRPOS+0)
    2551/     D4D : FD 66 12            	LD	H,(IY+FIFO_DIRPOS+1)
    2552/     D50 : 22 A2 22            	LD	(DIRPOS),HL
    2553/     D53 :                     
    2554/     D53 : CD AC 11            	CALL	READ_DIRFILE
    2555/     D56 :                     
    2556/     D56 : 3E 09               	LD	A,09H
    2557/     D58 : 32 11 82            	LD	(REG_BUFSEL),A
    2558/     D5B :                     
    2559/     D5B : 11 1A 00            	LD	DE,001AH
    2560/     D5E : 19                  	ADD	HL,DE
    2561/     D5F :                     		;
    2562/     D5F : FD 7E 0B            	LD	A,(IY+FIFO_STCL+0)
    2563/     D62 : 77                  	LD	(HL),A
    2564/     D63 : 23                  	INC	HL
    2565/     D64 : FD 7E 0C            	LD	A,(IY+FIFO_STCL+1)
    2566/     D67 : 77                  	LD	(HL),A
    2567/     D68 : 23                  	INC	HL
    2568/     D69 :                     		;
    2569/     D69 : FD 7E 15            	LD	A,(IY+FIFO_WRADD+0)
    2570/     D6C : 77                  	LD	(HL),A
    2571/     D6D : 23                  	INC	HL
    2572/     D6E : FD 7E 16            	LD	A,(IY+FIFO_WRADD+1)
    2573/     D71 : 77                  	LD	(HL),A
    2574/     D72 : 23                  	INC	HL
    2575/     D73 : FD 7E 17            	LD	A,(IY+FIFO_WRADD+2)
    2576/     D76 : 77                  	LD	(HL),A
    2577/     D77 : 23                  	INC	HL
    2578/     D78 : FD 7E 18            	LD	A,(IY+FIFO_WRADD+3)
    2579/     D7B : 77                  	LD	(HL),A
    2580/     D7C :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 44 - 2/18/2013 12:10:16


    2581/     D7C : CD AA 13            	CALL	WRITE1SEC
    2582/     D7F :                     
    2583/     D7F : AF                  	XOR	A
    2584/     D80 : 32 01 82            	LD	(REG_SDCTRL),A
    2585/     D83 : 3C                  	INC	A
    2586/     D84 : 32 11 82            	LD	(REG_BUFSEL),A
    2587/     D87 : 32 B6 22            	LD	(WRITEFLAG),A
    2588/     D8A : C9                  	RET
    2589/     D8B :                     
    2590/     D8B :                     
    2591/     D8B :                     ;
    2592/     D8B :                     ; file read from any position within 512 bytes
    2593/     D8B :                     ; (REG_BUFAD) <= use FIFO number
    2594/     D8B :                     ; (IY+FIFO_CMTLEN) <= file length
    2595/     D8B :                     ; (IY+FIFO_CMTPTR) <= read start position
    2596/     D8B :                     ; (P6TBUFFER) <= key data buffer
    2597/     D8B :                     ; IY <= use FIFO number
    2598/     D8B :                     ; A  <= read length
    2599/     D8B :                     ;
    2600/     D8B :                     ; RETURN
    2601/     D8B :                     ; A <= read length
    2602/     D8B :                     ;
    2603/     D8B :                     FILEPOSREAD:
    2604/     D8B :                     		;
    2605/     D8B :                     		; HLDE <= (IY+CMTLEN) - (IY+CMTPTR)
    2606/     D8B :                     		;
    2607/     D8B : B7                  	OR	A
    2608/     D8C : FD 6E 00            	LD	L,(IY+FIFO_CMTLEN+0)
    2609/     D8F : FD 66 01            	LD	H,(IY+FIFO_CMTLEN+1)
    2610/     D92 : FD 4E 04            	LD	C,(IY+FIFO_CMTPTR+0)
    2611/     D95 : FD 46 05            	LD	B,(IY+FIFO_CMTPTR+1)
    2612/     D98 : ED 42               	SBC	HL,BC
    2613/     D9A : EB                  	EX	DE,HL
    2614/     D9B : FD 6E 02            	LD	L,(IY+FIFO_CMTLEN+2)
    2615/     D9E : FD 66 03            	LD	H,(IY+FIFO_CMTLEN+3)
    2616/     DA1 : FD 4E 06            	LD	C,(IY+FIFO_CMTPTR+2)
    2617/     DA4 : FD 46 07            	LD	B,(IY+FIFO_CMTPTR+3)
    2618/     DA7 : ED 42               	SBC	HL,BC
    2619/     DA9 :                     
    2620/     DA9 : 30 05               	JR	NC,FPOSL_OK
    2621/     DAB :                     
    2622/     DAB : 06 00               	LD	B,00H
    2623/     DAD : C5                  	PUSH	BC
    2624/     DAE : 18 67               	JR	FPOSL_ED
    2625/     DB0 :                     
    2626/     DB0 :                     FPOSL_OK:
    2627/     DB0 : F5                  	PUSH	AF
    2628/     DB1 : AF                  	XOR	A
    2629/     DB2 : B4                  	OR	H
    2630/     DB3 : B5                  	OR	L
    2631/     DB4 : B2                  	OR	D
    2632/     DB5 : C1                  	POP	BC
    2633/     DB6 : 20 0C               	JR	NZ,FPOSL0
    2634/     DB8 :                     
    2635/     DB8 : 7B                  	LD	A,E
    2636/     DB9 : B8                  	CP	B
    2637/     DBA : 30 08               	JR	NC,FPOSL0
    2638/     DBC :                     
    2639/     DBC : 43                  	LD	B,E
    2640/     DBD :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 45 - 2/18/2013 12:10:16


    2641/     DBD : 78                  	LD	A,B
    2642/     DBE : B7                  	OR	A
    2643/     DBF : 20 03               	JR	NZ,FPOSL0
    2644/     DC1 :                     
    2645/     DC1 : C5                  	PUSH	BC
    2646/     DC2 : 18 53               	JR	FPOSL_ED
    2647/     DC4 :                     
    2648/     DC4 :                     FPOSL0:
    2649/     DC4 : 3E 01               	LD	A,01H
    2650/     DC6 : 32 01 82            	LD	(REG_SDCTRL),A
    2651/     DC9 :                     
    2652/     DC9 : C5                  	PUSH	BC
    2653/     DCA : C5                  	PUSH	BC
    2654/     DCB :                     
    2655/     DCB : CD 33 0E            	CALL	FILETAILREAD
    2656/     DCE :                     
    2657/     DCE : FD 6E 04            	LD	L,(IY+FIFO_CMTPTR+0)
    2658/     DD1 : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    2659/     DD4 : E6 01               	AND	01H
    2660/     DD6 : 67                  	LD	H,A
    2661/     DD7 : 11 00 80            	LD	DE,REG_SDBUF
    2662/     DDA : 19                  	ADD	HL,DE
    2663/     DDB :                     		;
    2664/     DDB : 11 BB 28            	LD	DE,P6TBUFFER
    2665/     DDE :                     		;
    2666/     DDE : 3E 01               	LD	A,01H
    2667/     DE0 : FD 77 13            	LD	(IY+FIFO_FATNEW),A
    2668/     DE3 :                     
    2669/     DE3 : C1                  	POP	BC
    2670/     DE4 :                     FPOSL1:
    2671/     DE4 : C5                  	PUSH	BC
    2672/     DE5 : 7C                  	LD	A,H
    2673/     DE6 : E6 01               	AND	01H
    2674/     DE8 : B5                  	OR	L
    2675/     DE9 : 20 21               	JR	NZ,FPOSL2
    2676/     DEB :                     
    2677/     DEB : D5                  	PUSH	DE
    2678/     DEC :                     
    2679/     DEC : FD 7E 13            	LD	A,(IY+FIFO_FATNEW)
    2680/     DEF : B7                  	OR	A
    2681/     DF0 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2682/     DF3 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2683/     DF6 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2684/     DF9 : CC 3B 12            	CALL	Z,GET_NEXTSEC
    2685/     DFC :                     		;
    2686/     DFC :                     
    2687/     DFC : CD 03 12            	CALL	CALCSDADD
    2688/     DFF :                     		;
    2689/     DFF : 21 A4 22            	LD	HL,WORK
    2690/     E02 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    2691/     E05 : CD 8D 13            	CALL	READ1SEC
    2692/     E08 :                     
    2693/     E08 : D1                  	POP	DE
    2694/     E09 : 21 00 80            	LD	HL,REG_SDBUF
    2695/     E0C :                     
    2696/     E0C :                     FPOSL2:
    2697/     E0C : AF                  	XOR	A
    2698/     E0D : FD 77 13            	LD	(IY+FIFO_FATNEW),A
    2699/     E10 :                     		;
    2700/     E10 : 7E                  	LD	A,(HL)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 46 - 2/18/2013 12:10:16


    2701/     E11 : 12                  	LD	(DE),A
    2702/     E12 :                     		;
    2703/     E12 : 23                  	INC	HL
    2704/     E13 : 13                  	INC	DE
    2705/     E14 :                     
    2706/     E14 : C1                  	POP	BC
    2707/     E15 : 10 CD               	DJNZ	FPOSL1
    2708/     E17 :                     
    2709/     E17 :                     FPOSL_ED:
    2710/     E17 : AF                  	XOR	A
    2711/     E18 : 32 01 82            	LD	(REG_SDCTRL),A
    2712/     E1B : FD 77 0A            	LD	(IY+FIFO_SEC),A
    2713/     E1E :                     
    2714/     E1E : FD 7E 0B            	LD	A,(IY+FIFO_STCL+0)
    2715/     E21 : FD 77 08            	LD	(IY+FIFO_CL+0),A
    2716/     E24 : FD 7E 0C            	LD	A,(IY+FIFO_STCL+1)
    2717/     E27 : FD 77 09            	LD	(IY+FIFO_CL+1),A
    2718/     E2A :                     
    2719/     E2A : 21 34 82            	LD	HL,REG_CMTRD
    2720/     E2D : 36 02               	LD	(HL),02H
    2721/     E2F : 36 00               	LD	(HL),00H
    2722/     E31 :                     
    2723/     E31 : F1                  	POP	AF
    2724/     E32 : C9                  	RET
    2725/     E33 :                     
    2726/     E33 :                     
    2727/     E33 :                     ;
    2728/     E33 :                     ; 1 sector read from file tail
    2729/     E33 :                     ; (REG_BUFAD) <= use FIFO number
    2730/     E33 :                     ; (IY+FIFO_CMTPTR) <= read length
    2731/     E33 :                     ; IY <= use FIFO number
    2732/     E33 :                     ;
    2733/     E33 :                     ; RETURN :
    2734/     E33 :                     ; (IY+CL),(IY+SEC) <= next sector
    2735/     E33 :                     ; (IY+BEFCL)       <= before claster
    2736/     E33 :                     ;
    2737/     E33 :                     ; Zflag <= 1  -> not read 1 sector
    2738/     E33 :                     ; 
    2739/     E33 :                     ; (IY+CL),(IY+BEFCL) = 0000H
    2740/     E33 :                     ; -> file length = 0  (and not read 1 sector)
    2741/     E33 :                     ;
    2742/     E33 :                     ; (IY+CL) >= FFF8H
    2743/     E33 :                     ; -> file length % 200H = 0  (and not read 1 sector)
    2744/     E33 :                     ;
    2745/     E33 :                     
    2746/     E33 :                     FILETAILREAD:
    2747/     E33 : FD 7E 0B            	LD	A,(IY+FIFO_STCL+0)
    2748/     E36 : FD 77 08            	LD	(IY+FIFO_CL+0),A
    2749/     E39 : FD 7E 0C            	LD	A,(IY+FIFO_STCL+1)
    2750/     E3C : FD 77 09            	LD	(IY+FIFO_CL+1),A
    2751/     E3F : AF                  	XOR	A
    2752/     E40 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    2753/     E43 : FD 77 0D            	LD	(IY+FIFO_BEFCL+0),A
    2754/     E46 : FD 77 0E            	LD	(IY+FIFO_BEFCL+1),A
    2755/     E49 : 21 00 00            	LD	HL,0000H
    2756/     E4C : 22 B0 22            	LD	(WORK4+0),HL
    2757/     E4F : 22 B2 22            	LD	(WORK4+2),HL
    2758/     E52 :                     
    2759/     E52 :                     FDRL2:
    2760/     E52 :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 47 - 2/18/2013 12:10:16


    2761/     E52 :                     		; CP (IY+FIFO_CMTPTR)-(WORK4)
    2762/     E52 :                     		;
    2763/     E52 : FD E5               	PUSH	IY
    2764/     E54 : E1                  	POP	HL
    2765/     E55 : 1E 04               	LD	E,FIFO_CMTPTR
    2766/     E57 : 16 00               	LD	D,00H
    2767/     E59 : 19                  	ADD	HL,DE
    2768/     E5A : E5                  	PUSH	HL
    2769/     E5B :                     		;
    2770/     E5B : 11 B0 22            	LD	DE,WORK4
    2771/     E5E : 06 04               	LD	B,04H
    2772/     E60 : CD 65 13            	CALL	CP_MHL_MDE
    2773/     E63 : E1                  	POP	HL
    2774/     E64 :                     
    2775/     E64 : C8                  	RET	Z
    2776/     E65 :                     
    2777/     E65 : E5                  	PUSH	HL
    2778/     E66 :                     
    2779/     E66 :                     		;
    2780/     E66 :                     		; (WORK4) = (WORK4) + 0200H
    2781/     E66 :                     		;
    2782/     E66 : 21 00 02            	LD	HL,0200H
    2783/     E69 : 22 A4 22            	LD	(WORK+0),HL
    2784/     E6C : 21 00 00            	LD	HL,0000H
    2785/     E6F : 22 A6 22            	LD	(WORK+2),HL
    2786/     E72 : 11 A4 22            	LD	DE,WORK
    2787/     E75 : 21 B0 22            	LD	HL,WORK4
    2788/     E78 : CD 2F 13            	CALL	ADD4B_MHL_MDE
    2789/     E7B :                     
    2790/     E7B :                     		;
    2791/     E7B :                     		; CP (IY+FIFO_CMTPTR)-(WORK4)
    2792/     E7B :                     		;
    2793/     E7B : E1                  	POP	HL
    2794/     E7C : 11 B0 22            	LD	DE,WORK4
    2795/     E7F : 06 04               	LD	B,04H
    2796/     E81 : CD 65 13            	CALL	CP_MHL_MDE
    2797/     E84 : 38 22               	JR	C,FDRL_END
    2798/     E86 :                     
    2799/     E86 :                     		;
    2800/     E86 :                     		; sector ++
    2801/     E86 :                     		;
    2802/     E86 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2803/     E89 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2804/     E8C : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2805/     E8F : E5                  	PUSH	HL
    2806/     E90 : CD 3B 12            	CALL	GET_NEXTSEC
    2807/     E93 : FD 75 08            	LD	(IY+FIFO_CL+0),L
    2808/     E96 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    2809/     E99 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    2810/     E9C :                     		;
    2811/     E9C : E1                  	POP	HL
    2812/     E9D : B7                  	OR	A
    2813/     E9E : 20 B2               	JR	NZ,FDRL2
    2814/     EA0 :                     		;
    2815/     EA0 : FD 75 0D            	LD	(IY+FIFO_BEFCL+0),L
    2816/     EA3 : FD 74 0E            	LD	(IY+FIFO_BEFCL+1),H
    2817/     EA6 :                     		;
    2818/     EA6 : 18 AA               	JR	FDRL2
    2819/     EA8 :                     
    2820/     EA8 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 48 - 2/18/2013 12:10:16


    2821/     EA8 :                     FDRL_END:
    2822/     EA8 :                     		;
    2823/     EA8 :                     		; read 1 sector of file end
    2824/     EA8 :                     		;
    2825/     EA8 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2826/     EAB : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2827/     EAE : 7C                  	LD	A,H
    2828/     EAF : B5                  	OR	L
    2829/     EB0 : CA 11 14            	JP	Z,SDERR
    2830/     EB3 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2831/     EB6 : CD 03 12            	CALL	CALCSDADD
    2832/     EB9 :                     		;
    2833/     EB9 : 21 A4 22            	LD	HL,WORK
    2834/     EBC : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    2835/     EBF :                     		;
    2836/     EBF : CD 8D 13            	CALL	READ1SEC
    2837/     EC2 :                     		;
    2838/     EC2 : 3E 01               	LD	A,01H
    2839/     EC4 : B7                  	OR	A
    2840/     EC5 : C9                  	RET
    2841/     EC6 :                     
    2842/     EC6 :                     
    2843/     EC6 :                     ;
    2844/     EC6 :                     ; jump read pointer
    2845/     EC6 :                     ; (REG_BUFAD) <= use FIFO number
    2846/     EC6 :                     ; BCDE <= read pointer
    2847/     EC6 :                     ; IY <= use FIFO number
    2848/     EC6 :                     ;
    2849/     EC6 :                     JMPREADPTR:
    2850/     EC6 : FD 73 04            	LD	(IY+FIFO_CMTPTR+0),E
    2851/     EC9 : FD 72 05            	LD	(IY+FIFO_CMTPTR+1),D
    2852/     ECC : FD 71 06            	LD	(IY+FIFO_CMTPTR+2),C
    2853/     ECF : FD 70 07            	LD	(IY+FIFO_CMTPTR+3),B
    2854/     ED2 : CD 33 0E            	CALL	FILETAILREAD
    2855/     ED5 : C0                  	RET	NZ
    2856/     ED6 : 18 D0               	JR	FDRL_END
    2857/     ED8 :                     
    2858/     ED8 :                     ;
    2859/     ED8 :                     ; rewind read pointer
    2860/     ED8 :                     ; (REG_BUFAD) <= use FIFO number
    2861/     ED8 :                     ; read(write) pointer <= sector address
    2862/     ED8 :                     ; BCDE <= pointer added
    2863/     ED8 :                     ; IY <= use FIFO number
    2864/     ED8 :                     ;
    2865/     ED8 :                     MOVEREADPTR:
    2866/     ED8 : 21 A4 22            	LD	HL,WORK
    2867/     EDB : 73                  	LD	(HL),E
    2868/     EDC : 23                  	INC	HL
    2869/     EDD : 72                  	LD	(HL),D
    2870/     EDE : 23                  	INC	HL
    2871/     EDF : 71                  	LD	(HL),C
    2872/     EE0 : 23                  	INC	HL
    2873/     EE1 : 70                  	LD	(HL),B
    2874/     EE2 :                     
    2875/     EE2 : FD E5               	PUSH	IY
    2876/     EE4 : E1                  	POP	HL
    2877/     EE5 : 0E 04               	LD	C,FIFO_CMTPTR
    2878/     EE7 : 06 00               	LD	B,00H
    2879/     EE9 : 09                  	ADD	HL,BC
    2880/     EEA : 11 A4 22            	LD	DE,WORK
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 49 - 2/18/2013 12:10:16


    2881/     EED : CD 2F 13            	CALL	ADD4B_MHL_MDE
    2882/     EF0 :                     
    2883/     EF0 : CD 33 0E            	CALL	FILETAILREAD
    2884/     EF3 : C0                  	RET	NZ
    2885/     EF4 : 18 B2               	JR	FDRL_END
    2886/     EF6 :                     
    2887/     EF6 :                     ;
    2888/     EF6 :                     ; 1 byte read from file
    2889/     EF6 :                     ; (REG_BUFAD) <= use FIFO number
    2890/     EF6 :                     ; (IY+FIFO_CMTPTR) <= read pointer
    2891/     EF6 :                     ; IY <= use FIFO number
    2892/     EF6 :                     ;
    2893/     EF6 :                     ; RETURN :
    2894/     EF6 :                     ; A <= read data
    2895/     EF6 :                     ; (IY+FIFO_CMTPTR) <= read pointer + 1
    2896/     EF6 :                     ;
    2897/     EF6 :                     ;
    2898/     EF6 :                     READ1BYTE:
    2899/     EF6 : C5                  	PUSH	BC
    2900/     EF7 : D5                  	PUSH	DE
    2901/     EF8 : E5                  	PUSH	HL
    2902/     EF9 :                     
    2903/     EF9 :                     		;
    2904/     EF9 :                     		; 1 byte read
    2905/     EF9 :                     		;
    2906/     EF9 : FD 5E 04            	LD	E,(IY+FIFO_CMTPTR+0)
    2907/     EFC : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    2908/     EFF : E6 01               	AND	01H
    2909/     F01 : 57                  	LD	D,A
    2910/     F02 : 21 00 80            	LD	HL,REG_SDBUF
    2911/     F05 : 19                  	ADD	HL,DE
    2912/     F06 :                     
    2913/     F06 : 3E 01               	LD	A,01H
    2914/     F08 : 32 11 82            	LD	(REG_BUFSEL),A
    2915/     F0B : 7E                  	LD	A,(HL)
    2916/     F0C : F5                  	PUSH	AF
    2917/     F0D :                     
    2918/     F0D :                     		;
    2919/     F0D :                     		; INC (IY+FIFO_CMTPTR)
    2920/     F0D :                     		;
    2921/     F0D : FD E5               	PUSH	IY
    2922/     F0F : E1                  	POP	HL
    2923/     F10 : 1E 04               	LD	E,FIFO_CMTPTR
    2924/     F12 : 16 00               	LD	D,00H
    2925/     F14 : 19                  	ADD	HL,DE
    2926/     F15 :                     		;
    2927/     F15 : 3E 01               	LD	A,01H
    2928/     F17 : CD 42 13            	CALL	ADD4B_MHL_A
    2929/     F1A :                     
    2930/     F1A :                     		;
    2931/     F1A :                     		; (IY+FIFO_CMTPTR) % 200H = 0?
    2932/     F1A :                     		;
    2933/     F1A : FD 5E 04            	LD	E,(IY+FIFO_CMTPTR+0)
    2934/     F1D : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    2935/     F20 : E6 01               	AND	01H
    2936/     F22 : B3                  	OR	E
    2937/     F23 : 20 3A               	JR	NZ,LR1BL1
    2938/     F25 :                     
    2939/     F25 :                     		;
    2940/     F25 :                     		; sector ++
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 50 - 2/18/2013 12:10:16


    2941/     F25 :                     		;
    2942/     F25 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2943/     F28 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2944/     F2B : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2945/     F2E : E5                  	PUSH	HL
    2946/     F2F : CD 3B 12            	CALL	GET_NEXTSEC
    2947/     F32 : FD 75 08            	LD	(IY+FIFO_CL+0),L
    2948/     F35 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    2949/     F38 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    2950/     F3B :                     		;
    2951/     F3B : E1                  	POP	HL
    2952/     F3C : B7                  	OR	A
    2953/     F3D : 20 06               	JR	NZ,LR1BL2
    2954/     F3F :                     		;
    2955/     F3F : FD 75 0D            	LD	(IY+FIFO_BEFCL+0),L
    2956/     F42 : FD 74 0E            	LD	(IY+FIFO_BEFCL+1),H
    2957/     F45 :                     		;
    2958/     F45 :                     
    2959/     F45 :                     		;
    2960/     F45 :                     		; 1 sector read
    2961/     F45 :                     		;
    2962/     F45 :                     LR1BL2:
    2963/     F45 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    2964/     F48 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    2965/     F4B : 7D                  	LD	A,L
    2966/     F4C : B4                  	OR	H
    2967/     F4D : CA 11 14            	JP	Z,SDERR
    2968/     F50 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    2969/     F53 : CD 03 12            	CALL	CALCSDADD
    2970/     F56 :                     		;
    2971/     F56 : 21 A4 22            	LD	HL,WORK
    2972/     F59 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    2973/     F5C :                     		;
    2974/     F5C : CD 8D 13            	CALL	READ1SEC
    2975/     F5F :                     		;
    2976/     F5F :                     
    2977/     F5F :                     LR1BL1:
    2978/     F5F : F1                  	POP	AF
    2979/     F60 : E1                  	POP	HL
    2980/     F61 : D1                  	POP	DE
    2981/     F62 : C1                  	POP	BC
    2982/     F63 : C9                  	RET
    2983/     F64 :                     
    2984/     F64 :                     ;
    2985/     F64 :                     ; 1 byte write to file
    2986/     F64 :                     ; (REG_BUFAD) <= use FIFO number
    2987/     F64 :                     ; (IY+FIFO_CMTPTR) <= read(write) pointer
    2988/     F64 :                     ; IY <= use FIFO number
    2989/     F64 :                     ; A <= write data
    2990/     F64 :                     ;
    2991/     F64 :                     ; RETURN :
    2992/     F64 :                     ; (IY+FIFO_CMTPTR) <= read(write) pointer + 1
    2993/     F64 :                     ;
    2994/     F64 :                     ;
    2995/     F64 :                     WRITE1BYTE:
    2996/     F64 : C5                  	PUSH	BC
    2997/     F65 : D5                  	PUSH	DE
    2998/     F66 : E5                  	PUSH	HL
    2999/     F67 : F5                  	PUSH	AF
    3000/     F68 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 51 - 2/18/2013 12:10:16


    3001/     F68 :                     		;
    3002/     F68 :                     		; 1 byte write
    3003/     F68 :                     		;
    3004/     F68 : FD 5E 04            	LD	E,(IY+FIFO_CMTPTR+0)
    3005/     F6B : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    3006/     F6E : E6 01               	AND	01H
    3007/     F70 : 57                  	LD	D,A
    3008/     F71 : 21 00 80            	LD	HL,REG_SDBUF
    3009/     F74 : 19                  	ADD	HL,DE
    3010/     F75 :                     
    3011/     F75 : 3E 09               	LD	A,09H
    3012/     F77 : 32 11 82            	LD	(REG_BUFSEL),A
    3013/     F7A : F1                  	POP	AF
    3014/     F7B : 77                  	LD	(HL),A
    3015/     F7C :                     
    3016/     F7C :                     		;
    3017/     F7C :                     		; INC (IY+FIFO_CMTPTR)
    3018/     F7C :                     		;
    3019/     F7C : FD E5               	PUSH	IY
    3020/     F7E : E1                  	POP	HL
    3021/     F7F : 1E 04               	LD	E,FIFO_CMTPTR
    3022/     F81 : 16 00               	LD	D,00H
    3023/     F83 : 19                  	ADD	HL,DE
    3024/     F84 :                     		;
    3025/     F84 : 3E 01               	LD	A,01H
    3026/     F86 : CD 42 13            	CALL	ADD4B_MHL_A
    3027/     F89 :                     
    3028/     F89 :                     		;
    3029/     F89 :                     		; (IY+FIFO_CMTPTR) % 200H = 0?
    3030/     F89 :                     		;
    3031/     F89 : FD 5E 04            	LD	E,(IY+FIFO_CMTPTR+0)
    3032/     F8C : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    3033/     F8F : E6 01               	AND	01H
    3034/     F91 : B3                  	OR	E
    3035/     F92 : 20 4F               	JR	NZ,LW1BL1
    3036/     F94 :                     
    3037/     F94 :                     		;
    3038/     F94 :                     		; 1 sector write
    3039/     F94 :                     		;
    3040/     F94 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    3041/     F97 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    3042/     F9A : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    3043/     F9D : CD 03 12            	CALL	CALCSDADD
    3044/     FA0 :                     		;
    3045/     FA0 : 21 A4 22            	LD	HL,WORK
    3046/     FA3 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    3047/     FA6 :                     		;
    3048/     FA6 : CD AA 13            	CALL	WRITE1SEC
    3049/     FA9 :                     
    3050/     FA9 :                     		;
    3051/     FA9 :                     		; sector ++
    3052/     FA9 :                     		;
    3053/     FA9 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    3054/     FAC : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    3055/     FAF : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    3056/     FB2 : E5                  	PUSH	HL
    3057/     FB3 : CD 3B 12            	CALL	GET_NEXTSEC
    3058/     FB6 : FD 75 08            	LD	(IY+FIFO_CL+0),L
    3059/     FB9 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    3060/     FBC : FD 77 0A            	LD	(IY+FIFO_SEC),A
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 52 - 2/18/2013 12:10:16


    3061/     FBF :                     		;
    3062/     FBF : E1                  	POP	HL
    3063/     FC0 : B7                  	OR	A
    3064/     FC1 : 20 06               	JR	NZ,LW1BL2
    3065/     FC3 :                     		;
    3066/     FC3 : FD 75 0D            	LD	(IY+FIFO_BEFCL+0),L
    3067/     FC6 : FD 74 0E            	LD	(IY+FIFO_BEFCL+1),H
    3068/     FC9 :                     		;
    3069/     FC9 :                     
    3070/     FC9 :                     		;
    3071/     FC9 :                     		; 1 sector read
    3072/     FC9 :                     		;
    3073/     FC9 :                     LW1BL2:
    3074/     FC9 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    3075/     FCC : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    3076/     FCF : 7D                  	LD	A,L
    3077/     FD0 : B4                  	OR	H
    3078/     FD1 : CA 11 14            	JP	Z,SDERR
    3079/     FD4 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    3080/     FD7 : CD 03 12            	CALL	CALCSDADD
    3081/     FDA :                     		;
    3082/     FDA : 21 A4 22            	LD	HL,WORK
    3083/     FDD : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    3084/     FE0 :                     		;
    3085/     FE0 : CD 8D 13            	CALL	READ1SEC
    3086/     FE3 :                     		;
    3087/     FE3 :                     
    3088/     FE3 :                     LW1BL1:
    3089/     FE3 : E1                  	POP	HL
    3090/     FE4 : D1                  	POP	DE
    3091/     FE5 : C1                  	POP	BC
    3092/     FE6 : C9                  	RET
    3093/     FE7 :                     
    3094/     FE7 :                     
    3095/     FE7 :                     ;
    3096/     FE7 :                     ; ROM file read
    3097/     FE7 :                     ; IX <= file name address
    3098/     FE7 :                     ; HL <= ROM start address
    3099/     FE7 :                     ; DE <= ROM start address (BANK number)
    3100/     FE7 :                     ;
    3101/     FE7 :                     ROMFILEREAD:
    3102/     FE7 : CD EE 0F            	CALL	ROMFILEREAD2
    3103/     FEA : DA 11 14            	JP	C,SDERR
    3104/     FED : C9                  	RET
    3105/     FEE :                     
    3106/     FEE :                     ;
    3107/     FEE :                     ; ROM file read
    3108/     FEE :                     ; IX <= file name address
    3109/     FEE :                     ; HL <= ROM start address
    3110/     FEE :                     ; DE <= ROM start address (BANK number)
    3111/     FEE :                     ;
    3112/     FEE :                     ; RETURN:Cflag=1 FILE not found
    3113/     FEE :                     ROMFILEREAD2:
    3114/     FEE : AF                  	XOR	A
    3115/     FEF : 32 10 82            	LD	(REG_BUFAD),A
    3116/     FF2 : FD 21 20 82         	LD	IY,REG_FIFO_0
    3117/     FF6 : 3E 05               	LD	A,05H
    3118/     FF8 : 32 BC 22            	LD	(FILESEL),A
    3119/     FFB :                     
    3120/     FFB : DD E5               	PUSH	IX
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 53 - 2/18/2013 12:10:16


    3121/     FFD : E5                  	PUSH	HL
    3122/     FFE : D5                  	PUSH	DE
    3123/     FFF :                     
    3124/     FFF : DD 21 21 28         	LD	IX,F_ROMDIR
    3125/    1003 : 3E 10               	LD	A,10H
    3126/    1005 : 32 BE 22            	LD	(SEARCHTYPE),A
    3127/    1008 : 21 00 00            	LD	HL,0000H
    3128/    100B : 22 A0 22            	LD	(DIRCL),HL
    3129/    100E : CD B4 10            	CALL	FILESEARCH
    3130/    1011 : DA 11 14            	JP	C,SDERR
    3131/    1014 :                     
    3132/    1014 : D1                  	POP	DE
    3133/    1015 : E1                  	POP	HL
    3134/    1016 : DD E1               	POP	IX
    3135/    1018 :                     
    3136/    1018 : FD 7E 08            	LD	A,(IY+FIFO_CL+0)
    3137/    101B : 32 A0 22            	LD	(DIRCL+0),A
    3138/    101E : FD 7E 09            	LD	A,(IY+FIFO_CL+1)
    3139/    1021 : 32 A1 22            	LD	(DIRCL+1),A
    3140/    1024 :                     
    3141/    1024 : FD 75 04            	LD	(IY+FIFO_CMTPTR+0),L
    3142/    1027 : FD 74 05            	LD	(IY+FIFO_CMTPTR+1),H
    3143/    102A : FD 73 06            	LD	(IY+FIFO_CMTPTR+2),E
    3144/    102D : FD 72 07            	LD	(IY+FIFO_CMTPTR+3),D
    3145/    1030 :                     		;
    3146/    1030 : AF                  	XOR	A
    3147/    1031 : 32 BE 22            	LD	(SEARCHTYPE),A
    3148/    1034 : CD B4 10            	CALL	FILESEARCH
    3149/    1037 : D8                  	RET	C
    3150/    1038 : CD 3C 10            	CALL	FILEREAD
    3151/    103B :                     		;
    3152/    103B : C9                  	RET
    3153/    103C :                     
    3154/    103C :                     ;
    3155/    103C :                     ; file read
    3156/    103C :                     ; (REG_BUFAD) <= use FIFO number
    3157/    103C :                     ; (FILESEL) <= FIFO type
    3158/    103C :                     ; IY <= use FIFO number
    3159/    103C :                     ;
    3160/    103C :                     FILEREAD:
    3161/    103C : 3E 01               	LD	A,01H
    3162/    103E : 32 01 82            	LD	(REG_SDCTRL),A
    3163/    1041 : 3A BC 22            	LD	A,(FILESEL)
    3164/    1044 : 32 11 82            	LD	(REG_BUFSEL),A
    3165/    1047 : 21 34 82            	LD	HL,REG_CMTRD
    3166/    104A : 36 02               	LD	(HL),02H
    3167/    104C : 36 00               	LD	(HL),00H
    3168/    104E :                     		;
    3169/    104E : FD 6E 08            FRL1:	LD	L,(IY+FIFO_CL+0)
    3170/    1051 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    3171/    1054 : 7D                  	LD	A,L
    3172/    1055 : B4                  	OR	H
    3173/    1056 : CA 11 14            	JP	Z,SDERR
    3174/    1059 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    3175/    105C : CD 03 12            	CALL	CALCSDADD
    3176/    105F :                     		;
    3177/    105F : 21 A4 22            	LD	HL,WORK
    3178/    1062 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    3179/    1065 :                     		;
    3180/    1065 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 54 - 2/18/2013 12:10:16


    3181/    1065 : CD 8D 13            	CALL	READ1SEC
    3182/    1068 :                     		;
    3183/    1068 :                     READCONT:
    3184/    1068 : 3E 01               	LD	A,01H
    3185/    106A : 32 01 82            	LD	(REG_SDCTRL),A
    3186/    106D : 3A BC 22            	LD	A,(FILESEL)
    3187/    1070 : 32 11 82            	LD	(REG_BUFSEL),A
    3188/    1073 : 3E 01               	LD	A,01H
    3189/    1075 : 32 34 82            	LD	(REG_CMTRD),A
    3190/    1078 :                     		;
    3191/    1078 : 3A BC 22            FRL3:	LD	A,(FILESEL)
    3192/    107B : FE 05               	CP	05H
    3193/    107D : 28 07               	JR	Z,FRL2
    3194/    107F : 3A 12 82            	LD	A,(REG_CMTOPEN)
    3195/    1082 : E6 01               	AND	01H
    3196/    1084 : 28 26               	JR	Z,FRL4
    3197/    1086 : 3A 34 82            FRL2:	LD	A,(REG_CMTRD)
    3198/    1089 : CB 6F               	BIT	5,A
    3199/    108B : 20 1F               	JR	NZ,FRL4
    3200/    108D : CB 67               	BIT	4,A
    3201/    108F : 28 E7               	JR	Z,FRL3
    3202/    1091 :                     		;
    3203/    1091 : AF                  	XOR	A
    3204/    1092 : 32 34 82            	LD	(REG_CMTRD),A
    3205/    1095 :                     		;
    3206/    1095 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    3207/    1098 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    3208/    109B : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    3209/    109E : CD 3B 12            	CALL	GET_NEXTSEC
    3210/    10A1 : FD 75 08            	LD	(IY+FIFO_CL+0),L
    3211/    10A4 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    3212/    10A7 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    3213/    10AA :                     		;
    3214/    10AA : 18 A2               	JR	FRL1
    3215/    10AC :                     		;
    3216/    10AC : AF                  FRL4:	XOR	A
    3217/    10AD : 32 34 82            	LD	(REG_CMTRD),A
    3218/    10B0 : 32 01 82            	LD	(REG_SDCTRL),A
    3219/    10B3 : C9                  	RET
    3220/    10B4 :                     
    3221/    10B4 :                     ;
    3222/    10B4 :                     ; rom file seaech in root directory
    3223/    10B4 :                     ; (REG_BUFAD) <= use FIFO number
    3224/    10B4 :                     ; IX <= file name address
    3225/    10B4 :                     ; IY <= use FIFO number
    3226/    10B4 :                     ;
    3227/    10B4 :                     ; RETURN
    3228/    10B4 :                     ; (IY+FIFO_CMTLEN) <= file length
    3229/    10B4 :                     ; (IY+FIFO_CL)     <= file claster number
    3230/    10B4 :                     ; (IY+FIFO_SEC)    <= file sector number
    3231/    10B4 :                     ; (IY+FIFO_STCL)   <= file start claster number
    3232/    10B4 :                     ; (IY+FIFO_DIRCL)  <= file claster in directory
    3233/    10B4 :                     ; (IY+FIFO_DIRPOS) <= file position in directory
    3234/    10B4 :                     ; Cflag = 1           file not found
    3235/    10B4 :                     FILESEARCH:
    3236/    10B4 : 3E 01               	LD	A,01H
    3237/    10B6 : 32 01 82            	LD	(REG_SDCTRL),A
    3238/    10B9 : 21 00 00            	LD	HL,0000H
    3239/    10BC : 22 A2 22            	LD	(DIRPOS),HL
    3240/    10BF : CD 4B 15            	CALL	SDADDINIT
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 55 - 2/18/2013 12:10:16


    3241/    10C2 :                     		;
    3242/    10C2 : CD AC 11            FSL1:	CALL	READ_DIRFILE
    3243/    10C5 :                     		;
    3244/    10C5 : 7E                  	LD	A,(HL)
    3245/    10C6 : B7                  	OR	A
    3246/    10C7 : 28 37               	JR	Z,FSL3
    3247/    10C9 : DD E5               	PUSH	IX
    3248/    10CB : D1                  	POP	DE
    3249/    10CC : E5                  	PUSH	HL
    3250/    10CD : 06 0B               	LD	B,0BH
    3251/    10CF : CD 65 13            	CALL	CP_MHL_MDE
    3252/    10D2 : E1                  	POP	HL
    3253/    10D3 : 20 0E               	JR	NZ,FSL11
    3254/    10D5 : 01 0B 00            	LD	BC,000BH
    3255/    10D8 : 09                  	ADD	HL,BC
    3256/    10D9 : 7E                  	LD	A,(HL)
    3257/    10DA : E6 1E               	AND	1EH
    3258/    10DC : 47                  	LD	B,A
    3259/    10DD : 3A BE 22            	LD	A,(SEARCHTYPE)
    3260/    10E0 : B8                  	CP	B
    3261/    10E1 : 28 0E               	JR	Z,FSL2
    3262/    10E3 :                     		;
    3263/    10E3 : 2A A2 22            FSL11:	LD	HL,(DIRPOS)
    3264/    10E6 : 23                  	INC	HL
    3265/    10E7 : 22 A2 22            	LD	(DIRPOS),HL
    3266/    10EA : 7C                  	LD	A,H
    3267/    10EB : FE 02               	CP	02H
    3268/    10ED : 30 11               	JR	NC,FSL3
    3269/    10EF : 18 D1               	JR	FSL1
    3270/    10F1 :                     		;
    3271/    10F1 : 01 0F 00            FSL2:	LD	BC,000FH
    3272/    10F4 : 09                  	ADD	HL,BC
    3273/    10F5 :                     	
    3274/    10F5 : CD 88 06            	CALL	SETFILEPARA
    3275/    10F8 :                     		;
    3276/    10F8 : AF                  	XOR	A
    3277/    10F9 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    3278/    10FC : 32 01 82            	LD	(REG_SDCTRL),A
    3279/    10FF : C9                  	RET
    3280/    1100 :                     
    3281/    1100 :                     FSL3:
    3282/    1100 : AF                  	XOR	A
    3283/    1101 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    3284/    1104 : 32 01 82            	LD	(REG_SDCTRL),A
    3285/    1107 : 37                  	SCF
    3286/    1108 : C9                  	RET
    3287/    1109 :                     
    3288/    1109 :                     ;
    3289/    1109 :                     ; rom area initialize
    3290/    1109 :                     ;
    3291/    1109 :                     ROMINIT:
    3292/    1109 : 21 03 82            	LD	HL,REG_ROMINIT
    3293/    110C : 36 01               	LD	(HL),01H
    3294/    110E : 35                  	DEC	(HL)
    3295/    110F : 7E                  ROMLP:	LD	A,(HL)
    3296/    1110 : B7                  	OR	A
    3297/    1111 : 20 FC               	JR	NZ,ROMLP
    3298/    1113 : C9                  	RET
    3299/    1114 :                     
    3300/    1114 :                     ;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 56 - 2/18/2013 12:10:16


    3301/    1114 :                     ; SD card initialized and read parameter
    3302/    1114 :                     ; use #0 FIFO (REG_BUFAD = 00H)
    3303/    1114 :                     ;
    3304/    1114 :                     SDCARD_OPEN:
    3305/    1114 : 21 01 82            	LD	HL,REG_SDCTRL
    3306/    1117 : 36 01               	LD	(HL),01H
    3307/    1119 : AF                  	XOR	A
    3308/    111A : 32 10 82            	LD	(REG_BUFAD),A
    3309/    111D :                     ;
    3310/    111D :                     ; command 0 (S/W reset)
    3311/    111D :                     ;
    3312/    111D : 21 00 00            	LD	HL,0000H
    3313/    1120 : 22 06 82            	LD	(REG_SDADD),HL
    3314/    1123 : 22 08 82            	LD	(REG_SDADD+2),HL
    3315/    1126 : AF                  	XOR	A
    3316/    1127 : CD D9 13            	CALL	SENDCMD2
    3317/    112A :                     ;
    3318/    112A :                     ; command 1 (idle detect)
    3319/    112A :                     ;
    3320/    112A : 3E 01               SDW1:	LD	A,01H
    3321/    112C : CD D9 13            	CALL	SENDCMD2
    3322/    112F : CB 4E               	BIT	1,(HL)
    3323/    1131 : 20 F7               	JR	NZ,SDW1
    3324/    1133 :                     ;
    3325/    1133 :                     ; command 16 (length set)
    3326/    1133 :                     ;
    3327/    1133 : 3E 10               	LD	A,10H
    3328/    1135 : CD C6 13            	CALL	SENDCMD
    3329/    1138 :                     ;
    3330/    1138 :                     ; read phisical sector #0
    3331/    1138 :                     ;
    3332/    1138 : CD 8D 13            	CALL	READ1SEC
    3333/    113B : 21 C6 81            	LD	HL,REG_OFFSET
    3334/    113E : 11 8D 22            	LD	DE,OFFSET
    3335/    1141 : CD 75 13            	CALL	LD4B_MDE_MHL
    3336/    1144 :                     ;
    3337/    1144 :                     ; read logical sector #0 (read BPB parameter)
    3338/    1144 :                     ;
    3339/    1144 : 21 8D 22            	LD	HL,OFFSET
    3340/    1147 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    3341/    114A : CD 8D 13            	CALL	READ1SEC
    3342/    114D : CD EB 13            	CALL	CHKSPT
    3343/    1150 :                     		;
    3344/    1150 :                     		; claster size = BPB_CLASTSEC
    3345/    1150 :                     		;
    3346/    1150 : 3A 0D 80            	LD	A,(BPB_CLASTSEC)
    3347/    1153 : 32 9F 22            	LD	(CLASTSIZE),A
    3348/    1156 :                     		;
    3349/    1156 :                     		; FAT start = OFFSET + BPB_FATST
    3350/    1156 :                     		;
    3351/    1156 : 2A 8D 22            	LD	HL,(OFFSET)
    3352/    1159 : ED 5B 0E 80         	LD	DE,(BPB_FATST)
    3353/    115D : 19                  	ADD	HL,DE
    3354/    115E : 22 91 22            	LD	(FATST),HL
    3355/    1161 : 2A 8F 22            	LD	HL,(OFFSET+2)
    3356/    1164 : 11 00 00            	LD	DE,0000H
    3357/    1167 : ED 5A               	ADC	HL,DE
    3358/    1169 : 22 93 22            	LD	(FATST+2),HL
    3359/    116C :                     ;		;
    3360/    116C :                     ;		; root directory start = FATST + BPB_FATNUM x BPB_FATSEC
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 57 - 2/18/2013 12:10:16


    3361/    116C :                     ;		;
    3362/    116C :                     ;	LD	DE,ROOTST
    3363/    116C :                     ;	LD	HL,FATST
    3364/    116C :                     ;	CALL	LD4B_MDE_MHL
    3365/    116C :                     ;	LD	HL,(BPB_FATSEC)
    3366/    116C :                     ;	LD	(WORK),HL
    3367/    116C :                     ;	LD	HL,0000H
    3368/    116C :                     ;	LD	(WORK+2),HL
    3369/    116C :                     ;
    3370/    116C :                     ;	LD	A,(BPB_FATNUM)
    3371/    116C :                     ;	LD	B,08H
    3372/    116C :                     ;RDLP1:	RRCA
    3373/    116C :                     ;	PUSH	AF
    3374/    116C :                     ;	PUSH	BC
    3375/    116C :                     ;	JR	NC,RDLP2
    3376/    116C :                     ;	LD	HL,ROOTST
    3377/    116C :                     ;	LD	DE,WORK
    3378/    116C :                     ;	CALL	ADD4B_MHL_MDE
    3379/    116C :                     ;		;
    3380/    116C :                     ;RDLP2:	LD	HL,WORK
    3381/    116C :                     ;	CALL	SHT4B_MHL
    3382/    116C :                     ;		;
    3383/    116C :                     ;	POP	BC
    3384/    116C :                     ;	POP	AF
    3385/    116C :                     ;	DJNZ	RDLP1
    3386/    116C :                     		;
    3387/    116C :                     		; FAT use sector number = BPB_FATSEC
    3388/    116C :                     		;
    3389/    116C : 2A 16 80            	LD	HL,(BPB_FATSEC)
    3390/    116F : 22 95 22            	LD	(FATSEC),HL
    3391/    1172 :                     		;
    3392/    1172 :                     		; root directory start = FATST + BPB_FATNUM(=02H) x FATSEC
    3393/    1172 :                     		;
    3394/    1172 : 11 97 22            	LD	DE,ROOTST
    3395/    1175 : 21 91 22            	LD	HL,FATST
    3396/    1178 : CD 75 13            	CALL	LD4B_MDE_MHL
    3397/    117B : 2A 95 22            	LD	HL,(FATSEC)
    3398/    117E : 22 A4 22            	LD	(WORK),HL
    3399/    1181 : 21 00 00            	LD	HL,0000H
    3400/    1184 : 22 A6 22            	LD	(WORK+2),HL
    3401/    1187 : 21 A4 22            	LD	HL,WORK
    3402/    118A : CD 54 13            	CALL	SHT4B_MHL
    3403/    118D : 21 97 22            	LD	HL,ROOTST
    3404/    1190 : 11 A4 22            	LD	DE,WORK
    3405/    1193 : CD 2F 13            	CALL	ADD4B_MHL_MDE
    3406/    1196 :                     		;
    3407/    1196 :                     		; claster start = ROOTST + 32
    3408/    1196 :                     		;
    3409/    1196 : 21 97 22            	LD	HL,ROOTST
    3410/    1199 : 11 9B 22            	LD	DE,CLASTST
    3411/    119C : CD 75 13            	CALL	LD4B_MDE_MHL
    3412/    119F : 21 9B 22            	LD	HL,CLASTST
    3413/    11A2 : 3E 20               	LD	A,20H
    3414/    11A4 : CD 42 13            	CALL	ADD4B_MHL_A
    3415/    11A7 :                     		;
    3416/    11A7 : AF                  	XOR	A
    3417/    11A8 : 32 01 82            	LD	(REG_SDCTRL),A
    3418/    11AB :                     		;
    3419/    11AB : C9                  	RET
    3420/    11AC :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 58 - 2/18/2013 12:10:16


    3421/    11AC :                     
    3422/    11AC :                     
    3423/    11AC :                     ;
    3424/    11AC :                     ; directory file list read
    3425/    11AC :                     ; (REG_BUFAD) <= use FIFO number
    3426/    11AC :                     ; (DIRCL)     <= claster number of directory claster (0000H = root)
    3427/    11AC :                     ; (DIRPOS)    <= file position in directory
    3428/    11AC :                     ;
    3429/    11AC :                     ; RETURN
    3430/    11AC :                     ; HL:file pointer address
    3431/    11AC :                     ;
    3432/    11AC :                     READ_DIRFILE:
    3433/    11AC : 2A A2 22            	LD	HL,(DIRPOS)
    3434/    11AF : 29                  	ADD	HL,HL
    3435/    11B0 : 29                  	ADD	HL,HL
    3436/    11B1 : 29                  	ADD	HL,HL
    3437/    11B2 : 29                  	ADD	HL,HL
    3438/    11B3 : 44                  	LD	B,H
    3439/    11B4 : 2A A0 22            	LD	HL,(DIRCL)
    3440/    11B7 : 7C                  	LD	A,H
    3441/    11B8 : B5                  	OR	L
    3442/    11B9 : 20 11               	JR	NZ,RDL1
    3443/    11BB :                     		;
    3444/    11BB :                     		; root directory
    3445/    11BB :                     		;
    3446/    11BB : 21 97 22            	LD	HL,ROOTST
    3447/    11BE : C5                  	PUSH	BC
    3448/    11BF : CD 84 13            	CALL	LD4B_WORK_MHL
    3449/    11C2 : C1                  	POP	BC
    3450/    11C3 : 78                  	LD	A,B
    3451/    11C4 : 21 A4 22            	LD	HL,WORK
    3452/    11C7 : CD 42 13            	CALL	ADD4B_MHL_A
    3453/    11CA : 18 0F               	JR	RDL2
    3454/    11CC :                     		;
    3455/    11CC :                     		;
    3456/    11CC : AF                  RDL1:	XOR	A
    3457/    11CD : 04                  	INC	B
    3458/    11CE :                     		;
    3459/    11CE : 05                  RDL3:	DEC	B
    3460/    11CF : 28 07               	JR	Z,RDL4
    3461/    11D1 : C5                  	PUSH	BC
    3462/    11D2 : CD 3B 12            	CALL	GET_NEXTSEC
    3463/    11D5 : C1                  	POP	BC
    3464/    11D6 : 18 F6               	JR	RDL3
    3465/    11D8 :                     		;
    3466/    11D8 : CD 03 12            RDL4:	CALL	CALCSDADD
    3467/    11DB :                     		;
    3468/    11DB : 21 A4 22            RDL2:	LD	HL,WORK
    3469/    11DE : 11 06 82            	LD	DE,REG_SDADD
    3470/    11E1 : 06 04               	LD	B,04H
    3471/    11E3 : CD 65 13            	CALL	CP_MHL_MDE
    3472/    11E6 : 28 09               	JR	Z,RDL5
    3473/    11E8 :                     		;
    3474/    11E8 : 21 A4 22            	LD	HL,WORK
    3475/    11EB : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    3476/    11EE : CD 8D 13            	CALL	READ1SEC
    3477/    11F1 :                     		;
    3478/    11F1 : 3A A2 22            RDL5:	LD	A,(DIRPOS)
    3479/    11F4 : E6 0F               	AND	0FH
    3480/    11F6 : 6F                  	LD	L,A
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 59 - 2/18/2013 12:10:16


    3481/    11F7 : 26 00               	LD	H,00H
    3482/    11F9 : 29                  	ADD	HL,HL
    3483/    11FA : 29                  	ADD	HL,HL
    3484/    11FB : 29                  	ADD	HL,HL
    3485/    11FC : 29                  	ADD	HL,HL
    3486/    11FD : 29                  	ADD	HL,HL
    3487/    11FE : 11 00 80            	LD	DE,REG_SDBUF
    3488/    1201 : 19                  	ADD	HL,DE
    3489/    1202 : C9                  	RET
    3490/    1203 :                     
    3491/    1203 :                     
    3492/    1203 :                     ;
    3493/    1203 :                     ; claster and sector number -> SD address
    3494/    1203 :                     ;
    3495/    1203 :                     ; SD address <= CLASTST + CLASTSIZE x (claster - 2) + sector
    3496/    1203 :                     ; (REG_BUFAD) <= use FIFO number
    3497/    1203 :                     ; HL : claster number
    3498/    1203 :                     ; A  : sector number
    3499/    1203 :                     ;
    3500/    1203 :                     ; RETURN : (WORK) <- SD address
    3501/    1203 :                     ;
    3502/    1203 :                     CALCSDADD:
    3503/    1203 : CD 5D 12            	CALL	CLASTCHECK
    3504/    1206 : 2B                  	DEC	HL
    3505/    1207 : 2B                  	DEC	HL
    3506/    1208 : 22 A8 22            	LD	(WORK2),HL
    3507/    120B : 21 00 00            	LD	HL,0000H
    3508/    120E : 22 AA 22            	LD	(WORK2+2),HL
    3509/    1211 :                     		;
    3510/    1211 : 21 9B 22            	LD	HL,CLASTST
    3511/    1214 : CD 84 13            	CALL	LD4B_WORK_MHL
    3512/    1217 : 21 A4 22            	LD	HL,WORK
    3513/    121A : CD 42 13            	CALL	ADD4B_MHL_A
    3514/    121D :                     		;	
    3515/    121D : 3A 9F 22            	LD	A,(CLASTSIZE)
    3516/    1220 : 06 08               	LD	B,08H
    3517/    1222 : 0F                  CSAL2:	RRCA
    3518/    1223 : F5                  	PUSH	AF
    3519/    1224 : C5                  	PUSH	BC
    3520/    1225 : 30 09               	JR	NC,CSAL1
    3521/    1227 : 21 A4 22            	LD	HL,WORK
    3522/    122A : 11 A8 22            	LD	DE,WORK2
    3523/    122D : CD 2F 13            	CALL	ADD4B_MHL_MDE
    3524/    1230 :                     		;
    3525/    1230 : 21 A8 22            CSAL1:	LD	HL,WORK2
    3526/    1233 : CD 54 13            	CALL	SHT4B_MHL
    3527/    1236 :                     		;
    3528/    1236 : C1                  	POP	BC
    3529/    1237 : F1                  	POP	AF
    3530/    1238 : 10 E8               	DJNZ	CSAL2
    3531/    123A :                     		;
    3532/    123A : C9                  	RET
    3533/    123B :                     
    3534/    123B :                     
    3535/    123B :                     ;
    3536/    123B :                     ; get next sector
    3537/    123B :                     ; (REG_BUFAD) <= use FIFO number
    3538/    123B :                     ; HL : claster number
    3539/    123B :                     ; A  : sector number
    3540/    123B :                     ;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 60 - 2/18/2013 12:10:16


    3541/    123B :                     ; RETURN
    3542/    123B :                     ; HL <= next claster number
    3543/    123B :                     ; A  <= next sector number
    3544/    123B :                     ;
    3545/    123B :                     GET_NEXTSEC:
    3546/    123B : CD 5D 12            	CALL	CLASTCHECK
    3547/    123E : 4F                  	LD	C,A
    3548/    123F : 0C                  	INC	C
    3549/    1240 : 3A 9F 22            	LD	A,(CLASTSIZE)
    3550/    1243 : 47                  	LD	B,A
    3551/    1244 : 79                  	LD	A,C
    3552/    1245 : B8                  	CP	B
    3553/    1246 : D8                  	RET	C
    3554/    1247 :                     		;
    3555/    1247 : CD 4C 12            	CALL	GET_NEXTCL
    3556/    124A : AF                  	XOR	A
    3557/    124B : C9                  	RET
    3558/    124C :                     
    3559/    124C :                     ;
    3560/    124C :                     ; get next claster number from FAT
    3561/    124C :                     ; (REG_BUFAD) <= use FIFO number
    3562/    124C :                     ; HL : claster number
    3563/    124C :                     ;
    3564/    124C :                     ; RETURN : HL <= next claster number
    3565/    124C :                     ;
    3566/    124C :                     GET_NEXTCL:
    3567/    124C : CD 5D 12            	CALL	CLASTCHECK
    3568/    124F :                     
    3569/    124F : E5                  	PUSH	HL
    3570/    1250 : CD 4B 15            	CALL	SDADDINIT
    3571/    1253 : E1                  	POP	HL
    3572/    1254 : AF                  	XOR	A
    3573/    1255 : CD E5 12            	CALL	CALCFATADD	
    3574/    1258 :                     
    3575/    1258 : 5E                  	LD	E,(HL)
    3576/    1259 : 23                  	INC	HL
    3577/    125A : 56                  	LD	D,(HL)
    3578/    125B : EB                  	EX	DE,HL
    3579/    125C : C9                  	RET
    3580/    125D :                     
    3581/    125D :                     ;
    3582/    125D :                     ; claster number check
    3583/    125D :                     ; HL : claster number
    3584/    125D :                     ;
    3585/    125D :                     CLASTCHECK:
    3586/    125D : E5                  	PUSH	HL
    3587/    125E : D5                  	PUSH	DE
    3588/    125F : 11 F7 FF            	LD	DE,0FFF7H
    3589/    1262 : B7                  	OR	A
    3590/    1263 : ED 52               	SBC	HL,DE
    3591/    1265 : D2 11 14            	JP	NC,SDERR
    3592/    1268 : D1                  	POP	DE
    3593/    1269 : E1                  	POP	HL
    3594/    126A : C9                  	RET
    3595/    126B :                     
    3596/    126B :                     ;
    3597/    126B :                     ; get new sector
    3598/    126B :                     ; (REG_BUFAD) <= use FIFO number
    3599/    126B :                     ; HL : claster number
    3600/    126B :                     ; A  : sector number
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 61 - 2/18/2013 12:10:16


    3601/    126B :                     ;
    3602/    126B :                     ; RETURN
    3603/    126B :                     ; HL <= next claster number
    3604/    126B :                     ; A  <= next sector number
    3605/    126B :                     ;
    3606/    126B :                     GET_NEWSEC:
    3607/    126B : CD 5D 12            	CALL	CLASTCHECK
    3608/    126E : 4F                  	LD	C,A
    3609/    126F : 0C                  	INC	C
    3610/    1270 : 3A 9F 22            	LD	A,(CLASTSIZE)
    3611/    1273 : 47                  	LD	B,A
    3612/    1274 : 79                  	LD	A,C
    3613/    1275 : B8                  	CP	B
    3614/    1276 : D8                  	RET	C
    3615/    1277 :                     		;
    3616/    1277 : CD 7C 12            	CALL	GET_NEWCL
    3617/    127A : AF                  	XOR	A
    3618/    127B : C9                  	RET
    3619/    127C :                     
    3620/    127C :                     ;
    3621/    127C :                     ; get new claster number from FAT
    3622/    127C :                     ; (REG_BUFAD) <= use FIFO number
    3623/    127C :                     ;
    3624/    127C :                     ; RETURN : HL <= next claster number
    3625/    127C :                     ;
    3626/    127C :                     GET_NEWCL:
    3627/    127C : CD 4B 15            	CALL	SDADDINIT
    3628/    127F : 21 00 00            	LD	HL,0000H
    3629/    1282 :                     
    3630/    1282 :                     GNCL_LP:
    3631/    1282 : E5                  	PUSH	HL
    3632/    1283 :                     
    3633/    1283 : AF                  	XOR	A
    3634/    1284 : CD E5 12            	CALL	CALCFATADD
    3635/    1287 :                     		;
    3636/    1287 : 5E                  	LD	E,(HL)
    3637/    1288 : 23                  	INC	HL
    3638/    1289 : 7E                  	LD	A,(HL)
    3639/    128A : B3                  	OR	E
    3640/    128B : E1                  	POP	HL
    3641/    128C :                     
    3642/    128C : 20 0C               	JR	NZ,GNCL_NG
    3643/    128E :                     
    3644/    128E : E5                  	PUSH	HL
    3645/    128F :                     
    3646/    128F : 3E 01               	LD	A,01H
    3647/    1291 : CD E5 12            	CALL	CALCFATADD
    3648/    1294 :                     		;
    3649/    1294 : 5E                  	LD	E,(HL)
    3650/    1295 : 23                  	INC	HL
    3651/    1296 : 7E                  	LD	A,(HL)
    3652/    1297 : B3                  	OR	E
    3653/    1298 : E1                  	POP	HL
    3654/    1299 :                     
    3655/    1299 : C8                  	RET	Z
    3656/    129A :                     
    3657/    129A :                     GNCL_NG:
    3658/    129A : 23                  	INC	HL
    3659/    129B : EB                  	EX	DE,HL
    3660/    129C :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 62 - 2/18/2013 12:10:16


    3661/    129C : 2A 95 22            	LD	HL,(FATSEC)
    3662/    129F : 65                  	LD	H,L
    3663/    12A0 : 2E 00               	LD	L,00H
    3664/    12A2 : 29                  	ADD	HL,HL
    3665/    12A3 :                     
    3666/    12A3 : B7                  	OR	A
    3667/    12A4 : ED 52               	SBC	HL,DE
    3668/    12A6 : EB                  	EX	DE,HL
    3669/    12A7 :                     
    3670/    12A7 : D2 82 12            	JP	NC,GNCL_LP
    3671/    12AA :                     
    3672/    12AA : C3 11 14            	JP	SDERR
    3673/    12AD :                     
    3674/    12AD :                     
    3675/    12AD :                     ;
    3676/    12AD :                     ; FAT overwrite
    3677/    12AD :                     ; (REG_BUFAD) <= use FIFO number
    3678/    12AD :                     ; HL <= claster number
    3679/    12AD :                     ; DE <= new data
    3680/    12AD :                     ;
    3681/    12AD :                     FATWRITE:
    3682/    12AD : CD 5D 12            	CALL	CLASTCHECK
    3683/    12B0 :                     
    3684/    12B0 : D5                  	PUSH	DE
    3685/    12B1 : E5                  	PUSH	HL
    3686/    12B2 : D5                  	PUSH	DE
    3687/    12B3 : E5                  	PUSH	HL
    3688/    12B4 :                     
    3689/    12B4 : CD 4B 15            	CALL	SDADDINIT
    3690/    12B7 : E1                  	POP	HL
    3691/    12B8 : AF                  	XOR	A
    3692/    12B9 : CD E5 12            	CALL	CALCFATADD
    3693/    12BC :                     		;
    3694/    12BC :                     
    3695/    12BC : 3E 09               	LD	A,09H
    3696/    12BE : 32 11 82            	LD	(REG_BUFSEL),A
    3697/    12C1 :                     		;
    3698/    12C1 : D1                  	POP	DE
    3699/    12C2 : 73                  	LD	(HL),E
    3700/    12C3 : 23                  	INC	HL
    3701/    12C4 : 72                  	LD	(HL),D
    3702/    12C5 :                     		;
    3703/    12C5 : 3E 01               	LD	A,01H
    3704/    12C7 : 32 11 82            	LD	(REG_BUFSEL),A
    3705/    12CA :                     		;
    3706/    12CA :                     
    3707/    12CA : CD AA 13            	CALL	WRITE1SEC
    3708/    12CD :                     
    3709/    12CD : E1                  	POP	HL
    3710/    12CE :                     		;
    3711/    12CE : 3E 01               	LD	A,01H
    3712/    12D0 : CD E5 12            	CALL	CALCFATADD
    3713/    12D3 :                     		;
    3714/    12D3 : 3E 09               	LD	A,09H
    3715/    12D5 : 32 11 82            	LD	(REG_BUFSEL),A
    3716/    12D8 :                     		;
    3717/    12D8 : D1                  	POP	DE
    3718/    12D9 : 73                  	LD	(HL),E
    3719/    12DA : 23                  	INC	HL
    3720/    12DB : 72                  	LD	(HL),D
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 63 - 2/18/2013 12:10:16


    3721/    12DC :                     		;
    3722/    12DC : 3E 01               	LD	A,01H
    3723/    12DE : 32 11 82            	LD	(REG_BUFSEL),A
    3724/    12E1 :                     		;
    3725/    12E1 :                     
    3726/    12E1 : CD AA 13            	CALL	WRITE1SEC
    3727/    12E4 :                     
    3728/    12E4 :                     
    3729/    12E4 : C9                  	RET
    3730/    12E5 :                     
    3731/    12E5 :                     ;
    3732/    12E5 :                     ; FAT address calculate
    3733/    12E5 :                     ; (REG_BUFAD) <= use FIFO number
    3734/    12E5 :                     ; HL <= claster number
    3735/    12E5 :                     ; A  <= 1:FAT#2 0:FAT#1
    3736/    12E5 :                     ;
    3737/    12E5 :                     ; RETURN
    3738/    12E5 :                     ; HL <= FAT address
    3739/    12E5 :                     ;
    3740/    12E5 :                     CALCFATADD:
    3741/    12E5 : E5                  	PUSH	HL
    3742/    12E6 : F5                  	PUSH	AF
    3743/    12E7 : E5                  	PUSH	HL
    3744/    12E8 :                     
    3745/    12E8 : 11 AC 22            	LD	DE,WORK3
    3746/    12EB : 21 06 82            	LD	HL,REG_SDADD
    3747/    12EE : CD 75 13            	CALL	LD4B_MDE_MHL
    3748/    12F1 :                     
    3749/    12F1 :                     		;
    3750/    12F1 :                     		; SDADD <= FATST + claster number / 16 (+ FATSEC)
    3751/    12F1 :                     		;
    3752/    12F1 : 21 91 22            	LD	HL,FATST
    3753/    12F4 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    3754/    12F7 : E1                  	POP	HL
    3755/    12F8 : 7C                  	LD	A,H
    3756/    12F9 : 21 06 82            	LD	HL,REG_SDADD
    3757/    12FC : CD 42 13            	CALL	ADD4B_MHL_A
    3758/    12FF : F1                  	POP	AF
    3759/    1300 : B7                  	OR	A
    3760/    1301 : 28 15               	JR	Z,CFAL1
    3761/    1303 :                     		;
    3762/    1303 : 2A 95 22            	LD	HL,(FATSEC)
    3763/    1306 : 22 A4 22            	LD	(WORK+0),HL
    3764/    1309 : 21 00 00            	LD	HL,0000H
    3765/    130C : 22 A6 22            	LD	(WORK+2),HL
    3766/    130F : 11 A4 22            	LD	DE,WORK
    3767/    1312 : 21 06 82            	LD	HL,REG_SDADD
    3768/    1315 : CD 2F 13            	CALL	ADD4B_MHL_MDE
    3769/    1318 :                     CFAL1:
    3770/    1318 :                     		;
    3771/    1318 : 21 AC 22            	LD	HL,WORK3
    3772/    131B : 11 06 82            	LD	DE,REG_SDADD
    3773/    131E : 06 04               	LD	B,04H
    3774/    1320 : CD 65 13            	CALL	CP_MHL_MDE
    3775/    1323 :                     		;
    3776/    1323 : C4 8D 13            	CALL	NZ,READ1SEC
    3777/    1326 :                     		;
    3778/    1326 : E1                  	POP	HL
    3779/    1327 : 26 00               	LD	H,00H
    3780/    1329 : 29                  	ADD	HL,HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 64 - 2/18/2013 12:10:16


    3781/    132A : 11 00 80            	LD	DE,REG_SDBUF
    3782/    132D : 19                  	ADD	HL,DE
    3783/    132E :                     
    3784/    132E : C9                  	RET
    3785/    132F :                     
    3786/    132F :                     ;
    3787/    132F :                     ; (HL)x4b <- (HL)x4b + (DE)x4b
    3788/    132F :                     ;
    3789/    132F :                     ADD4B_MHL_MDE:
    3790/    132F : 1A                  	LD	A,(DE)
    3791/    1330 : 86                  	ADD	A,(HL)
    3792/    1331 : 77                  	LD	(HL),A
    3793/    1332 : 13                  	INC	DE
    3794/    1333 : 23                  	INC	HL
    3795/    1334 : 1A                  	LD	A,(DE)
    3796/    1335 : 8E                  	ADC	A,(HL)
    3797/    1336 : 77                  	LD	(HL),A
    3798/    1337 : 13                  	INC	DE
    3799/    1338 : 23                  	INC	HL
    3800/    1339 : 1A                  	LD	A,(DE)
    3801/    133A : 8E                  	ADC	A,(HL)
    3802/    133B : 77                  	LD	(HL),A
    3803/    133C : 13                  	INC	DE
    3804/    133D : 23                  	INC	HL
    3805/    133E : 1A                  	LD	A,(DE)
    3806/    133F : 8E                  	ADC	A,(HL)
    3807/    1340 : 77                  	LD	(HL),A
    3808/    1341 : C9                  	RET
    3809/    1342 :                     
    3810/    1342 :                     
    3811/    1342 :                     ;
    3812/    1342 :                     ; (HL)x4b <- (HL)x4b + A
    3813/    1342 :                     ;
    3814/    1342 :                     ADD4B_MHL_A:
    3815/    1342 : 86                  	ADD	A,(HL)
    3816/    1343 : 77                  	LD	(HL),A
    3817/    1344 : 23                  	INC	HL
    3818/    1345 : 3E 00               	LD	A,00H
    3819/    1347 : 8E                  	ADC	A,(HL)
    3820/    1348 : 77                  	LD	(HL),A
    3821/    1349 : 23                  	INC	HL
    3822/    134A : 3E 00               	LD	A,00H
    3823/    134C : 8E                  	ADC	A,(HL)
    3824/    134D : 77                  	LD	(HL),A
    3825/    134E : 23                  	INC	HL
    3826/    134F : 3E 00               	LD	A,00H
    3827/    1351 : 8E                  	ADC	A,(HL)
    3828/    1352 : 77                  	LD	(HL),A
    3829/    1353 : C9                  	RET
    3830/    1354 :                     
    3831/    1354 :                     
    3832/    1354 :                     ;
    3833/    1354 :                     ; (HL)x4b <- (HL)x4b x 2
    3834/    1354 :                     ;
    3835/    1354 :                     SHT4B_MHL:
    3836/    1354 : B7                  	OR	A
    3837/    1355 : 7E                  	LD	A,(HL)
    3838/    1356 : 17                  	RLA
    3839/    1357 : 77                  	LD	(HL),A
    3840/    1358 : 23                  	INC	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 65 - 2/18/2013 12:10:16


    3841/    1359 : 7E                  	LD	A,(HL)
    3842/    135A : 17                  	RLA
    3843/    135B : 77                  	LD	(HL),A
    3844/    135C : 23                  	INC	HL
    3845/    135D : 7E                  	LD	A,(HL)
    3846/    135E : 17                  	RLA
    3847/    135F : 77                  	LD	(HL),A
    3848/    1360 : 23                  	INC	HL
    3849/    1361 : 7E                  	LD	A,(HL)
    3850/    1362 : 17                  	RLA
    3851/    1363 : 77                  	LD	(HL),A
    3852/    1364 : C9                  	RET
    3853/    1365 :                     
    3854/    1365 :                     
    3855/    1365 :                     ;
    3856/    1365 :                     ; CP (HL)-(DE) x B byte
    3857/    1365 :                     ;
    3858/    1365 :                     ; RETURN
    3859/    1365 :                     ; (HL) > (DE) : Cflag reset / Zflag reset
    3860/    1365 :                     ; (HL) = (DE) : Cflag reset / Zflag set
    3861/    1365 :                     ; (HL) < (DE) : Cflag set   / Zflag reset
    3862/    1365 :                     ;
    3863/    1365 :                     CP_MHL_MDE:
    3864/    1365 : 78                  	LD	A,B
    3865/    1366 : 13                  CPL1:	INC	DE
    3866/    1367 : 23                  	INC	HL
    3867/    1368 : 10 FC               	DJNZ	CPL1
    3868/    136A : 47                  	LD	B,A
    3869/    136B :                     
    3870/    136B : 1B                  CPL2:	DEC	DE
    3871/    136C : 2B                  	DEC	HL
    3872/    136D : 1A                  	LD	A,(DE)
    3873/    136E : BE                  	CP	(HL)
    3874/    136F : 3F                  	CCF
    3875/    1370 : C0                  	RET	NZ
    3876/    1371 : 10 F8               	DJNZ	CPL2
    3877/    1373 : AF                  	XOR	A
    3878/    1374 : C9                  	RET
    3879/    1375 :                     
    3880/    1375 :                     ;
    3881/    1375 :                     ; (DE)x4b <- (HL)x4b
    3882/    1375 :                     ;
    3883/    1375 :                     LD4B_MDE_MHL:
    3884/    1375 : 01 04 00            	LD	BC,0004H
    3885/    1378 : ED B0               	LDIR
    3886/    137A : C9                  	RET
    3887/    137B :                     
    3888/    137B :                     ;
    3889/    137B :                     ; (REG_SDADD)x4b <- (HL)x4b
    3890/    137B :                     ;
    3891/    137B :                     LD4B_REG_SDADD_MHL:
    3892/    137B : 11 06 82            	LD	DE,REG_SDADD
    3893/    137E : 01 04 00            	LD	BC,0004H
    3894/    1381 : ED B0               	LDIR
    3895/    1383 : C9                  	RET
    3896/    1384 :                     
    3897/    1384 :                     ;
    3898/    1384 :                     ; (WORK)x4b <- (HL)x4b
    3899/    1384 :                     ;
    3900/    1384 :                     LD4B_WORK_MHL:
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 66 - 2/18/2013 12:10:16


    3901/    1384 : 11 A4 22            	LD	DE,WORK
    3902/    1387 : 01 04 00            	LD	BC,0004H
    3903/    138A : ED B0               	LDIR
    3904/    138C : C9                  	RET
    3905/    138D :                     
    3906/    138D :                     
    3907/    138D :                     ;
    3908/    138D :                     ; read 1 sector
    3909/    138D :                     ;
    3910/    138D :                     READ1SEC:
    3911/    138D : 3E 08               	LD	A,08H
    3912/    138F : 32 11 82            	LD	(REG_BUFSEL),A
    3913/    1392 : 21 13 82            	LD	HL,REG_SDRD
    3914/    1395 : 36 01               	LD	(HL),01H
    3915/    1397 : 35                  	DEC	(HL)
    3916/    1398 : 3E 11               	LD	A,11H
    3917/    139A : CD C6 13            	CALL	SENDCMD
    3918/    139D : 3A 13 82            RSL1:	LD	A,(REG_SDRD)
    3919/    13A0 : E6 10               	AND	10H
    3920/    13A2 : 28 F9               	JR	Z,RSL1
    3921/    13A4 : 3E 01               	LD	A,01H
    3922/    13A6 : 32 11 82            	LD	(REG_BUFSEL),A
    3923/    13A9 : C9                  	RET
    3924/    13AA :                     
    3925/    13AA :                     ;
    3926/    13AA :                     ; write 1 sector
    3927/    13AA :                     ;
    3928/    13AA :                     
    3929/    13AA :                     WRITE1SEC:
    3930/    13AA : AF                  	XOR	A
    3931/    13AB : 32 11 82            	LD	(REG_BUFSEL),A
    3932/    13AE : 21 14 82            	LD	HL,REG_SDWR
    3933/    13B1 : 36 01               	LD	(HL),01H
    3934/    13B3 : 35                  	DEC	(HL)
    3935/    13B4 : 3E 18               	LD	A,18H
    3936/    13B6 : CD C6 13            	CALL	SENDCMD
    3937/    13B9 : 3A 14 82            WSL1:	LD	A,(REG_SDWR)
    3938/    13BC : E6 10               	AND	10H
    3939/    13BE : 28 F9               	JR	Z,WSL1
    3940/    13C0 :                     
    3941/    13C0 : 3E 01               	LD	A,01H
    3942/    13C2 : 32 11 82            	LD	(REG_BUFSEL),A
    3943/    13C5 : C9                  	RET
    3944/    13C6 :                     
    3945/    13C6 :                     
    3946/    13C6 :                     
    3947/    13C6 :                     SENDCMD:
    3948/    13C6 :                     ;
    3949/    13C6 :                     ; Areg <= command_No
    3950/    13C6 :                     ;
    3951/    13C6 : 32 05 82            	LD	(REG_SDCMDNO),A
    3952/    13C9 : 21 00 82            	LD	HL,REG_SDCMDST
    3953/    13CC : 36 01               	LD	(HL),01H
    3954/    13CE : 35                  	DEC	(HL)
    3955/    13CF : CB 46               SCL1:	BIT	0,(HL)
    3956/    13D1 : 20 FC               	JR	NZ,SCL1
    3957/    13D3 : 3E 06               	LD	A,06H
    3958/    13D5 : A6                  	AND	(HL)
    3959/    13D6 : 20 39               	JR	NZ,SDERR
    3960/    13D8 : C9                  	RET
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 67 - 2/18/2013 12:10:16


    3961/    13D9 :                     
    3962/    13D9 :                     
    3963/    13D9 :                     SENDCMD2:
    3964/    13D9 :                     ;
    3965/    13D9 :                     ; Areg <= command_No
    3966/    13D9 :                     ;
    3967/    13D9 : 32 05 82            	LD	(REG_SDCMDNO),A
    3968/    13DC : 21 00 82            	LD	HL,REG_SDCMDST
    3969/    13DF : 36 01               	LD	(HL),01H
    3970/    13E1 : 35                  	DEC	(HL)
    3971/    13E2 : CB 46               SCL2:	BIT	0,(HL)
    3972/    13E4 : 20 FC               	JR	NZ,SCL2
    3973/    13E6 : CB 56               	BIT	2,(HL)
    3974/    13E8 : 20 27               	JR	NZ,SDERR
    3975/    13EA : C9                  	RET
    3976/    13EB :                     
    3977/    13EB :                     
    3978/    13EB :                     CHKSPT:
    3979/    13EB :                     ;
    3980/    13EB :                     ; SD card support check
    3981/    13EB :                     ;
    3982/    13EB :                     ; FAT16
    3983/    13EB :                     ; # of FAT = 02H
    3984/    13EB :                     ; # of sector byte = 0200H
    3985/    13EB :                     ; # of root directory entry = 0200H
    3986/    13EB :                     
    3987/    13EB : 2A 39 80            	LD	HL,(BPB_FATVER)
    3988/    13EE : 11 31 36            	LD	DE,3631H
    3989/    13F1 : B7                  	OR	A
    3990/    13F2 : ED 52               	SBC	HL,DE
    3991/    13F4 : 20 1B               	JR	NZ,SDERR
    3992/    13F6 :                     		;
    3993/    13F6 : 3A 10 80            	LD	A,(BPB_FATNUM)
    3994/    13F9 : FE 02               	CP	02H
    3995/    13FB : 20 14               	JR	NZ,SDERR
    3996/    13FD :                     		;
    3997/    13FD : 2A 0B 80            	LD	HL,(BPB_SECBYTE)
    3998/    1400 : 11 00 02            	LD	DE,0200H
    3999/    1403 : B7                  	OR	A
    4000/    1404 : ED 52               	SBC	HL,DE
    4001/    1406 : 20 09               	JR	NZ,SDERR
    4002/    1408 :                     		;
    4003/    1408 : 2A 11 80            	LD	HL,(BPB_DIRENTRY)
    4004/    140B : B7                  	OR	A
    4005/    140C : ED 52               	SBC	HL,DE
    4006/    140E : 20 01               	JR	NZ,SDERR
    4007/    1410 : C9                  	RET
    4008/    1411 :                     
    4009/    1411 :                     
    4010/    1411 :                     SDERR:
    4011/    1411 :                     ;
    4012/    1411 :                     ; SD card error
    4013/    1411 :                     ;
    4014/    1411 : 21 01 82            	LD	HL,REG_SDCTRL
    4015/    1414 : 3E 02               	LD	A,02H
    4016/    1416 : 77                  	LD	(HL),A
    4017/    1417 : 31 FF 3F            	LD	SP,INITSP
    4018/    141A : 3A B4 22            	LD	A,(SDMODE)
    4019/    141D : B7                  	OR	A
    4020/    141E : 28 FE               ERRLP:	JR	Z,ERRLP
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 68 - 2/18/2013 12:10:16


    4021/    1420 : FE 01               	CP	01H
    4022/    1422 : CA FD 00            	JP	Z,MAINSTART
    4023/    1425 : C3 08 01            	JP	MAINST2
    4024/    1428 : 18 F4               	JR	ERRLP
    4025/    142A :                     
    4026/    142A :                     ;
    4027/    142A :                     ; LCD initialize
    4028/    142A :                     ;
    4029/    142A :                     LCD_INIT:
    4030/    142A : 11 00 03            	LD	DE,00300H
    4031/    142D : CD 5A 14            	CALL	LCD_OUTDT
    4032/    1430 : 11 01 00            	LD	DE,00001H
    4033/    1433 : CD 5A 14            	CALL	LCD_OUTDT
    4034/    1436 : 11 02 00            	LD	DE,00002H
    4035/    1439 : CD 5A 14            	CALL	LCD_OUTDT
    4036/    143C : 11 03 CC            	LD	DE,0CC03H
    4037/    143F : CD 5A 14            	CALL	LCD_OUTDT
    4038/    1442 : 11 04 46            	LD	DE,04604H
    4039/    1445 : CD 5A 14            	CALL	LCD_OUTDT
    4040/    1448 : 11 05 0D            	LD	DE,00D05H
    4041/    144B : CD 5A 14            	CALL	LCD_OUTDT
    4042/    144E : 11 07 00            	LD	DE,00007H
    4043/    1451 : CD 5A 14            	CALL	LCD_OUTDT
    4044/    1454 :                     
    4045/    1454 : 3E 01               	LD	A,01H
    4046/    1456 : 32 04 84            	LD	(REG_LCDDONE),A
    4047/    1459 :                     
    4048/    1459 : C9                  	RET
    4049/    145A :                     
    4050/    145A :                     ;
    4051/    145A :                     ; LCD setting data output
    4052/    145A :                     ;
    4053/    145A :                     LCD_OUTDT:
    4054/    145A : 21 03 84            	LD	HL,REG_LCDST
    4055/    145D : ED 53 01 84         	LD	(REG_LCDADD),DE
    4056/    1461 : 36 01               	LD	(HL),01H
    4057/    1463 : AF                  	XOR	A
    4058/    1464 : BE                  LCDD1:	CP	(HL)
    4059/    1465 : 20 FD               	JR	NZ,LCDD1
    4060/    1467 : C9                  	RET
    4061/    1468 :                     
    4062/    1468 :                     ;
    4063/    1468 :                     ; FDD initialize
    4064/    1468 :                     ;
    4065/    1468 :                     FDUNITINIT:
    4066/    1468 : AF                  	XOR	A
    4067/    1469 : 32 7F 82            	LD	(REG_FDD0),A
    4068/    146C : 32 9F 82            	LD	(REG_FDD1),A
    4069/    146F : 32 BF 82            	LD	(REG_FDD2),A
    4070/    1472 : 32 DF 82            	LD	(REG_FDD3),A
    4071/    1475 : 32 C1 22            	LD	(EXTFDDST),A
    4072/    1478 : 32 F2 9F            	LD	(REG_EXTFDDCIO),A
    4073/    147B : 32 C3 22            	LD	(EXTFDDRLEN),A
    4074/    147E : 32 C4 22            	LD	(EXTFDDSLEN),A
    4075/    1481 : C9                  	RET
    4076/    1482 :                     
    4077/    1482 :                     ;
    4078/    1482 :                     ; UART initialize
    4079/    1482 :                     ;
    4080/    1482 :                     UARTINIT:
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 69 - 2/18/2013 12:10:16


    4081/    1482 : AF                  	XOR	A
    4082/    1483 : 32 18 84            	LD	(REG_UARTENB),A
    4083/    1486 : 32 58 23            	LD	(UART_BAUD),A
    4084/    1489 : C9                  	RET
    4085/    148A :                     
    4086/    148A :                     ;
    4087/    148A :                     ; SD registers and circuits initialize
    4088/    148A :                     ;
    4089/    148A :                     SDREGINIT:
    4090/    148A : CD F4 14            	CALL	SDREGINIT_0
    4091/    148D : CD 19 15            	CALL	SDREGINIT_1
    4092/    1490 : FD 21 60 82         	LD	IY,REG_FIFO_2
    4093/    1494 : CD 31 15            	CALL	SDREGINIT_2
    4094/    1497 : FD 21 80 82         	LD	IY,REG_FIFO_3
    4095/    149B : CD 31 15            	CALL	SDREGINIT_2
    4096/    149E : FD 21 A0 82         	LD	IY,REG_FIFO_4
    4097/    14A2 : CD 31 15            	CALL	SDREGINIT_2
    4098/    14A5 : FD 21 C0 82         	LD	IY,REG_FIFO_5
    4099/    14A9 : CD 31 15            	CALL	SDREGINIT_2
    4100/    14AC :                     		;
    4101/    14AC : 21 13 82            	LD	HL,REG_SDRD
    4102/    14AF : 36 01               	LD	(HL),01H
    4103/    14B1 : 36 00               	LD	(HL),00H
    4104/    14B3 :                     		;
    4105/    14B3 : 3A 04 82            	LD	A,(REG_SDWP)
    4106/    14B6 : 32 B7 22            	LD	(SDWPFLAG),A
    4107/    14B9 :                     		;
    4108/    14B9 : 21 00 00            	LD	HL,0000H
    4109/    14BC : 22 BF 22            	LD	(SDDETTIMER),HL
    4110/    14BF :                     		;
    4111/    14BF : 11 AC 23            	LD	DE,ST_CMTREAD_VAL
    4112/    14C2 : CD 42 15            	CALL	LD_ST_NOSELECT
    4113/    14C5 : 11 E9 23            	LD	DE,ST_CMTWRITE_VAL
    4114/    14C8 : CD 42 15            	CALL	LD_ST_NOSELECT
    4115/    14CB : 11 C2 24            	LD	DE,ST_FDD0INTFILE_VAL
    4116/    14CE : CD 42 15            	CALL	LD_ST_NOSELECT
    4117/    14D1 : 11 03 25            	LD	DE,ST_FDD1INTFILE_VAL
    4118/    14D4 : CD 42 15            	CALL	LD_ST_NOSELECT
    4119/    14D7 : 11 44 25            	LD	DE,ST_FDD0EXTFILE_VAL
    4120/    14DA : CD 42 15            	CALL	LD_ST_NOSELECT
    4121/    14DD : 11 85 25            	LD	DE,ST_FDD1EXTFILE_VAL
    4122/    14E0 : CD 42 15            	CALL	LD_ST_NOSELECT
    4123/    14E3 :                     		;
    4124/    14E3 : 3A 04 82            	LD	A,(REG_SDWP)
    4125/    14E6 : B7                  	OR	A
    4126/    14E7 : C8                  	RET	Z
    4127/    14E8 :                     		;
    4128/    14E8 : 11 E9 23            	LD	DE,ST_CMTWRITE_VAL
    4129/    14EB : 21 FF 25            	LD	HL,ST_WRPROTECT
    4130/    14EE : 01 0C 00            	LD	BC,000CH
    4131/    14F1 : ED B0               	LDIR
    4132/    14F3 :                     		;
    4133/    14F3 : C9                  	RET
    4134/    14F4 :                     
    4135/    14F4 :                     ;
    4136/    14F4 :                     ; SD registers and circuits initialize (#0:CMT load FIFO)
    4137/    14F4 :                     ;
    4138/    14F4 :                     SDREGINIT_0:
    4139/    14F4 : E5                  	PUSH	HL
    4140/    14F5 : 21 20 82            	LD	HL,REG_FIFO_0
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 70 - 2/18/2013 12:10:16


    4141/    14F8 : AF                  	XOR	A
    4142/    14F9 : 06 20               	LD	B,20H
    4143/    14FB : 77                  SRL1_0:	LD	(HL),A
    4144/    14FC : 23                  	INC	HL
    4145/    14FD : 10 FC               	DJNZ	SRL1_0
    4146/    14FF :                     		;
    4147/    14FF : FD 21 20 82         	LD	IY,REG_FIFO_0
    4148/    1503 :                     		;
    4149/    1503 : 21 34 82            	LD	HL,REG_CMTRD
    4150/    1506 : 36 02               	LD	(HL),02H
    4151/    1508 : 36 00               	LD	(HL),00H
    4152/    150A :                     		;
    4153/    150A : AF                  	XOR	A
    4154/    150B : 32 B5 22            	LD	(READFLAG),A
    4155/    150E : 32 19 23            	LD	(P6TCMDENB),A
    4156/    1511 : 32 1A 23            	LD	(P6TCMDENBBEF),A
    4157/    1514 : 32 1B 23            	LD	(P6TFILEREAD),A
    4158/    1517 :                     		;
    4159/    1517 : E1                  	POP	HL
    4160/    1518 : C9                  	RET
    4161/    1519 :                     
    4162/    1519 :                     ;
    4163/    1519 :                     ; SD registers and circuits initialize (#1:CMT save FIFO)
    4164/    1519 :                     ;
    4165/    1519 :                     SDREGINIT_1:
    4166/    1519 : E5                  	PUSH	HL
    4167/    151A : 21 40 82            	LD	HL,REG_FIFO_1
    4168/    151D : AF                  	XOR	A
    4169/    151E : 06 20               	LD	B,20H
    4170/    1520 : 77                  SRL1_1:	LD	(HL),A
    4171/    1521 : 23                  	INC	HL
    4172/    1522 : 10 FC               	DJNZ	SRL1_1
    4173/    1524 :                     		;
    4174/    1524 : FD 21 40 82         	LD	IY,REG_FIFO_1
    4175/    1528 :                     		;
    4176/    1528 : AF                  	XOR	A
    4177/    1529 : 32 54 82            	LD	(REG_CMTWR),A
    4178/    152C : 32 B6 22            	LD	(WRITEFLAG),A
    4179/    152F :                     		;
    4180/    152F : E1                  	POP	HL
    4181/    1530 : C9                  	RET
    4182/    1531 :                     
    4183/    1531 :                     ;
    4184/    1531 :                     ; SD registers and circuits initialize (#2:INT FDD#0 FIFO)
    4185/    1531 :                     ;
    4186/    1531 :                     SDREGINIT_2:
    4187/    1531 : E5                  	PUSH	HL
    4188/    1532 :                     
    4189/    1532 : FD E5               	PUSH	IY
    4190/    1534 : E1                  	POP	HL
    4191/    1535 : AF                  	XOR	A
    4192/    1536 : 06 1E               	LD	B,1EH
    4193/    1538 : 77                  SRL1_2:	LD	(HL),A
    4194/    1539 : 23                  	INC	HL
    4195/    153A : 10 FC               	DJNZ	SRL1_2
    4196/    153C :                     		;
    4197/    153C : AF                  	XOR	A
    4198/    153D : FD 77 14            	LD	(IY+FIFO_FLOPPY),A
    4199/    1540 :                     		;
    4200/    1540 : E1                  	POP	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 71 - 2/18/2013 12:10:16


    4201/    1541 : C9                  	RET
    4202/    1542 :                     
    4203/    1542 :                     
    4204/    1542 :                     ;
    4205/    1542 :                     ; copy "no select" string
    4206/    1542 :                     ;
    4207/    1542 :                     LD_ST_NOSELECT:
    4208/    1542 : 21 F3 25            	LD	HL,ST_NOSELECT
    4209/    1545 : 01 0C 00            	LD	BC,000CH
    4210/    1548 : ED B0               	LDIR
    4211/    154A : C9                  	RET
    4212/    154B :                     
    4213/    154B :                     ;
    4214/    154B :                     ; SD address initialize
    4215/    154B :                     ;
    4216/    154B :                     SDADDINIT:
    4217/    154B : 21 FF FF            	LD	HL,0FFFFH
    4218/    154E : 22 06 82            	LD	(REG_SDADD),HL
    4219/    1551 : 22 08 82            	LD	(REG_SDADD+2),HL
    4220/    1554 : C9                  	RET
    4221/    1555 :                     
    4222/    1555 :                     ;
    4223/    1555 :                     ; function key buffer initialize
    4224/    1555 :                     ;
    4225/    1555 :                     KEYBUFINIT:
    4226/    1555 : 21 21 23            	LD	HL,CTRLNOW
    4227/    1558 : AF                  	XOR	A
    4228/    1559 : 06 0C               	LD	B,0CH
    4229/    155B : 77                  KBL1:	LD	(HL),A
    4230/    155C : 23                  	INC	HL
    4231/    155D : 10 FC               	DJNZ	KBL1
    4232/    155F : C9                  	RET
    4233/    1560 :                     
    4234/    1560 :                     ;
    4235/    1560 :                     ; detect SD card insert or eject
    4236/    1560 :                     ;
    4237/    1560 :                     DETSDEJECT:
    4238/    1560 : 3A 04 82            	LD	A,(REG_SDWP)
    4239/    1563 : 47                  	LD	B,A
    4240/    1564 : 3A B7 22            	LD	A,(SDWPFLAG)
    4241/    1567 : A8                  	XOR	B
    4242/    1568 : 28 0D               	JR	Z,DSEL1
    4243/    156A :                     
    4244/    156A :                     		;
    4245/    156A :                     		; detected SD card insert / eject
    4246/    156A :                     		;
    4247/    156A : 3A 04 82            	LD	A,(REG_SDWP)
    4248/    156D : 32 B7 22            	LD	(SDWPFLAG),A
    4249/    1570 :                     		;
    4250/    1570 : 21 00 10            	LD	HL,1000H
    4251/    1573 : 22 BF 22            	LD	(SDDETTIMER),HL
    4252/    1576 : C9                  	RET
    4253/    1577 :                     
    4254/    1577 :                     DSEL1:
    4255/    1577 : 2A BF 22            	LD	HL,(SDDETTIMER)
    4256/    157A : 7C                  	LD	A,H
    4257/    157B : B5                  	OR	L
    4258/    157C : C8                  	RET	Z
    4259/    157D :                     
    4260/    157D : 2B                  	DEC	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 72 - 2/18/2013 12:10:16


    4261/    157E : 22 BF 22            	LD	(SDDETTIMER),HL
    4262/    1581 : 7C                  	LD	A,H
    4263/    1582 : B5                  	OR	L
    4264/    1583 : C0                  	RET	NZ
    4265/    1584 :                     
    4266/    1584 :                     		;
    4267/    1584 :                     		; timer full
    4268/    1584 :                     		;
    4269/    1584 : CD 14 11            	CALL	SDCARD_OPEN
    4270/    1587 : CD 8A 14            	CALL	SDREGINIT
    4271/    158A :                     
    4272/    158A : 3E 01               	LD	A,01H
    4273/    158C : 32 BA 22            	LD	(PAGEREDRAW),A
    4274/    158F :                     		;
    4275/    158F :                     
    4276/    158F : C9                  	RET
    4277/    1590 :                     
    4278/    1590 :                     
    4279/    1590 :                     ;
    4280/    1590 :                     ; p6t format auto command input
    4281/    1590 :                     ;
    4282/    1590 :                     P6TKEYWAIT:
    4283/    1590 : 3A 1A 23            	LD	A,(P6TCMDENBBEF)
    4284/    1593 : 4F                  	LD	C,A
    4285/    1594 : 3A 19 23            	LD	A,(P6TCMDENB)
    4286/    1597 : 47                  	LD	B,A
    4287/    1598 : 32 1A 23            	LD	(P6TCMDENBBEF),A
    4288/    159B :                     
    4289/    159B : 3A 1B 23            	LD	A,(P6TFILEREAD)
    4290/    159E : B7                  	OR	A
    4291/    159F : C8                  	RET	Z
    4292/    15A0 :                     
    4293/    15A0 : 78                  	LD	A,B
    4294/    15A1 : B7                  	OR	A
    4295/    15A2 : 79                  	LD	A,C
    4296/    15A3 : 20 23               	JR	NZ,P6L1
    4297/    15A5 :                     
    4298/    15A5 : B7                  	OR	A
    4299/    15A6 : C8                  	RET	Z
    4300/    15A7 :                     
    4301/    15A7 :                     		;
    4302/    15A7 :                     		; auto mode -> manual mode
    4303/    15A7 :                     		;
    4304/    15A7 : 21 00 00            	LD	HL,0000H
    4305/    15AA : 22 1C 23            	LD	(KEYTIMER),HL
    4306/    15AD :                     
    4307/    15AD : 3A B5 22            	LD	A,(READFLAG)
    4308/    15B0 : B7                  	OR	A
    4309/    15B1 : C8                  	RET	Z
    4310/    15B2 :                     
    4311/    15B2 : 2A 2B 82            	LD	HL,(REG_FIFO_0+FIFO_STCL)
    4312/    15B5 : 22 28 82            	LD	(REG_FIFO_0+FIFO_CL),HL
    4313/    15B8 : AF                  	XOR	A
    4314/    15B9 : 32 2A 82            	LD	(REG_FIFO_0+FIFO_SEC),A
    4315/    15BC : 3C                  	INC	A
    4316/    15BD : 32 B5 22            	LD	(READFLAG),A
    4317/    15C0 :                     
    4318/    15C0 : 21 34 82            	LD	HL,REG_CMTRD
    4319/    15C3 : 36 02               	LD	(HL),02H
    4320/    15C5 : 36 00               	LD	(HL),00H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 73 - 2/18/2013 12:10:16


    4321/    15C7 :                     
    4322/    15C7 : C9                  	RET
    4323/    15C8 :                     
    4324/    15C8 :                     P6L1:
    4325/    15C8 : B7                  	OR	A
    4326/    15C9 : 20 10               	JR	NZ,P6L2
    4327/    15CB :                     
    4328/    15CB :                     		;
    4329/    15CB :                     		; manual mode -> auto mode
    4330/    15CB :                     		;
    4331/    15CB :                     
    4332/    15CB : 21 00 10            	LD	HL,1000H
    4333/    15CE : 22 1C 23            	LD	(KEYTIMER),HL
    4334/    15D1 : AF                  	XOR	A
    4335/    15D2 : 32 20 23            	LD	(P6TKEYPUSH),A
    4336/    15D5 : 3E 05               	LD	A,05H
    4337/    15D7 : 32 1F 23            	LD	(P6TBUFPOS),A
    4338/    15DA :                     
    4339/    15DA : C9                  	RET
    4340/    15DB :                     
    4341/    15DB :                     P6L2:		;
    4342/    15DB :                     		; auto mode
    4343/    15DB :                     		;
    4344/    15DB :                     		; judge command finish
    4345/    15DB :                     		;
    4346/    15DB : 3A 1E 23            	LD	A,(P6TCMDLEN)
    4347/    15DE : 47                  	LD	B,A
    4348/    15DF : 3A 1F 23            	LD	A,(P6TBUFPOS)
    4349/    15E2 : B8                  	CP	B
    4350/    15E3 : D0                  	RET	NC
    4351/    15E4 :                     
    4352/    15E4 :                     		;
    4353/    15E4 :                     		; judge timer full and CMT read end
    4354/    15E4 :                     		;
    4355/    15E4 : 2A 1C 23            	LD	HL,(KEYTIMER)
    4356/    15E7 : 7C                  	LD	A,H
    4357/    15E8 : B5                  	OR	L
    4358/    15E9 : 28 05               	JR	Z,P6LPUSH
    4359/    15EB :                     
    4360/    15EB : 2B                  	DEC	HL
    4361/    15EC : 22 1C 23            	LD	(KEYTIMER),HL
    4362/    15EF : C9                  	RET
    4363/    15F0 :                     
    4364/    15F0 :                     P6LPUSH:
    4365/    15F0 : 3A 20 23            	LD	A,(P6TKEYPUSH)
    4366/    15F3 : B7                  	OR	A
    4367/    15F4 : 20 12               	JR	NZ,P6LRELEASE
    4368/    15F6 :                     
    4369/    15F6 : CD 1B 16            	CALL	GETKEYP6T
    4370/    15F9 : 32 16 84            	LD	(REG_KEYDAT),A
    4371/    15FC : 22 1C 23            	LD	(KEYTIMER),HL
    4372/    15FF :                     
    4373/    15FF : 3E 01               	LD	A,01H
    4374/    1601 : 32 20 23            	LD	(P6TKEYPUSH),A
    4375/    1604 : 32 17 84            	LD	(REG_KEYENB),A
    4376/    1607 :                     
    4377/    1607 : C9                  	RET
    4378/    1608 :                     
    4379/    1608 :                     P6LRELEASE:
    4380/    1608 : CD 1B 16            	CALL	GETKEYP6T
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 74 - 2/18/2013 12:10:16


    4381/    160B : EB                  	EX	DE,HL
    4382/    160C : 22 1C 23            	LD	(KEYTIMER),HL
    4383/    160F : 78                  	LD	A,B
    4384/    1610 : 32 1F 23            	LD	(P6TBUFPOS),A
    4385/    1613 :                     
    4386/    1613 : AF                  	XOR	A
    4387/    1614 : 32 20 23            	LD	(P6TKEYPUSH),A
    4388/    1617 : 32 17 84            	LD	(REG_KEYENB),A
    4389/    161A :                     
    4390/    161A : C9                  	RET
    4391/    161B :                     
    4392/    161B :                     ;
    4393/    161B :                     ; get key data and stroke interval from buffer
    4394/    161B :                     ;
    4395/    161B :                     ; (P6TBUFFER) <= key data buffer
    4396/    161B :                     ; (P6TBUFPOS) <= buffer position
    4397/    161B :                     ;
    4398/    161B :                     ; RETURN
    4399/    161B :                     ; A  <= push key data
    4400/    161B :                     ; HL <= key push wait timer
    4401/    161B :                     ; DE <= key release wait timer
    4402/    161B :                     ; B  <= next buffer position
    4403/    161B :                     ;
    4404/    161B :                     GETKEYP6T:
    4405/    161B : 3A 1F 23            	LD	A,(P6TBUFPOS)
    4406/    161E : 5F                  	LD	E,A
    4407/    161F : 16 00               	LD	D,00H
    4408/    1621 : 21 BB 28            	LD	HL,P6TBUFFER
    4409/    1624 : 19                  	ADD	HL,DE
    4410/    1625 : 7E                  	LD	A,(HL)
    4411/    1626 : 4F                  	LD	C,A
    4412/    1627 :                     
    4413/    1627 : 3A 1F 23            	LD	A,(P6TBUFPOS)
    4414/    162A : FE 05               	CP	05H
    4415/    162C : 20 30               	JR	NZ,GKPL1
    4416/    162E :                     
    4417/    162E :                     		;
    4418/    162E :                     		; BASIC MODE
    4419/    162E :                     		;
    4420/    162E : 3A 15 84            	LD	A,(REG_MK2MODE)
    4421/    1631 : B7                  	OR	A
    4422/    1632 : 20 1E               	JR	NZ,GKPL_MK2
    4423/    1634 :                     
    4424/    1634 : 79                  	LD	A,C
    4425/    1635 : B7                  	OR	A
    4426/    1636 : 28 10               	JR	Z,GKPL0
    4427/    1638 : FE 05               	CP	05H
    4428/    163A : 30 0C               	JR	NC,GKPL0
    4429/    163C :                     
    4430/    163C : E6 01               	AND	01H
    4431/    163E : 32 12 84            	LD	(REG_MEM16K),A
    4432/    1641 :                     		;
    4433/    1641 : 21 11 84            	LD	HL,REG_CTRLRST
    4434/    1644 : 36 01               	LD	(HL),01H
    4435/    1646 : 36 00               	LD	(HL),00H
    4436/    1648 :                     
    4437/    1648 :                     GKPL0:
    4438/    1648 : 06 06               	LD	B,06H
    4439/    164A : 21 00 01            	LD	HL,0100H
    4440/    164D : 11 00 10            	LD	DE,1000H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 75 - 2/18/2013 12:10:16


    4441/    1650 : AF                  	XOR	A
    4442/    1651 : C9                  	RET
    4443/    1652 :                     
    4444/    1652 :                     GKPL_MK2:
    4445/    1652 : 06 06               	LD	B,06H
    4446/    1654 : 79                  	LD	A,C
    4447/    1655 : C6 30               	ADD	A,30H
    4448/    1657 : 21 00 01            	LD	HL,0100H
    4449/    165A : 11 00 10            	LD	DE,1000H
    4450/    165D : C9                  	RET
    4451/    165E :                     
    4452/    165E :                     GKPL1:
    4453/    165E : FE 06               	CP	06H
    4454/    1660 : 20 0C               	JR	NZ,GKPL2
    4455/    1662 :                     		;
    4456/    1662 :                     		; Pages
    4457/    1662 :                     		;
    4458/    1662 : 06 07               	LD	B,07H
    4459/    1664 : 79                  	LD	A,C
    4460/    1665 : C6 30               	ADD	A,30H
    4461/    1667 : 21 00 01            	LD	HL,0100H
    4462/    166A : 11 00 01            	LD	DE,0100H
    4463/    166D : C9                  	RET
    4464/    166E :                     
    4465/    166E :                     GKPL2:
    4466/    166E : FE 07               	CP	07H
    4467/    1670 : 20 0B               	JR	NZ,GKPL3
    4468/    1672 :                     		;
    4469/    1672 :                     		; Pages (return)
    4470/    1672 :                     		;
    4471/    1672 : 06 09               	LD	B,09H
    4472/    1674 : 3E 0D               	LD	A,0DH
    4473/    1676 : 21 00 01            	LD	HL,0100H
    4474/    1679 : 11 00 20            	LD	DE,2000H
    4475/    167C : C9                  	RET
    4476/    167D :                     
    4477/    167D :                     GKPL3:
    4478/    167D : 47                  	LD	B,A
    4479/    167E : 04                  	INC	B
    4480/    167F : 21 00 01            	LD	HL,0100H
    4481/    1682 : 11 00 01            	LD	DE,0100H
    4482/    1685 :                     
    4483/    1685 : 3E 0A               	LD	A,0AH
    4484/    1687 : B9                  	CP	C
    4485/    1688 : 20 06               	JR	NZ,GKPL4
    4486/    168A :                     
    4487/    168A : 11 00 10            	LD	DE,1000H
    4488/    168D : 3E 0D               	LD	A,0DH
    4489/    168F : C9                  	RET
    4490/    1690 :                     
    4491/    1690 :                     GKPL4:
    4492/    1690 : 3E 0D               	LD	A,0DH
    4493/    1692 : B9                  	CP	C
    4494/    1693 : 20 03               	JR	NZ,GKPL5
    4495/    1695 : 11 00 10            	LD	DE,1000H
    4496/    1698 :                     GKPL5:
    4497/    1698 : 79                  	LD	A,C
    4498/    1699 : C9                  	RET
    4499/    169A :                     
    4500/    169A :                     ;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 76 - 2/18/2013 12:10:16


    4501/    169A :                     ; read auto command from p6t file
    4502/    169A :                     ;
    4503/    169A :                     ; RETURN
    4504/    169A :                     ; A <= P6T flag (01H:auto command 00H:no command)
    4505/    169A :                     ; (P6TBUFFER) <= key data buffer
    4506/    169A :                     ; (P6TCMDLEN) <= command length
    4507/    169A :                     ;
    4508/    169A :                     READP6T:
    4509/    169A :                     
    4510/    169A :                     		;
    4511/    169A :                     		; (IY+CMTPTR) <= (IY+CMTLEN) - 4
    4512/    169A :                     		;
    4513/    169A : FD 7E 00            	LD	A,(IY+FIFO_CMTLEN+0)
    4514/    169D : D6 04               	SUB	04H
    4515/    169F : FD 77 04            	LD	(IY+FIFO_CMTPTR+0),A
    4516/    16A2 : FD 7E 01            	LD	A,(IY+FIFO_CMTLEN+1)
    4517/    16A5 : DE 00               	SBC	A,00H
    4518/    16A7 : FD 77 05            	LD	(IY+FIFO_CMTPTR+1),A
    4519/    16AA : FD 7E 02            	LD	A,(IY+FIFO_CMTLEN+2)
    4520/    16AD : DE 00               	SBC	A,00H
    4521/    16AF : FD 77 06            	LD	(IY+FIFO_CMTPTR+2),A
    4522/    16B2 : FD 7E 03            	LD	A,(IY+FIFO_CMTLEN+3)
    4523/    16B5 : DE 00               	SBC	A,00H
    4524/    16B7 : FD 77 07            	LD	(IY+FIFO_CMTPTR+3),A
    4525/    16BA :                     
    4526/    16BA : 3E 04               	LD	A,04H
    4527/    16BC : CD 8B 0D            	CALL	FILEPOSREAD
    4528/    16BF : B7                  	OR	A
    4529/    16C0 : 28 47               	JR	Z,RP6T_NG
    4530/    16C2 :                     
    4531/    16C2 : 21 BB 28            	LD	HL,P6TBUFFER
    4532/    16C5 : 7E                  	LD	A,(HL)
    4533/    16C6 : FD 77 04            	LD	(IY+FIFO_CMTPTR+0),A
    4534/    16C9 : 23                  	INC	HL
    4535/    16CA : 7E                  	LD	A,(HL)
    4536/    16CB : FD 77 05            	LD	(IY+FIFO_CMTPTR+1),A
    4537/    16CE : 23                  	INC	HL
    4538/    16CF : 7E                  	LD	A,(HL)
    4539/    16D0 : FD 77 06            	LD	(IY+FIFO_CMTPTR+2),A
    4540/    16D3 : 23                  	INC	HL
    4541/    16D4 : 7E                  	LD	A,(HL)
    4542/    16D5 : FD 77 07            	LD	(IY+FIFO_CMTPTR+3),A
    4543/    16D8 :                     
    4544/    16D8 : 3E 4A               	LD	A,4AH
    4545/    16DA : CD 8B 0D            	CALL	FILEPOSREAD
    4546/    16DD : B7                  	OR	A
    4547/    16DE : 28 29               	JR	Z,RP6T_NG
    4548/    16E0 :                     
    4549/    16E0 : 21 BB 28            	LD	HL,P6TBUFFER
    4550/    16E3 :                     		;
    4551/    16E3 :                     		; 0000H identify0 = "P"
    4552/    16E3 :                     		;
    4553/    16E3 : 7E                  	LD	A,(HL)
    4554/    16E4 : FE 50               	CP	'P'
    4555/    16E6 : 20 21               	JR	NZ,RP6T_NG
    4556/    16E8 :                     
    4557/    16E8 :                     		;
    4558/    16E8 :                     		; 0001H identify1 = "6"
    4559/    16E8 :                     		;
    4560/    16E8 : 23                  	INC	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 77 - 2/18/2013 12:10:16


    4561/    16E9 : 7E                  	LD	A,(HL)
    4562/    16EA : FE 36               	CP	'6'
    4563/    16EC : 20 1B               	JR	NZ,RP6T_NG
    4564/    16EE :                     
    4565/    16EE :                     		;
    4566/    16EE :                     		; 0002H version = 02H
    4567/    16EE :                     		;
    4568/    16EE : 23                  	INC	HL
    4569/    16EF : 7E                  	LD	A,(HL)
    4570/    16F0 : FE 02               	CP	02H
    4571/    16F2 : 20 15               	JR	NZ,RP6T_NG
    4572/    16F4 :                     
    4573/    16F4 :                     		;
    4574/    16F4 :                     		; 0004H auto command enable = 01H
    4575/    16F4 :                     		;
    4576/    16F4 : 23                  	INC	HL
    4577/    16F5 : 23                  	INC	HL
    4578/    16F6 : 7E                  	LD	A,(HL)
    4579/    16F7 : FE 01               	CP	01H
    4580/    16F9 : 20 0E               	JR	NZ,RP6T_NG
    4581/    16FB :                     
    4582/    16FB :                     		;
    4583/    16FB :                     		; 0007H command length(low)
    4584/    16FB :                     		;
    4585/    16FB : 23                  	INC	HL
    4586/    16FC : 23                  	INC	HL
    4587/    16FD : 23                  	INC	HL
    4588/    16FE : 7E                  	LD	A,(HL)
    4589/    16FF : E6 3F               	AND	3FH
    4590/    1701 : C6 09               	ADD	A,09H
    4591/    1703 : 32 1E 23            	LD	(P6TCMDLEN),A
    4592/    1706 :                     
    4593/    1706 : 3E 01               	LD	A,01H
    4594/    1708 : C9                  	RET
    4595/    1709 :                     
    4596/    1709 :                     RP6T_NG:
    4597/    1709 : AF                  	XOR	A
    4598/    170A : 32 1E 23            	LD	(P6TCMDLEN),A
    4599/    170D : C9                  	RET
    4600/    170E :                     
    4601/    170E :                     ;
    4602/    170E :                     ; external floppy disk access
    4603/    170E :                     ;
    4604/    170E :                     EXTDISKWAIT:
    4605/    170E : 3A C1 22            	LD	A,(EXTFDDST)
    4606/    1711 : B7                  	OR	A
    4607/    1712 : 20 11               	JR	NZ,EXTST01H
    4608/    1714 :                     
    4609/    1714 :                     		;
    4610/    1714 :                     		; EXTFDDST:00H - 03H
    4611/    1714 :                     		; command receive phase
    4612/    1714 :                     		;
    4613/    1714 :                     
    4614/    1714 :                     		;
    4615/    1714 :                     		; wait ATN ON
    4616/    1714 :                     		;
    4617/    1714 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4618/    1717 : E6 08               	AND	08H			; wait ATN ON
    4619/    1719 : C8                  	RET	Z
    4620/    171A : 3E 0B               	LD	A,0BH
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 78 - 2/18/2013 12:10:16


    4621/    171C : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set RFD
    4622/    171F : 3E 01               	LD	A,01H
    4623/    1721 : 32 C1 22            	LD	(EXTFDDST),A
    4624/    1724 : C9                  	RET
    4625/    1725 :                     
    4626/    1725 :                     EXTST01H:
    4627/    1725 : FE 01               	CP	01H
    4628/    1727 : 20 0C               	JR	NZ,EXTST02H
    4629/    1729 :                     
    4630/    1729 :                     		;
    4631/    1729 :                     		; wait ATN OFF
    4632/    1729 :                     		;
    4633/    1729 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4634/    172C : E6 08               	AND	08H			; wait ATN OFF
    4635/    172E : C0                  	RET	NZ
    4636/    172F : 3E 02               	LD	A,02H
    4637/    1731 : 32 C1 22            	LD	(EXTFDDST),A
    4638/    1734 : C9                  	RET
    4639/    1735 :                     
    4640/    1735 :                     EXTST02H:
    4641/    1735 : FE 02               	CP	02H
    4642/    1737 : 20 1C               	JR	NZ,EXTST03H
    4643/    1739 :                     
    4644/    1739 :                     		;
    4645/    1739 :                     		; wait DAV ON
    4646/    1739 :                     		;
    4647/    1739 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4648/    173C : E6 01               	AND	01H			; wait DAV ON
    4649/    173E : C8                  	RET	Z
    4650/    173F : 3E 0A               	LD	A,0AH
    4651/    1741 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset RFD
    4652/    1744 : 3A F0 9F            	LD	A,(REG_EXTFDDDI)
    4653/    1747 : 32 C2 22            	LD	(EXTFDDCMD),A
    4654/    174A : 3E 0D               	LD	A,0DH
    4655/    174C : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set DAC
    4656/    174F : 3E 03               	LD	A,03H
    4657/    1751 : 32 C1 22            	LD	(EXTFDDST),A
    4658/    1754 : C9                  	RET
    4659/    1755 :                     
    4660/    1755 :                     EXTST03H:
    4661/    1755 : FE 03               	CP	03H
    4662/    1757 : 20 11               	JR	NZ,EXTST10H
    4663/    1759 :                     
    4664/    1759 :                     		;
    4665/    1759 :                     		; wait DAV OFF
    4666/    1759 :                     		;
    4667/    1759 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4668/    175C : E6 01               	AND	01H			; wait DAV OFF
    4669/    175E : C0                  	RET	NZ
    4670/    175F : 3E 0C               	LD	A,0CH
    4671/    1761 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset DAC
    4672/    1764 : 3E 10               	LD	A,10H
    4673/    1766 : 32 C1 22            	LD	(EXTFDDST),A
    4674/    1769 : C9                  	RET
    4675/    176A :                     
    4676/    176A :                     
    4677/    176A :                     EXTST10H:
    4678/    176A : FE 10               	CP	10H
    4679/    176C : 20 35               	JR	NZ,EXTST20H
    4680/    176E :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 79 - 2/18/2013 12:10:16


    4681/    176E :                     		;
    4682/    176E :                     		; EXTFDDST:10H
    4683/    176E :                     		; command analyze phase
    4684/    176E :                     		; (detect parameter send/receive length)
    4685/    176E :                     		;
    4686/    176E :                     
    4687/    176E :                     		;
    4688/    176E :                     		; analyze command
    4689/    176E :                     		;
    4690/    176E : AF                  	XOR	A
    4691/    176F : 32 C3 22            	LD	(EXTFDDRLEN),A
    4692/    1772 : 32 C4 22            	LD	(EXTFDDSLEN),A
    4693/    1775 : 32 F4 22            	LD	(EXTFDDSUBST),A
    4694/    1778 : 32 C1 22            	LD	(EXTFDDST),A
    4695/    177B : 3A C2 22            	LD	A,(EXTFDDCMD)
    4696/    177E : FE 08               	CP	08H
    4697/    1780 : D0                  	RET	NC
    4698/    1781 :                     
    4699/    1781 : 6F                  	LD	L,A
    4700/    1782 : 26 00               	LD	H,00H
    4701/    1784 : 29                  	ADD	HL,HL
    4702/    1785 : 29                  	ADD	HL,HL
    4703/    1786 : 11 D0 22            	LD	DE,EXTFDDCMDTBL
    4704/    1789 : 19                  	ADD	HL,DE
    4705/    178A : 7E                  	LD	A,(HL)
    4706/    178B : 32 C3 22            	LD	(EXTFDDRLEN),A
    4707/    178E : 23                  	INC	HL
    4708/    178F : 7E                  	LD	A,(HL)
    4709/    1790 : 32 C4 22            	LD	(EXTFDDSLEN),A
    4710/    1793 : 23                  	INC	HL
    4711/    1794 : 7E                  	LD	A,(HL)
    4712/    1795 : 32 F2 22            	LD	(EXTFDDSUBAD),A
    4713/    1798 : 23                  	INC	HL
    4714/    1799 : 7E                  	LD	A,(HL)
    4715/    179A : 32 F3 22            	LD	(EXTFDDSUBAD+1),A
    4716/    179D : 3E 20               	LD	A,20H
    4717/    179F : 32 C1 22            	LD	(EXTFDDST),A
    4718/    17A2 : C9                  	RET
    4719/    17A3 :                     
    4720/    17A3 :                     EXTST20H:
    4721/    17A3 : FE 20               	CP	20H
    4722/    17A5 : 20 51               	JR	NZ,EXTST30H
    4723/    17A7 :                     
    4724/    17A7 :                     		;
    4725/    17A7 :                     		; EXTFDDST:20H
    4726/    17A7 :                     		; command execute
    4727/    17A7 :                     		; (generate output parameter)
    4728/    17A7 :                     		;
    4729/    17A7 : 3E 30               	LD	A,30H
    4730/    17A9 : 32 C1 22            	LD	(EXTFDDST),A
    4731/    17AC : 21 C5 22            	LD	HL,EXTFDDPARA
    4732/    17AF : 22 CC 22            	LD	(EXTFDDPTR),HL
    4733/    17B2 :                     
    4734/    17B2 : 3A C2 22            	LD	A,(EXTFDDCMD)
    4735/    17B5 : FE 03               	CP	03H
    4736/    17B7 : 20 07               	JR	NZ,EXTCMDL1
    4737/    17B9 :                     
    4738/    17B9 :                     		;
    4739/    17B9 :                     		; 03H : Transfer Buffer
    4740/    17B9 :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 80 - 2/18/2013 12:10:16


    4741/    17B9 : 21 00 B0            	LD	HL,EXTRDBUF
    4742/    17BC : 22 CC 22            	LD	(EXTFDDPTR),HL
    4743/    17BF : C9                  	RET
    4744/    17C0 :                     
    4745/    17C0 :                     EXTCMDL1:
    4746/    17C0 : FE 06               	CP	06H
    4747/    17C2 : 20 07               	JR	NZ,EXTCMDL2
    4748/    17C4 :                     
    4749/    17C4 :                     		;
    4750/    17C4 :                     		; 06H : Command Status
    4751/    17C4 :                     		;
    4752/    17C4 : 3A F1 22            	LD	A,(EXTFDDRDFLAG)
    4753/    17C7 : 32 C5 22            	LD	(EXTFDDPARA),A
    4754/    17CA : C9                  	RET
    4755/    17CB :                     
    4756/    17CB :                     EXTCMDL2:
    4757/    17CB : FE 07               	CP	07H
    4758/    17CD : 20 15               	JR	NZ,EXTCMDL3
    4759/    17CF :                     
    4760/    17CF :                     		;
    4761/    17CF :                     		; 07H : Drive Status
    4762/    17CF :                     		;
    4763/    17CF : 3A DF 82            	LD	A,(REG_FDD3)	; drive #1
    4764/    17D2 : E6 01               	AND	01H
    4765/    17D4 : 87                  	ADD	A,A
    4766/    17D5 : 47                  	LD	B,A
    4767/    17D6 : 3A BF 82            	LD	A,(REG_FDD2)	; drive #0
    4768/    17D9 : E6 01               	AND	01H
    4769/    17DB : B0                  	OR	B
    4770/    17DC : 87                  	ADD	A,A
    4771/    17DD : 87                  	ADD	A,A
    4772/    17DE : 87                  	ADD	A,A
    4773/    17DF : 87                  	ADD	A,A
    4774/    17E0 : 32 C5 22            	LD	(EXTFDDPARA),A
    4775/    17E3 : C9                  	RET
    4776/    17E4 :                     
    4777/    17E4 :                     EXTCMDL3:
    4778/    17E4 : FE 08               	CP	08H
    4779/    17E6 : 20 06               	JR	NZ,EXTCMDL4
    4780/    17E8 :                     
    4781/    17E8 :                     		;
    4782/    17E8 :                     		; 08H : Test Memory
    4783/    17E8 :                     		;
    4784/    17E8 : 3E 80               	LD	A,80H
    4785/    17EA : 32 C5 22            	LD	(EXTFDDPARA),A
    4786/    17ED : C9                  	RET
    4787/    17EE :                     
    4788/    17EE :                     EXTCMDL4:
    4789/    17EE : FE 10               	CP	10H
    4790/    17F0 : 20 05               	JR	NZ,EXTCMDL5
    4791/    17F2 :                     
    4792/    17F2 :                     		;
    4793/    17F2 :                     		; 10H : Load and Go
    4794/    17F2 :                     		;
    4795/    17F2 : AF                  	XOR	A
    4796/    17F3 : 32 C1 22            	LD	(EXTFDDST),A
    4797/    17F6 : C9                  	RET
    4798/    17F7 :                     
    4799/    17F7 :                     EXTCMDL5:
    4800/    17F7 : C9                  	RET
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 81 - 2/18/2013 12:10:16


    4801/    17F8 :                     
    4802/    17F8 :                     EXTST30H:
    4803/    17F8 : FE 30               	CP	30H
    4804/    17FA : 20 1B               	JR	NZ,EXTST31H
    4805/    17FC :                     
    4806/    17FC :                     		;
    4807/    17FC :                     		; EXTFDDST:30H - 32H
    4808/    17FC :                     		; parameter receive phase
    4809/    17FC :                     		;
    4810/    17FC :                     
    4811/    17FC : 3A C3 22            	LD	A,(EXTFDDRLEN)
    4812/    17FF : FE 80               	CP	80H
    4813/    1801 : 28 55               	JR	Z,EXTST30DATA
    4814/    1803 : B7                  	OR	A
    4815/    1804 : 20 06               	JR	NZ,EXTST30L1
    4816/    1806 : 3E 40               	LD	A,40H
    4817/    1808 : 32 C1 22            	LD	(EXTFDDST),A
    4818/    180B : C9                  	RET
    4819/    180C :                     
    4820/    180C :                     EXTST30L1:
    4821/    180C : 3E 0B               	LD	A,0BH
    4822/    180E : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set RFD
    4823/    1811 : 3E 31               	LD	A,31H
    4824/    1813 : 32 C1 22            	LD	(EXTFDDST),A
    4825/    1816 : C9                  	RET
    4826/    1817 :                     
    4827/    1817 :                     
    4828/    1817 :                     EXTST31H:
    4829/    1817 : FE 31               	CP	31H
    4830/    1819 : 20 21               	JR	NZ,EXTST32H
    4831/    181B :                     
    4832/    181B :                     		;
    4833/    181B :                     		; wait DAV ON
    4834/    181B :                     		;
    4835/    181B : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4836/    181E : E6 01               	AND	01H			; wait DAV ON
    4837/    1820 : C8                  	RET	Z
    4838/    1821 : 3E 0A               	LD	A,0AH
    4839/    1823 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset RFD
    4840/    1826 : 3A F0 9F            	LD	A,(REG_EXTFDDDI)
    4841/    1829 : 2A CC 22            	LD	HL,(EXTFDDPTR)
    4842/    182C : 77                  	LD	(HL),A
    4843/    182D : 23                  	INC	HL
    4844/    182E : 22 CC 22            	LD	(EXTFDDPTR),HL
    4845/    1831 : 3E 0D               	LD	A,0DH
    4846/    1833 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set DAC
    4847/    1836 : 3E 32               	LD	A,32H
    4848/    1838 : 32 C1 22            	LD	(EXTFDDST),A
    4849/    183B : C9                  	RET
    4850/    183C :                     
    4851/    183C :                     EXTST32H:
    4852/    183C : FE 32               	CP	32H
    4853/    183E : 20 6C               	JR	NZ,EXTST40H
    4854/    1840 :                     
    4855/    1840 :                     		;
    4856/    1840 :                     		; wait DAV OFF
    4857/    1840 :                     		;
    4858/    1840 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4859/    1843 : E6 01               	AND	01H			; wait DAV OFF
    4860/    1845 : C0                  	RET	NZ
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 82 - 2/18/2013 12:10:16


    4861/    1846 : 3E 0C               	LD	A,0CH
    4862/    1848 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset DAC
    4863/    184B : 3A C3 22            	LD	A,(EXTFDDRLEN)
    4864/    184E : 3D                  	DEC	A
    4865/    184F : 32 C3 22            	LD	(EXTFDDRLEN),A
    4866/    1852 : 3E 30               	LD	A,30H
    4867/    1854 : 32 C1 22            	LD	(EXTFDDST),A
    4868/    1857 : C9                  	RET
    4869/    1858 :                     
    4870/    1858 :                     
    4871/    1858 :                     EXTST30DATA:
    4872/    1858 : 3A C2 22            	LD	A,(EXTFDDCMD)
    4873/    185B : FE 01               	CP	01H
    4874/    185D : 20 10               	JR	NZ,EXTST30DATA_L0
    4875/    185F :                     
    4876/    185F :                     		;
    4877/    185F :                     		; 01H : Write Disk
    4878/    185F :                     		;
    4879/    185F : 21 00 A0            	LD	HL,EXTWRBUF
    4880/    1862 : 22 CC 22            	LD	(EXTFDDPTR),HL
    4881/    1865 : 3A C5 22            	LD	A,(EXTFDDPARA)
    4882/    1868 : 47                  	LD	B,A
    4883/    1869 : 0E 00               	LD	C,00H
    4884/    186B : ED 43 CE 22         	LD	(EXTFDDDTLEN),BC
    4885/    186F :                     
    4886/    186F :                     EXTST30DATA_L0:
    4887/    186F : AF                  	XOR	A
    4888/    1870 : 32 C3 22            	LD	(EXTFDDRLEN),A
    4889/    1873 : 3E 40               	LD	A,40H
    4890/    1875 : 32 C1 22            	LD	(EXTFDDST),A
    4891/    1878 : ED 4B CE 22         	LD	BC,(EXTFDDDTLEN)
    4892/    187C : 2A CC 22            	LD	HL,(EXTFDDPTR)
    4893/    187F :                     EXTST30DATA_L1:
    4894/    187F : 78                  	LD	A,B
    4895/    1880 : B1                  	OR	C
    4896/    1881 : C8                  	RET	Z
    4897/    1882 :                     
    4898/    1882 : 3E 0B               	LD	A,0BH
    4899/    1884 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set RFD
    4900/    1887 :                     EXTST30DATA_L2:
    4901/    1887 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4902/    188A : E6 01               	AND	01H			; wait DAV ON
    4903/    188C : 28 F9               	JR	Z,EXTST30DATA_L2
    4904/    188E : 3E 0A               	LD	A,0AH
    4905/    1890 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset RFD
    4906/    1893 : 3A F0 9F            	LD	A,(REG_EXTFDDDI)
    4907/    1896 : 77                  	LD	(HL),A
    4908/    1897 : 23                  	INC	HL
    4909/    1898 : 3E 0D               	LD	A,0DH
    4910/    189A : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set DAC
    4911/    189D :                     EXTST30DATA_L3:
    4912/    189D : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4913/    18A0 : E6 01               	AND	01H			; wait DAV OFF
    4914/    18A2 : 20 F9               	JR	NZ,EXTST30DATA_L3
    4915/    18A4 : 3E 0C               	LD	A,0CH
    4916/    18A6 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset DAC
    4917/    18A9 : 0B                  	DEC	BC
    4918/    18AA : 18 D3               	JR	EXTST30DATA_L1
    4919/    18AC :                     
    4920/    18AC :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 83 - 2/18/2013 12:10:16


    4921/    18AC :                     EXTST40H:
    4922/    18AC : FE 40               	CP	40H
    4923/    18AE : 20 16               	JR	NZ,EXTST41H
    4924/    18B0 :                     
    4925/    18B0 :                     		;
    4926/    18B0 :                     		; EXTFDDST:40H - 43H
    4927/    18B0 :                     		; parameter send phase
    4928/    18B0 :                     		;
    4929/    18B0 :                     
    4930/    18B0 : 3A C4 22            	LD	A,(EXTFDDSLEN)
    4931/    18B3 : FE 80               	CP	80H
    4932/    18B5 : 28 5B               	JR	Z,EXTST40DATA
    4933/    18B7 : B7                  	OR	A
    4934/    18B8 : 20 06               	JR	NZ,EXTST40L1
    4935/    18BA :                     
    4936/    18BA :                     EXTST40LL2:
    4937/    18BA : 3E 50               	LD	A,50H
    4938/    18BC : 32 C1 22            	LD	(EXTFDDST),A
    4939/    18BF : C9                  	RET
    4940/    18C0 :                     
    4941/    18C0 :                     EXTST40L1:
    4942/    18C0 : 3E 41               	LD	A,41H
    4943/    18C2 : 32 C1 22            	LD	(EXTFDDST),A
    4944/    18C5 : C9                  	RET
    4945/    18C6 :                     
    4946/    18C6 :                     
    4947/    18C6 :                     
    4948/    18C6 :                     EXTST41H:
    4949/    18C6 : FE 41               	CP	41H
    4950/    18C8 : 20 1C               	JR	NZ,EXTST42H
    4951/    18CA :                     
    4952/    18CA :                     		;
    4953/    18CA :                     		; wait RFD ON
    4954/    18CA :                     		;
    4955/    18CA : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4956/    18CD : E6 02               	AND	02H			; wait RFD ON
    4957/    18CF : C8                  	RET	Z
    4958/    18D0 : 2A CC 22            	LD	HL,(EXTFDDPTR)
    4959/    18D3 : 7E                  	LD	A,(HL)
    4960/    18D4 : 32 F1 9F            	LD	(REG_EXTFDDDO),A
    4961/    18D7 : 23                  	INC	HL
    4962/    18D8 : 22 CC 22            	LD	(EXTFDDPTR),HL
    4963/    18DB : 3E 09               	LD	A,09H
    4964/    18DD : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set DAV
    4965/    18E0 : 3E 42               	LD	A,42H
    4966/    18E2 : 32 C1 22            	LD	(EXTFDDST),A
    4967/    18E5 : C9                  	RET
    4968/    18E6 :                     
    4969/    18E6 :                     EXTST42H:
    4970/    18E6 : FE 42               	CP	42H
    4971/    18E8 : 20 11               	JR	NZ,EXTST43H
    4972/    18EA :                     
    4973/    18EA :                     		;
    4974/    18EA :                     		; wait DAC ON
    4975/    18EA :                     		;
    4976/    18EA : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4977/    18ED : E6 04               	AND	04H			; wait DAC ON
    4978/    18EF : C8                  	RET	Z
    4979/    18F0 : 3E 08               	LD	A,08H
    4980/    18F2 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset DAV
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 84 - 2/18/2013 12:10:16


    4981/    18F5 : 3E 43               	LD	A,43H
    4982/    18F7 : 32 C1 22            	LD	(EXTFDDST),A
    4983/    18FA : C9                  	RET
    4984/    18FB :                     
    4985/    18FB :                     EXTST43H:
    4986/    18FB : FE 43               	CP	43H
    4987/    18FD : 20 4D               	JR	NZ,EXTST50H
    4988/    18FF :                     
    4989/    18FF :                     		;
    4990/    18FF :                     		; wait DAC OFF
    4991/    18FF :                     		;
    4992/    18FF : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    4993/    1902 : E6 04               	AND	04H			; wait DAC OFF
    4994/    1904 : C0                  	RET	NZ
    4995/    1905 : 3A C4 22            	LD	A,(EXTFDDSLEN)
    4996/    1908 : 3D                  	DEC	A
    4997/    1909 : 32 C4 22            	LD	(EXTFDDSLEN),A
    4998/    190C : 3E 40               	LD	A,40H
    4999/    190E : 32 C1 22            	LD	(EXTFDDST),A
    5000/    1911 : C9                  	RET
    5001/    1912 :                     
    5002/    1912 :                     
    5003/    1912 :                     EXTST40DATA:
    5004/    1912 : AF                  	XOR	A
    5005/    1913 : 32 C4 22            	LD	(EXTFDDSLEN),A
    5006/    1916 : 3E 50               	LD	A,50H
    5007/    1918 : 32 C1 22            	LD	(EXTFDDST),A
    5008/    191B : ED 4B CE 22         	LD	BC,(EXTFDDDTLEN)
    5009/    191F : 2A CC 22            	LD	HL,(EXTFDDPTR)
    5010/    1922 :                     EXTST40DATA_L1:
    5011/    1922 : 78                  	LD	A,B
    5012/    1923 : B1                  	OR	C
    5013/    1924 : C8                  	RET	Z
    5014/    1925 :                     
    5015/    1925 :                     EXTST40DATA_L2:
    5016/    1925 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    5017/    1928 : E6 02               	AND	02H			; wait RFD ON
    5018/    192A : 28 F9               	JR	Z,EXTST40DATA_L2
    5019/    192C : 7E                  	LD	A,(HL)
    5020/    192D : 32 F1 9F            	LD	(REG_EXTFDDDO),A
    5021/    1930 : 23                  	INC	HL
    5022/    1931 : 3E 09               	LD	A,09H
    5023/    1933 : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; set DAV
    5024/    1936 :                     EXTST40DATA_L3:
    5025/    1936 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    5026/    1939 : E6 04               	AND	04H			; wait DAC ON
    5027/    193B : 28 F9               	JR	Z,EXTST40DATA_L3
    5028/    193D : 3E 08               	LD	A,08H
    5029/    193F : 32 F3 9F            	LD	(REG_EXTFDDCNT),A	; reset DAV
    5030/    1942 :                     EXTST40DATA_L4:
    5031/    1942 : 3A F2 9F            	LD	A,(REG_EXTFDDCIO)
    5032/    1945 : E6 04               	AND	04H			; wait DAC OFF
    5033/    1947 : 20 F9               	JR	NZ,EXTST40DATA_L4
    5034/    1949 : 0B                  	DEC	BC
    5035/    194A : 18 D6               	JR	EXTST40DATA_L1
    5036/    194C :                     
    5037/    194C :                     
    5038/    194C :                     
    5039/    194C :                     EXTST50H:
    5040/    194C : FE 50               	CP	50H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 85 - 2/18/2013 12:10:16


    5041/    194E : C0                  	RET	NZ
    5042/    194F :                     
    5043/    194F :                     		;
    5044/    194F :                     		; EXTFDDST:50H
    5045/    194F :                     		; command execute
    5046/    194F :                     		;
    5047/    194F : 2A F2 22            	LD	HL,(EXTFDDSUBAD)
    5048/    1952 : 7C                  	LD	A,H
    5049/    1953 : B5                  	OR	L
    5050/    1954 : 20 05               	JR	NZ,EXTST50L1
    5051/    1956 :                     
    5052/    1956 : AF                  	XOR	A
    5053/    1957 : 32 C1 22            	LD	(EXTFDDST),A
    5054/    195A : C9                  	RET
    5055/    195B :                     
    5056/    195B :                     EXTST50L1:
    5057/    195B : E9                  	JP	(HL)
    5058/    195C :                     
    5059/    195C :                     
    5060/    195C :                     ;
    5061/    195C :                     ; external FDC output data
    5062/    195C :                     ; B <= output data
    5063/    195C :                     ;
    5064/    195C :                     EXTFDCDTIN:
    5065/    195C :                     
    5066/    195C :                     		;
    5067/    195C :                     		; wait RQM(b7)=1 DIO(b6)=1
    5068/    195C :                     		;
    5069/    195C : 3A F4 9F            	LD	A,(REG_EXTFDCMAIN)
    5070/    195F : EE C0               	XOR	0C0H
    5071/    1961 : E6 C0               	AND	0C0H
    5072/    1963 : C0                  	RET	NZ
    5073/    1964 : 2A FC 22            	LD	HL,(EXTFDCRSTPTR)
    5074/    1967 : 3A F5 9F            	LD	A,(REG_EXTFDCDATA)
    5075/    196A : 77                  	LD	(HL),A
    5076/    196B : 23                  	INC	HL
    5077/    196C : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5078/    196F : 21 F4 22            	LD	HL,EXTFDDSUBST
    5079/    1972 : 34                  	INC	(HL)
    5080/    1973 : C9                  	RET
    5081/    1974 :                     
    5082/    1974 :                     ;
    5083/    1974 :                     ; external FDC output data
    5084/    1974 :                     ; B <= output data
    5085/    1974 :                     ;
    5086/    1974 :                     EXTFDCDTOUT:
    5087/    1974 :                     
    5088/    1974 :                     		;
    5089/    1974 :                     		; wait RQM(b7)=1 DIO(b6)=0
    5090/    1974 :                     		;
    5091/    1974 : 3A F4 9F            	LD	A,(REG_EXTFDCMAIN)
    5092/    1977 : EE 80               	XOR	80H
    5093/    1979 : E6 C0               	AND	0C0H
    5094/    197B : C0                  	RET	NZ
    5095/    197C : 78                  	LD	A,B
    5096/    197D : 32 F5 9F            	LD	(REG_EXTFDCDATA),A
    5097/    1980 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5098/    1983 : 34                  	INC	(HL)
    5099/    1984 : C9                  	RET
    5100/    1985 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 86 - 2/18/2013 12:10:16


    5101/    1985 :                     ;
    5102/    1985 :                     ; external FDC FDINT wait
    5103/    1985 :                     ;
    5104/    1985 :                     EXTFDCFDINTWAIT:
    5105/    1985 :                     
    5106/    1985 :                     		;
    5107/    1985 :                     		; wait FDINT
    5108/    1985 :                     		;
    5109/    1985 : 3A 70 83            	LD	A,(REG_FDINT)
    5110/    1988 : B7                  	OR	A
    5111/    1989 : C8                  	RET	Z
    5112/    198A : 21 F4 22            	LD	HL,EXTFDDSUBST
    5113/    198D : 34                  	INC	(HL)
    5114/    198E : C9                  	RET
    5115/    198F :                     
    5116/    198F :                     ;
    5117/    198F :                     ; external FDC bust wait
    5118/    198F :                     ;
    5119/    198F :                     EXTFDCBUSYWAIT:
    5120/    198F :                     
    5121/    198F :                     		;
    5122/    198F :                     		; wait FDC no busy(b4) = 0
    5123/    198F :                     		; wait FDD no busy(b3-0) = 0000
    5124/    198F :                     		;
    5125/    198F : 3A F4 9F            	LD	A,(REG_EXTFDCMAIN)
    5126/    1992 : E6 1F               	AND	1FH
    5127/    1994 : C0                  	RET	NZ
    5128/    1995 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5129/    1998 : 34                  	INC	(HL)
    5130/    1999 : C9                  	RET
    5131/    199A :                     
    5132/    199A :                     
    5133/    199A :                     ;
    5134/    199A :                     ; external FDD intialize process
    5135/    199A :                     ; (command 00H)
    5136/    199A :                     ;
    5137/    199A :                     EXTCMD00:
    5138/    199A : 3A F4 22            	LD	A,(EXTFDDSUBST)
    5139/    199D : B7                  	OR	A
    5140/    199E : 20 13               	JR	NZ,EXTCMD00_01H
    5141/    19A0 :                     
    5142/    19A0 :                     		;
    5143/    19A0 :                     		; external FDD initialize
    5144/    19A0 :                     		;
    5145/    19A0 : 3E 80               	LD	A,80H
    5146/    19A2 : 32 F1 22            	LD	(EXTFDDRDFLAG),A
    5147/    19A5 : 3E 03               	LD	A,03H
    5148/    19A7 : 32 41 83            	LD	(REG_EXTFDD+FDD_DMASIZE),A
    5149/    19AA :                     
    5150/    19AA :                     		; recalibrate#0-0 (FDD#0)
    5151/    19AA : 21 F5 22            	LD	HL,EXTFDCRST
    5152/    19AD : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5153/    19B0 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5154/    19B3 :                     
    5155/    19B3 :                     EXTCMD00_01H:
    5156/    19B3 : 3D                  	DEC	A
    5157/    19B4 : 20 05               	JR	NZ,EXTCMD00_02H
    5158/    19B6 :                     
    5159/    19B6 :                     		; recalibrate#0-1 (FDD#0)
    5160/    19B6 : 06 07               	LD	B,CMD_RECALB
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 87 - 2/18/2013 12:10:16


    5161/    19B8 : C3 74 19            	JP	EXTFDCDTOUT
    5162/    19BB :                     
    5163/    19BB :                     EXTCMD00_02H:
    5164/    19BB : 3D                  	DEC	A
    5165/    19BC : 20 05               	JR	NZ,EXTCMD00_03H
    5166/    19BE :                     
    5167/    19BE :                     		; recalibrate#0-2 (FDD#0)
    5168/    19BE : 06 00               	LD	B,00H
    5169/    19C0 : C3 74 19            	JP	EXTFDCDTOUT
    5170/    19C3 :                     
    5171/    19C3 :                     EXTCMD00_03H:
    5172/    19C3 : 3D                  	DEC	A
    5173/    19C4 : 20 03               	JR	NZ,EXTCMD00_04H
    5174/    19C6 :                     
    5175/    19C6 :                     		; recalibrate#0-3 (FDD#0)
    5176/    19C6 : C3 85 19            	JP	EXTFDCFDINTWAIT
    5177/    19C9 :                     
    5178/    19C9 :                     EXTCMD00_04H:
    5179/    19C9 : 3D                  	DEC	A
    5180/    19CA : 20 03               	JR	NZ,EXTCMD00_05H
    5181/    19CC :                     
    5182/    19CC :                     		; recalibrate#0-4 (FDD#0)
    5183/    19CC : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5184/    19CF :                     
    5185/    19CF :                     EXTCMD00_05H:
    5186/    19CF : 3D                  	DEC	A
    5187/    19D0 : 20 05               	JR	NZ,EXTCMD00_06H
    5188/    19D2 :                     
    5189/    19D2 :                     		; sense inttrupt status#0-5 (FDD#0)
    5190/    19D2 : 06 08               	LD	B,CMD_SENSEINTST
    5191/    19D4 : C3 74 19            	JP	EXTFDCDTOUT
    5192/    19D7 :                     
    5193/    19D7 :                     EXTCMD00_06H:
    5194/    19D7 : 3D                  	DEC	A
    5195/    19D8 : 20 03               	JR	NZ,EXTCMD00_07H
    5196/    19DA :                     
    5197/    19DA :                     		; read data result #0-6 (ST0)
    5198/    19DA : C3 5C 19            	JP	EXTFDCDTIN
    5199/    19DD :                     
    5200/    19DD :                     EXTCMD00_07H:
    5201/    19DD : 3D                  	DEC	A
    5202/    19DE : 20 03               	JR	NZ,EXTCMD00_08H
    5203/    19E0 :                     
    5204/    19E0 :                     		; read data result #0-7 (PCN)
    5205/    19E0 : C3 5C 19            	JP	EXTFDCDTIN
    5206/    19E3 :                     
    5207/    19E3 :                     EXTCMD00_08H:
    5208/    19E3 : 3D                  	DEC	A
    5209/    19E4 : 20 09               	JR	NZ,EXTCMD00_09H
    5210/    19E6 :                     
    5211/    19E6 :                     		; recalibrate#1-0 (FDD#0)
    5212/    19E6 : 21 F5 22            	LD	HL,EXTFDCRST
    5213/    19E9 : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5214/    19EC : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5215/    19EF :                     
    5216/    19EF :                     EXTCMD00_09H:
    5217/    19EF : 3D                  	DEC	A
    5218/    19F0 : 20 05               	JR	NZ,EXTCMD00_0AH
    5219/    19F2 :                     
    5220/    19F2 :                     		; recalibrate#1-1 (FDD#0)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 88 - 2/18/2013 12:10:16


    5221/    19F2 : 06 07               	LD	B,CMD_RECALB
    5222/    19F4 : C3 74 19            	JP	EXTFDCDTOUT
    5223/    19F7 :                     
    5224/    19F7 :                     EXTCMD00_0AH:
    5225/    19F7 : 3D                  	DEC	A
    5226/    19F8 : 20 05               	JR	NZ,EXTCMD00_0BH
    5227/    19FA :                     
    5228/    19FA :                     		; recalibrate#1-2 (FDD#0)
    5229/    19FA : 06 00               	LD	B,00H
    5230/    19FC : C3 74 19            	JP	EXTFDCDTOUT
    5231/    19FF :                     
    5232/    19FF :                     EXTCMD00_0BH:
    5233/    19FF : 3D                  	DEC	A
    5234/    1A00 : 20 03               	JR	NZ,EXTCMD00_0CH
    5235/    1A02 :                     
    5236/    1A02 :                     		; recalibrate#1-3 (FDD#0)
    5237/    1A02 : C3 85 19            	JP	EXTFDCFDINTWAIT
    5238/    1A05 :                     
    5239/    1A05 :                     EXTCMD00_0CH:
    5240/    1A05 : 3D                  	DEC	A
    5241/    1A06 : 20 03               	JR	NZ,EXTCMD00_0DH
    5242/    1A08 :                     
    5243/    1A08 :                     		; recalibrate#1-4 (FDD#0)
    5244/    1A08 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5245/    1A0B :                     
    5246/    1A0B :                     EXTCMD00_0DH:
    5247/    1A0B : 3D                  	DEC	A
    5248/    1A0C : 20 05               	JR	NZ,EXTCMD00_0EH
    5249/    1A0E :                     
    5250/    1A0E :                     		; sense interrupt status#1-5 (FDD#0)
    5251/    1A0E : 06 08               	LD	B,CMD_SENSEINTST
    5252/    1A10 : C3 74 19            	JP	EXTFDCDTOUT
    5253/    1A13 :                     
    5254/    1A13 :                     EXTCMD00_0EH:
    5255/    1A13 : 3D                  	DEC	A
    5256/    1A14 : 20 03               	JR	NZ,EXTCMD00_0FH
    5257/    1A16 :                     
    5258/    1A16 :                     		; sense interrupt status#1-6 (ST0)
    5259/    1A16 : C3 5C 19            	JP	EXTFDCDTIN
    5260/    1A19 :                     
    5261/    1A19 :                     EXTCMD00_0FH:
    5262/    1A19 : 3D                  	DEC	A
    5263/    1A1A : 20 03               	JR	NZ,EXTCMD00_10H
    5264/    1A1C :                     
    5265/    1A1C :                     		; sense interrupt status#1-7 (PCN)
    5266/    1A1C : C3 5C 19            	JP	EXTFDCDTIN
    5267/    1A1F :                     
    5268/    1A1F :                     EXTCMD00_10H:
    5269/    1A1F : 3D                  	DEC	A
    5270/    1A20 : 20 09               	JR	NZ,EXTCMD00_11H
    5271/    1A22 :                     
    5272/    1A22 :                     		; recalibrate#0-0 (FDD#1)
    5273/    1A22 : 21 F5 22            	LD	HL,EXTFDCRST
    5274/    1A25 : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5275/    1A28 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5276/    1A2B :                     
    5277/    1A2B :                     EXTCMD00_11H:
    5278/    1A2B : 3D                  	DEC	A
    5279/    1A2C : 20 05               	JR	NZ,EXTCMD00_12H
    5280/    1A2E :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 89 - 2/18/2013 12:10:16


    5281/    1A2E :                     		; recalibrate#0-1 (FDD#1)
    5282/    1A2E : 06 07               	LD	B,CMD_RECALB
    5283/    1A30 : C3 74 19            	JP	EXTFDCDTOUT
    5284/    1A33 :                     
    5285/    1A33 :                     EXTCMD00_12H:
    5286/    1A33 : 3D                  	DEC	A
    5287/    1A34 : 20 05               	JR	NZ,EXTCMD00_13H
    5288/    1A36 :                     
    5289/    1A36 :                     		; recalibrate#0-2 (FDD#1)
    5290/    1A36 : 06 00               	LD	B,00H
    5291/    1A38 : C3 74 19            	JP	EXTFDCDTOUT
    5292/    1A3B :                     
    5293/    1A3B :                     EXTCMD00_13H:
    5294/    1A3B : 3D                  	DEC	A
    5295/    1A3C : 20 03               	JR	NZ,EXTCMD00_14H
    5296/    1A3E :                     
    5297/    1A3E :                     		; recalibrate#0-3 (FDD#1)
    5298/    1A3E : C3 85 19            	JP	EXTFDCFDINTWAIT
    5299/    1A41 :                     
    5300/    1A41 :                     EXTCMD00_14H:
    5301/    1A41 : 3D                  	DEC	A
    5302/    1A42 : 20 03               	JR	NZ,EXTCMD00_15H
    5303/    1A44 :                     
    5304/    1A44 :                     		; recalibrate#0-4 (FDD#1)
    5305/    1A44 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5306/    1A47 :                     
    5307/    1A47 :                     EXTCMD00_15H:
    5308/    1A47 : 3D                  	DEC	A
    5309/    1A48 : 20 05               	JR	NZ,EXTCMD00_16H
    5310/    1A4A :                     
    5311/    1A4A :                     		; sense interrupt status#0-5 (FDD#1)
    5312/    1A4A : 06 08               	LD	B,CMD_SENSEINTST
    5313/    1A4C : C3 74 19            	JP	EXTFDCDTOUT
    5314/    1A4F :                     
    5315/    1A4F :                     EXTCMD00_16H:
    5316/    1A4F : 3D                  	DEC	A
    5317/    1A50 : 20 03               	JR	NZ,EXTCMD00_17H
    5318/    1A52 :                     
    5319/    1A52 :                     		; sense interrupt status#0-6 (ST0)
    5320/    1A52 : C3 5C 19            	JP	EXTFDCDTIN
    5321/    1A55 :                     
    5322/    1A55 :                     EXTCMD00_17H:
    5323/    1A55 : 3D                  	DEC	A
    5324/    1A56 : 20 03               	JR	NZ,EXTCMD00_18H
    5325/    1A58 :                     
    5326/    1A58 :                     		; sense interrupt status#0-7 (PCN)
    5327/    1A58 : C3 5C 19            	JP	EXTFDCDTIN
    5328/    1A5B :                     
    5329/    1A5B :                     EXTCMD00_18H:
    5330/    1A5B : 3D                  	DEC	A
    5331/    1A5C : 20 09               	JR	NZ,EXTCMD00_19H
    5332/    1A5E :                     
    5333/    1A5E :                     		; recalibrate#1-0 (FDD#1)
    5334/    1A5E : 21 F5 22            	LD	HL,EXTFDCRST
    5335/    1A61 : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5336/    1A64 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5337/    1A67 :                     
    5338/    1A67 :                     EXTCMD00_19H:
    5339/    1A67 : 3D                  	DEC	A
    5340/    1A68 : 20 05               	JR	NZ,EXTCMD00_1AH
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 90 - 2/18/2013 12:10:16


    5341/    1A6A :                     
    5342/    1A6A :                     		; recalibrate#1-1 (FDD#1)
    5343/    1A6A : 06 07               	LD	B,CMD_RECALB
    5344/    1A6C : C3 74 19            	JP	EXTFDCDTOUT
    5345/    1A6F :                     
    5346/    1A6F :                     EXTCMD00_1AH:
    5347/    1A6F : 3D                  	DEC	A
    5348/    1A70 : 20 05               	JR	NZ,EXTCMD00_1BH
    5349/    1A72 :                     
    5350/    1A72 :                     		; recalibrate#1-2 (FDD#1)
    5351/    1A72 : 06 00               	LD	B,00H
    5352/    1A74 : C3 74 19            	JP	EXTFDCDTOUT
    5353/    1A77 :                     
    5354/    1A77 :                     EXTCMD00_1BH:
    5355/    1A77 : 3D                  	DEC	A
    5356/    1A78 : 20 03               	JR	NZ,EXTCMD00_1CH
    5357/    1A7A :                     
    5358/    1A7A :                     		; recalibrate#1-3 (FDD#1)
    5359/    1A7A : C3 85 19            	JP	EXTFDCFDINTWAIT
    5360/    1A7D :                     
    5361/    1A7D :                     EXTCMD00_1CH:
    5362/    1A7D : 3D                  	DEC	A
    5363/    1A7E : 20 03               	JR	NZ,EXTCMD00_1DH
    5364/    1A80 :                     
    5365/    1A80 :                     		; recalibrate#1-4 (FDD#1)
    5366/    1A80 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5367/    1A83 :                     
    5368/    1A83 :                     EXTCMD00_1DH:
    5369/    1A83 : 3D                  	DEC	A
    5370/    1A84 : 20 05               	JR	NZ,EXTCMD00_1EH
    5371/    1A86 :                     
    5372/    1A86 :                     		; sense interrupt status#1-5 (FDD#1)
    5373/    1A86 : 06 08               	LD	B,CMD_SENSEINTST
    5374/    1A88 : C3 74 19            	JP	EXTFDCDTOUT
    5375/    1A8B :                     
    5376/    1A8B :                     EXTCMD00_1EH:
    5377/    1A8B : 3D                  	DEC	A
    5378/    1A8C : 20 03               	JR	NZ,EXTCMD00_1FH
    5379/    1A8E :                     
    5380/    1A8E :                     		; sense interrupt status#1-6 (ST0)
    5381/    1A8E : C3 5C 19            	JP	EXTFDCDTIN
    5382/    1A91 :                     
    5383/    1A91 :                     EXTCMD00_1FH:
    5384/    1A91 : 3D                  	DEC	A
    5385/    1A92 : 20 03               	JR	NZ,EXTCMD00_20H
    5386/    1A94 :                     
    5387/    1A94 :                     		; sense interrupt status#1-7 (PCN)
    5388/    1A94 : C3 5C 19            	JP	EXTFDCDTIN
    5389/    1A97 :                     
    5390/    1A97 :                     EXTCMD00_20H:
    5391/    1A97 :                     
    5392/    1A97 : AF                  	XOR	A
    5393/    1A98 : 32 C1 22            	LD	(EXTFDDST),A
    5394/    1A9B : C9                  	RET
    5395/    1A9C :                     
    5396/    1A9C :                     ;
    5397/    1A9C :                     ; external FDD write disk process
    5398/    1A9C :                     ; (command 01H)
    5399/    1A9C :                     ; external FDD read disk process
    5400/    1A9C :                     ; (command 02H)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 91 - 2/18/2013 12:10:16


    5401/    1A9C :                     ;
    5402/    1A9C :                     EXTCMD02:
    5403/    1A9C : 3A F4 22            	LD	A,(EXTFDDSUBST)
    5404/    1A9F : B7                  	OR	A
    5405/    1AA0 : 20 09               	JR	NZ,EXTCMD02_01H
    5406/    1AA2 :                     
    5407/    1AA2 :                     		; seek #0 (wait FDC no busy)
    5408/    1AA2 : 21 F5 22            	LD	HL,EXTFDCRST
    5409/    1AA5 : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5410/    1AA8 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5411/    1AAB :                     
    5412/    1AAB :                     EXTCMD02_01H:
    5413/    1AAB : 3D                  	DEC	A
    5414/    1AAC : 20 05               	JR	NZ,EXTCMD02_02H
    5415/    1AAE :                     
    5416/    1AAE :                     		; seek #1 (command)
    5417/    1AAE : 06 0F               	LD	B,CMD_SEEK
    5418/    1AB0 : C3 74 19            	JP	EXTFDCDTOUT
    5419/    1AB3 :                     
    5420/    1AB3 :                     EXTCMD02_02H:
    5421/    1AB3 : 3D                  	DEC	A
    5422/    1AB4 : 20 09               	JR	NZ,EXTCMD02_03H
    5423/    1AB6 :                     
    5424/    1AB6 :                     		; seek #2 (hd/us)
    5425/    1AB6 : 3A C6 22            	LD	A,(EXTFDDPARA+1)
    5426/    1AB9 : E6 01               	AND	01H
    5427/    1ABB : 47                  	LD	B,A
    5428/    1ABC : C3 74 19            	JP	EXTFDCDTOUT
    5429/    1ABF :                     
    5430/    1ABF :                     EXTCMD02_03H:
    5431/    1ABF : 3D                  	DEC	A
    5432/    1AC0 : 20 07               	JR	NZ,EXTCMD02_04H
    5433/    1AC2 :                     
    5434/    1AC2 :                     		; seek #3 (NCN)
    5435/    1AC2 :                     		; 1D only
    5436/    1AC2 : 3A C7 22            	LD	A,(EXTFDDPARA+2)
    5437/    1AC5 : 47                  	LD	B,A
    5438/    1AC6 : C3 74 19            	JP	EXTFDCDTOUT
    5439/    1AC9 :                     
    5440/    1AC9 :                     EXTCMD02_04H:
    5441/    1AC9 : 3D                  	DEC	A
    5442/    1ACA : 20 03               	JR	NZ,EXTCMD02_05H
    5443/    1ACC :                     
    5444/    1ACC :                     		; seek #4 (FDINT wait)
    5445/    1ACC : C3 85 19            	JP	EXTFDCFDINTWAIT
    5446/    1ACF :                     
    5447/    1ACF :                     EXTCMD02_05H:
    5448/    1ACF : 3D                  	DEC	A
    5449/    1AD0 : 20 03               	JR	NZ,EXTCMD02_06H
    5450/    1AD2 :                     
    5451/    1AD2 :                     		; seek #5 (FDC no busy wait)
    5452/    1AD2 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5453/    1AD5 :                     
    5454/    1AD5 :                     EXTCMD02_06H:
    5455/    1AD5 : 3D                  	DEC	A
    5456/    1AD6 : 20 05               	JR	NZ,EXTCMD02_07H
    5457/    1AD8 :                     
    5458/    1AD8 :                     		; sense interrupt status#0
    5459/    1AD8 : 06 08               	LD	B,CMD_SENSEINTST
    5460/    1ADA : C3 74 19            	JP	EXTFDCDTOUT
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 92 - 2/18/2013 12:10:16


    5461/    1ADD :                     
    5462/    1ADD :                     EXTCMD02_07H:
    5463/    1ADD : 3D                  	DEC	A
    5464/    1ADE : 20 03               	JR	NZ,EXTCMD02_08H
    5465/    1AE0 :                     
    5466/    1AE0 :                     		; sense interrupt status#1 (ST0)
    5467/    1AE0 : C3 5C 19            	JP	EXTFDCDTIN
    5468/    1AE3 :                     
    5469/    1AE3 :                     EXTCMD02_08H:
    5470/    1AE3 : 3D                  	DEC	A
    5471/    1AE4 : 20 03               	JR	NZ,EXTCMD02_09H
    5472/    1AE6 :                     
    5473/    1AE6 :                     		; sense interrupt status#2 (PCN)
    5474/    1AE6 : C3 5C 19            	JP	EXTFDCDTIN
    5475/    1AE9 :                     
    5476/    1AE9 :                     EXTCMD02_09H:
    5477/    1AE9 : 3D                  	DEC	A
    5478/    1AEA : 20 29               	JR	NZ,EXTCMD02_0AH
    5479/    1AEC :                     
    5480/    1AEC : 0E 80               	LD	C,80H
    5481/    1AEE : 3A C6 22            	LD	A,(EXTFDDPARA+1)	; drive number
    5482/    1AF1 : E6 01               	AND	01H
    5483/    1AF3 : 47                  	LD	B,A
    5484/    1AF4 : 21 F5 22            	LD	HL,EXTFDCRST
    5485/    1AF7 : 7E                  	LD	A,(HL)			; ST0
    5486/    1AF8 : E6 DF               	AND	0DFH
    5487/    1AFA : A8                  	XOR	B
    5488/    1AFB : 23                  	INC	HL
    5489/    1AFC : 46                  	LD	B,(HL)			; PCN
    5490/    1AFD : A8                  	XOR	B
    5491/    1AFE : 47                  	LD	B,A
    5492/    1AFF : 3A C7 22            	LD	A,(EXTFDDPARA+2)	; track number
    5493/    1B02 : A8                  	XOR	B
    5494/    1B03 : 28 0B               	JR	Z,EXTCMD02_SIL1
    5495/    1B05 : 0E 81               	LD	C,81H
    5496/    1B07 : 79                  	LD	A,C
    5497/    1B08 : 32 F1 22            	LD	(EXTFDDRDFLAG),A
    5498/    1B0B : AF                  	XOR	A
    5499/    1B0C : 32 C1 22            	LD	(EXTFDDST),A
    5500/    1B0F : C9                  	RET
    5501/    1B10 :                     
    5502/    1B10 :                     EXTCMD02_SIL1:
    5503/    1B10 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5504/    1B13 : 34                  	INC	(HL)
    5505/    1B14 : C9                  	RET
    5506/    1B15 :                     
    5507/    1B15 :                     
    5508/    1B15 :                     EXTCMD02_0AH:
    5509/    1B15 : 3D                  	DEC	A
    5510/    1B16 : 20 09               	JR	NZ,EXTCMD02_0BH
    5511/    1B18 :                     
    5512/    1B18 :                     		; read/write data #0 (wait FDC no busy)
    5513/    1B18 : 21 F5 22            	LD	HL,EXTFDCRST
    5514/    1B1B : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5515/    1B1E : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5516/    1B21 :                     
    5517/    1B21 :                     EXTCMD02_0BH:
    5518/    1B21 : 3D                  	DEC	A
    5519/    1B22 : 20 0F               	JR	NZ,EXTCMD02_0CH
    5520/    1B24 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 93 - 2/18/2013 12:10:16


    5521/    1B24 :                     		; read/write data #1 (command)
    5522/    1B24 : 06 46               	LD	B,CMD_MFMRDDATA
    5523/    1B26 : 3A C2 22            	LD	A,(EXTFDDCMD)
    5524/    1B29 : FE 02               	CP	02H
    5525/    1B2B : CA 74 19            	JP	Z,EXTFDCDTOUT
    5526/    1B2E :                     
    5527/    1B2E : 06 45               	LD	B,CMD_MFMWRDATA
    5528/    1B30 : C3 74 19            	JP	EXTFDCDTOUT
    5529/    1B33 :                     
    5530/    1B33 :                     EXTCMD02_0CH:
    5531/    1B33 : 3D                  	DEC	A
    5532/    1B34 : 20 09               	JR	NZ,EXTCMD02_0DH
    5533/    1B36 :                     
    5534/    1B36 :                     		; read/write data #2 (hd/us)
    5535/    1B36 :                     		; 1D only
    5536/    1B36 : 3A C6 22            	LD	A,(EXTFDDPARA+1)
    5537/    1B39 : E6 01               	AND	01H
    5538/    1B3B : 47                  	LD	B,A
    5539/    1B3C : C3 74 19            	JP	EXTFDCDTOUT
    5540/    1B3F :                     
    5541/    1B3F :                     EXTCMD02_0DH:
    5542/    1B3F : 3D                  	DEC	A
    5543/    1B40 : 20 07               	JR	NZ,EXTCMD02_0EH
    5544/    1B42 :                     
    5545/    1B42 :                     		; read/write data #3 (C)
    5546/    1B42 : 3A C7 22            	LD	A,(EXTFDDPARA+2)
    5547/    1B45 : 47                  	LD	B,A
    5548/    1B46 : C3 74 19            	JP	EXTFDCDTOUT
    5549/    1B49 :                     
    5550/    1B49 :                     EXTCMD02_0EH:
    5551/    1B49 : 3D                  	DEC	A
    5552/    1B4A : 20 05               	JR	NZ,EXTCMD02_0FH
    5553/    1B4C :                     
    5554/    1B4C :                     		; read/write data #4 (H)
    5555/    1B4C : 06 00               	LD	B,00H
    5556/    1B4E : C3 74 19            	JP	EXTFDCDTOUT
    5557/    1B51 :                     
    5558/    1B51 :                     EXTCMD02_0FH:
    5559/    1B51 : 3D                  	DEC	A
    5560/    1B52 : 20 07               	JR	NZ,EXTCMD02_10H
    5561/    1B54 :                     
    5562/    1B54 :                     		; read/write data #5 (R)
    5563/    1B54 : 3A C8 22            	LD	A,(EXTFDDPARA+3)
    5564/    1B57 : 47                  	LD	B,A
    5565/    1B58 : C3 74 19            	JP	EXTFDCDTOUT
    5566/    1B5B :                     
    5567/    1B5B :                     EXTCMD02_10H:
    5568/    1B5B : 3D                  	DEC	A
    5569/    1B5C : 20 05               	JR	NZ,EXTCMD02_11H
    5570/    1B5E :                     
    5571/    1B5E :                     		; read/write data #6 (N)
    5572/    1B5E : 06 01               	LD	B,01H
    5573/    1B60 : C3 74 19            	JP	EXTFDCDTOUT
    5574/    1B63 :                     
    5575/    1B63 :                     EXTCMD02_11H:
    5576/    1B63 : 3D                  	DEC	A
    5577/    1B64 : 20 05               	JR	NZ,EXTCMD02_12H
    5578/    1B66 :                     
    5579/    1B66 :                     		; read/write data #7 (EOT)
    5580/    1B66 : 06 10               	LD	B,10H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 94 - 2/18/2013 12:10:16


    5581/    1B68 : C3 74 19            	JP	EXTFDCDTOUT
    5582/    1B6B :                     
    5583/    1B6B :                     EXTCMD02_12H:
    5584/    1B6B : 3D                  	DEC	A
    5585/    1B6C : 20 05               	JR	NZ,EXTCMD02_13H
    5586/    1B6E :                     
    5587/    1B6E :                     		; read/write data #8 (GOL)
    5588/    1B6E : 06 14               	LD	B,14H
    5589/    1B70 : C3 74 19            	JP	EXTFDCDTOUT
    5590/    1B73 :                     
    5591/    1B73 :                     EXTCMD02_13H:
    5592/    1B73 : 3D                  	DEC	A
    5593/    1B74 : 20 05               	JR	NZ,EXTCMD02_14H
    5594/    1B76 :                     
    5595/    1B76 :                     		; read/write data #9 (DTL)
    5596/    1B76 : 06 FF               	LD	B,0FFH
    5597/    1B78 : C3 74 19            	JP	EXTFDCDTOUT
    5598/    1B7B :                     
    5599/    1B7B :                     EXTCMD02_14H:
    5600/    1B7B : 3D                  	DEC	A
    5601/    1B7C : 20 1E               	JR	NZ,EXTCMD02_15H
    5602/    1B7E :                     
    5603/    1B7E :                     		; DMA #0 (DMA on)
    5604/    1B7E : 3A C5 22            	LD	A,(EXTFDDPARA)
    5605/    1B81 : 47                  	LD	B,A
    5606/    1B82 : 3E 0F               	LD	A,0FH
    5607/    1B84 : 90                  	SUB	B
    5608/    1B85 : 32 41 83            	LD	(REG_EXTFDD+FDD_DMASIZE),A
    5609/    1B88 :                     
    5610/    1B88 : 06 02               	LD	B,02H
    5611/    1B8A : 3A C2 22            	LD	A,(EXTFDDCMD)
    5612/    1B8D : FE 02               	CP	02H
    5613/    1B8F : 28 02               	JR	Z,EXTCMD02_14_L1
    5614/    1B91 : 06 00               	LD	B,00H
    5615/    1B93 :                     EXTCMD02_14_L1:
    5616/    1B93 : 78                  	LD	A,B
    5617/    1B94 : 32 40 83            	LD	(REG_EXTFDD+FDD_DMACTRL),A
    5618/    1B97 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5619/    1B9A : 34                  	INC	(HL)
    5620/    1B9B : C9                  	RET
    5621/    1B9C :                     
    5622/    1B9C :                     EXTCMD02_15H:
    5623/    1B9C : 3D                  	DEC	A
    5624/    1B9D : 20 03               	JR	NZ,EXTCMD02_16H
    5625/    1B9F :                     
    5626/    1B9F :                     		; DMA #1 (FDINT wait)
    5627/    1B9F : C3 85 19            	JP	EXTFDCFDINTWAIT
    5628/    1BA2 :                     
    5629/    1BA2 :                     EXTCMD02_16H:
    5630/    1BA2 : 3D                  	DEC	A
    5631/    1BA3 : 20 0A               	JR	NZ,EXTCMD02_17H
    5632/    1BA5 :                     
    5633/    1BA5 :                     		; DMA #2 (DMA off)
    5634/    1BA5 : 3E 03               	LD	A,03H
    5635/    1BA7 : 32 40 83            	LD	(REG_EXTFDD+FDD_DMACTRL),A
    5636/    1BAA : 21 F4 22            	LD	HL,EXTFDDSUBST
    5637/    1BAD : 34                  	INC	(HL)
    5638/    1BAE : C9                  	RET
    5639/    1BAF :                     
    5640/    1BAF :                     EXTCMD02_17H:
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 95 - 2/18/2013 12:10:16


    5641/    1BAF : D6 07               	SUB	07H
    5642/    1BB1 : 38 02               	JR	C,EXTCMD02_17H_L1
    5643/    1BB3 : 20 03               	JR	NZ,EXTCMD02_1EH
    5644/    1BB5 :                     
    5645/    1BB5 :                     EXTCMD02_17H_L1:
    5646/    1BB5 :                     		; read/write data result #0-6 (ST0-N)
    5647/    1BB5 : C3 5C 19            	JP	EXTFDCDTIN
    5648/    1BB8 :                     
    5649/    1BB8 :                     EXTCMD02_1EH:
    5650/    1BB8 : 3A C5 22            	LD	A,(EXTFDDPARA)		; sector number
    5651/    1BBB : 67                  	LD	H,A
    5652/    1BBC : 2E 00               	LD	L,00H
    5653/    1BBE : 22 CE 22            	LD	(EXTFDDDTLEN),HL
    5654/    1BC1 : 3A C6 22            	LD	A,(EXTFDDPARA+1)	; drive number
    5655/    1BC4 : E6 01               	AND	01H
    5656/    1BC6 : 47                  	LD	B,A
    5657/    1BC7 : 21 F5 22            	LD	HL,EXTFDCRST
    5658/    1BCA : 7E                  	LD	A,(HL)			; ST0
    5659/    1BCB : E6 DF               	AND	0DFH
    5660/    1BCD : A8                  	XOR	B
    5661/    1BCE : 23                  	INC	HL
    5662/    1BCF : 46                  	LD	B,(HL)			; ST1
    5663/    1BD0 : B0                  	OR	B
    5664/    1BD1 : 23                  	INC	HL
    5665/    1BD2 : 46                  	LD	B,(HL)			; ST2
    5666/    1BD3 : B0                  	OR	B
    5667/    1BD4 :                     
    5668/    1BD4 : 0E 80               	LD	C,80H
    5669/    1BD6 : 28 06               	JR	Z,EXTCMD02_RSL1
    5670/    1BD8 : CB C1               	SET	0,C
    5671/    1BDA : AF                  	XOR	A
    5672/    1BDB : 32 CF 22            	LD	(EXTFDDDTLEN+1),A
    5673/    1BDE :                     EXTCMD02_RSL1:
    5674/    1BDE :                     
    5675/    1BDE : 3A C2 22            	LD	A,(EXTFDDCMD)
    5676/    1BE1 : FE 02               	CP	02H
    5677/    1BE3 : 20 02               	JR	NZ,EXTCMD02_RSL2
    5678/    1BE5 : CB F1               	SET	6,C
    5679/    1BE7 :                     EXTCMD02_RSL2:
    5680/    1BE7 :                     
    5681/    1BE7 : 79                  	LD	A,C
    5682/    1BE8 : 32 F1 22            	LD	(EXTFDDRDFLAG),A
    5683/    1BEB :                     
    5684/    1BEB : AF                  	XOR	A
    5685/    1BEC : 32 C1 22            	LD	(EXTFDDST),A
    5686/    1BEF : C9                  	RET
    5687/    1BF0 :                     
    5688/    1BF0 :                     ;
    5689/    1BF0 :                     ; external FDD format
    5690/    1BF0 :                     ; (command 05H)
    5691/    1BF0 :                     ;
    5692/    1BF0 :                     EXTCMD05:
    5693/    1BF0 : 3A F4 22            	LD	A,(EXTFDDSUBST)
    5694/    1BF3 : B7                  	OR	A
    5695/    1BF4 : 20 09               	JR	NZ,EXTCMD05_01H
    5696/    1BF6 :                     
    5697/    1BF6 : AF                  	XOR	A
    5698/    1BF7 : 32 F0 22            	LD	(EXTFMTCY),A
    5699/    1BFA : 21 F4 22            	LD	HL,EXTFDDSUBST
    5700/    1BFD : 34                  	INC	(HL)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 96 - 2/18/2013 12:10:16


    5701/    1BFE : C9                  	RET
    5702/    1BFF :                     
    5703/    1BFF :                     EXTCMD05_01H:
    5704/    1BFF : 3D                  	DEC	A
    5705/    1C00 : 20 09               	JR	NZ,EXTCMD05_02H
    5706/    1C02 :                     
    5707/    1C02 :                     		; seek #0 (wait FDC no busy)
    5708/    1C02 : 21 F5 22            	LD	HL,EXTFDCRST
    5709/    1C05 : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5710/    1C08 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5711/    1C0B :                     
    5712/    1C0B :                     EXTCMD05_02H:
    5713/    1C0B : 3D                  	DEC	A
    5714/    1C0C : 20 05               	JR	NZ,EXTCMD05_03H
    5715/    1C0E :                     
    5716/    1C0E :                     		; seek #1 (command)
    5717/    1C0E : 06 0F               	LD	B,CMD_SEEK
    5718/    1C10 : C3 74 19            	JP	EXTFDCDTOUT
    5719/    1C13 :                     
    5720/    1C13 :                     EXTCMD05_03H:
    5721/    1C13 : 3D                  	DEC	A
    5722/    1C14 : 20 09               	JR	NZ,EXTCMD05_04H
    5723/    1C16 :                     
    5724/    1C16 :                     		; seek #2 (hd/us)
    5725/    1C16 : 3A C5 22            	LD	A,(EXTFDDPARA)
    5726/    1C19 : E6 01               	AND	01H
    5727/    1C1B : 47                  	LD	B,A
    5728/    1C1C : C3 74 19            	JP	EXTFDCDTOUT
    5729/    1C1F :                     
    5730/    1C1F :                     EXTCMD05_04H:
    5731/    1C1F : 3D                  	DEC	A
    5732/    1C20 : 20 07               	JR	NZ,EXTCMD05_05H
    5733/    1C22 :                     
    5734/    1C22 :                     		; seek #3 (NCN)
    5735/    1C22 :                     		; 1D only
    5736/    1C22 : 3A F0 22            	LD	A,(EXTFMTCY)
    5737/    1C25 : 47                  	LD	B,A
    5738/    1C26 : C3 74 19            	JP	EXTFDCDTOUT
    5739/    1C29 :                     
    5740/    1C29 :                     EXTCMD05_05H:
    5741/    1C29 : 3D                  	DEC	A
    5742/    1C2A : 20 03               	JR	NZ,EXTCMD05_06H
    5743/    1C2C :                     
    5744/    1C2C :                     		; seek #4 (FDINT wait)
    5745/    1C2C : C3 85 19            	JP	EXTFDCFDINTWAIT
    5746/    1C2F :                     
    5747/    1C2F :                     EXTCMD05_06H:
    5748/    1C2F : 3D                  	DEC	A
    5749/    1C30 : 20 03               	JR	NZ,EXTCMD05_07H
    5750/    1C32 :                     
    5751/    1C32 :                     		; seek #5 (FDC no busy wait)
    5752/    1C32 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5753/    1C35 :                     
    5754/    1C35 :                     EXTCMD05_07H:
    5755/    1C35 : 3D                  	DEC	A
    5756/    1C36 : 20 05               	JR	NZ,EXTCMD05_08H
    5757/    1C38 :                     
    5758/    1C38 :                     		; sense interrupt status#0
    5759/    1C38 : 06 08               	LD	B,CMD_SENSEINTST
    5760/    1C3A : C3 74 19            	JP	EXTFDCDTOUT
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 97 - 2/18/2013 12:10:16


    5761/    1C3D :                     
    5762/    1C3D :                     EXTCMD05_08H:
    5763/    1C3D : 3D                  	DEC	A
    5764/    1C3E : 20 03               	JR	NZ,EXTCMD05_09H
    5765/    1C40 :                     
    5766/    1C40 :                     		; sense interrupt status#1 (ST0)
    5767/    1C40 : C3 5C 19            	JP	EXTFDCDTIN
    5768/    1C43 :                     
    5769/    1C43 :                     EXTCMD05_09H:
    5770/    1C43 : 3D                  	DEC	A
    5771/    1C44 : 20 03               	JR	NZ,EXTCMD05_0AH
    5772/    1C46 :                     
    5773/    1C46 :                     		; sense interrupt status#2 (PCN)
    5774/    1C46 : C3 5C 19            	JP	EXTFDCDTIN
    5775/    1C49 :                     
    5776/    1C49 :                     EXTCMD05_0AH:
    5777/    1C49 : 3D                  	DEC	A
    5778/    1C4A : 20 40               	JR	NZ,EXTCMD05_0BH
    5779/    1C4C :                     
    5780/    1C4C : 0E 80               	LD	C,80H
    5781/    1C4E : 3A C5 22            	LD	A,(EXTFDDPARA)		; drive number
    5782/    1C51 : E6 01               	AND	01H
    5783/    1C53 : 47                  	LD	B,A
    5784/    1C54 : 21 F5 22            	LD	HL,EXTFDCRST
    5785/    1C57 : 7E                  	LD	A,(HL)			; ST0
    5786/    1C58 : E6 DF               	AND	0DFH
    5787/    1C5A : A8                  	XOR	B
    5788/    1C5B : 23                  	INC	HL
    5789/    1C5C : 46                  	LD	B,(HL)			; PCN
    5790/    1C5D : A8                  	XOR	B
    5791/    1C5E : 47                  	LD	B,A
    5792/    1C5F : 3A F0 22            	LD	A,(EXTFMTCY)		; track number
    5793/    1C62 : A8                  	XOR	B
    5794/    1C63 : 28 0B               	JR	Z,EXTCMD05_SIL1
    5795/    1C65 : 0E 81               	LD	C,81H
    5796/    1C67 : 79                  	LD	A,C
    5797/    1C68 : 32 F1 22            	LD	(EXTFDDRDFLAG),A
    5798/    1C6B : AF                  	XOR	A
    5799/    1C6C : 32 C1 22            	LD	(EXTFDDST),A
    5800/    1C6F : C9                  	RET
    5801/    1C70 :                     
    5802/    1C70 :                     EXTCMD05_SIL1:
    5803/    1C70 : 21 00 A0            	LD	HL,EXTWRBUF
    5804/    1C73 : 06 10               	LD	B,10H
    5805/    1C75 : 0E 01               	LD	C,01H
    5806/    1C77 : 3A F0 22            	LD	A,(EXTFMTCY)
    5807/    1C7A :                     EXTCMD05_SIL2:
    5808/    1C7A : 77                  	LD	(HL),A
    5809/    1C7B : 23                  	INC	HL
    5810/    1C7C : 36 00               	LD	(HL),00H
    5811/    1C7E : 23                  	INC	HL
    5812/    1C7F : 71                  	LD	(HL),C
    5813/    1C80 : 23                  	INC	HL
    5814/    1C81 : 36 01               	LD	(HL),01H
    5815/    1C83 : 23                  	INC	HL
    5816/    1C84 : 0C                  	INC	C
    5817/    1C85 : 10 F3               	DJNZ	EXTCMD05_SIL2
    5818/    1C87 :                     
    5819/    1C87 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5820/    1C8A : 34                  	INC	(HL)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 98 - 2/18/2013 12:10:16


    5821/    1C8B : C9                  	RET
    5822/    1C8C :                     
    5823/    1C8C :                     
    5824/    1C8C :                     EXTCMD05_0BH:
    5825/    1C8C : 3D                  	DEC	A
    5826/    1C8D : 20 09               	JR	NZ,EXTCMD05_0CH
    5827/    1C8F :                     
    5828/    1C8F :                     		; write ID #0 (wait FDC no busy)
    5829/    1C8F : 21 F5 22            	LD	HL,EXTFDCRST
    5830/    1C92 : 22 FC 22            	LD	(EXTFDCRSTPTR),HL
    5831/    1C95 : C3 8F 19            	JP	EXTFDCBUSYWAIT
    5832/    1C98 :                     
    5833/    1C98 :                     EXTCMD05_0CH:
    5834/    1C98 : 3D                  	DEC	A
    5835/    1C99 : 20 05               	JR	NZ,EXTCMD05_0DH
    5836/    1C9B :                     
    5837/    1C9B :                     		; write ID #1 (command)
    5838/    1C9B : 06 4D               	LD	B,CMD_MFMWRID
    5839/    1C9D : C3 74 19            	JP	EXTFDCDTOUT
    5840/    1CA0 :                     
    5841/    1CA0 :                     EXTCMD05_0DH:
    5842/    1CA0 : 3D                  	DEC	A
    5843/    1CA1 : 20 09               	JR	NZ,EXTCMD05_0EH
    5844/    1CA3 :                     
    5845/    1CA3 :                     		; write ID #2 (hd/us)
    5846/    1CA3 :                     		; 1D only
    5847/    1CA3 : 3A C5 22            	LD	A,(EXTFDDPARA)
    5848/    1CA6 : E6 01               	AND	01H
    5849/    1CA8 : 47                  	LD	B,A
    5850/    1CA9 : C3 74 19            	JP	EXTFDCDTOUT
    5851/    1CAC :                     
    5852/    1CAC :                     EXTCMD05_0EH:
    5853/    1CAC : 3D                  	DEC	A
    5854/    1CAD : 20 05               	JR	NZ,EXTCMD05_0FH
    5855/    1CAF :                     
    5856/    1CAF :                     		; write ID #3 (N)
    5857/    1CAF : 06 01               	LD	B,01H
    5858/    1CB1 : C3 74 19            	JP	EXTFDCDTOUT
    5859/    1CB4 :                     
    5860/    1CB4 :                     EXTCMD05_0FH:
    5861/    1CB4 : 3D                  	DEC	A
    5862/    1CB5 : 20 05               	JR	NZ,EXTCMD05_10H
    5863/    1CB7 :                     
    5864/    1CB7 :                     		; write ID #4 (SC)
    5865/    1CB7 : 06 10               	LD	B,10H
    5866/    1CB9 : C3 74 19            	JP	EXTFDCDTOUT
    5867/    1CBC :                     
    5868/    1CBC :                     EXTCMD05_10H:
    5869/    1CBC : 3D                  	DEC	A
    5870/    1CBD : 20 05               	JR	NZ,EXTCMD05_11H
    5871/    1CBF :                     
    5872/    1CBF :                     		; write ID #5 (GPL)
    5873/    1CBF : 06 33               	LD	B,33H
    5874/    1CC1 : C3 74 19            	JP	EXTFDCDTOUT
    5875/    1CC4 :                     
    5876/    1CC4 :                     EXTCMD05_11H:
    5877/    1CC4 : 3D                  	DEC	A
    5878/    1CC5 : 20 05               	JR	NZ,EXTCMD05_12H
    5879/    1CC7 :                     
    5880/    1CC7 :                     		; write ID #6 (D)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 99 - 2/18/2013 12:10:16


    5881/    1CC7 : 06 FF               	LD	B,0FFH
    5882/    1CC9 : C3 74 19            	JP	EXTFDCDTOUT
    5883/    1CCC :                     
    5884/    1CCC :                     EXTCMD05_12H:
    5885/    1CCC : 3D                  	DEC	A
    5886/    1CCD : 20 0E               	JR	NZ,EXTCMD05_13H
    5887/    1CCF :                     
    5888/    1CCF :                     		; DMA #0 (DMA on)
    5889/    1CCF : 3E 0E               	LD	A,0EH
    5890/    1CD1 : 32 41 83            	LD	(REG_EXTFDD+FDD_DMASIZE),A
    5891/    1CD4 : AF                  	XOR	A
    5892/    1CD5 : 32 40 83            	LD	(REG_EXTFDD+FDD_DMACTRL),A
    5893/    1CD8 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5894/    1CDB : 34                  	INC	(HL)
    5895/    1CDC : C9                  	RET
    5896/    1CDD :                     
    5897/    1CDD :                     EXTCMD05_13H:
    5898/    1CDD : 3D                  	DEC	A
    5899/    1CDE : 20 03               	JR	NZ,EXTCMD05_14H
    5900/    1CE0 :                     
    5901/    1CE0 :                     		; DMA #1 (FDINT wait)
    5902/    1CE0 : C3 85 19            	JP	EXTFDCFDINTWAIT
    5903/    1CE3 :                     
    5904/    1CE3 :                     EXTCMD05_14H:
    5905/    1CE3 : 3D                  	DEC	A
    5906/    1CE4 : 20 0A               	JR	NZ,EXTCMD05_15H
    5907/    1CE6 :                     
    5908/    1CE6 :                     		; DMA #2 (DMA off)
    5909/    1CE6 : 3E 03               	LD	A,03H
    5910/    1CE8 : 32 40 83            	LD	(REG_EXTFDD+FDD_DMACTRL),A
    5911/    1CEB : 21 F4 22            	LD	HL,EXTFDDSUBST
    5912/    1CEE : 34                  	INC	(HL)
    5913/    1CEF : C9                  	RET
    5914/    1CF0 :                     
    5915/    1CF0 :                     EXTCMD05_15H:
    5916/    1CF0 : D6 07               	SUB	07H
    5917/    1CF2 : 38 02               	JR	C,EXTCMD05_15H_L1
    5918/    1CF4 : 20 03               	JR	NZ,EXTCMD05_1CH
    5919/    1CF6 :                     
    5920/    1CF6 :                     EXTCMD05_15H_L1:
    5921/    1CF6 :                     		; read/write data result #0-6 (ST0-N)
    5922/    1CF6 : C3 5C 19            	JP	EXTFDCDTIN
    5923/    1CF9 :                     
    5924/    1CF9 :                     EXTCMD05_1CH:
    5925/    1CF9 : 3D                  	DEC	A
    5926/    1CFA : 20 29               	JR	NZ,EXTCMD05_1DH
    5927/    1CFC :                     
    5928/    1CFC : 3A C5 22            	LD	A,(EXTFDDPARA)		; drive number
    5929/    1CFF : E6 01               	AND	01H
    5930/    1D01 : 47                  	LD	B,A
    5931/    1D02 : 21 F5 22            	LD	HL,EXTFDCRST
    5932/    1D05 : 7E                  	LD	A,(HL)			; ST0
    5933/    1D06 : E6 DF               	AND	0DFH
    5934/    1D08 : A8                  	XOR	B
    5935/    1D09 : 23                  	INC	HL
    5936/    1D0A : 46                  	LD	B,(HL)			; ST1
    5937/    1D0B : B0                  	OR	B
    5938/    1D0C : 23                  	INC	HL
    5939/    1D0D : 46                  	LD	B,(HL)			; ST2
    5940/    1D0E : B0                  	OR	B
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 100 - 2/18/2013 12:10:16


    5941/    1D0F :                     
    5942/    1D0F : 28 0A               	JR	Z,EXTCMD05_RSL1
    5943/    1D11 : 3E 81               	LD	A,81H
    5944/    1D13 : 32 F1 22            	LD	(EXTFDDRDFLAG),A
    5945/    1D16 : AF                  	XOR	A
    5946/    1D17 : 32 C1 22            	LD	(EXTFDDST),A
    5947/    1D1A : C9                  	RET
    5948/    1D1B :                     
    5949/    1D1B :                     EXTCMD05_RSL1:
    5950/    1D1B : 3E 80               	LD	A,80H
    5951/    1D1D : 32 F1 22            	LD	(EXTFDDRDFLAG),A
    5952/    1D20 : 21 F4 22            	LD	HL,EXTFDDSUBST
    5953/    1D23 : 34                  	INC	(HL)
    5954/    1D24 : C9                  	RET
    5955/    1D25 :                     
    5956/    1D25 :                     EXTCMD05_1DH:
    5957/    1D25 :                     
    5958/    1D25 : 21 F0 22            	LD	HL,EXTFMTCY
    5959/    1D28 : 34                  	INC	(HL)
    5960/    1D29 : 7E                  	LD	A,(HL)
    5961/    1D2A : FE 28               	CP	28H
    5962/    1D2C : 30 06               	JR	NC,EXTCMD05_END
    5963/    1D2E :                     
    5964/    1D2E : 3E 01               	LD	A,01H
    5965/    1D30 : 32 F4 22            	LD	(EXTFDDSUBST),A
    5966/    1D33 : C9                  	RET
    5967/    1D34 :                     
    5968/    1D34 :                     EXTCMD05_END:
    5969/    1D34 : AF                  	XOR	A
    5970/    1D35 : 32 C1 22            	LD	(EXTFDDST),A
    5971/    1D38 : C9                  	RET
    5972/    1D39 :                     
    5973/    1D39 :                     ;
    5974/    1D39 :                     ; floppy disk access
    5975/    1D39 :                     ;
    5976/    1D39 :                     DISKWAIT:
    5977/    1D39 : DD 7E 20            	LD	A,(IX+FDD_COMEND)
    5978/    1D3C : B7                  	OR	A
    5979/    1D3D : 20 05               	JR	NZ,DWL0
    5980/    1D3F :                     
    5981/    1D3F : AF                  	XOR	A
    5982/    1D40 : DD 77 17            	LD	(IX+FDD_ENDTRG),A
    5983/    1D43 : C9                  	RET
    5984/    1D44 :                     
    5985/    1D44 :                     		;
    5986/    1D44 :                     		; drive number -> IY
    5987/    1D44 :                     		;
    5988/    1D44 :                     DWL0:
    5989/    1D44 : DD E5               	PUSH	IX
    5990/    1D46 : C1                  	POP	BC
    5991/    1D47 : 21 10 83            	LD	HL,REG_INTFDD
    5992/    1D4A : B7                  	OR	A
    5993/    1D4B : ED 42               	SBC	HL,BC
    5994/    1D4D : DD 7E 23            	LD	A,(IX+FDD_DNUM)
    5995/    1D50 : 20 0E               	JR	NZ,DWL_EXT
    5996/    1D52 : FD 21 60 82         	LD	IY,REG_FIFO_2
    5997/    1D56 : E6 01               	AND	01H
    5998/    1D58 : 28 12               	JR	Z,DWL1
    5999/    1D5A : FD 21 80 82         	LD	IY,REG_FIFO_3
    6000/    1D5E : 18 0C               	JR	DWL1
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 101 - 2/18/2013 12:10:16


    6001/    1D60 :                     
    6002/    1D60 :                     DWL_EXT:
    6003/    1D60 : E6 01               	AND	01H
    6004/    1D62 : FD 21 A0 82         	LD	IY,REG_FIFO_4
    6005/    1D66 : 28 04               	JR	Z,DWL1
    6006/    1D68 : FD 21 C0 82         	LD	IY,REG_FIFO_5
    6007/    1D6C :                     
    6008/    1D6C :                     		;
    6009/    1D6C :                     		; status register clear
    6010/    1D6C :                     		;
    6011/    1D6C : 47                  DWL1:	LD	B,A
    6012/    1D6D : DD 7E 24            	LD	A,(IX+FDD_HNUM)
    6013/    1D70 : B7                  	OR	A
    6014/    1D71 : 17                  	RLA
    6015/    1D72 : 17                  	RLA
    6016/    1D73 : B0                  	OR	B
    6017/    1D74 : E6 07               	AND	07H
    6018/    1D76 : DD 77 10            	LD	(IX+FDD_ST0),A
    6019/    1D79 : AF                  	XOR	A
    6020/    1D7A : DD 77 11            	LD	(IX+FDD_ST1),A
    6021/    1D7D : DD 77 12            	LD	(IX+FDD_ST2),A
    6022/    1D80 :                     		;
    6023/    1D80 :                     		; set CHRN
    6024/    1D80 :                     		;
    6025/    1D80 : DD 7E 25            	LD	A,(IX+FDD_IDRC)
    6026/    1D83 : DD 77 13            	LD	(IX+FDD_RST_C),A
    6027/    1D86 : DD 7E 26            	LD	A,(IX+FDD_IDRH)
    6028/    1D89 : DD 77 14            	LD	(IX+FDD_RST_H),A
    6029/    1D8C : DD 7E 27            	LD	A,(IX+FDD_IDRR)
    6030/    1D8F : DD 77 15            	LD	(IX+FDD_RST_R),A
    6031/    1D92 : DD 7E 28            	LD	A,(IX+FDD_IDRN)
    6032/    1D95 : DD 77 16            	LD	(IX+FDD_RST_N),A
    6033/    1D98 :                     
    6034/    1D98 :                     		;
    6035/    1D98 :                     		; FDD nouse
    6036/    1D98 :                     		;
    6037/    1D98 : FD 7E 1F            	LD	A,(IY+FIFO_FDD)
    6038/    1D9B : E6 01               	AND	01H
    6039/    1D9D : 20 07               	JR	NZ,DWL3
    6040/    1D9F : DD CB 10 E6         	SET	4,(IX+FDD_ST0)
    6041/    1DA3 : C3 AE 1F            	JP	DISKABEND
    6042/    1DA6 :                     
    6043/    1DA6 :                     		;
    6044/    1DA6 :                     		; FLOPPY not insert
    6045/    1DA6 :                     		;
    6046/    1DA6 : FD 7E 14            DWL3:	LD	A,(IY+FIFO_FLOPPY)
    6047/    1DA9 : E6 01               	AND	01H
    6048/    1DAB : C8                  	RET	Z
    6049/    1DAC :                     
    6050/    1DAC :                     		;
    6051/    1DAC :                     		; Write Protect
    6052/    1DAC :                     		;
    6053/    1DAC : 11 00 B0            	LD	DE,EXTRDBUF
    6054/    1DAF : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6055/    1DB2 : FE 05               	CP	CMD_WRDATA
    6056/    1DB4 : 28 08               	JR	Z,DWL4
    6057/    1DB6 : FE 09               	CP	CMD_WRDELDATA
    6058/    1DB8 : 28 04               	JR	Z,DWL4
    6059/    1DBA : FE 0D               	CP	CMD_WRID
    6060/    1DBC : 20 12               	JR	NZ,DWL5
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 102 - 2/18/2013 12:10:16


    6061/    1DBE :                     DWL4:
    6062/    1DBE : 3A 04 82            	LD	A,(REG_SDWP)
    6063/    1DC1 : B7                  	OR	A
    6064/    1DC2 : C2 74 1F            	JP	NZ,DW_NOTWRITABLE
    6065/    1DC5 : FD 7E 14            	LD	A,(IY+FIFO_FLOPPY)
    6066/    1DC8 : E6 08               	AND	08H
    6067/    1DCA : C2 74 1F            	JP	NZ,DW_NOTWRITABLE
    6068/    1DCD :                     DWL52:
    6069/    1DCD : 11 00 A0            	LD	DE,EXTWRBUF
    6070/    1DD0 :                     
    6071/    1DD0 :                     DWL5:
    6072/    1DD0 : DD E5               	PUSH	IX
    6073/    1DD2 : C1                  	POP	BC
    6074/    1DD3 : 21 10 83            	LD	HL,REG_INTFDD
    6075/    1DD6 : B7                  	OR	A
    6076/    1DD7 : ED 42               	SBC	HL,BC
    6077/    1DD9 : 20 03               	JR	NZ,DWL53
    6078/    1DDB : 11 00 90            	LD	DE,DISKBUF
    6079/    1DDE :                     DWL53:
    6080/    1DDE :                     
    6081/    1DDE :                     		;
    6082/    1DDE :                     		; set transfer bytes
    6083/    1DDE :                     		;
    6084/    1DDE : ED 53 17 23         	LD	(DMABUFFERADD),DE
    6085/    1DE2 :                     
    6086/    1DE2 : DD 7E 01            	LD	A,(IX+FDD_DMASIZE)
    6087/    1DE5 : 67                  	LD	H,A
    6088/    1DE6 : 2E 00               	LD	L,00H
    6089/    1DE8 : 22 15 23            	LD	(DMATRANSBYTES),HL
    6090/    1DEB :                     
    6091/    1DEB :                     		;
    6092/    1DEB : 21 FF FF            	LD	HL,0FFFFH
    6093/    1DEE : 22 FE 22            	LD	(FDDSECNUM),HL
    6094/    1DF1 :                     		;
    6095/    1DF1 : AF                  	XOR	A
    6096/    1DF2 : 32 00 23            	LD	(SECACCFLAG),A
    6097/    1DF5 :                     
    6098/    1DF5 : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6099/    1DF8 : FE 0A               	CP	CMD_RDID
    6100/    1DFA : CA 72 1F            	JP	Z,DW_RDID
    6101/    1DFD :                     
    6102/    1DFD : 06 02               	LD	B,02H	; buffer -> P6
    6103/    1DFF : FE 06               	CP	CMD_RDDATA
    6104/    1E01 : 28 0A               	JR	Z,DWL6
    6105/    1E03 : FE 0C               	CP	CMD_RDDELDATA
    6106/    1E05 : 28 06               	JR	Z,DWL6
    6107/    1E07 : FE 02               	CP	CMD_RDDIA
    6108/    1E09 : 28 02               	JR	Z,DWL6
    6109/    1E0B : 06 00               	LD	B,00H	; P6 -> buffer
    6110/    1E0D :                     DWL6:
    6111/    1E0D :                     		;
    6112/    1E0D :                     		; wait DMA ON
    6113/    1E0D :                     		;
    6114/    1E0D : DD 7E 00            	LD	A,(IX+FDD_DMACTRL)
    6115/    1E10 : E6 03               	AND	03H
    6116/    1E12 : A8                  	XOR	B
    6117/    1E13 : C0                  	RET	NZ
    6118/    1E14 :                     
    6119/    1E14 : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6120/    1E17 : FE 02               	CP	CMD_RDDIA
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 103 - 2/18/2013 12:10:16


    6121/    1E19 : CA 72 1F            	JP	Z,DW_RDDIA
    6122/    1E1C :                     
    6123/    1E1C :                     		;
    6124/    1E1C :                     		; Read  Data/Read  Deleted Data
    6125/    1E1C :                     		; Write Data/Write Deleted Data
    6126/    1E1C :                     		; Scan Equal
    6127/    1E1C :                     		; Scan Low or Equal/Scan High or Equal
    6128/    1E1C :                     		;
    6129/    1E1C :                     
    6130/    1E1C :                     		;
    6131/    1E1C :                     		; first sector
    6132/    1E1C :                     		;
    6133/    1E1C : CD BB 1F            	CALL	DISKOPEN
    6134/    1E1F :                     		;
    6135/    1E1F : FD 46 15            	LD	B,(IY+FIFO_CNUM)
    6136/    1E22 : DD 7E 24            	LD	A,(IX+FDD_HNUM)
    6137/    1E25 : 4F                  	LD	C,A
    6138/    1E26 :                     		;
    6139/    1E26 : CD DC 1F            	CALL	GETDISKSECADD
    6140/    1E29 : DA AA 1F            	JP	C,DW_NOSEC
    6141/    1E2C :                     
    6142/    1E2C : CD C6 0E            	CALL	JMPREADPTR
    6143/    1E2F :                     
    6144/    1E2F :                     DWL_LP:
    6145/    1E2F :                     
    6146/    1E2F : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6147/    1E32 : FE 0D               	CP	CMD_WRID
    6148/    1E34 : 20 2F               	JR	NZ,DW_NOTWRID
    6149/    1E36 :                     
    6150/    1E36 :                     		;
    6151/    1E36 :                     		; write ID
    6152/    1E36 :                     		;
    6153/    1E36 : FD 7E 15            	LD	A,(IY+FIFO_CNUM)
    6154/    1E39 : DD 77 13            	LD	(IX+FDD_RST_C),A
    6155/    1E3C : DD 7E 24            	LD	A,(IX+FDD_HNUM)
    6156/    1E3F : DD 77 14            	LD	(IX+FDD_RST_H),A
    6157/    1E42 : 3E 01               	LD	A,01H
    6158/    1E44 : DD 77 15            	LD	(IX+FDD_RST_R),A
    6159/    1E47 : DD 7E 25            	LD	A,(IX+FDD_IDRC)		; sector length
    6160/    1E4A : DD 77 16            	LD	(IX+FDD_RST_N),A
    6161/    1E4D :                     
    6162/    1E4D : DD 46 26            	LD	B,(IX+FDD_IDRH)		; sector number of 1 track
    6163/    1E50 :                     
    6164/    1E50 :                     DW_WRIDLP:
    6165/    1E50 : C5                  	PUSH	BC
    6166/    1E51 : CD FF 21            	CALL	FDDWRITEID
    6167/    1E54 : DD 34 15            	INC	(IX+FDD_RST_R)
    6168/    1E57 : C1                  	POP	BC
    6169/    1E58 : 3A 00 23            	LD	A,(SECACCFLAG)
    6170/    1E5B : E6 02               	AND	02H
    6171/    1E5D : C2 B2 1F            	JP	NZ,DISKEND
    6172/    1E60 : 10 EE               	DJNZ	DW_WRIDLP
    6173/    1E62 : C3 B2 1F            	JP	DISKEND
    6174/    1E65 :                     
    6175/    1E65 :                     
    6176/    1E65 :                     DW_NOTWRID:
    6177/    1E65 : CD 37 20            	CALL	GETSECSTAT
    6178/    1E68 : E5                  	PUSH	HL
    6179/    1E69 :                     
    6180/    1E69 : 2A FE 22            	LD	HL,(FDDSECNUM)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 104 - 2/18/2013 12:10:16


    6181/    1E6C : 23                  	INC	HL
    6182/    1E6D : 7C                  	LD	A,H
    6183/    1E6E : B5                  	OR	L
    6184/    1E6F : 20 04               	JR	NZ,DWL7
    6185/    1E71 : ED 53 FE 22         	LD	(FDDSECNUM),DE
    6186/    1E75 :                     DWL7:
    6187/    1E75 : E1                  	POP	HL
    6188/    1E76 :                     
    6189/    1E76 : 3A 03 23            	LD	A,(SECSTAT)
    6190/    1E79 : FE A0               	CP	0A0H		; ID CRC error
    6191/    1E7B : CA 94 1F            	JP	Z,DW_IDCRCERR
    6192/    1E7E :                     
    6193/    1E7E : FE E0               	CP	0E0H		; no ID Address mark
    6194/    1E80 : CA 61 1F            	JP	Z,DW_SECSKIP
    6195/    1E83 :                     
    6196/    1E83 : 47                  	LD	B,A
    6197/    1E84 : 3A 01 23            	LD	A,(SECIDRCOMP)
    6198/    1E87 : B7                  	OR	A
    6199/    1E88 : 28 1B               	JR	Z,DW_SECEQ
    6200/    1E8A :                     
    6201/    1E8A :                     		;
    6202/    1E8A :                     		; IDR <> CHRN
    6203/    1E8A :                     		;
    6204/    1E8A : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6205/    1E8D : FE 05               	CP	CMD_WRDATA
    6206/    1E8F : CA 61 1F            	JP	Z,DW_SECSKIP
    6207/    1E92 : FE 09               	CP	CMD_WRDELDATA
    6208/    1E94 : CA 61 1F            	JP	Z,DW_SECSKIP
    6209/    1E97 :                     
    6210/    1E97 : 78                  	LD	A,B
    6211/    1E98 : FE F0               	CP	0F0H		; no Data Address Mark
    6212/    1E9A : CA 61 1F            	JP	Z,DW_SECSKIP
    6213/    1E9D : FE B0               	CP	0B0H		; Data CRC Error
    6214/    1E9F : CA 8A 1F            	JP	Z,DW_DATACRCERR
    6215/    1EA2 : C3 61 1F            	JP	DW_SECSKIP
    6216/    1EA5 :                     
    6217/    1EA5 :                     DW_SECEQ:
    6218/    1EA5 :                     		;
    6219/    1EA5 :                     		; IDR = CHRN
    6220/    1EA5 :                     		;
    6221/    1EA5 : 78                  	LD	A,B
    6222/    1EA6 : FE F0               	CP	0F0H		; no Data Address Mark
    6223/    1EA8 : CA 7A 1F            	JP	Z,DW_NODATA
    6224/    1EAB :                     
    6225/    1EAB : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6226/    1EAE : FE 05               	CP	CMD_WRDATA
    6227/    1EB0 : 28 25               	JR	Z,DW_WR_WRDEL
    6228/    1EB2 : FE 09               	CP	CMD_WRDELDATA
    6229/    1EB4 : 28 21               	JR	Z,DW_WR_WRDEL
    6230/    1EB6 :                     
    6231/    1EB6 : DD CB 22 46         	BIT	0,(IX+FDD_MT)	; SK
    6232/    1EBA : 28 0D               	JR	Z,DWL8
    6233/    1EBC : 3A 02 23            	LD	A,(SECDELCOMP)
    6234/    1EBF : B7                  	OR	A		; equal Deleted Mark
    6235/    1EC0 : 28 07               	JR	Z,DWL8
    6236/    1EC2 :                     
    6237/    1EC2 : DD CB 12 F6         	SET	6,(IX+FDD_ST2)
    6238/    1EC6 : C3 61 1F            	JP	DW_SECSKIP
    6239/    1EC9 :                     
    6240/    1EC9 :                     DWL8:
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 105 - 2/18/2013 12:10:16


    6241/    1EC9 : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6242/    1ECC : FE 06               	CP	CMD_RDDATA
    6243/    1ECE : 28 29               	JR	Z,DW_RD_RDDEL
    6244/    1ED0 : FE 0C               	CP	CMD_RDDELDATA
    6245/    1ED2 : 28 25               	JR	Z,DW_RD_RDDEL
    6246/    1ED4 : C3 AE 1F            	JP	DISKABEND
    6247/    1ED7 :                     
    6248/    1ED7 :                     		;
    6249/    1ED7 :                     		; write data / write deleted data
    6250/    1ED7 :                     		;
    6251/    1ED7 :                     DW_WR_WRDEL:
    6252/    1ED7 : 01 FF FF            	LD	BC,0FFFFH
    6253/    1EDA : 11 F0 FF            	LD	DE,0FFF0H
    6254/    1EDD : E5                  	PUSH	HL
    6255/    1EDE : CD D8 0E            	CALL	MOVEREADPTR
    6256/    1EE1 :                     
    6257/    1EE1 : 06 00               	LD	B,00H
    6258/    1EE3 : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6259/    1EE6 : FE 05               	CP	CMD_WRDATA
    6260/    1EE8 : 28 02               	JR	Z,DW_WR_WRDEL_L1
    6261/    1EEA : 06 10               	LD	B,10H
    6262/    1EEC :                     DW_WR_WRDEL_L1:
    6263/    1EEC : 78                  	LD	A,B
    6264/    1EED : 32 0C 23            	LD	(SECHEADER_DM),A
    6265/    1EF0 :                     
    6266/    1EF0 :                     		;
    6267/    1EF0 :                     		; write Deleted Mark
    6268/    1EF0 :                     		;
    6269/    1EF0 : CD CA 20            	CALL	SETSECSTAT
    6270/    1EF3 :                     
    6271/    1EF3 :                     		;
    6272/    1EF3 : E1                  	POP	HL
    6273/    1EF4 : CD AF 21            	CALL	FDDWRITESEC
    6274/    1EF7 : 18 14               	JR	DW_RWEND
    6275/    1EF9 :                     
    6276/    1EF9 :                     		;
    6277/    1EF9 :                     		; read data / read deleted data
    6278/    1EF9 :                     		;
    6279/    1EF9 :                     DW_RD_RDDEL:
    6280/    1EF9 : CD EC 20            	CALL	FDDREADSEC
    6281/    1EFC :                     
    6282/    1EFC : 3A 03 23            	LD	A,(SECSTAT)
    6283/    1EFF : FE B0               	CP	0B0H		; Data CRC Error
    6284/    1F01 : CA 8A 1F            	JP	Z,DW_DATACRCERR
    6285/    1F04 : 3A 02 23            	LD	A,(SECDELCOMP)
    6286/    1F07 : B7                  	OR	A		; equal Deleted Mark
    6287/    1F08 : C2 84 1F            	JP	NZ,DW_DELETEDMARK
    6288/    1F0B : 18 00               	JR	DW_RWEND
    6289/    1F0D :                     
    6290/    1F0D :                     
    6291/    1F0D :                     DW_RWEND:
    6292/    1F0D : DD 7E 29            	LD	A,(IX+FDD_EOT)
    6293/    1F10 : 47                  	LD	B,A
    6294/    1F11 : DD 7E 15            	LD	A,(IX+FDD_RST_R)
    6295/    1F14 : B8                  	CP	B
    6296/    1F15 : 28 0E               	JR	Z,DWL91
    6297/    1F17 :                     
    6298/    1F17 :                     		;
    6299/    1F17 :                     		; R <> EOT
    6300/    1F17 :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 106 - 2/18/2013 12:10:16


    6301/    1F17 : 3C                  	INC	A
    6302/    1F18 : DD 77 15            	LD	(IX+FDD_RST_R),A
    6303/    1F1B :                     
    6304/    1F1B : 3A 00 23            	LD	A,(SECACCFLAG)
    6305/    1F1E : E6 02               	AND	02H
    6306/    1F20 : C2 B2 1F            	JP	NZ,DISKEND
    6307/    1F23 : 18 3F               	JR	DW_SECEND
    6308/    1F25 :                     
    6309/    1F25 :                     DWL91:
    6310/    1F25 :                     		;
    6311/    1F25 :                     		; R = EOT
    6312/    1F25 :                     		;
    6313/    1F25 : 3E 01               	LD	A,01H
    6314/    1F27 : DD 77 15            	LD	(IX+FDD_RST_R),A
    6315/    1F2A :                     
    6316/    1F2A : DD CB 22 56         	BIT	2,(IX+FDD_MT)
    6317/    1F2E : 28 0E               	JR	Z,DW_CYEND
    6318/    1F30 :                     
    6319/    1F30 : DD 7E 14            	LD	A,(IX+FDD_RST_H)
    6320/    1F33 : EE 01               	XOR	01H
    6321/    1F35 : DD 77 14            	LD	(IX+FDD_RST_H),A
    6322/    1F38 :                     
    6323/    1F38 : DD 7E 24            	LD	A,(IX+FDD_HNUM)
    6324/    1F3B : B7                  	OR	A
    6325/    1F3C : 28 26               	JR	Z,DW_SECEND
    6326/    1F3E :                     
    6327/    1F3E :                     DW_CYEND:
    6328/    1F3E :                     		;
    6329/    1F3E :                     		; C <= +1
    6330/    1F3E :                     		;
    6331/    1F3E : DD 7E 13            	LD	A,(IX+FDD_RST_C)
    6332/    1F41 : 3C                  	INC	A
    6333/    1F42 : DD 77 13            	LD	(IX+FDD_RST_C),A
    6334/    1F45 :                     
    6335/    1F45 : 3A 00 23            	LD	A,(SECACCFLAG)
    6336/    1F48 : FE 01               	CP	01H
    6337/    1F4A : 28 4E               	JR	Z,DW_ENDCY
    6338/    1F4C :                     
    6339/    1F4C : 3A 00 23            	LD	A,(SECACCFLAG)
    6340/    1F4F : E6 02               	AND	02H
    6341/    1F51 : C2 B2 1F            	JP	NZ,DISKEND
    6342/    1F54 :                     
    6343/    1F54 : 3A 04 23            	LD	A,(COMPCY)
    6344/    1F57 : FE 01               	CP	01H
    6345/    1F59 : 28 45               	JR	Z,DW_BADCY
    6346/    1F5B : FE 02               	CP	02H
    6347/    1F5D : 28 47               	JR	Z,DW_WRONGCY
    6348/    1F5F : 18 49               	JR	DW_NOSEC
    6349/    1F61 :                     
    6350/    1F61 :                     DW_SECSKIP:
    6351/    1F61 : CD 27 21            	CALL	FDDSECSKIP
    6352/    1F64 :                     
    6353/    1F64 :                     DW_SECEND:
    6354/    1F64 : 2A FE 22            	LD	HL,(FDDSECNUM)
    6355/    1F67 : 2B                  	DEC	HL
    6356/    1F68 : 22 FE 22            	LD	(FDDSECNUM),HL
    6357/    1F6B : 7C                  	LD	A,H
    6358/    1F6C : B5                  	OR	L
    6359/    1F6D : C2 2F 1E            	JP	NZ,DWL_LP
    6360/    1F70 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 107 - 2/18/2013 12:10:16


    6361/    1F70 : 18 38               	JR	DW_NOSEC
    6362/    1F72 :                     
    6363/    1F72 :                     
    6364/    1F72 :                     DW_RDDIA:
    6365/    1F72 :                     DW_RDID:
    6366/    1F72 : 18 3A               	JR	DISKABEND
    6367/    1F74 :                     
    6368/    1F74 :                     DW_NOTWRITABLE:
    6369/    1F74 : DD CB 11 CE         	SET	1,(IX+FDD_ST1)
    6370/    1F78 : 18 34               	JR	DISKABEND
    6371/    1F7A :                     
    6372/    1F7A :                     DW_NODATA:
    6373/    1F7A : DD CB 11 C6         	SET	0,(IX+FDD_ST1)
    6374/    1F7E : DD CB 12 C6         	SET	0,(IX+FDD_ST2)
    6375/    1F82 : 18 2A               	JR	DISKABEND
    6376/    1F84 :                     
    6377/    1F84 :                     DW_DELETEDMARK:
    6378/    1F84 : DD CB 12 F6         	SET	6,(IX+FDD_ST2)
    6379/    1F88 : 18 24               	JR	DISKABEND
    6380/    1F8A :                     
    6381/    1F8A :                     DW_DATACRCERR:
    6382/    1F8A : DD CB 11 EE         	SET	5,(IX+FDD_ST1)
    6383/    1F8E : DD CB 12 EE         	SET	5,(IX+FDD_ST2)
    6384/    1F92 : 18 1A               	JR	DISKABEND
    6385/    1F94 :                     
    6386/    1F94 :                     DW_IDCRCERR:
    6387/    1F94 : DD CB 11 EE         	SET	5,(IX+FDD_ST1)
    6388/    1F98 : 18 14               	JR	DISKABEND
    6389/    1F9A :                     
    6390/    1F9A :                     DW_ENDCY:
    6391/    1F9A : DD CB 11 FE         	SET	7,(IX+FDD_ST1)
    6392/    1F9E : 18 0E               	JR	DISKABEND
    6393/    1FA0 :                     
    6394/    1FA0 :                     DW_BADCY:
    6395/    1FA0 : DD CB 12 CE         	SET	1,(IX+FDD_ST2)
    6396/    1FA4 : 18 04               	JR	DW_NOSEC
    6397/    1FA6 :                     
    6398/    1FA6 :                     DW_WRONGCY:
    6399/    1FA6 : DD CB 12 E6         	SET	4,(IX+FDD_ST2)
    6400/    1FAA :                     
    6401/    1FAA :                     DW_NOSEC:
    6402/    1FAA : DD CB 11 D6         	SET	2,(IX+FDD_ST1)
    6403/    1FAE :                     
    6404/    1FAE :                     DISKABEND:
    6405/    1FAE : DD CB 10 F6         	SET	6,(IX+FDD_ST0)
    6406/    1FB2 :                     
    6407/    1FB2 :                     DISKEND:
    6408/    1FB2 : AF                  	XOR	A
    6409/    1FB3 : 32 01 82            	LD	(REG_SDCTRL),A
    6410/    1FB6 : 3C                  	INC	A
    6411/    1FB7 : DD 77 17            	LD	(IX+FDD_ENDTRG),A
    6412/    1FBA :                     
    6413/    1FBA : C9                  	RET
    6414/    1FBB :                     
    6415/    1FBB :                     DISKOPEN:
    6416/    1FBB : 3E 01               	LD	A,01H
    6417/    1FBD : 32 01 82            	LD	(REG_SDCTRL),A
    6418/    1FC0 : 16 04               	LD	D,04H
    6419/    1FC2 : DD E5               	PUSH	IX
    6420/    1FC4 : C1                  	POP	BC
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 108 - 2/18/2013 12:10:16


    6421/    1FC5 : 21 10 83            	LD	HL,REG_INTFDD
    6422/    1FC8 : B7                  	OR	A
    6423/    1FC9 : ED 42               	SBC	HL,BC
    6424/    1FCB : 28 02               	JR	Z,DISKOPEN_L1
    6425/    1FCD : 06 06               	LD	B,06H
    6426/    1FCF :                     DISKOPEN_L1:
    6427/    1FCF : DD 7E 23            	LD	A,(IX+FDD_DNUM)
    6428/    1FD2 : 82                  	ADD	A,D
    6429/    1FD3 : 32 10 82            	LD	(REG_BUFAD),A
    6430/    1FD6 : 3E 01               	LD	A,01H
    6431/    1FD8 : 32 11 82            	LD	(REG_BUFSEL),A
    6432/    1FDB : C9                  	RET
    6433/    1FDC :                     
    6434/    1FDC :                     
    6435/    1FDC :                     ;
    6436/    1FDC :                     ; get disk sector address
    6437/    1FDC :                     ; (REG_BUFAD) <= use FIFO number
    6438/    1FDC :                     ; IY <= use FIFO number
    6439/    1FDC :                     ; B <= Cylinder number
    6440/    1FDC :                     ; C <= Head number
    6441/    1FDC :                     ;
    6442/    1FDC :                     ;
    6443/    1FDC :                     ; RETURN :
    6444/    1FDC :                     ; BCDE  <= disk sector address
    6445/    1FDC :                     ; Cflag <= 1 (no found sector address)
    6446/    1FDC :                     ;
    6447/    1FDC :                     GETDISKSECADD:
    6448/    1FDC : FD 7E 00            	LD	A,(IY+FIFO_CMTLEN+0)
    6449/    1FDF : FD B6 01            	OR	(IY+FIFO_CMTLEN+1)
    6450/    1FE2 : FD B6 02            	OR	(IY+FIFO_CMTLEN+2)
    6451/    1FE5 : FD B6 03            	OR	(IY+FIFO_CMTLEN+3)
    6452/    1FE8 : 37                  	SCF
    6453/    1FE9 : C8                  	RET	Z
    6454/    1FEA :                     
    6455/    1FEA : FD 7E 1F            	LD	A,(IY+FIFO_FDD)
    6456/    1FED : E6 02               	AND	02H
    6457/    1FEF : 28 0B               	JR	Z,GDL_FDD1D
    6458/    1FF1 :                     
    6459/    1FF1 : FD 7E 14            	LD	A,(IY+FIFO_FLOPPY)
    6460/    1FF4 : E6 02               	AND	02H
    6461/    1FF6 : 20 0E               	JR	NZ,GDL_X1
    6462/    1FF8 : CB 20               	SLA	B
    6463/    1FFA : 18 0A               	JR	GDL_X1
    6464/    1FFC :                     
    6465/    1FFC :                     GDL_FDD1D:
    6466/    1FFC : FD 7E 14            	LD	A,(IY+FIFO_FLOPPY)
    6467/    1FFF : E6 02               	AND	02H
    6468/    2001 : 28 03               	JR	Z,GDL_X1
    6469/    2003 : CB 38               	SRL	B
    6470/    2005 : D8                  	RET	C
    6471/    2006 :                     
    6472/    2006 :                     		;
    6473/    2006 :                     		; calc address offset
    6474/    2006 :                     		;
    6475/    2006 :                     GDL_X1:
    6476/    2006 : 26 00               	LD	H,00H
    6477/    2008 : 68                  	LD	L,B
    6478/    2009 : 29                  	ADD	HL,HL
    6479/    200A : 29                  	ADD	HL,HL
    6480/    200B : 29                  	ADD	HL,HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 109 - 2/18/2013 12:10:16


    6481/    200C : 79                  	LD	A,C
    6482/    200D : E6 01               	AND	01H
    6483/    200F : 87                  	ADD	A,A
    6484/    2010 : 87                  	ADD	A,A
    6485/    2011 : 5F                  	LD	E,A
    6486/    2012 : 16 00               	LD	D,00H
    6487/    2014 : 19                  	ADD	HL,DE
    6488/    2015 : 1E 20               	LD	E,20H
    6489/    2017 : 19                  	ADD	HL,DE
    6490/    2018 :                     
    6491/    2018 : EB                  	EX	DE,HL
    6492/    2019 : 01 00 00            	LD	BC,0000H
    6493/    201C : CD C6 0E            	CALL	JMPREADPTR
    6494/    201F :                     		;
    6495/    201F : CD F6 0E            	CALL	READ1BYTE
    6496/    2022 : 5F                  	LD	E,A
    6497/    2023 : CD F6 0E            	CALL	READ1BYTE
    6498/    2026 : 57                  	LD	D,A
    6499/    2027 : CD F6 0E            	CALL	READ1BYTE
    6500/    202A : 4F                  	LD	C,A
    6501/    202B : CD F6 0E            	CALL	READ1BYTE
    6502/    202E : 47                  	LD	B,A
    6503/    202F :                     
    6504/    202F : 78                  	LD	A,B
    6505/    2030 : B1                  	OR	C
    6506/    2031 : B2                  	OR	D
    6507/    2032 : B3                  	OR	E
    6508/    2033 : 37                  	SCF
    6509/    2034 : C8                  	RET	Z
    6510/    2035 : B7                  	OR	A
    6511/    2036 : C9                  	RET
    6512/    2037 :                     
    6513/    2037 :                     ; get sector status
    6514/    2037 :                     ; (REG_BUFAD) <= use FIFO number
    6515/    2037 :                     ; IY <= use FIFO number
    6516/    2037 :                     ; read pointer <= sector status address
    6517/    2037 :                     ;
    6518/    2037 :                     ; RETURN :
    6519/    2037 :                     ; read pointer <= sector address
    6520/    2037 :                     ; HL <= sector size
    6521/    2037 :                     ; DE <= sector number
    6522/    2037 :                     ; (SECIDRCOMP) <= result of comparation with IDR and FLOPPY
    6523/    2037 :                     ; (SECDELCOMP) <= result of comparation with DELETED MARK and command
    6524/    2037 :                     ; (SECSTAT)    <= sector status
    6525/    2037 :                     ; (COMPCY)     <= result of comparation with IDR-C and FLOPPY-C
    6526/    2037 :                     ; (SECHEADER)  <= read sector header (16 bytes)
    6527/    2037 :                     ;
    6528/    2037 :                     GETSECSTAT:
    6529/    2037 :                     
    6530/    2037 : 21 05 23            	LD	HL,SECHEADER
    6531/    203A : CD F6 0E            	CALL	READ1BYTE	; C
    6532/    203D : 77                  	LD	(HL),A
    6533/    203E : 23                  	INC	HL
    6534/    203F : 4F                  	LD	C,A
    6535/    2040 : DD AE 13            	XOR	(IX+FDD_RST_C)
    6536/    2043 : 47                  	LD	B,A
    6537/    2044 : 28 09               	JR	Z,GSS_L0
    6538/    2046 : 79                  	LD	A,C
    6539/    2047 : FE FF               	CP	0FFH
    6540/    2049 : 3E 01               	LD	A,01H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 110 - 2/18/2013 12:10:16


    6541/    204B : 28 02               	JR	Z,GSS_L0
    6542/    204D : 3E 02               	LD	A,02H
    6543/    204F :                     GSS_L0:
    6544/    204F : 32 04 23            	LD	(COMPCY),A
    6545/    2052 : CD F6 0E            	CALL	READ1BYTE	; H
    6546/    2055 : 77                  	LD	(HL),A
    6547/    2056 : 23                  	INC	HL
    6548/    2057 : DD AE 14            	XOR	(IX+FDD_RST_H)
    6549/    205A : B0                  	OR	B
    6550/    205B : 47                  	LD	B,A
    6551/    205C : CD F6 0E            	CALL	READ1BYTE	; R
    6552/    205F : 77                  	LD	(HL),A
    6553/    2060 : 23                  	INC	HL
    6554/    2061 : DD AE 15            	XOR	(IX+FDD_RST_R)
    6555/    2064 : B0                  	OR	B
    6556/    2065 : 47                  	LD	B,A
    6557/    2066 : CD F6 0E            	CALL	READ1BYTE	; N
    6558/    2069 : 77                  	LD	(HL),A
    6559/    206A : 23                  	INC	HL
    6560/    206B : DD AE 16            	XOR	(IX+FDD_RST_N)
    6561/    206E : B0                  	OR	B
    6562/    206F : 47                  	LD	B,A
    6563/    2070 : CD F6 0E            	CALL	READ1BYTE	; sector number
    6564/    2073 : 77                  	LD	(HL),A
    6565/    2074 : 23                  	INC	HL
    6566/    2075 : 5F                  	LD	E,A
    6567/    2076 : CD F6 0E            	CALL	READ1BYTE	; sector number
    6568/    2079 : 77                  	LD	(HL),A
    6569/    207A : 23                  	INC	HL
    6570/    207B : 57                  	LD	D,A
    6571/    207C : D5                  	PUSH	DE
    6572/    207D :                     
    6573/    207D : CD F6 0E            	CALL	READ1BYTE	; FM/MFM
    6574/    2080 : 77                  	LD	(HL),A
    6575/    2081 : 23                  	INC	HL
    6576/    2082 : 4F                  	LD	C,A
    6577/    2083 : DD 7E 22            	LD	A,(IX+FDD_MT)
    6578/    2086 : 2F                  	CPL
    6579/    2087 : E6 02               	AND	02H
    6580/    2089 : 0F                  	RRCA
    6581/    208A : 0F                  	RRCA
    6582/    208B : 0F                  	RRCA
    6583/    208C : A9                  	XOR	C
    6584/    208D : B0                  	OR	B
    6585/    208E : 32 01 23            	LD	(SECIDRCOMP),A
    6586/    2091 :                     
    6587/    2091 : 0E 00               	LD	C,00H
    6588/    2093 : DD 7E 21            	LD	A,(IX+FDD_COMMAND)
    6589/    2096 : FE 0C               	CP	CMD_RDDELDATA
    6590/    2098 : 20 02               	JR	NZ,GSS_L1
    6591/    209A : 0E 10               	LD	C,10H
    6592/    209C : CD F6 0E            GSS_L1:	CALL	READ1BYTE	; DELETED MARK
    6593/    209F : 77                  	LD	(HL),A
    6594/    20A0 : 23                  	INC	HL
    6595/    20A1 : A9                  	XOR	C
    6596/    20A2 : 32 02 23            	LD	(SECDELCOMP),A
    6597/    20A5 :                     
    6598/    20A5 : CD F6 0E            	CALL	READ1BYTE	; STATUS
    6599/    20A8 : 77                  	LD	(HL),A
    6600/    20A9 : 23                  	INC	HL
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 111 - 2/18/2013 12:10:16


    6601/    20AA : FE 10               	CP	10H
    6602/    20AC : 20 01               	JR	NZ,GSS_L2
    6603/    20AE : AF                  	XOR	A
    6604/    20AF : 32 03 23            GSS_L2:	LD	(SECSTAT),A
    6605/    20B2 :                     
    6606/    20B2 : 06 05               	LD	B,05H
    6607/    20B4 : CD F6 0E            GSS_L3:	CALL	READ1BYTE	; reserved
    6608/    20B7 : 77                  	LD	(HL),A
    6609/    20B8 : 23                  	INC	HL
    6610/    20B9 : 10 F9               	DJNZ	GSS_L3
    6611/    20BB :                     
    6612/    20BB : CD F6 0E            	CALL	READ1BYTE	; sector size
    6613/    20BE : 77                  	LD	(HL),A
    6614/    20BF : 23                  	INC	HL
    6615/    20C0 : 5F                  	LD	E,A
    6616/    20C1 : CD F6 0E            	CALL	READ1BYTE	; sector size
    6617/    20C4 : 77                  	LD	(HL),A
    6618/    20C5 : 23                  	INC	HL
    6619/    20C6 : 57                  	LD	D,A
    6620/    20C7 :                     
    6621/    20C7 : EB                  	EX	DE,HL
    6622/    20C8 : D1                  	POP	DE
    6623/    20C9 : C9                  	RET
    6624/    20CA :                     
    6625/    20CA :                     ; set sector status
    6626/    20CA :                     ; (REG_BUFAD) <= use FIFO number
    6627/    20CA :                     ; IY <= use FIFO number
    6628/    20CA :                     ; read pointer <= sector status address
    6629/    20CA :                     ; (SECHEADER)  <= read sector header (16 bytes)
    6630/    20CA :                     ;
    6631/    20CA :                     ; RETURN :
    6632/    20CA :                     ; read pointer <= sector address
    6633/    20CA :                     ;
    6634/    20CA :                     SETSECSTAT:
    6635/    20CA :                     
    6636/    20CA : 06 10               	LD	B,10H
    6637/    20CC : 21 05 23            	LD	HL,SECHEADER
    6638/    20CF :                     
    6639/    20CF :                     SSS_L1:
    6640/    20CF : 7E                  	LD	A,(HL)
    6641/    20D0 : CD 64 0F            	CALL	WRITE1BYTE
    6642/    20D3 : 23                  	INC	HL
    6643/    20D4 : 10 F9               	DJNZ	SSS_L1
    6644/    20D6 :                     
    6645/    20D6 :                     		;
    6646/    20D6 :                     		; 1 sector write
    6647/    20D6 :                     		;
    6648/    20D6 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    6649/    20D9 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    6650/    20DC : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    6651/    20DF : CD 03 12            	CALL	CALCSDADD
    6652/    20E2 :                     		;
    6653/    20E2 : 21 A4 22            	LD	HL,WORK
    6654/    20E5 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    6655/    20E8 :                     		;
    6656/    20E8 : CD AA 13            	CALL	WRITE1SEC
    6657/    20EB :                     
    6658/    20EB : C9                  	RET
    6659/    20EC :                     
    6660/    20EC :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 112 - 2/18/2013 12:10:16


    6661/    20EC :                     
    6662/    20EC :                     ; read sector from FDD
    6663/    20EC :                     ; (REG_BUFAD) <= use FIFO number
    6664/    20EC :                     ; IY <= use FIFO number
    6665/    20EC :                     ; HL <= sector bytes
    6666/    20EC :                     ; read pointer <= sector status address
    6667/    20EC :                     ; (DMABUFFERADD)  <= DMA buffer address
    6668/    20EC :                     ; (DMATRANSBYTES) <= DMA transfer bytes
    6669/    20EC :                     ;
    6670/    20EC :                     ; RETURN :
    6671/    20EC :                     ; read pointer <= sector address
    6672/    20EC :                     ; (DMABUFFERADD)  <= DMA buffer address
    6673/    20EC :                     ; (DMATRANSBYTES) <= DMA transfer bytes
    6674/    20EC :                     ; (SECACCFLAG) <= set flag
    6675/    20EC :                     ;
    6676/    20EC :                     FDDREADSEC:
    6677/    20EC : ED 4B 17 23         	LD	BC,(DMABUFFERADD)
    6678/    20F0 : ED 5B 15 23         	LD	DE,(DMATRANSBYTES)
    6679/    20F4 :                     FRSL1:
    6680/    20F4 : CD F6 0E            	CALL	READ1BYTE
    6681/    20F7 : 02                  	LD	(BC),A
    6682/    20F8 : 78                  	LD	A,B
    6683/    20F9 : E6 F0               	AND	0F0H
    6684/    20FB : FE 90               	CP	DISKBUF_U
    6685/    20FD : 03                  	INC	BC
    6686/    20FE : 78                  	LD	A,B
    6687/    20FF : 20 06               	JR	NZ,FRSL2
    6688/    2101 :                     
    6689/    2101 :                     		; internal FDD (0x9000 - 0x93FF)
    6690/    2101 : E6 03               	AND	03H
    6691/    2103 : F6 90               	OR	DISKBUF_U
    6692/    2105 : 18 04               	JR	FRSL3
    6693/    2107 :                     
    6694/    2107 :                     FRSL2:
    6695/    2107 :                     		; external FDD (0xB000 - 0xBFFF)
    6696/    2107 : E6 0F               	AND	0FH
    6697/    2109 : F6 B0               	OR	EXTRDBUF_U
    6698/    210B :                     
    6699/    210B :                     FRSL3:
    6700/    210B : 47                  	LD	B,A
    6701/    210C :                     
    6702/    210C : 13                  	INC	DE
    6703/    210D : 7A                  	LD	A,D
    6704/    210E : FE 0F               	CP	0FH
    6705/    2110 : 3E 03               	LD	A,03H
    6706/    2112 : 28 07               	JR	Z,FRS_END
    6707/    2114 :                     
    6708/    2114 : 2B                  	DEC	HL
    6709/    2115 : 7C                  	LD	A,H
    6710/    2116 : B5                  	OR	L
    6711/    2117 : 20 DB               	JR	NZ,FRSL1
    6712/    2119 :                     
    6713/    2119 : 3E 01               	LD	A,01H
    6714/    211B :                     
    6715/    211B :                     FRS_END:
    6716/    211B : 32 00 23            	LD	(SECACCFLAG),A
    6717/    211E : ED 43 17 23         	LD	(DMABUFFERADD),BC
    6718/    2122 : ED 53 15 23         	LD	(DMATRANSBYTES),DE
    6719/    2126 : C9                  	RET
    6720/    2127 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 113 - 2/18/2013 12:10:16


    6721/    2127 :                     
    6722/    2127 :                     ;
    6723/    2127 :                     ; skip 1 sector
    6724/    2127 :                     ; (REG_BUFAD) <= use FIFO number
    6725/    2127 :                     ; IY <= use FIFO number
    6726/    2127 :                     ; HL <= sector bytes
    6727/    2127 :                     ; read pointer <= sector status address
    6728/    2127 :                     ;
    6729/    2127 :                     ; RETURN :
    6730/    2127 :                     ; read pointer <= sector address
    6731/    2127 :                     ;
    6732/    2127 :                     FDDSECSKIP:
    6733/    2127 :                     
    6734/    2127 : EB                  	EX	DE,HL
    6735/    2128 :                     
    6736/    2128 :                     FSS_L3:
    6737/    2128 : FD 6E 04            	LD	L,(IY+FIFO_CMTPTR+0)
    6738/    212B : FD 66 05            	LD	H,(IY+FIFO_CMTPTR+1)
    6739/    212E : 7C                  	LD	A,H
    6740/    212F : 19                  	ADD	HL,DE
    6741/    2130 : 38 0C               	JR	C,FSS_L1
    6742/    2132 : AC                  	XOR	H
    6743/    2133 : E6 FE               	AND	0FEH
    6744/    2135 : 20 07               	JR	NZ,FSS_L1
    6745/    2137 :                     
    6746/    2137 : FD 75 04            	LD	(IY+FIFO_CMTPTR+0),L
    6747/    213A : FD 74 05            	LD	(IY+FIFO_CMTPTR+1),H
    6748/    213D : C9                  	RET
    6749/    213E :                     
    6750/    213E :                     FSS_L1:
    6751/    213E : 21 00 02            	LD	HL,0200H
    6752/    2141 : FD 4E 04            	LD	C,(IY+FIFO_CMTPTR+0)
    6753/    2144 : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    6754/    2147 : E6 01               	AND	01H
    6755/    2149 : 47                  	LD	B,A
    6756/    214A : B7                  	OR	A
    6757/    214B : ED 42               	SBC	HL,BC
    6758/    214D :                     
    6759/    214D : EB                  	EX	DE,HL
    6760/    214E : B7                  	OR	A
    6761/    214F : ED 52               	SBC	HL,DE
    6762/    2151 : EB                  	EX	DE,HL
    6763/    2152 :                     
    6764/    2152 : AF                  	XOR	A
    6765/    2153 : FD 77 04            	LD	(IY+FIFO_CMTPTR+0),A
    6766/    2156 : FD 7E 05            	LD	A,(IY+FIFO_CMTPTR+1)
    6767/    2159 : E6 FE               	AND	0FEH
    6768/    215B : C6 02               	ADD	A,02H
    6769/    215D : FD 77 05            	LD	(IY+FIFO_CMTPTR+1),A
    6770/    2160 : FD 7E 06            	LD	A,(IY+FIFO_CMTPTR+2)
    6771/    2163 : CE 00               	ADC	A,00H
    6772/    2165 : FD 77 06            	LD	(IY+FIFO_CMTPTR+2),A
    6773/    2168 : FD 7E 07            	LD	A,(IY+FIFO_CMTPTR+3)
    6774/    216B : CE 00               	ADC	A,00H
    6775/    216D : FD 77 07            	LD	(IY+FIFO_CMTPTR+3),A
    6776/    2170 :                     
    6777/    2170 : D5                  	PUSH	DE
    6778/    2171 :                     
    6779/    2171 :                     
    6780/    2171 :                     		;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 114 - 2/18/2013 12:10:16


    6781/    2171 :                     		; sector ++
    6782/    2171 :                     		;
    6783/    2171 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    6784/    2174 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    6785/    2177 : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    6786/    217A : E5                  	PUSH	HL
    6787/    217B : CD 3B 12            	CALL	GET_NEXTSEC
    6788/    217E : FD 75 08            	LD	(IY+FIFO_CL+0),L
    6789/    2181 : FD 74 09            	LD	(IY+FIFO_CL+1),H
    6790/    2184 : FD 77 0A            	LD	(IY+FIFO_SEC),A
    6791/    2187 :                     		;
    6792/    2187 : E1                  	POP	HL
    6793/    2188 : B7                  	OR	A
    6794/    2189 : 20 06               	JR	NZ,FSS_L2
    6795/    218B :                     		;
    6796/    218B : FD 75 0D            	LD	(IY+FIFO_BEFCL+0),L
    6797/    218E : FD 74 0E            	LD	(IY+FIFO_BEFCL+1),H
    6798/    2191 :                     		;
    6799/    2191 :                     
    6800/    2191 :                     		;
    6801/    2191 :                     		; 1 sector read
    6802/    2191 :                     		;
    6803/    2191 :                     FSS_L2:
    6804/    2191 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    6805/    2194 : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    6806/    2197 : 7D                  	LD	A,L
    6807/    2198 : B4                  	OR	H
    6808/    2199 : CA 11 14            	JP	Z,SDERR
    6809/    219C : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    6810/    219F : CD 03 12            	CALL	CALCSDADD
    6811/    21A2 :                     		;
    6812/    21A2 : 21 A4 22            	LD	HL,WORK
    6813/    21A5 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    6814/    21A8 :                     		;
    6815/    21A8 : CD 8D 13            	CALL	READ1SEC
    6816/    21AB :                     		;
    6817/    21AB :                     
    6818/    21AB : D1                  	POP	DE
    6819/    21AC : C3 28 21            	JP	FSS_L3
    6820/    21AF :                     
    6821/    21AF :                     
    6822/    21AF :                     
    6823/    21AF :                     ; write sector to FDD
    6824/    21AF :                     ; (REG_BUFAD) <= use FIFO number
    6825/    21AF :                     ; IY <= use FIFO number
    6826/    21AF :                     ; HL <= sector bytes
    6827/    21AF :                     ; read(write) pointer <= sector status address
    6828/    21AF :                     ; (DMABUFFERADD)  <= DMA buffer address
    6829/    21AF :                     ; (DMATRANSBYTES) <= DMA transfer bytes
    6830/    21AF :                     ;
    6831/    21AF :                     ; RETURN :
    6832/    21AF :                     ; read(write) pointer <= sector address
    6833/    21AF :                     ; (DMABUFFERADD)  <= DMA buffer address
    6834/    21AF :                     ; (DMATRANSBYTES) <= DMA transfer bytes
    6835/    21AF :                     ; (SECACCFLAG) <= set flag
    6836/    21AF :                     ;
    6837/    21AF :                     FDDWRITESEC:
    6838/    21AF : ED 4B 17 23         	LD	BC,(DMABUFFERADD)
    6839/    21B3 : ED 5B 15 23         	LD	DE,(DMATRANSBYTES)
    6840/    21B7 :                     
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 115 - 2/18/2013 12:10:16


    6841/    21B7 :                     FWSL1:
    6842/    21B7 : 0A                  	LD	A,(BC)
    6843/    21B8 : CD 64 0F            	CALL	WRITE1BYTE
    6844/    21BB : 78                  	LD	A,B
    6845/    21BC : E6 F0               	AND	0F0H
    6846/    21BE : FE 90               	CP	DISKBUF_U
    6847/    21C0 : 03                  	INC	BC
    6848/    21C1 : 78                  	LD	A,B
    6849/    21C2 : 20 06               	JR	NZ,FWSL2
    6850/    21C4 :                     
    6851/    21C4 :                     		; internal FDD (0x9000 - 0x93FF)
    6852/    21C4 : E6 03               	AND	03H
    6853/    21C6 : F6 90               	OR	DISKBUF_U
    6854/    21C8 : 18 04               	JR	FWSL3
    6855/    21CA :                     
    6856/    21CA :                     FWSL2:
    6857/    21CA :                     		; external FDD (0xA000 - 0xAFFF)
    6858/    21CA : E6 0F               	AND	0FH
    6859/    21CC : F6 A0               	OR	EXTWRBUF_U
    6860/    21CE :                     
    6861/    21CE :                     FWSL3:
    6862/    21CE : 47                  	LD	B,A
    6863/    21CF :                     
    6864/    21CF : 13                  	INC	DE
    6865/    21D0 : 7A                  	LD	A,D
    6866/    21D1 : FE 0F               	CP	0FH
    6867/    21D3 : 3E 03               	LD	A,03H
    6868/    21D5 : 28 07               	JR	Z,FWS_END
    6869/    21D7 :                     
    6870/    21D7 : 2B                  	DEC	HL
    6871/    21D8 : 7C                  	LD	A,H
    6872/    21D9 : B5                  	OR	L
    6873/    21DA : 20 DB               	JR	NZ,FWSL1
    6874/    21DC :                     
    6875/    21DC : 3E 01               	LD	A,01H
    6876/    21DE :                     
    6877/    21DE :                     FWS_END:
    6878/    21DE : 32 00 23            	LD	(SECACCFLAG),A
    6879/    21E1 : ED 43 17 23         	LD	(DMABUFFERADD),BC
    6880/    21E5 : ED 53 15 23         	LD	(DMATRANSBYTES),DE
    6881/    21E9 :                     
    6882/    21E9 :                     		;
    6883/    21E9 :                     		; 1 sector write
    6884/    21E9 :                     		;
    6885/    21E9 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    6886/    21EC : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    6887/    21EF : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    6888/    21F2 : CD 03 12            	CALL	CALCSDADD
    6889/    21F5 :                     		;
    6890/    21F5 : 21 A4 22            	LD	HL,WORK
    6891/    21F8 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    6892/    21FB :                     		;
    6893/    21FB : CD AA 13            	CALL	WRITE1SEC
    6894/    21FE :                     
    6895/    21FE : C9                  	RET
    6896/    21FF :                     
    6897/    21FF :                     
    6898/    21FF :                     ; write ID to FDD
    6899/    21FF :                     ; (REG_BUFAD) <= use FIFO number
    6900/    21FF :                     ; IY <= use FIFO number
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 116 - 2/18/2013 12:10:16


    6901/    21FF :                     ; read(write) pointer <= sector status address
    6902/    21FF :                     ; (DMABUFFERADD)  <= DMA buffer address
    6903/    21FF :                     ; (DMATRANSBYTES) <= DMA transfer bytes
    6904/    21FF :                     ; (IX+FDD_IDRC)   <= N   (data length of 1 sector)
    6905/    21FF :                     ; (IX+FDD_IDRH)   <= SC  (sector number of 1 track)
    6906/    21FF :                     ; (IX+FDD_IDRN)   <= D   (data pattern)
    6907/    21FF :                     ;
    6908/    21FF :                     ; RETURN :
    6909/    21FF :                     ; read(write) pointer <= sector address
    6910/    21FF :                     ; (DMABUFFERADD)  <= DMA buffer address
    6911/    21FF :                     ; (DMATRANSBYTES) <= DMA transfer bytes
    6912/    21FF :                     ; (SECACCFLAG) <= set flag
    6913/    21FF :                     ;
    6914/    21FF :                     FDDWRITEID:
    6915/    21FF : 21 04 00            	LD	HL,0004H
    6916/    2202 : ED 4B 17 23         	LD	BC,(DMABUFFERADD)
    6917/    2206 : ED 5B 15 23         	LD	DE,(DMATRANSBYTES)
    6918/    220A :                     
    6919/    220A :                     FWDL1:
    6920/    220A : 0A                  	LD	A,(BC)
    6921/    220B : CD 64 0F            	CALL	WRITE1BYTE
    6922/    220E :                     
    6923/    220E : 78                  	LD	A,B
    6924/    220F : E6 F0               	AND	0F0H
    6925/    2211 : FE 90               	CP	DISKBUF_U
    6926/    2213 : 03                  	INC	BC
    6927/    2214 : 78                  	LD	A,B
    6928/    2215 : 20 06               	JR	NZ,FWDL2
    6929/    2217 :                     
    6930/    2217 :                     		; internal FDD (0x9000 - 0x93FF)
    6931/    2217 : E6 03               	AND	03H
    6932/    2219 : F6 90               	OR	DISKBUF_U
    6933/    221B : 18 04               	JR	FWDL3
    6934/    221D :                     
    6935/    221D :                     FWDL2:
    6936/    221D :                     		; external FDD (0xA000 - 0xAFFF)
    6937/    221D : E6 0F               	AND	0FH
    6938/    221F : F6 A0               	OR	EXTWRBUF_U
    6939/    2221 :                     
    6940/    2221 :                     FWDL3:
    6941/    2221 : 47                  	LD	B,A
    6942/    2222 :                     
    6943/    2222 : 13                  	INC	DE
    6944/    2223 : 7A                  	LD	A,D
    6945/    2224 : FE 0F               	CP	0FH
    6946/    2226 : 3E 03               	LD	A,03H
    6947/    2228 : 28 02               	JR	Z,FWDL4
    6948/    222A : 3E 01               	LD	A,01H
    6949/    222C :                     FWDL4:
    6950/    222C : 32 00 23            	LD	(SECACCFLAG),A
    6951/    222F :                     
    6952/    222F : 2B                  	DEC	HL
    6953/    2230 : 7C                  	LD	A,H
    6954/    2231 : B5                  	OR	L
    6955/    2232 : 20 D6               	JR	NZ,FWDL1
    6956/    2234 :                     
    6957/    2234 : ED 43 17 23         	LD	(DMABUFFERADD),BC
    6958/    2238 : ED 53 15 23         	LD	(DMATRANSBYTES),DE
    6959/    223C :                     
    6960/    223C : DD 7E 26            	LD	A,(IX+FDD_IDRH)
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 117 - 2/18/2013 12:10:16


    6961/    223F : CD 64 0F            	CALL	WRITE1BYTE		; sector number of 1 track
    6962/    2242 : AF                  	XOR	A
    6963/    2243 : CD 64 0F            	CALL	WRITE1BYTE		; sector number of 1 track
    6964/    2246 :                     
    6965/    2246 : DD 7E 22            	LD	A,(IX+FDD_MT)
    6966/    2249 : 2F                  	CPL
    6967/    224A : E6 02               	AND	02H
    6968/    224C : 0F                  	RRCA
    6969/    224D : 0F                  	RRCA
    6970/    224E : 0F                  	RRCA
    6971/    224F : CD 64 0F            	CALL	WRITE1BYTE		; FM/MFM
    6972/    2252 :                     
    6973/    2252 : 06 07               	LD	B,07H
    6974/    2254 :                     FWDL5:
    6975/    2254 : AF                  	XOR	A
    6976/    2255 : CD 64 0F            	CALL	WRITE1BYTE		; Deleted Mark / status / reserved x 5
    6977/    2258 : 10 FA               	DJNZ	FWDL5
    6978/    225A :                     
    6979/    225A : DD 46 25            	LD	B,(IX+FDD_IDRC) 	; sector length
    6980/    225D : 04                  	INC	B
    6981/    225E : 21 40 00            	LD	HL,0040H
    6982/    2261 :                     FWDL6:
    6983/    2261 : 29                  	ADD	HL,HL
    6984/    2262 : 10 FD               	DJNZ	FWDL6
    6985/    2264 : 7D                  	LD	A,L
    6986/    2265 : CD 64 0F            	CALL	WRITE1BYTE		; sector length
    6987/    2268 : 7C                  	LD	A,H
    6988/    2269 : CD 64 0F            	CALL	WRITE1BYTE		; sector length
    6989/    226C :                     
    6990/    226C :                     FWDL7:
    6991/    226C : DD 7E 28            	LD	A,(IX+FDD_IDRN)		; data pattern
    6992/    226F : CD 64 0F            	CALL	WRITE1BYTE
    6993/    2272 : 2B                  	DEC	HL
    6994/    2273 : 7C                  	LD	A,H
    6995/    2274 : B5                  	OR	L
    6996/    2275 : 20 F5               	JR	NZ,FWDL7
    6997/    2277 :                     
    6998/    2277 :                     		;
    6999/    2277 :                     		; 1 sector write
    7000/    2277 :                     		;
    7001/    2277 : FD 6E 08            	LD	L,(IY+FIFO_CL+0)
    7002/    227A : FD 66 09            	LD	H,(IY+FIFO_CL+1)
    7003/    227D : FD 7E 0A            	LD	A,(IY+FIFO_SEC)
    7004/    2280 : CD 03 12            	CALL	CALCSDADD
    7005/    2283 :                     		;
    7006/    2283 : 21 A4 22            	LD	HL,WORK
    7007/    2286 : CD 7B 13            	CALL	LD4B_REG_SDADD_MHL
    7008/    2289 :                     		;
    7009/    2289 : CD AA 13            	CALL	WRITE1SEC
    7010/    228C :                     
    7011/    228C : C9                  	RET
    7012/    228D :                     
    7013/    228D :                     
    7014/    228D :                     
    7015/    228D :                     ;
    7016/    228D :                     ; offset address
    7017/    228D :                     ;
    7018/    228D : 00 00 00 00         OFFSET:		DB	00H,00H,00H,00H
    7019/    2291 :                     
    7020/    2291 :                     ;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 118 - 2/18/2013 12:10:16


    7021/    2291 :                     ; FAT start address
    7022/    2291 :                     ;
    7023/    2291 : 00 00 00 00         FATST:		DB	00H,00H,00H,00H
    7024/    2295 :                     
    7025/    2295 :                     ;
    7026/    2295 :                     ; FAT use sector number
    7027/    2295 :                     ;
    7028/    2295 : 00 00               FATSEC:		DB	00H,00H
    7029/    2297 :                     
    7030/    2297 :                     ;
    7031/    2297 :                     ; root directory start address
    7032/    2297 :                     ;
    7033/    2297 : 00 00 00 00         ROOTST:		DB	00H,00H,00H,00H
    7034/    229B :                     
    7035/    229B :                     ;
    7036/    229B :                     ; claster start address (claster number is #2)
    7037/    229B :                     ;
    7038/    229B : 00 00 00 00         CLASTST:	DB	00H,00H,00H,00H
    7039/    229F :                     
    7040/    229F :                     ;
    7041/    229F :                     ; claster size (x512 byte)
    7042/    229F :                     ;
    7043/    229F : 00                  CLASTSIZE:	DB	00H
    7044/    22A0 :                     
    7045/    22A0 :                     ;
    7046/    22A0 :                     ; directory start address (temporary)
    7047/    22A0 :                     ;
    7048/    22A0 : 00 00               DIRCL:		DB	00H,00H
    7049/    22A2 :                     
    7050/    22A2 :                     ;
    7051/    22A2 :                     ; directory file pointer (temporary)
    7052/    22A2 :                     ;
    7053/    22A2 : 00 00               DIRPOS:		DB	00H,00H
    7054/    22A4 :                     
    7055/    22A4 :                     ;
    7056/    22A4 :                     ; 4 byte calc work
    7057/    22A4 :                     ;
    7058/    22A4 : 00 00 00 00         WORK:		DB	00H,00H,00H,00H
    7059/    22A8 : 00 00 00 00         WORK2:		DB	00H,00H,00H,00H
    7060/    22AC : 00 00 00 00         WORK3:		DB	00H,00H,00H,00H
    7061/    22B0 : 00 00 00 00         WORK4:		DB	00H,00H,00H,00H
    7062/    22B4 :                     
    7063/    22B4 :                     ;
    7064/    22B4 :                     ; return mode of SD error
    7065/    22B4 :                     ;
    7066/    22B4 : 00                  SDMODE:		DB	00H
    7067/    22B5 :                     
    7068/    22B5 :                     ;
    7069/    22B5 :                     ; read flag
    7070/    22B5 :                     ;
    7071/    22B5 :                     ; 00H : no selected file
    7072/    22B5 :                     ; 01H : selected and no read
    7073/    22B5 :                     ; 02H : selected and reading
    7074/    22B5 :                     ;
    7075/    22B5 : 00                  READFLAG	DB	00H
    7076/    22B6 :                     
    7077/    22B6 :                     ;
    7078/    22B6 :                     ; write flag
    7079/    22B6 :                     ;
    7080/    22B6 :                     ; 00H : no selected file
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 119 - 2/18/2013 12:10:16


    7081/    22B6 :                     ; 01H : selected and CMTwrite not open
    7082/    22B6 :                     ; 02H : selected and CMTwrite open
    7083/    22B6 :                     ;
    7084/    22B6 : 00                  WRITEFLAG	DB	00H
    7085/    22B7 :                     
    7086/    22B7 :                     ;
    7087/    22B7 :                     ; SD write protect latch
    7088/    22B7 :                     ;
    7089/    22B7 : 00                  SDWPFLAG	DB	00H
    7090/    22B8 :                     
    7091/    22B8 :                     ;
    7092/    22B8 :                     ; display page number
    7093/    22B8 :                     ;
    7094/    22B8 : 00                  PAGENUM		DB	00H
    7095/    22B9 :                     
    7096/    22B9 :                     ;
    7097/    22B9 :                     ; befoer page number
    7098/    22B9 :                     ;
    7099/    22B9 : 00                  BEFPAGENUM	DB	00H
    7100/    22BA :                     
    7101/    22BA :                     ;
    7102/    22BA :                     ; display page redraw
    7103/    22BA :                     ;
    7104/    22BA : 00                  PAGEREDRAW	DB	00H
    7105/    22BB :                     
    7106/    22BB :                     ;
    7107/    22BB :                     ; cursur redraw
    7108/    22BB :                     ;
    7109/    22BB : 00                  CURSORREDRAW	DB	00H
    7110/    22BC :                     
    7111/    22BC :                     ;
    7112/    22BC :                     ; file selecter CMT/EXT.ROM
    7113/    22BC :                     ; CMT load : 04H
    7114/    22BC :                     ; ROM load : 05H
    7115/    22BC :                     ; FDD load : 06H
    7116/    22BC :                     ; CMT save : 0CH
    7117/    22BC :                     ; FDD save : 0EH
    7118/    22BC :                     ;
    7119/    22BC : 00                  FILESEL		DB	00H
    7120/    22BD :                     
    7121/    22BD :                     ;
    7122/    22BD :                     ; extend rom on/off
    7123/    22BD :                     ;
    7124/    22BD : 00                  EXROMFLAG	DB	00H
    7125/    22BE :                     
    7126/    22BE :                     ;
    7127/    22BE :                     ; search file type
    7128/    22BE :                     ; 00H:file
    7129/    22BE :                     ; 10H:directory
    7130/    22BE :                     ;
    7131/    22BE : 00                  SEARCHTYPE	DB	00H
    7132/    22BF :                     
    7133/    22BF :                     ;
    7134/    22BF :                     ; SD insert / eject detect timer
    7135/    22BF :                     ;
    7136/    22BF : 00 00               SDDETTIMER	DB	00H,00H
    7137/    22C1 :                     
    7138/    22C1 :                     ;
    7139/    22C1 :                     ; external FDD status
    7140/    22C1 :                     ;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 120 - 2/18/2013 12:10:16


    7141/    22C1 : 00                  EXTFDDST	DB	00H
    7142/    22C2 :                     
    7143/    22C2 :                     ;
    7144/    22C2 :                     ; external FDD command
    7145/    22C2 :                     ;
    7146/    22C2 : 00                  EXTFDDCMD	DB	00H
    7147/    22C3 :                     
    7148/    22C3 :                     ;
    7149/    22C3 :                     ; external FDD command receive length
    7150/    22C3 :                     ; bit7:data flag
    7151/    22C3 :                     ;
    7152/    22C3 : 00                  EXTFDDRLEN	DB	00H
    7153/    22C4 :                     
    7154/    22C4 :                     ;
    7155/    22C4 :                     ; external FDD command send length
    7156/    22C4 :                     ; bit7:data flag
    7157/    22C4 :                     ;
    7158/    22C4 : 00                  EXTFDDSLEN	DB	00H
    7159/    22C5 :                     
    7160/    22C5 :                     ;
    7161/    22C5 :                     ; external FDD command parameter buffer
    7162/    22C5 :                     ;
    7163/    22C5 : 00 00 00 00 00 00   EXTFDDPARA	DB	00H,00H,00H,00H,00H,00H,00H
                    00 
    7164/    22CC :                     
    7165/    22CC :                     ;
    7166/    22CC :                     ; external FDD command parameter pointer
    7167/    22CC :                     ;
    7168/    22CC : 00 00               EXTFDDPTR	DW	0000H
    7169/    22CE :                     
    7170/    22CE :                     ;
    7171/    22CE :                     ; external FDD command data length
    7172/    22CE :                     ;
    7173/    22CE : 00 00               EXTFDDDTLEN	DB	00H,00H
    7174/    22D0 :                     
    7175/    22D0 :                     ;
    7176/    22D0 :                     ; external FDD command table (receive length / send length)
    7177/    22D0 :                     ;
    7178/    22D0 : 00 00               EXTFDDCMDTBL	DB	00H,00H		; 00H:Initialize
    7179/    22D2 : 9A 19               		DW	EXTCMD00
    7180/    22D4 : 84 00               		DB	84H,00H		; 01H:Write Disk
    7181/    22D6 : 9C 1A               		DW	EXTCMD02
    7182/    22D8 : 04 00               		DB	04H,00H		; 02H:Read Disk
    7183/    22DA : 9C 1A               		DW	EXTCMD02
    7184/    22DC : 00 80               		DB	00H,80H		; 03H:Transfer Buffer
    7185/    22DE : 00 00               		DW	0000H
    7186/    22E0 : 07 00               		DB	07H,00H		; 04H:Copy
    7187/    22E2 : 00 00               		DW	0000H
    7188/    22E4 : 01 00               		DB	01H,00H		; 05H:Format
    7189/    22E6 : F0 1B               		DW	EXTCMD05
    7190/    22E8 : 00 01               		DB	00H,01H		; 06H:Command Status
    7191/    22EA : 00 00               		DW	0000H
    7192/    22EC : 00 01               		DB	00H,01H		; 07H:Drive Status
    7193/    22EE : 00 00               		DW	0000H
    7194/    22F0 :                     
    7195/    22F0 :                     ;		DB	00H,01H,00H,00H	; 08H:Test Memory
    7196/    22F0 :                     ;		DB	04H,80H,00H,00H	; 09H:Read Memory
    7197/    22F0 :                     ;		DB	01H,00H,00H,00H	; 0AH:Port Output
    7198/    22F0 :                     ;		DB	04H,80H,00H,00H	; 0BH:Get Memory
    7199/    22F0 :                     ;		DB	84H,00H,00H,00H	; 0CH:Set Memory
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 121 - 2/18/2013 12:10:16


    7200/    22F0 :                     ;		DB	02H,00H,00H,00H	; 0DH:Execute
    7201/    22F0 :                     ;		DB	06H,00H,00H,00H	; 0EH:Load Memory
    7202/    22F0 :                     ;		DB	06H,00H,00H,00H	; 0FH:Save Memory
    7203/    22F0 :                     ;		DB	00H,00H,00H,00H	; 10H:Load and Go
    7204/    22F0 :                     
    7205/    22F0 :                     ;
    7206/    22F0 :                     ; external FDD format cylinder nubmer
    7207/    22F0 :                     ;
    7208/    22F0 : 00                  EXTFMTCY	DB	00H
    7209/    22F1 :                     
    7210/    22F1 :                     ;
    7211/    22F1 :                     ; external FDD command status
    7212/    22F1 :                     ; bit7:1 bit6:read flag bit0:error
    7213/    22F1 :                     ;
    7214/    22F1 : 80                  EXTFDDRDFLAG	DB	80H
    7215/    22F2 :                     
    7216/    22F2 :                     ;
    7217/    22F2 :                     ; external FDD sub-routine address
    7218/    22F2 :                     ;
    7219/    22F2 : 00 00               EXTFDDSUBAD	DW	0000H
    7220/    22F4 :                     
    7221/    22F4 :                     ;
    7222/    22F4 :                     ; external FDD sub-routine status
    7223/    22F4 :                     ;
    7224/    22F4 : 00                  EXTFDDSUBST	DB	00H
    7225/    22F5 :                     
    7226/    22F5 :                     ;
    7227/    22F5 :                     ; external FDC result
    7228/    22F5 :                     ;
    7229/    22F5 : 00 00 00 00 00 00   EXTFDCRST	DB	00H,00H,00H,00H,00H,00H,00H
                    00 
    7230/    22FC :                     
    7231/    22FC :                     ;
    7232/    22FC :                     ; external FDC result pointer
    7233/    22FC :                     ;
    7234/    22FC : 00 00               EXTFDCRSTPTR	DB	00H,00H
    7235/    22FE :                     
    7236/    22FE :                     ;
    7237/    22FE :                     ; FDD sector access number
    7238/    22FE :                     ;
    7239/    22FE : 00 00               FDDSECNUM	DB	00H,00H
    7240/    2300 :                     
    7241/    2300 :                     ;
    7242/    2300 :                     ; sector access flag
    7243/    2300 :                     ; bit0 : read/write sector
    7244/    2300 :                     ; bit1 : end flag
    7245/    2300 :                     ;
    7246/    2300 : 00                  SECACCFLAG	DB	00H
    7247/    2301 :                     
    7248/    2301 :                     ;
    7249/    2301 :                     ; sector compare with IDR and FLOPPY
    7250/    2301 :                     ; 00H : equal
    7251/    2301 :                     ;
    7252/    2301 : 00                  SECIDRCOMP	DB	00H
    7253/    2302 :                     
    7254/    2302 :                     ;
    7255/    2302 :                     ; sector compare with DELETED MARK and command
    7256/    2302 :                     ; 00H : equal
    7257/    2302 :                     ;
    7258/    2302 : 00                  SECDELCOMP	DB	00H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 122 - 2/18/2013 12:10:16


    7259/    2303 :                     
    7260/    2303 :                     ;
    7261/    2303 :                     ; sector status
    7262/    2303 :                     ; 00H : normal
    7263/    2303 :                     ; A0H : ID CRC error
    7264/    2303 :                     ; B0H : DATA CRC error
    7265/    2303 :                     ; E0H : no ID Address mark
    7266/    2303 :                     ; F0H : no Data Address mark
    7267/    2303 :                     ;
    7268/    2303 : 00                  SECSTAT		DB	00H
    7269/    2304 :                     
    7270/    2304 :                     ;
    7271/    2304 :                     ; cylinder compare with IDR-C and FLOPPY-C
    7272/    2304 :                     ; 00H : equal
    7273/    2304 :                     ; 01H : not equal and FLOPPY-C = FFH
    7274/    2304 :                     ; 02H : not equal and FLOPPY-C <> FFH
    7275/    2304 :                     ;
    7276/    2304 : 00                  COMPCY		DB	00H
    7277/    2305 :                     
    7278/    2305 :                     ;
    7279/    2305 :                     ; sector header buffer (16 bytes)
    7280/    2305 :                     ; states / reserved x 5 / data size x 2
    7281/    2305 :                     ;
    7282/    2305 : 00                  SECHEADER	DB	00H	; C
    7283/    2306 : 00                  		DB	00H	; H
    7284/    2307 : 00                  		DB	00H	; R
    7285/    2308 : 00                  		DB	00H	; N
    7286/    2309 : 00 00               		DB	00H,00H	; sector number
    7287/    230B : 00                  		DB	00H	; FM/MFM
    7288/    230C : 00                  SECHEADER_DM	DB	00H	; Deleted Mark
    7289/    230D : 00                  		DB	00H	; states
    7290/    230E : 00 00 00 00 00      		DB	00H,00H,00H,00H,00H	; reserved
    7291/    2313 : 00 00               		DB	00H,00H	; data size
    7292/    2315 :                     
    7293/    2315 :                     ;
    7294/    2315 :                     ; DMA transfer bytes
    7295/    2315 :                     ;
    7296/    2315 : 00 00               DMATRANSBYTES	DB	00H,00H
    7297/    2317 :                     
    7298/    2317 :                     ;
    7299/    2317 :                     ; buffer address
    7300/    2317 :                     ;
    7301/    2317 : 00 00               DMABUFFERADD	DB	00H,00H
    7302/    2319 :                     
    7303/    2319 :                     ;
    7304/    2319 :                     ; p6t auto command enable
    7305/    2319 :                     ;
    7306/    2319 : 00                  P6TCMDENB	DB	00H
    7307/    231A :                     
    7308/    231A :                     ;
    7309/    231A :                     ; p6t auto command enable before
    7310/    231A :                     ;
    7311/    231A : 00                  P6TCMDENBBEF	DB	00H
    7312/    231B :                     
    7313/    231B :                     ;
    7314/    231B :                     ; p6t file read flag
    7315/    231B :                     ;
    7316/    231B : 00                  P6TFILEREAD	DB	00H
    7317/    231C :                     
    7318/    231C :                     ;
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 123 - 2/18/2013 12:10:16


    7319/    231C :                     ; p6t auto command timer
    7320/    231C :                     ;
    7321/    231C : 00 00               KEYTIMER	DB	00H,00H
    7322/    231E :                     
    7323/    231E :                     ;
    7324/    231E :                     ; p6t auto command length
    7325/    231E :                     ;
    7326/    231E : 00                  P6TCMDLEN	DB	00H
    7327/    231F :                     
    7328/    231F :                     ;
    7329/    231F :                     ; p6t buffer position
    7330/    231F :                     ;
    7331/    231F : 00                  P6TBUFPOS	DB	00H
    7332/    2320 :                     
    7333/    2320 :                     ;
    7334/    2320 :                     ; p6t key push flag
    7335/    2320 :                     ;
    7336/    2320 : 00                  P6TKEYPUSH	DB	00H
    7337/    2321 :                     
    7338/    2321 :                     ;
    7339/    2321 :                     ; control select register buffer / function key buffer
    7340/    2321 :                     ; key push detect
    7341/    2321 :                     ;
    7342/    2321 : 00                  CTRLNOW		DB	00H
    7343/    2322 : 00 00 00            FUNCNOW		DB	00H,00H,00H
    7344/    2325 : 00                  CTRLBEF		DB	00H
    7345/    2326 : 00 00 00            FUNCBEF		DB	00H,00H,00H
    7346/    2329 : 00                  CTRLPUSH	DB	00H
    7347/    232A : 00 00 00            FUNCPUSH	DB	00H,00H,00H
    7348/    232D :                     
    7349/    232D :                     ;
    7350/    232D :                     ; cursor position address and length
    7351/    232D :                     ;
    7352/    232D : 00 00               CURSOR_ADD	DB	00H,00H
    7353/    232F : 00                  CURSOR_LEN	DB	00H
    7354/    2330 :                     
    7355/    2330 :                     ;
    7356/    2330 :                     ; claster number buffer x 20 x2
    7357/    2330 :                     ;
    7358/    2330 : 00 00 00 00 00 00   FILEPTR_BUF	DB	00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 00 00 
    7359/    233A : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 00 00 
    7360/    2344 : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 00 00 
    7361/    234E : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 00 00 
    7362/    2358 :                     
    7363/    2358 :                     ;
    7364/    2358 :                     ; UART baud rate
    7365/    2358 :                     ;
    7366/    2358 : 00                  UART_BAUD	DB	00H
    7367/    2359 :                     
    7368/    2359 :                     ;
    7369/    2359 :                     ; EXPAND KANJI ROM exist flag
    7370/    2359 :                     ;
    7371/    2359 : 00                  EXKANJIEXIST	DB	00H
    7372/    235A :                     
    7373/    235A :                     ;
    7374/    235A :                     ; strings
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 124 - 2/18/2013 12:10:16


    7375/    235A :                     ;
    7376/    235A : 09 00 50 43 2D 36   ST_PC6001F	DB	009H,00H,"PC-6001F",00H
                    30 30 31 46 00 
    7377/    2365 : 06 00 50 43 2D 36   ST_PC6001FMK2	DB	006H,00H,"PC-6001F Mk2",00H
                    30 30 31 46 20 4D 
                    6B 32 00 
    7378/    2374 : 09 00 50 43 2D 36   ST_PC6601F	DB	009H,00H,"PC-6601F",00H
                    36 30 31 46 00 
    7379/    237F : 15 00 46 50 47 41   ST_FPGAVER	DB	015H,00H,"FPGA v."
                    20 76 2E 
    7380/    2388 : 30 30 30 30 00      ST_FPGAVER_VAL	DB	"0000",00H
    7381/    238D : 36 00 46 2F 57 20   ST_FIRMVER	DB	036H,00H,"F/W v."
                    76 2E 
    7382/    2395 : 30 30 30 30 00      ST_FIRMVER_VAL	DB	"0000",00H
    7383/    239A : 61 00 43 4D 54 20   ST_CMTREAD	DB	061H,00H, "CMT READ FILE  ["
                    52 45 41 44 20 46 
                    49 4C 45 20 20 5B 
    7384/    23AC : 46 46 46 46 46 46   ST_CMTREAD_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7385/    23BA : 81 00 43 4D 54 20   ST_CMTREW	DB	081H,00H,"CMT READ FILE REW.[  OK  ]",00H
                    52 45 41 44 20 46 
                    49 4C 45 20 52 45 
                    57 2E 5B 20 20 4F 
                    4B 20 20 5D 00 
    7386/    23D7 : A1 00 43 4D 54 20   ST_CMTWRITE	DB	0A1H,00H, "CMT WRITE FILE ["
                    57 52 49 54 45 20 
                    46 49 4C 45 20 5B 
    7387/    23E9 : 46 46 46 46 46 46   ST_CMTWRITE_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7388/    23F7 : E1 00 52 41 4D 20   ST_MEMSIZE	DB	0E1H,00H,"RAM SIZE          ["
                    53 49 5A 45 20 20 
                    20 20 20 20 20 20 
                    20 20 5B 
    7389/    240C : 20 31 36 4B 42 20   ST_MEMSIZE_VAL	DB	" 16KB ]",00H
                    5D 00 
    7390/    2414 : 01 01 45 58 50 41   ST_EXROM	DB	001H,01H,"EXPAND ROM     ["
                    4E 44 20 52 4F 4D 
                    20 20 20 20 20 5B 
    7391/    2426 : 46 46 46 46 46 46   ST_EXROM_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7392/    2434 : 21 01 45 58 50 41   ST_EXKANJI	DB	021H,01H,"EXPAND KANJI ROM  [ "
                    4E 44 20 4B 41 4E 
                    4A 49 20 52 4F 4D 
                    20 20 5B 20 
    7393/    244A : 20 4F 46 46 20 5D   ST_EXKANJI_VAL	DB	" OFF ]",00H
                    00 
    7394/    2451 : 61 01 53 43 52 45   ST_SC4COL	DB	061H,01H,"SCREEN4 COLOR    ["
                    45 4E 34 20 43 4F 
                    4C 4F 52 20 20 20 
                    20 5B 
    7395/    2465 : D0 C4 DE D8 2F D3   ST_SC4COL_VAL	DB	"/ ]",00H
                    D3 20 5D 00 
    7396/    246F : 81 01 55 41 52 54   ST_UART		DB	081H,01H,"UART SETTING  ["
                    20 53 45 54 54 49 
                    4E 47 20 20 5B 
    7397/    2480 : 20 20 20 20 4E 4F   ST_UART_VAL	DB	"    NO USE   ]",00H
                    20 55 53 45 20 20 
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 125 - 2/18/2013 12:10:16


                    20 5D 00 
    7398/    248F :                     
    7399/    248F : 61 00 49 4E 54 20   ST_FDD0INTSET		DB	061H,00H, "INT FDD#0 SETTING   ["
                    46 44 44 23 30 20 
                    53 45 54 54 49 4E 
                    47 20 20 20 5B 
    7400/    24A6 : 4E 4F 20 55 53 45   ST_FDD0INTSET_VAL	DB	"NO USE]",00H
                    5D 00 
    7401/    24AE : 81 00 49 4E 54 20   ST_FDD0INTFILE		DB	081H,00H, "INT FDD#0 FILE   ["
                    46 44 44 23 30 20 
                    46 49 4C 45 20 20 
                    20 5B 
    7402/    24C2 : 46 46 46 46 46 46   ST_FDD0INTFILE_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7403/    24D0 : A1 00 49 4E 54 20   ST_FDD1INTSET		DB	0A1H,00H, "INT FDD#1 SETTING   ["
                    46 44 44 23 31 20 
                    53 45 54 54 49 4E 
                    47 20 20 20 5B 
    7404/    24E7 : 4E 4F 20 55 53 45   ST_FDD1INTSET_VAL	DB	"NO USE]",00H
                    5D 00 
    7405/    24EF : C1 00 49 4E 54 20   ST_FDD1INTFILE		DB	0C1H,00H, "INT FDD#1 FILE   ["
                    46 44 44 23 31 20 
                    46 49 4C 45 20 20 
                    20 5B 
    7406/    2503 : 46 46 46 46 46 46   ST_FDD1INTFILE_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7407/    2511 : 01 01 45 58 54 20   ST_FDD0EXTSET		DB	001H,01H, "EXT FDD#0 SETTING   ["
                    46 44 44 23 30 20 
                    53 45 54 54 49 4E 
                    47 20 20 20 5B 
    7408/    2528 : 4E 4F 20 55 53 45   ST_FDD0EXTSET_VAL	DB	"NO USE]",00H
                    5D 00 
    7409/    2530 : 21 01 45 58 54 20   ST_FDD0EXTFILE		DB	021H,01H, "EXT FDD#0 FILE   ["
                    46 44 44 23 30 20 
                    46 49 4C 45 20 20 
                    20 5B 
    7410/    2544 : 46 46 46 46 46 46   ST_FDD0EXTFILE_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7411/    2552 : 41 01 45 58 54 20   ST_FDD1EXTSET		DB	041H,01H, "EXT FDD#1 SETTING   ["
                    46 44 44 23 31 20 
                    53 45 54 54 49 4E 
                    47 20 20 20 5B 
    7412/    2569 : 4E 4F 20 55 53 45   ST_FDD1EXTSET_VAL	DB	"NO USE]",00H
                    5D 00 
    7413/    2571 : 61 01 45 58 54 20   ST_FDD1EXTFILE		DB	061H,01H, "EXT FDD#1 FILE   ["
                    46 44 44 23 31 20 
                    46 49 4C 45 20 20 
                    20 5B 
    7414/    2585 : 46 46 46 46 46 46   ST_FDD1EXTFILE_VAL	DB	"FFFFFFFF EEE]",00H
                    46 46 20 45 45 45 
                    5D 00 
    7415/    2593 :                     
    7416/    2593 : 50 36 54            ST_P6T		DB	"P6T"
    7417/    2596 :                     
    7418/    2596 :                     
    7419/    2596 :                     ; : :RET :SPC
    7420/    2596 :                     ; :ESC    :F8  :F11
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 126 - 2/18/2013 12:10:16


    7421/    2596 :                     ;0123456789ABCDEF0123456789ABCDEF
    7422/    2596 :                     
    7423/    2596 : C0 01               ST_KEYFUNC1	DB	0C0H,001H
    7424/    2598 : 20 92 E4 DE 93 3A   		DB	020H,092H,0E4H,0DEH,093H,03AH,0B6H,0B0H
                    B6 B0 
    7425/    25A0 : BF D9 B7 B0 20 99   		DB	0BFH,0D9H,0B7H,0B0H,020H,099H,08FH,0E3H
                    8F E3 
    7426/    25A8 : 92 3A 52 45 54 20   		DB	092H,03AH,052H,045H,054H,020H,0E2H,097H
                    E2 97 
    7427/    25B0 : DE ED 3A 53 50 43   		DB	0DEH,0EDH,03AH,053H,050H,043H,020H,000H
                    20 00 
    7428/    25B8 : E0 01               ST_KEYFUNC2	DB	0E0H,001H
    7429/    25BA : 20 B7 AC DD BE D9   		DB	020H,0B7H,0ACH,0DDH,0BEH,0D9H,03AH,045H
                    3A 45 
    7430/    25C2 : 53 43 20 20 20 20   		DB	053H,043H,020H,020H,020H,020H,095H,0FCH
                    95 FC 
    7431/    25CA : F9 3A 46 38 20 20   		DB	0F9H,03AH,046H,038H,020H,020H,0D8H,0BEH
                    D8 BE 
    7432/    25D2 : AF C4 3A 46 31 31   		DB	0AFH,0C4H,03AH,046H,031H,031H,020H,000H
                    20 00 
    7433/    25DA :                     
    7434/    25DA : 00 00               ST_FNAME	DB	00H,00H
    7435/    25DC : 46 46 46 46 46 46   ST_FNAME_VAL	DB	"FFFFFFFF EEE",00H
                    46 46 20 45 45 45 
                    00 
    7436/    25E9 :                     
    7437/    25E9 : E0 01 48 4C 3A      ST_DEBUG	DB	0E0H,01H,"HL:"
    7438/    25EE : 30 30 30 30 00      ST_DEBUG_VAL	DB	"0000",00H
    7439/    25F3 :                     
    7440/    25F3 : 3D 3D 20 9E FD E0   ST_NOSELECT	DB	03DH,03DH,020H,09EH,0FDH,0E0H
    7441/    25F9 : 98 E5 9C 20 3D 3D   		DB	098H,0E5H,09CH,020H,03DH,03DH	;"==  =="
    7442/    25FF : 3D 20 96 97 9A F0   ST_WRPROTECT	DB	03DH,020H,096H,097H,09AH,0F0H
    7443/    2605 : 20 97 FD 9C 20 3D   		DB	020H,097H,0FDH,09CH,020H,03DH	;"=   ="
    7444/    260B : 20 4F 46 46         ST_OFF		DB	" OFF"
    7445/    260F : 20 4F 4E 20         ST_ON		DB	" ON "
    7446/    2613 : 20 31 36            ST_16		DB	" 16"
    7447/    2616 : 20 33 32            ST_32		DB	" 32"
    7448/    2619 : 20 36 34            ST_64		DB	" 64"
    7449/    261C : 31 32 38            ST_128		DB	"128"
    7450/    261F : F0 E4 DE F8 2F F3   ST_SC4COL0	DB	0F0H,0E4H,0DEH,0F8H,02FH,0F3H,0F3H,020H	;"/ "
                    F3 20 
    7451/    2627 : F3 F3 2F F0 E4 DE   ST_SC4COL1	DB	0F3H,0F3H,02FH,0F0H,0E4H,0DEH,0F8H,020H	;"/ "
                    F8 20 
    7452/    262F : 20 91 95 2F 91 96   ST_SC4COL2	DB	020H,091H,095H,02FH,091H,096H,020H,020H	;" /  "
                    20 20 
    7453/    2637 : 20 91 96 2F 91 95   ST_SC4COL3	DB	020H,091H,096H,02FH,091H,095H,020H,020H	;" /  "
                    20 20 
    7454/    263F : 20 20 4F 46 46 20   ST_SC4COLOFF	DB	"  OFF   "
                    20 20 
    7455/    2647 : 20 20 20 20 4E 4F   ST_UARTBAUD	DB	"    NO USE   "	; 00
                    20 55 53 45 20 20 
                    20 
    7456/    2654 : 20 20 20 31 35 30   		DB	"   150/   600"	; 01
                    2F 20 20 20 36 30 
                    30 
    7457/    2661 : 20 20 20 33 30 30   		DB	"   300/  1200"	; 02
                    2F 20 20 31 32 30 
                    30 
    7458/    266E : 20 20 20 36 30 30   		DB	"   600/  2400"	; 03
                    2F 20 20 32 34 30 
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 127 - 2/18/2013 12:10:16


                    30 
    7459/    267B : 20 20 31 32 30 30   		DB	"  1200/  4800"	; 04
                    2F 20 20 34 38 30 
                    30 
    7460/    2688 : 20 20 32 34 30 30   		DB	"  2400/  9600"	; 05
                    2F 20 20 39 36 30 
                    30 
    7461/    2695 : 20 20 34 38 30 30   		DB	"  4800/ 19200"	; 06
                    2F 20 31 39 32 30 
                    30 
    7462/    26A2 : 20 20 39 36 30 30   		DB	"  9600/ 38400"	; 07
                    2F 20 33 38 34 30 
                    30 
    7463/    26AF : 20 31 34 30 30 30   		DB	" 14000/ 56000"	; 08
                    2F 20 35 36 30 30 
                    30 
    7464/    26BC : 20 31 34 34 30 30   		DB	" 14400/ 57600"	; 09
                    2F 20 35 37 36 30 
                    30 
    7465/    26C9 : 20 31 39 32 30 30   		DB	" 19200/ 76800"	; 0A
                    2F 20 37 36 38 30 
                    30 
    7466/    26D6 : 20 32 38 38 30 30   		DB	" 28800/115200"	; 0B
                    2F 31 31 35 32 30 
                    30 
    7467/    26E3 : 20 33 30 37 32 30   		DB	" 30720/122880"	; 0C
                    2F 31 32 32 38 38 
                    30 
    7468/    26F0 : 20 33 32 30 30 30   		DB	" 32000/128000"	; 0D
                    2F 31 32 38 30 30 
                    30 
    7469/    26FD : 20 33 38 34 30 30   		DB	" 38400/153600"	; 0E
                    2F 31 35 33 36 30 
                    30 
    7470/    270A : 20 35 37 36 30 30   		DB	" 57600/230400"	; 0F
                    2F 32 33 30 34 30 
                    30 
    7471/    2717 : 20 36 34 30 30 30   		DB	" 64000/256000"	; 10
                    2F 32 35 36 30 30 
                    30 
    7472/    2724 : 20 37 36 38 30 30   		DB	" 76800/307200"	; 11
                    2F 33 30 37 32 30 
                    30 
    7473/    2731 : 31 31 35 32 30 30   		DB	"115200/460800"	; 12
                    2F 34 36 30 38 30 
                    30 
    7474/    273E : 31 32 38 30 30 30   		DB	"128000/512000"	; 13
                    2F 35 31 32 30 30 
                    30 
    7475/    274B : 31 35 33 36 30 30   		DB	"153600/614400"	; 14
                    2F 36 31 34 34 30 
                    30 
    7476/    2758 : 31 39 32 30 30 30   		DB	"192000/768000"	; 15
                    2F 37 36 38 30 30 
                    30 
    7477/    2765 : 32 33 30 34 30 30   		DB	"230400/921600"	; 16
                    2F 39 32 31 36 30 
                    30 
    7478/    2772 : 32 35 36 30 30 30   		DB	"256000/ 1024K"	; 17
                    2F 20 31 30 32 34 
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 128 - 2/18/2013 12:10:16


                    4B 
    7479/    277F :                     
    7480/    277F : 4E 4F 20 55 53 45   ST_NOUSE	DB	"NO USE"
    7481/    2785 : 20 20 31 44 20 20   ST_1D		DB	"  1D  "
    7482/    278B : 20 20 31 44 44 20   ST_1DD		DB	"  1DD "
    7483/    2791 : 20 20 32 44 20 20   ST_2D		DB	"  2D  "
    7484/    2797 : 20 20 32 44 44 20   ST_2DD		DB	"  2DD "
    7485/    279D :                     
    7486/    279D :                     ;
    7487/    279D :                     ; UART baud rate value table
    7488/    279D :                     ;
    7489/    279D : FF FF FF            TB_UARTBAUD	DB	0FFH,0FFH,0FFH	; 00
    7490/    27A0 : 0B 8B 02            		DB	00BH,08BH,002H	; 01
    7491/    27A3 : 85 45 01            		DB	085H,045H,001H	; 02
    7492/    27A6 : C3 A2 00            		DB	0C3H,0A2H,000H	; 03
    7493/    27A9 : 61 51 00            		DB	061H,051H,000H	; 04
    7494/    27AC : B1 28 00            		DB	0B1H,028H,000H	; 05
    7495/    27AF : 58 14 00            		DB	058H,014H,000H	; 06
    7496/    27B2 : 2C 0A 00            		DB	02CH,00AH,000H	; 07
    7497/    27B5 : FA 06 00            		DB	0FAH,006H,000H	; 08
    7498/    27B8 : C8 06 00            		DB	0C8H,006H,000H	; 09
    7499/    27BB : 16 05 00            		DB	016H,005H,000H	; 0A
    7500/    27BE : 64 03 00            		DB	064H,003H,000H	; 0B
    7501/    27C1 : 2E 03 00            		DB	02EH,003H,000H	; 0C
    7502/    27C4 : 0D 03 00            		DB	00DH,003H,000H	; 0D
    7503/    27C7 : 8B 02 00            		DB	08BH,002H,000H	; 0E
    7504/    27CA : B2 01 00            		DB	0B2H,001H,000H	; 0F
    7505/    27CD : 87 01 00            		DB	087H,001H,000H	; 10
    7506/    27D0 : 46 01 00            		DB	046H,001H,000H	; 11
    7507/    27D3 : D9 00 00            		DB	0D9H,000H,000H	; 12
    7508/    27D6 : C3 00 00            		DB	0C3H,000H,000H	; 13
    7509/    27D9 : A3 00 00            		DB	0A3H,000H,000H	; 14
    7510/    27DC : 82 00 00            		DB	082H,000H,000H	; 15
    7511/    27DF : 6D 00 00            		DB	06DH,000H,000H	; 16
    7512/    27E2 : 62 00 00            		DB	062H,000H,000H	; 17
    7513/    27E5 :                     
    7514/    27E5 :                     
    7515/    27E5 :                     ;
    7516/    27E5 :                     ; page 0 cursor data
    7517/    27E5 :                     ;
    7518/    27E5 : 71 00 0C            PAGE0CURDATA	DB	071H,000H,00CH
    7519/    27E8 : 94 00 06            		DB	094H,000H,006H
    7520/    27EB : B1 00 0C            		DB	0B1H,000H,00CH
    7521/    27EE : D1 00 01            		DB	0D1H,000H,001H	; no menu
    7522/    27F1 : F4 00 06            		DB	0F4H,000H,006H
    7523/    27F4 : 11 01 0C            		DB	011H,001H,00CH
    7524/    27F7 : 34 01 06            		DB	034H,001H,006H
    7525/    27FA : 51 01 01            		DB	051H,001H,001H	; no menu
    7526/    27FD : 73 01 08            		DB	073H,001H,008H
    7527/    2800 : 90 01 0D            		DB	090H,001H,00DH
    7528/    2803 :                     
    7529/    2803 :                     ;
    7530/    2803 :                     ; page 2 cursor data
    7531/    2803 :                     ;
    7532/    2803 : 76 00 06            PAGE2CURDATA	DB	076H,000H,006H
    7533/    2806 : 93 00 0C            		DB	093H,000H,00CH
    7534/    2809 : B6 00 06            		DB	0B6H,000H,006H
    7535/    280C : D3 00 0C            		DB	0D3H,000H,00CH
    7536/    280F : F3 00 01            		DB	0F3H,000H,001H
    7537/    2812 : 16 01 06            		DB	016H,001H,006H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 129 - 2/18/2013 12:10:16


    7538/    2815 : 33 01 0C            		DB	033H,001H,00CH
    7539/    2818 : 56 01 06            		DB	056H,001H,006H
    7540/    281B : 73 01 0C            		DB	073H,001H,00CH
    7541/    281E : 93 01 01            		DB	093H,001H,001H
    7542/    2821 :                     
    7543/    2821 :                     ;
    7544/    2821 :                     ; BASIC-ROM directory name
    7545/    2821 :                     ;
    7546/    2821 : 52 4F 4D 20 20 20   F_ROMDIR	DB	"ROM        "
                    20 20 20 20 20 
    7547/    282C :                     
    7548/    282C :                     ;
    7549/    282C :                     ; BASIC-ROM file name
    7550/    282C :                     ;
    7551/    282C : 42 41 53 49 43 52   F_BASICROM60	DB	"BASICROM60 "
                    4F 4D 36 30 20 
    7552/    2837 : 43 47 52 4F 4D 36   F_CGROM60	DB	"CGROM60 60 "
                    30 20 36 30 20 
    7553/    2842 : 42 41 53 49 43 52   F_BASICROM62	DB	"BASICROM62 "
                    4F 4D 36 32 20 
    7554/    284D : 43 47 52 4F 4D 36   F_CGROM62	DB	"CGROM60 62 "
                    30 20 36 32 20 
    7555/    2858 : 43 47 52 4F 4D 36   F_CG2ROM62	DB	"CGROM60M62 "
                    30 4D 36 32 20 
    7556/    2863 : 4B 41 4E 4A 49 52   F_KANJIROM62	DB	"KANJIROM62 "
                    4F 4D 36 32 20 
    7557/    286E : 56 4F 49 43 45 52   F_VOICEROM62	DB	"VOICEROM62 "
                    4F 4D 36 32 20 
    7558/    2879 : 42 41 53 49 43 52   F_BASICROM66	DB	"BASICROM66 "
                    4F 4D 36 36 20 
    7559/    2884 : 43 47 52 4F 4D 36   F_CGROM66	DB	"CGROM60 66 "
                    30 20 36 36 20 
    7560/    288F : 43 47 52 4F 4D 36   F_CG2ROM66	DB	"CGROM66 66 "
                    36 20 36 36 20 
    7561/    289A : 4B 41 4E 4A 49 52   F_KANJIROM66	DB	"KANJIROM66 "
                    4F 4D 36 36 20 
    7562/    28A5 : 56 4F 49 43 45 52   F_VOICEROM66	DB	"VOICEROM66 "
                    4F 4D 36 36 20 
    7563/    28B0 : 45 58 4B 41 4E 4A   F_EXKANJIROM	DB	"EXKANJI ROM"
                    49 20 52 4F 4D 
    7564/    28BB :                     
    7565/    28BB :                     ;
    7566/    28BB :                     ; P6T file buffer (63 + 10 byte)
    7567/    28BB :                     ;
    7568/    28BB :                     P6TBUFFER
    7569/    28BB : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7570/    28C3 : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7571/    28CB : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7572/    28D3 : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7573/    28DB : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7574/    28E3 : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7575/    28EB : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7576/    28F3 : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 130 - 2/18/2013 12:10:16


                    00 00 
    7577/    28FB : 00 00 00 00 00 00   		DB	00H,00H,00H,00H,00H,00H,00H,00H
                    00 00 
    7578/    2903 : 00                  		DB	00H
    7579/    2904 :                     
    7580/    2904 :                     	END
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 131 - 2/18/2013 12:10:16


  symbol table (* = unused):
  ------------------------

 ADD4B_MHL_A :                 1342 C |  ADD4B_MHL_MDE :               132F C |
*ARCHITECTURE :  i386-unknown-win32 - |  BEFPAGENUM :                  22B9 C |
*BIGENDIAN :                      0 - |  BPB_CLASTSEC :                800D - |
 BPB_DIRENTRY :                8011 - |  BPB_FATNUM :                  8010 - |
 BPB_FATSEC :                  8016 - |  BPB_FATST :                   800E - |
 BPB_FATVER :                  8039 - |  BPB_SECBYTE :                 800B - |
*BRANCHEXT :                      0 - |  CALCFATADD :                  12E5 C |
 CALCSDADD :                   1203 C | *CASESENSITIVE :                  0 - |
 CFAL1 :                       1318 C |  CHKSPT :                      13EB C |
 CLASTCHECK :                  125D C |  CLASTSIZE :                   229F C |
 CLASTST :                     229B C |  CMD_MFMRDDATA :                 46 - |
 CMD_MFMWRDATA :                 45 - |  CMD_MFMWRID :                   4D - |
 CMD_RDDATA :                     6 - |  CMD_RDDELDATA :                  C - |
 CMD_RDDIA :                      2 - |  CMD_RDID :                       A - |
 CMD_RECALB :                     7 - | *CMD_SCEQU :                     11 - |
*CMD_SCHIG :                     1D - | *CMD_SCLOW :                     19 - |
 CMD_SEEK :                       F - |  CMD_SENSEINTST :                 8 - |
 CMD_WRDATA :                     5 - |  CMD_WRDELDATA :                  9 - |
 CMD_WRID :                       D - |  CMTREADWAIT :                  B68 C |
 CMTWRITEWAIT :                 BB5 C |  COMPCY :                      2304 C |
*CONSTPI :        3.141592653589793 - |  CPL1 :                        1366 C |
 CPL2 :                        136B C |  CP_MHL_MDE :                  1365 C |
 CRWL1 :                        B95 C |  CSAL1 :                       1230 C |
 CSAL2 :                       1222 C |  CTRLATT :                     C000 - |
 CTRLBEF :                     2325 C |  CTRLNOW :                     2321 C |
 CTRLPUSH :                    2329 C |  CTRLVRAM :                    C200 - |
 CUR2BUF :                      666 C |  CUR2CHK :                      681 C |
 CURSORREDRAW :                22BB C |  CURSOR_ADD :                  232D C |
 CURSOR_LEN :                  232F C |  CWWL0 :                        C32 C |
 CWWL1 :                        C55 C |  CWWL11 :                       CCF C |
 CWWL2 :                        CDE C |  CWWL3 :                        D16 C |
 CWWL4 :                        D2B C |  CWWL5 :                        D41 C |
 CWW_FL2 :                      C69 C | *DATE :                   2/18/2013 - |
 DCL1 :                         A7F C |  DCL2 :                         A72 C |
 DETSDEJECT :                  1560 C |  DIRCL :                       22A0 C |
 DIRPOS :                      22A2 C |  DISKABEND :                   1FAE C |
 DISKBUF :                     9000 - |  DISKBUF_U :                     90 - |
 DISKEND :                     1FB2 C |  DISKOPEN :                    1FBB C |
 DISKOPEN_L1 :                 1FCF C |  DISKWAIT :                    1D39 C |
 DISPCUR :                      A5A C |  DISPPAGE :                     7DE C |
 DISPPAGE0 :                    800 C |  DISPPAGE1 :                    8AE C |
 DISPPAGE2 :                    981 C |  DMABUFFERADD :                2317 C |
 DMATRANSBYTES :               2315 C |  DP0L2 :                        80C C |
 DP0L21 :                       81E C |  DP0L5 :                        85C C |
 DP2LF0 :                       9A3 C |  DP2LF1 :                       9CD C |
 DP2LF2 :                       9F7 C |  DP2LF3 :                       A21 C |
 DPOL3 :                        832 C |  DSEL1 :                       1577 C |
 DWL0 :                        1D44 C |  DWL1 :                        1D6C C |
 DWL3 :                        1DA6 C |  DWL4 :                        1DBE C |
 DWL5 :                        1DD0 C | *DWL52 :                       1DCD C |
 DWL53 :                       1DDE C |  DWL6 :                        1E0D C |
 DWL7 :                        1E75 C |  DWL8 :                        1EC9 C |
 DWL91 :                       1F25 C |  DWL_EXT :                     1D60 C |
 DWL_LP :                      1E2F C |  DW_BADCY :                    1FA0 C |
 DW_CYEND :                    1F3E C |  DW_DATACRCERR :               1F8A C |
 DW_DELETEDMARK :              1F84 C |  DW_ENDCY :                    1F9A C |
 DW_IDCRCERR :                 1F94 C |  DW_NODATA :                   1F7A C |
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 132 - 2/18/2013 12:10:16


 DW_NOSEC :                    1FAA C |  DW_NOTWRID :                  1E65 C |
 DW_NOTWRITABLE :              1F74 C |  DW_RDDIA :                    1F72 C |
 DW_RDID :                     1F72 C |  DW_RD_RDDEL :                 1EF9 C |
 DW_RWEND :                    1F0D C |  DW_SECEND :                   1F64 C |
 DW_SECEQ :                    1EA5 C |  DW_SECSKIP :                  1F61 C |
 DW_WRIDLP :                   1E50 C |  DW_WRONGCY :                  1FA6 C |
 DW_WR_WRDEL :                 1ED7 C |  DW_WR_WRDEL_L1 :              1EEC C |
 ERRLP :                       141E C |  EXKANJIEXIST :                2359 C |
 EXROMFLAG :                   22BD C |  EXTCMD00 :                    199A C |
 EXTCMD00_01H :                19B3 C |  EXTCMD00_02H :                19BB C |
 EXTCMD00_03H :                19C3 C |  EXTCMD00_04H :                19C9 C |
 EXTCMD00_05H :                19CF C |  EXTCMD00_06H :                19D7 C |
 EXTCMD00_07H :                19DD C |  EXTCMD00_08H :                19E3 C |
 EXTCMD00_09H :                19EF C |  EXTCMD00_0AH :                19F7 C |
 EXTCMD00_0BH :                19FF C |  EXTCMD00_0CH :                1A05 C |
 EXTCMD00_0DH :                1A0B C |  EXTCMD00_0EH :                1A13 C |
 EXTCMD00_0FH :                1A19 C |  EXTCMD00_10H :                1A1F C |
 EXTCMD00_11H :                1A2B C |  EXTCMD00_12H :                1A33 C |
 EXTCMD00_13H :                1A3B C |  EXTCMD00_14H :                1A41 C |
 EXTCMD00_15H :                1A47 C |  EXTCMD00_16H :                1A4F C |
 EXTCMD00_17H :                1A55 C |  EXTCMD00_18H :                1A5B C |
 EXTCMD00_19H :                1A67 C |  EXTCMD00_1AH :                1A6F C |
 EXTCMD00_1BH :                1A77 C |  EXTCMD00_1CH :                1A7D C |
 EXTCMD00_1DH :                1A83 C |  EXTCMD00_1EH :                1A8B C |
 EXTCMD00_1FH :                1A91 C |  EXTCMD00_20H :                1A97 C |
 EXTCMD02 :                    1A9C C |  EXTCMD02_01H :                1AAB C |
 EXTCMD02_02H :                1AB3 C |  EXTCMD02_03H :                1ABF C |
 EXTCMD02_04H :                1AC9 C |  EXTCMD02_05H :                1ACF C |
 EXTCMD02_06H :                1AD5 C |  EXTCMD02_07H :                1ADD C |
 EXTCMD02_08H :                1AE3 C |  EXTCMD02_09H :                1AE9 C |
 EXTCMD02_0AH :                1B15 C |  EXTCMD02_0BH :                1B21 C |
 EXTCMD02_0CH :                1B33 C |  EXTCMD02_0DH :                1B3F C |
 EXTCMD02_0EH :                1B49 C |  EXTCMD02_0FH :                1B51 C |
 EXTCMD02_10H :                1B5B C |  EXTCMD02_11H :                1B63 C |
 EXTCMD02_12H :                1B6B C |  EXTCMD02_13H :                1B73 C |
 EXTCMD02_14H :                1B7B C |  EXTCMD02_14_L1 :              1B93 C |
 EXTCMD02_15H :                1B9C C |  EXTCMD02_16H :                1BA2 C |
 EXTCMD02_17H :                1BAF C |  EXTCMD02_17H_L1 :             1BB5 C |
 EXTCMD02_1EH :                1BB8 C |  EXTCMD02_RSL1 :               1BDE C |
 EXTCMD02_RSL2 :               1BE7 C |  EXTCMD02_SIL1 :               1B10 C |
 EXTCMD05 :                    1BF0 C |  EXTCMD05_01H :                1BFF C |
 EXTCMD05_02H :                1C0B C |  EXTCMD05_03H :                1C13 C |
 EXTCMD05_04H :                1C1F C |  EXTCMD05_05H :                1C29 C |
 EXTCMD05_06H :                1C2F C |  EXTCMD05_07H :                1C35 C |
 EXTCMD05_08H :                1C3D C |  EXTCMD05_09H :                1C43 C |
 EXTCMD05_0AH :                1C49 C |  EXTCMD05_0BH :                1C8C C |
 EXTCMD05_0CH :                1C98 C |  EXTCMD05_0DH :                1CA0 C |
 EXTCMD05_0EH :                1CAC C |  EXTCMD05_0FH :                1CB4 C |
 EXTCMD05_10H :                1CBC C |  EXTCMD05_11H :                1CC4 C |
 EXTCMD05_12H :                1CCC C |  EXTCMD05_13H :                1CDD C |
 EXTCMD05_14H :                1CE3 C |  EXTCMD05_15H :                1CF0 C |
 EXTCMD05_15H_L1 :             1CF6 C |  EXTCMD05_1CH :                1CF9 C |
 EXTCMD05_1DH :                1D25 C |  EXTCMD05_END :                1D34 C |
 EXTCMD05_RSL1 :               1D1B C |  EXTCMD05_SIL1 :               1C70 C |
 EXTCMD05_SIL2 :               1C7A C |  EXTCMDL1 :                    17C0 C |
 EXTCMDL2 :                    17CB C |  EXTCMDL3 :                    17E4 C |
 EXTCMDL4 :                    17EE C |  EXTCMDL5 :                    17F7 C |
 EXTDISKWAIT :                 170E C |  EXTFDCBUSYWAIT :              198F C |
 EXTFDCDTIN :                  195C C |  EXTFDCDTOUT :                 1974 C |
 EXTFDCFDINTWAIT :             1985 C |  EXTFDCRST :                   22F5 C |
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 133 - 2/18/2013 12:10:16


 EXTFDCRSTPTR :                22FC C |  EXTFDDCMD :                   22C2 C |
 EXTFDDCMDTBL :                22D0 C |  EXTFDDDTLEN :                 22CE C |
 EXTFDDPARA :                  22C5 C |  EXTFDDPTR :                   22CC C |
 EXTFDDRDFLAG :                22F1 C |  EXTFDDRLEN :                  22C3 C |
 EXTFDDSLEN :                  22C4 C |  EXTFDDST :                    22C1 C |
 EXTFDDSUBAD :                 22F2 C |  EXTFDDSUBST :                 22F4 C |
 EXTFMTCY :                    22F0 C |  EXTRDBUF :                    B000 - |
 EXTRDBUF_U :                    B0 - |  EXTST01H :                    1725 C |
 EXTST02H :                    1735 C |  EXTST03H :                    1755 C |
 EXTST10H :                    176A C |  EXTST20H :                    17A3 C |
 EXTST30DATA :                 1858 C |  EXTST30DATA_L0 :              186F C |
 EXTST30DATA_L1 :              187F C |  EXTST30DATA_L2 :              1887 C |
 EXTST30DATA_L3 :              189D C |  EXTST30H :                    17F8 C |
 EXTST30L1 :                   180C C |  EXTST31H :                    1817 C |
 EXTST32H :                    183C C |  EXTST40DATA :                 1912 C |
 EXTST40DATA_L1 :              1922 C |  EXTST40DATA_L2 :              1925 C |
 EXTST40DATA_L3 :              1936 C |  EXTST40DATA_L4 :              1942 C |
 EXTST40H :                    18AC C |  EXTST40L1 :                   18C0 C |
*EXTST40LL2 :                  18BA C |  EXTST41H :                    18C6 C |
 EXTST42H :                    18E6 C |  EXTST43H :                    18FB C |
 EXTST50H :                    194C C |  EXTST50L1 :                   195B C |
 EXTWRBUF :                    A000 - |  EXTWRBUF_U :                    A0 - |
*FALSE :                          0 - |  FATSEC :                      2295 C |
 FATST :                       2291 C |  FATWRITE :                    12AD C |
 FDDREADSEC :                  20EC C |  FDDSECNUM :                   22FE C |
 FDDSECSKIP :                  2127 C |  FDDWRITEID :                  21FF C |
 FDDWRITESEC :                 21AF C |  FDD_COMEND :                    20 - |
 FDD_COMMAND :                   21 - |  FDD_DMACTRL :                    0 - |
 FDD_DMASIZE :                    1 - |  FDD_DNUM :                      23 - |
*FDD_DTL :                       2B - |  FDD_ENDTRG :                    17 - |
 FDD_EOT :                       29 - | *FDD_GPL :                       2A - |
 FDD_HNUM :                      24 - |  FDD_IDRC :                      25 - |
 FDD_IDRH :                      26 - |  FDD_IDRN :                      28 - |
 FDD_IDRR :                      27 - |  FDD_MT :                        22 - |
 FDD_RST_C :                     13 - |  FDD_RST_H :                     14 - |
 FDD_RST_N :                     16 - |  FDD_RST_R :                     15 - |
 FDD_ST0 :                       10 - |  FDD_ST1 :                       11 - |
 FDD_ST2 :                       12 - |  FDRL2 :                        E52 C |
 FDRL_END :                     EA8 C |  FDUNITINIT :                  1468 C |
 FIFO_BEFCL :                     D - |  FIFO_CL :                        8 - |
 FIFO_CMTLEN :                    0 - |  FIFO_CMTPTR :                    4 - |
 FIFO_CNUM :                     15 - |  FIFO_DIRCL :                     F - |
 FIFO_DIRPOS :                   11 - |  FIFO_FATNEW :                   13 - |
 FIFO_FDD :                      1F - |  FIFO_FLOPPY :                   14 - |
 FIFO_SEC :                       A - | *FIFO_STAT :                     14 - |
 FIFO_STCL :                      B - |  FIFO_WRADD :                    15 - |
 FILEPOSREAD :                  D8B C |  FILEPTR_BUF :                 2330 C |
 FILEREAD :                    103C C |  FILESEARCH :                  10B4 C |
 FILESEL :                     22BC C |  FILESELINIT :                  2D0 C |
 FILETAILREAD :                 E33 C |  FIRMVER :                       53 - |
 FPOSL0 :                       DC4 C |  FPOSL1 :                       DE4 C |
 FPOSL2 :                       E0C C |  FPOSL_ED :                     E17 C |
 FPOSL_OK :                     DB0 C |  FRL1 :                        104E C |
 FRL2 :                        1086 C |  FRL3 :                        1078 C |
 FRL4 :                        10AC C |  FRSL1 :                       20F4 C |
 FRSL2 :                       2107 C |  FRSL3 :                       210B C |
 FRS_END :                     211B C |  FSIL1 :                        2F2 C |
 FSIL2 :                        2FF C |  FSIL3 :                        30D C |
 FSIL4 :                        31B C |  FSIL5 :                        329 C |
 FSIL6 :                        337 C |  FSIL7 :                        345 C |
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 134 - 2/18/2013 12:10:16


 FSL1 :                        10C2 C |  FSL11 :                       10E3 C |
 FSL2 :                        10F1 C |  FSL3 :                        1100 C |
 FSS_L1 :                      213E C |  FSS_L2 :                      2191 C |
 FSS_L3 :                      2128 C | *FULLPMMU :                       1 - |
*FUNCBEF :                     2326 C | *FUNCNOW :                     2322 C |
 FUNCPUSH :                    232A C |  FWDL1 :                       220A C |
 FWDL2 :                       221D C |  FWDL3 :                       2221 C |
 FWDL4 :                       222C C |  FWDL5 :                       2254 C |
 FWDL6 :                       2261 C |  FWDL7 :                       226C C |
 FWSL1 :                       21B7 C |  FWSL2 :                       21CA C |
 FWSL3 :                       21CE C |  FWS_END :                     21DE C |
 F_BASICROM60 :                282C C |  F_BASICROM62 :                2842 C |
 F_BASICROM66 :                2879 C |  F_CG2ROM62 :                  2858 C |
 F_CG2ROM66 :                  288F C |  F_CGROM60 :                   2837 C |
 F_CGROM62 :                   284D C |  F_CGROM66 :                   2884 C |
 F_EXKANJIROM :                28B0 C |  F_KANJIROM62 :                2863 C |
 F_KANJIROM66 :                289A C |  F_ROMDIR :                    2821 C |
 F_VOICEROM62 :                286E C |  F_VOICEROM66 :                28A5 C |
 GDL_FDD1D :                   1FFC C |  GDL_X1 :                      2006 C |
 GETDISKSECADD :               1FDC C |  GETKEYP6T :                   161B C |
 GETSECSTAT :                  2037 C |  GET_NEWCL :                   127C C |
 GET_NEWSEC :                  126B C |  GET_NEXTCL :                  124C C |
 GET_NEXTSEC :                 123B C |  GKPL0 :                       1648 C |
 GKPL1 :                       165E C |  GKPL2 :                       166E C |
 GKPL3 :                       167D C |  GKPL4 :                       1690 C |
 GKPL5 :                       1698 C |  GKPL_MK2 :                    1652 C |
 GNCL_LP :                     1282 C |  GNCL_NG :                     129A C |
 GSS_L0 :                      204F C |  GSS_L1 :                      209C C |
 GSS_L2 :                      20AF C |  GSS_L3 :                      20B4 C |
*HAS64 :                          1 - | *HASDSP :                         0 - |
*HASFPU :                         0 - | *HASPMMU :                        0 - |
*INEXTMODE :                      0 - |  INITSP :                      3FFF - |
*INLWORDMODE :                    0 - | *INMAXMODE :                      0 - |
*INSRCMODE :                      0 - | *INSUPMODE :                      0 - |
 JMPREADPTR :                   EC6 C |  KBL1 :                        155B C |
 KDLP1 :                        B4A C |  KDLP2 :                        B63 C |
 KEYBUFINIT :                  1555 C |  KEYDET :                       B3A C |
 KEYINPAGE :                    17F C |  KEYINPAGE0 :                   191 C |
 KEYINPAGE1 :                   347 C |  KEYINPAGE2 :                   6C0 C |
 KEYTIMER :                    231C C |  KP0L0 :                        291 C |
*KP0L00 :                       1C5 C |  KP0L01 :                       1D6 C |
 KP0L02 :                       1F5 C |  KP0L04 :                       20B C |
 KP0L05 :                       21E C |  KP0L06 :                       22F C |
 KP0L08 :                       23D C |  KP0L081 :                      24F C |
 KP0L082 :                      25A C |  KP0L09 :                       25F C |
 KP0L1 :                        29A C |  KP0L91 :                       273 C |
 KP0L92 :                       27B C |  KP0LS :                        1B1 C |
 KP1L0 :                        36C C |  KP1L1 :                        37D C |
 KP1L11 :                       436 C |  KP1L1_FDD :                    4F6 C |
 KP1L1_FDD_1 :                  580 C |  KP1L1_FDD_2 :                  58C C |
 KP1L1_FDD_3 :                  594 C |  KP1L1_FDD_RW :                 50D C |
 KP1L1_FS1 :                    475 C |  KP1L1_FS2 :                    4C3 C |
 KP1L1_FS3 :                    4EA C |  KP1L1_FS4 :                    5AD C |
 KP1L1_FS5 :                    5BB C |  KP1L1_FS6 :                    5C9 C |
 KP1L1_FS7 :                    5D7 C |  KP1L1_LEN_0 :                  5A1 C |
 KP1L1_LEN_NG :                 598 C |  KP1L1_LEN_OK :                 53B C |
 KP1L1_NOP6T :                  471 C |  KP1L1_NOSEL1 :                 3A2 C |
 KP1L1_NOSEL2 :                 3BE C |  KP1L1_NOSEL3 :                 3CA C |
 KP1L1_NOSEL4 :                 3DA C |  KP1L1_NOSEL5 :                 3E7 C |
 KP1L1_NOSEL6 :                 3F4 C |  KP1L1_NOSEL7 :                 401 C |
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 135 - 2/18/2013 12:10:16


 KP1L1_NOSELECT :               38E C |  KP1L1_NOSELEND :               39B C |
 KP1L1_NOSELFDD :               3D5 C |  KP1L1_ROOT :                   42F C |
 KP1L1_SEL1 :                   403 C |  KP1L2 :                        5D9 C |
 KP1L3 :                        5F9 C |  KP1L4 :                        623 C |
 KP1L5 :                        64B C |  KP2L0 :                        7A4 C |
*KP2L00 :                       6DD C |  KP2L01 :                       6FB C |
 KP2L02 :                       712 C |  KP2L03 :                       730 C |
 KP2L05 :                       747 C |  KP2L06 :                       75F C |
 KP2L07 :                       776 C |  KP2L08 :                       78E C |
 KP2L1 :                        7AD C | *KP2LS :                        6C9 C |
 LCDD1 :                       1464 C |  LCD_INIT :                    142A C |
 LCD_OUTDT :                   145A C |  LD4B_MDE_MHL :                1375 C |
 LD4B_REG_SDADD_MHL :          137B C |  LD4B_WORK_MHL :               1384 C |
 LD_ST_NOSELECT :              1542 C | *LISTON :                         1 - |
 LR1BL1 :                       F5F C |  LR1BL2 :                       F45 C |
 LW1BL1 :                       FE3 C |  LW1BL2 :                       FC9 C |
*MACEXP :                         1 - |  MAINST2 :                      108 C |
 MAINSTART :                     FD C |  MLP10 :                        11D C |
 MLP11 :                        148 C | *MLP12 :                        174 C |
*MOMCPU :                        80 - | *MOMCPUNAME :                   Z80 - |
 MOVEREADPTR :                  ED8 C | *NESTMAX :                      100 - |
 OFFSET :                      228D C |  P0CL0 :                        2B8 C |
 P0CL2 :                        2BD C |  P1LP10 :                       8B8 C |
 P1LP11 :                       8C3 C |  P1LP12 :                       959 C |
 P1LP13 :                       8C8 C |  P1LP131 :                      8DD C |
 P1LP14 :                       969 C |  P1LP141 :                      976 C |
 P1LP15 :                       8CA C |  P1LP151 :                      8DF C |
 P1LP16 :                       907 C |  P1LP161 :                      92A C |
 P1LP18 :                       939 C |  P2CL0 :                        7CB C |
 P6L1 :                        15C8 C |  P6L2 :                        15DB C |
 P6LPUSH :                     15F0 C |  P6LRELEASE :                  1608 C |
 P6TBUFFER :                   28BB C |  P6TBUFPOS :                   231F C |
 P6TCMDENB :                   2319 C |  P6TCMDENBBEF :                231A C |
 P6TCMDLEN :                   231E C |  P6TFILEREAD :                 231B C |
 P6TKEYPUSH :                  2320 C |  P6TKEYWAIT :                  1590 C |
*PACKING :                        0 - | *PADDING :                        1 - |
 PAGE0CURDATA :                27E5 C |  PAGE0CURMOV :                  2A1 C |
 PAGE0INIT :                    355 C |  PAGE1REDRAW :                  371 C |
 PAGE2CURDATA :                2803 C |  PAGE2CURMOV :                  7B4 C |
 PAGE2INIT :                    199 C |  PAGEINIT :                     34E C |
 PAGENUM :                     22B8 C |  PAGEREDRAW :                  22BA C |
 PRINTSTRING :                  B28 C |  PSL1 :                         B32 C |
 RDL1 :                        11CC C |  RDL2 :                        11DB C |
 RDL3 :                        11CE C |  RDL4 :                        11D8 C |
 RDL5 :                        11F1 C |  RDM2 :                          51 C |
 RDM3 :                          97 C |  READ1BYTE :                    EF6 C |
 READ1SEC :                    138D C |  READCONT :                    1068 C |
 READEND :                       D8 C |  READEND2 :                      F0 C |
 READFLAG :                    22B5 C |  READP6T :                     169A C |
 READ_DIRFILE :                11AC C |  REG_BUFAD :                   8210 - |
 REG_BUFSEL :                  8211 - |  REG_CMTOPEN :                 8212 - |
 REG_CMTRD :                   8234 - |  REG_CMTWR :                   8254 - |
 REG_CTRLRST :                 8411 - |  REG_CTRLSEL :                 8410 - |
 REG_DBGTRG :                  8414 - |  REG_EXKANJIENB :              841C - |
 REG_EXTFDCDATA :              9FF5 - |  REG_EXTFDCMAIN :              9FF4 - |
 REG_EXTFDD :                  8340 - |  REG_EXTFDDCIO :               9FF2 - |
 REG_EXTFDDCNT :               9FF3 - |  REG_EXTFDDDI :                9FF0 - |
 REG_EXTFDDDO :                9FF1 - |  REG_FDD0 :                    827F - |
 REG_FDD1 :                    829F - |  REG_FDD2 :                    82BF - |
 REG_FDD3 :                    82DF - |  REG_FDINT :                   8370 - |
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 136 - 2/18/2013 12:10:16


 REG_FIFO_0 :                  8220 - |  REG_FIFO_1 :                  8240 - |
 REG_FIFO_2 :                  8260 - |  REG_FIFO_3 :                  8280 - |
 REG_FIFO_4 :                  82A0 - |  REG_FIFO_5 :                  82C0 - |
 REG_FIRMVER :                 8442 - |  REG_FPGAVER :                 8440 - |
 REG_FUNCKEY :                 8420 - |  REG_INTFDD :                  8310 - |
 REG_KEYDAT :                  8416 - |  REG_KEYENB :                  8417 - |
 REG_LCDADD :                  8401 - | *REG_LCDDAT :                  8402 - |
 REG_LCDDONE :                 8404 - | *REG_LCDMODE :                 8400 - |
 REG_LCDST :                   8403 - |  REG_MEM16K :                  8412 - |
 REG_MK2MODE :                 8415 - |  REG_OFFSET :                  81C6 - |
 REG_ROMINIT :                 8203 - |  REG_SC4MODE :                 8413 - |
 REG_SDADD :                   8206 - |  REG_SDBUF :                   8000 - |
 REG_SDCMDNO :                 8205 - |  REG_SDCMDST :                 8200 - |
 REG_SDCTRL :                  8201 - |  REG_SDRD :                    8213 - |
 REG_SDRDDONE :                8202 - |  REG_SDWP :                    8204 - |
 REG_SDWR :                    8214 - |  REG_UARTENB :                 8418 - |
 REG_UARTLEN :                 8419 - | *RELAXED :                        0 - |
 ROMFILEREAD :                  FE7 C |  ROMFILEREAD2 :                 FEE C |
 ROMINIT :                     1109 C |  ROMLP :                       110F C |
 ROOTST :                      2297 C |  RP6T_NG :                     1709 C |
 RSL1 :                        139D C |  SCL1 :                        13CF C |
 SCL2 :                        13E2 C |  SCREENINIT :                   A89 C |
 SDADDINIT :                   154B C |  SDCARD_OPEN :                 1114 C |
 SDDETTIMER :                  22BF C |  SDERR :                       1411 C |
 SDMODE :                      22B4 C |  SDREGINIT :                   148A C |
 SDREGINIT_0 :                 14F4 C |  SDREGINIT_1 :                 1519 C |
 SDREGINIT_2 :                 1531 C |  SDW1 :                        112A C |
 SDWPFLAG :                    22B7 C |  SEARCHTYPE :                  22BE C |
 SECACCFLAG :                  2300 C |  SECDELCOMP :                  2302 C |
 SECHEADER :                   2305 C |  SECHEADER_DM :                230C C |
 SECIDRCOMP :                  2301 C |  SECSTAT :                     2303 C |
 SENDCMD :                     13C6 C |  SENDCMD2 :                    13D9 C |
 SETFILEPARA :                  688 C |  SETFILEPARA2 :                 69C C |
 SETSECSTAT :                  20CA C |  SHT4B_MHL :                   1354 C |
 SIL_BOT :                      ABA C |  SIL_MID :                      AAB C |
 SIL_P6 :                       AE8 C |  SIL_TOP :                      A9C C |
 SRL1_0 :                      14FB C |  SRL1_1 :                      1520 C |
 SRL1_2 :                      1538 C |  SSS_L1 :                      20CF C |
*START :                          0 C |  ST_128 :                      261C C |
 ST_16 :                       2613 C |  ST_1D :                       2785 C |
 ST_1DD :                      278B C |  ST_2D :                       2791 C |
 ST_2DD :                      2797 C |  ST_32 :                       2616 C |
 ST_64 :                       2619 C |  ST_CMTREAD :                  239A C |
 ST_CMTREAD_VAL :              23AC C |  ST_CMTREW :                   23BA C |
 ST_CMTWRITE :                 23D7 C |  ST_CMTWRITE_VAL :             23E9 C |
*ST_DEBUG :                    25E9 C | *ST_DEBUG_VAL :                25EE C |
 ST_EXKANJI :                  2434 C |  ST_EXKANJI_VAL :              244A C |
 ST_EXROM :                    2414 C |  ST_EXROM_VAL :                2426 C |
 ST_FDD0EXTFILE :              2530 C |  ST_FDD0EXTFILE_VAL :          2544 C |
 ST_FDD0EXTSET :               2511 C |  ST_FDD0EXTSET_VAL :           2528 C |
 ST_FDD0INTFILE :              24AE C |  ST_FDD0INTFILE_VAL :          24C2 C |
 ST_FDD0INTSET :               248F C |  ST_FDD0INTSET_VAL :           24A6 C |
 ST_FDD1EXTFILE :              2571 C |  ST_FDD1EXTFILE_VAL :          2585 C |
 ST_FDD1EXTSET :               2552 C |  ST_FDD1EXTSET_VAL :           2569 C |
 ST_FDD1INTFILE :              24EF C |  ST_FDD1INTFILE_VAL :          2503 C |
 ST_FDD1INTSET :               24D0 C |  ST_FDD1INTSET_VAL :           24E7 C |
 ST_FIRMVER :                  238D C |  ST_FIRMVER_VAL :              2395 C |
 ST_FNAME :                    25DA C |  ST_FNAME_VAL :                25DC C |
 ST_FPGAVER :                  237F C |  ST_FPGAVER_VAL :              2388 C |
 ST_KEYFUNC1 :                 2596 C |  ST_KEYFUNC2 :                 25B8 C |
 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 137 - 2/18/2013 12:10:16


 ST_MEMSIZE :                  23F7 C |  ST_MEMSIZE_VAL :              240C C |
 ST_NOSELECT :                 25F3 C |  ST_NOUSE :                    277F C |
 ST_OFF :                      260B C |  ST_ON :                       260F C |
 ST_P6T :                      2593 C |  ST_PC6001F :                  235A C |
 ST_PC6001FMK2 :               2365 C |  ST_PC6601F :                  2374 C |
 ST_SC4COL :                   2451 C |  ST_SC4COL0 :                  261F C |
 ST_SC4COL1 :                  2627 C |  ST_SC4COL2 :                  262F C |
 ST_SC4COL3 :                  2637 C |  ST_SC4COLOFF :                263F C |
 ST_SC4COL_VAL :               2465 C |  ST_UART :                     246F C |
 ST_UARTBAUD :                 2647 C |  ST_UART_VAL :                 2480 C |
 ST_WRPROTECT :                25FF C |  TB_UARTBAUD :                 279D C |
*TIME :                    12:10:16 - | *TRUE :                           1 - |
 UARTINIT :                    1482 C |  UART_BAUD :                   2358 C |
 VCL1 :                         B06 C |  VCL2 :                         B15 C |
 VCL3 :                         B22 C | *VERSION :                     142F - |
 VER_CONV :                     B04 C |  WORK :                        22A4 C |
 WORK2 :                       22A8 C |  WORK3 :                       22AC C |
 WORK4 :                       22B0 C |  WRITE1BYTE :                   F64 C |
 WRITE1SEC :                   13AA C |  WRITEFLAG :                   22B6 C |
 WSL1 :                        13B9 C |

    753 symbols
     47 unused symbols

 AS V1.42 Beta [Bld 84] - source file ctrlrom.asm - page 138 - 2/18/2013 12:10:16


  codepages:
  ----------

STANDARD (0 changed characters)


0.14 seconds assembly time

   7581 lines source file
      2 passes
      0 errors
      0 warnings
